<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Panel kierowcy – grafik</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; }
    .toolbar .form-select, .toolbar .form-control { max-width: 280px }
    /* Style kalendarza skopiowane z panelu terapeuty */
    .cal-wrap { overflow:auto; border:1px solid var(--bs-border-color); border-radius:.5rem; }
    .cal-grid { display:grid; grid-template-columns: 80px repeat(7, 1fr); }
    .cal-head { position:sticky; top:0; z-index:2; background:var(--bs-body-bg); border-bottom:1px solid var(--bs-border-color); }
    .cal-head div { padding:.5rem; font-weight:600; text-align:center; border-left:1px solid var(--bs-border-color); }
    .cal-head div:first-child { border-left:0; text-align:left; }
    .cal-row { height:24px; border-top:1px dotted var(--bs-border-color); font-size:12px; }
    .cal-row label { display:inline-block; padding:2px 6px; color: var(--bs-secondary-color); }
    .cal-col { position:relative; border-left:1px solid var(--bs-border-color); }
    .cal-event { position:absolute; left:4px; right:4px; border-radius:.5rem; padding:2px 6px; font-size:12px; line-height:1.2; overflow:hidden; }
    .cal-event.pickup { background: rgba(13,202,240,.15); border:1px solid rgba(13,202,240,.35); }
    .cal-event.dropoff { background: rgba(25,135,84,.15); border-color: rgba(25,135,84,.35); }
    .cal-event.cancelled { background: rgba(220,53,69,.10); border-color: rgba(220,53,69,.35); text-decoration:line-through; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <header class="d-flex flex-wrap align-items-center gap-2 mb-3 toolbar">
      <h1 class="h5 m-0">Panel kierowcy – grafik</h1>
      <div class="ms-auto"></div>
      <select id="driverSelect" class="form-select">
        <option value="all">— wszyscy kierowcy —</option>
      </select>
      <input type="month" id="refMonth" class="form-control" />
      <div class="btn-group">
        <button id="tpPrev" class="btn btn-outline-secondary">«</button>
        <button id="tpToday" class="btn btn-outline-secondary">Dziś</button>
        <button id="tpNext" class="btn btn-outline-secondary">»</button>
      </div>
    </header>
    <div id="alertBox" class="mb-3"></div>
    <div id="calendarHost"></div>
  </div>

  <script>
    const API = ""; // ten sam origin
    const DOW_SHORT = ["Pn","Wt","Śr","Cz","Pt","So","Nd"];
    const START_HOUR = 7, END_HOUR = 20, PX_PER_MIN = 24 / 30;

    let _state = {
      driverId: "all",
      refMonth: new Date(),
      drivers: [],
      rows: []
    };

    function parseLocalTimestamp(str) {
      if (!str) return null;
      const s = str.trim().replace('T', ' ');
      const m = /^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/.exec(s);
      if (!m) return null;
      const [_, Y, M, D, h, mnt, sec] = m;
      return new Date(Number(Y), Number(M) - 1, Number(D), Number(h), Number(mnt), Number(sec));
    }

    function fmtLocalTime(str) {
      const d = parseLocalTimestamp(str);
      if (!d) return "";
      return d.toLocaleTimeString("pl-PL", { hour: "2-digit", minute: "2-digit" });
    }

    (async function init() {
      const t = new Date();
      document.getElementById("refMonth").value = t.toISOString().slice(0, 7);
      _state.refMonth = new Date(t.getFullYear(), t.getMonth(), 1);

      try {
        const res = await fetch(`${API}/api/drivers`);
        _state.drivers = (await res.json()).filter(x => x.active !== false);
        const sel = document.getElementById("driverSelect");
        sel.innerHTML = `<option value="all">— wszyscy kierowcy —</option>` +
          _state.drivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join("");
      } catch (e) {
        console.error("Błąd ładowania kierowców:", e);
      }

      document.getElementById("driverSelect").addEventListener("change", reloadData);
      document.getElementById("refMonth").addEventListener("change", e => {
        const [y, m] = e.target.value.split("-").map(Number);
        _state.refMonth = new Date(y, m - 1, 1);
        reloadData();
      });

      document.getElementById("tpPrev").addEventListener("click", () => shiftMonth(-1));
      document.getElementById("tpNext").addEventListener("click", () => shiftMonth(1));
      document.getElementById("tpToday").addEventListener("click", goToday);

      reloadData();
    })();

    function shiftMonth(offset) {
      const d = new Date(_state.refMonth.getFullYear(), _state.refMonth.getMonth() + offset, 1);
      _state.refMonth = d;
      document.getElementById("refMonth").value = d.toISOString().slice(0, 7);
      reloadData();
    }

    function goToday() {
      const t = new Date();
      const m = new Date(t.getFullYear(), t.getMonth(), 1);
      _state.refMonth = m;
      document.getElementById("refMonth").value = m.toISOString().slice(0, 7);
      reloadData();
    }

    async function reloadData() {
      _state.driverId = document.getElementById("driverSelect").value || "all";
      const mk = `${_state.refMonth.getFullYear()}-${String(_state.refMonth.getMonth() + 1).padStart(2, '0')}`;
      const host = document.getElementById("calendarHost");
      host.innerHTML = `<div class="text-muted p-3">Ładowanie…</div>`;

      try {
        if (_state.driverId === "all") {
          const promises = _state.drivers.map(d =>
            fetch(`${API}/api/drivers/${d.id}/schedule?month=${mk}`)
            .then(r => r.ok ? r.json() : [])
          );
          _state.rows = (await Promise.all(promises)).flat();
        } else {
          const did = Number(_state.driverId);
          const res = await fetch(`${API}/api/drivers/${did}/schedule?month=${mk}`);
          _state.rows = await res.json() || [];
        }
        renderWeek();
      } catch (e) {
        host.innerHTML = `<div class="text-danger p-3">Błąd ładowania: ${e.message}</div>`;
      }
    }

    function renderWeek() {
      const host = document.getElementById("calendarHost");
      const firstOfMonth = new Date(_state.refMonth.getFullYear(), _state.refMonth.getMonth(), 1);
      const daysInMonth = new Date(_state.refMonth.getFullYear(), _state.refMonth.getMonth() + 1, 0).getDate();
      const days = Array.from({ length: daysInMonth }, (_, i) => new Date(firstOfMonth.getFullYear(), firstOfMonth.getMonth(), i + 1));

      let gridHtml = '';
      for (const day of days) {
        const dow = (day.getDay() + 6) % 7; // 0=pn
        const dayKey = day.toISOString().slice(0, 10);
        const dayEvents = _state.rows.filter(r => r.starts_at && r.starts_at.startsWith(dayKey));

        let eventsHtml = '';
        for (const r of dayEvents) {
          const s = parseLocalTimestamp(r.starts_at);
          const e = parseLocalTimestamp(r.ends_at);
          if (!s || !e) continue;

          const top = ((s.getHours() - START_HOUR) * 60 + s.getMinutes()) * PX_PER_MIN;
          const height = Math.max(18, Math.max(0, (e - s) / 60000) * PX_PER_MIN);

          eventsHtml += `<div class="cal-event ${r.kind || ""} ${r.status || "planned"}" style="top:${top}px; height:${height}px;">
            <div><strong>${fmtLocalTime(r.starts_at)}–${fmtLocalTime(r.ends_at)}</strong></div>
            <div class="text-truncate">${r.client_name || ""}</div>
            <div class="text-truncate"><small>${[r.place_from, r.place_to].filter(Boolean).join(" → ")}</small></div>
          </div>`;
        }
        gridHtml += `<div class="cal-col">${eventsHtml}</div>`;
      }

      const head = `<div class="cal-head cal-grid">
        <div style="padding:.5rem">Godz.</div>
        ${days.map(d => `<div>${DOW_SHORT[(d.getDay() + 6) % 7]}<br><small>${d.getDate()}</small></div>`).join("")}
      </div>`;

      let times = `<div>`;
      for (let h = START_HOUR; h <= END_HOUR; h++) {
        times += `<div class="cal-row"><label>${String(h).padStart(2, '0')}:00</label></div>`;
        if (h !== END_HOUR) times += `<div class="cal-row"></div>`;
      }
      times += `</div>`;

      const colHeight = ((END_HOUR - START_HOUR + 1) * 2 - 1) * 24;
      const cols = days.map(() => `<div class="cal-col" style="height:${colHeight}px"></div>`).join("");

      host.innerHTML = `<h4 class="mb-3">${_state.refMonth.toLocaleDateString("pl-PL", {month: "long", year: "numeric"})}</h4>
        <div class="cal-wrap">
          <div class="cal-grid">${times}${cols}</div>${head}
        </div>`;

      // Ponowne wstawienie eventów do siatki
      const dayCols = host.querySelectorAll('.cal-grid .cal-col');
      host.querySelectorAll('.cal-event').forEach(ev => {
          // Logika do wstawiania, jeśli potrzebna
      });
    }
  </script>
</body>
</html>