<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Planowanie SUO ‚Äì saldo i pakiety</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
  body { padding: 16px; }
  @media (min-width: 992px){ body { padding: 24px; } }
  .table thead th { white-space: nowrap; }
  .actions .btn { min-width: 110px; }
  @media (max-width: 576px){
    .actions .btn { width: 100%; }
    .actions .btn + .btn { margin-top: .5rem; }
  }
  .offcanvas.offcanvas-panel { --bs-offcanvas-width: 520px; }
  /* na wszelki wypadek wymu≈õ t≈Ço panelu (gdyby motyw mia≈Ç inne zmienne) */
  .offcanvas { --bs-offcanvas-bg: #fff; }

  @media (prefers-color-scheme: dark){
    .offcanvas { --bs-offcanvas-bg: #1e1e1e; }
  }

  .form-section-title { font-weight: 600; margin-top: 12px; }

  /* Kafelki ‚Äì delikatny efekt hover */
.start-card {
  transition: transform .12s ease, box-shadow .12s ease;
  border-radius: 16px;
}
.start-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.08);
}

</style>
</head>
<body>
    <div class="col-12 col-lg-6">
        <h1 class="h5 m-0">Modu≈Ç planowania</h1>
    </div>
<!-- POCZƒÑTEK ZMIANY: Poprawiona, responsywna nawigacja -->
    <nav class="navbar navbar-expand-lg bg-light-subtle mb-4 rounded shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-calendar-check"></i> Modu≈Ç Planowania
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-people-fill me-1"></i> Klienci
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="klienci.html"><i class="bi bi-list-ul me-2"></i>Lista Klient√≥w</a></li>
                            <li><a class="dropdown-item" href="client_history.html"><i class="bi bi-clock-history me-2"></i>Historia Klienta</a></li>
                            <li><a class="dropdown-item" href="dostepnosc.html"><i class="bi bi-person-check me-2"></i>Dostƒôpno≈õƒá Klienta</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item fw-bold" href="#" id="openClientSelectModalBtn"><i class="bi bi-plus-circle-fill me-2"></i>Dodaj Pakiet</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-calendar3 me-1"></i> Grafiki
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="therapist.html"><i class="bi bi-heart-pulse me-2"></i>Plan Terapeuty</a></li>
                            <li><a class="dropdown-item" href="kierowcy.html"><i class="bi bi-truck me-2"></i>Plan Kierowcy</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-star-fill me-1"></i> Modu≈Ç TUS
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="tus.html"><i class="bi bi-person-video3 me-2"></i>ZarzƒÖdzanie Grupami</a></li>
                            <li><a class="dropdown-item" href="plan-tus.html"><i class="bi bi-calendar-range me-2"></i>Globalny Plan TUS</a></li>
                            <li><a class="dropdown-item" href="attendance.html"><i class="bi bi-check-circle-fill me-2"></i>Lista Obecno≈õci TUS</a></li>
                        </ul>
                    </li>
                     <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-clipboard-check-fill"></i> Obecno≈õƒá
                        </a>
                        <ul class="dropdown-menu">
                             <li><a class="dropdown-item" href="individaul-attendance.html"><i class="bi bi-person-fill-check me-2"></i>Obecno≈õƒá Indywidualna</a></li>
                             <li><a class="dropdown-item" href="client-attendance.html"><i class="bi bi-card-checklist me-2"></i>Miesiƒôczna Obecno≈õƒá Klienta</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- KONIEC ZMIANY -->


<div id="errorBox" class="alert alert-danger d-none"></div>
   <div id="screen"></div>

  <div class="container-fluid">
    <header class="row align-items-center g-2 mb-3">

      <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
        <input id="clientFilter" type="text" class="form-control" placeholder="Szukaj klienta" style="max-width: 220px">
        <select id="therapistFilter" class="form-select" style="max-width: 260px">
          <option value="">‚Äî wszyscy terapeuci ‚Äî</option>
        </select>
        <input id="monthInput" type="month" class="form-control" style="max-width: 160px">
        <input id="dayInput" type="date" class="form-control" style="max-width: 170px">

        <button id="reloadBtn" class="btn btn-primary">
          <span class="spinner-border spinner-border-sm d-none" id="reloadSpinner" role="status" aria-hidden="true"></span>
          <span id="reloadTxt">Od≈õwie≈º</span></button>
         <button id="gapsMonthBtn" class="btn btn-outline-secondary">Braki w miesiƒÖcu</button>
      </div>
    </header>

    <div id="alertBox" class="mb-3"></div>
    <div id="gapsBox" class="mb-3"></div>


    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
          <h2 class="h6 m-0">Saldo SUO ‚Äì klienci</h2>
          <small class="text-muted">Kliknij ‚ÄûDodaj pakiet‚Äù, aby dodaƒá pickup ‚Üí terapiƒô ‚Üí dropoff</small>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle" id="clientsTable">
            <thead class="table-light">
              <tr>
                <th>Klient</th>
                <th class="d-none d-md-table-cell">Telefon</th>
                <th class="d-none d-lg-table-cell">Adres</th>
                <th>MiesiƒÖc</th>
                <th>Przydzia≈Ç</th>
                <th>Wykorzystano</th>
                <th>Pozosta≈Ço</th>
                <th>Status</th>

                <th style="width:1%"></th>
              </tr>
            </thead>
            <tbody id="clientsTbody">
              <tr>
                <td colspan="9" class="text-center py-4">
                  <div class="d-inline-flex align-items-center gap-2 text-muted">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>≈Åadowanie‚Ä¶</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="card shadow-sm mt-4">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
      <h2 class="h6 m-0">Terapeuci</h2>
      <button class="btn btn-sm btn-primary" id="btnOpenTherapistAdd">Dodaj terapeutƒô</button>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nazwa</th>
            <th class="d-none d-md-table-cell">Specjalizacja</th>
            <th class="d-none d-lg-table-cell">Telefon</th>
            <th>Status</th>
            <th style="width:1%"></th>
          </tr>
        </thead>
        <tbody id="therapistsTbody">
          <tr><td colspan="6" class="text-center text-muted py-3">≈Åadowanie‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
      <h2 class="h6 m-0">Kierowcy</h2>
      <button class="btn btn-sm btn-primary" id="btnOpenDriverAdd">Dodaj kierowcƒô</button>
    </div>


    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nazwa</th>
            <th class="d-none d-lg-table-cell">Telefon</th>
            <th>Status</th>
            <th style="width:1%"></th>
          </tr>
        </thead>
        <tbody id="driversTbody">
          <tr><td colspan="5" class="text-center text-muted py-3">≈Åadowanie‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

        </div>

      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="packageCanvas" aria-labelledby="packageCanvasLabel">
    <div class="offcanvas-header">
      <h5 id="packageCanvasLabel">Dodaj pakiet zdarze≈Ñ</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Zamknij"></button>
    </div>
    <div class="offcanvas-body">
      <form id="packageForm" class="needs-validation" novalidate>
        <input type="hidden" id="pkgClientId">
        <div class="mb-3">
          <label class="form-label">Etykieta (np. ‚ÄûWtorek poranny‚Äù)</label>
          <input type="text" class="form-control" id="pkgLabel" placeholder="Opcjonalnie">
        </div>

        <div class="form-section-title">Terapia</div>
        <div class="row g-3">
          <div class="col-12 col-sm-6">
            <label class="form-label">Terapeuta</label>
            <select class="form-select" id="thSelect" required>
              <option value="">‚Äî wybierz terapeutƒô ‚Äî</option>
            </select>
        </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" id="thDate" required>
          </div>
          <div class="col-6 col-sm-3">
            <label class="form-label">Start</label>
            <input type="time" class="form-control" id="thStart" required>
          </div>
          <div class="col-6 col-sm-3">
            <label class="form-label">Koniec</label>
            <input type="time" class="form-control" id="thEnd" required>
          </div>
          <div class="col-12">
            <label class="form-label">Miejsce</label>
            <input type="text" class="form-control" id="thPlace" placeholder="Poradnia">
          </div>
        </div>

        <hr class="my-3">

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="withPickup">
          <label class="form-check-label" for="withPickup"><strong>Dodaj dow√≥z (pickup)</strong></label>
        </div>
        <div id="pickupFields" class="row g-3 d-none">
          <div class="col-6 col-sm-6">
            <label class="form-label">Kierowca (pickup)</label>
            <select class="form-select" id="pkDriverSelect">
              <option value="">‚Äî wybierz kierowcƒô ‚Äî</option>
            </select>
        </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Vehicle ID</label>
            <input type="number" class="form-control" id="pkVehicleId">
          </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Start</label>
            <input type="time" class="form-control" id="pkStart">
          </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Koniec</label>
            <input type="time" class="form-control" id="pkEnd">
          </div>
          <div class="col-6">
            <label class="form-label">Z (from)</label>
            <input type="text" class="form-control" id="pkFrom" placeholder="Dom">
          </div>
          <div class="col-6">
            <label class="form-label">Do (to)</label>
            <input type="text" class="form-control" id="pkTo" placeholder="Poradnia">
          </div>
        </div>

        <hr class="my-3">

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="withDropoff">
          <label class="form-check-label" for="withDropoff"><strong>Dodaj odw√≥z (dropoff)</strong></label>
        </div>
        <div id="dropoffFields" class="row g-3 d-none">
          <div class="col-6 col-sm-6">
            <label class="form-label">Kierowca (dropoff)</label>
            <select class="form-select" id="dpDriverSelect">
              <option value="">‚Äî wybierz kierowcƒô ‚Äî</option>
            </select>
        </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Vehicle ID</label>
            <input type="number" class="form-control" id="dpVehicleId">
          </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Start</label>
            <input type="time" class="form-control" id="dpStart">
          </div>
          <div class="col-6 col-sm-6">
            <label class="form-label">Koniec</label>
            <input type="time" class="form-control" id="dpEnd">
          </div>
          <div class="col-6">
            <label class="form-label">Z (from)</label>
            <input type="text" class="form-control" id="dpFrom" placeholder="Poradnia">
          </div>
          <div class="col-6">
            <label class="form-label">Do (to)</label>
            <input type="text" class="form-control" id="dpTo" placeholder="Dom">
          </div>
        </div>

        <hr class="my-3">
        <div class="col-12 col-sm-6">
          <label class="form-label">Status</label>
          <select id="pkgStatus" class="form-select">
            <option value="planned" selected>zaplanowany</option>
            <option value="done">wykonany</option>
            <option value="cancelled">anulowany</option>
          </select>
        </div>

        <div class="d-grid d-sm-flex gap-2 mt-4">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Anuluj</button>
          <button id="pkgSaveBtn" class="btn btn-primary" type="submit">
            <span class="spinner-border spinner-border-sm d-none" id="pkgSpinner"></span>
            Zapisz pakiet
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="allocCanvas" aria-labelledby="allocCanvasLabel">
    <div class="offcanvas-header">
      <h5 id="allocCanvasLabel">Ustaw przydzia≈Ç SUO</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Zamknij"></button>
    </div>
    <div class="offcanvas-body">
      <form id="allocForm" class="needs-validation" novalidate>
        <input type="hidden" id="allocClientId">
        <div class="mb-3">
          <label class="form-label">Klient</label>
          <input type="text" class="form-control" id="allocClientName" disabled>
        </div>
        <div class="mb-3">
          <label class="form-label">MiesiƒÖc (YYYY-MM)</label>
          <input type="month" class="form-control" id="allocMonth" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Przydzia≈Ç godzin</label>
          <input type="number" min="0" step="0.5" class="form-control" id="allocMinutes" placeholder="np. 20" required>
        </div>

        <div class="d-grid d-sm-flex gap-2">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Anuluj</button>
          <button id="allocSaveBtn" class="btn btn-primary" type="submit">
            <span class="spinner-border spinner-border-sm d-none" id="allocSpinner"></span>
            Zapisz
          </button>
        </div>
      </form>
    </div>
  </div>

<div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="clientCanvas" aria-labelledby="clientCanvasLabel">
  <div class="offcanvas-header">
    <h5 id="clientCanvasLabel">Dodaj klienta</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Zamknij"></button>
  </div>
  <div class="offcanvas-body">
    <form id="clientForm">
       <input type="hidden" id="clId">
      <div class="mb-3">
        <label class="form-label">Imiƒô i nazwisko</label>
        <input type="text" class="form-control" id="clName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Telefon</label>
        <input type="text" class="form-control" id="clPhone">
      </div>
      <div class="mb-3">
        <label class="form-label">Adres</label>
        <input type="text" class="form-control" id="clAddress">
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="clActive" checked>
        <label class="form-check-label" for="clActive">Aktywny</label>
      </div>
      <div class="d-grid d-sm-flex gap-2">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Anuluj</button>
        <button id="clSaveBtn" class="btn btn-primary" type="submit">
          <span class="spinner-border spinner-border-sm d-none" id="clSpinner"></span>
          Zapisz
        </button>
      </div>
    </form>
  </div>
</div>

<div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="therapistCanvas" aria-labelledby="therapistCanvasLabel">
  <div class="offcanvas-header">
    <h5 id="therapistCanvasLabel">Dodaj terapeutƒô</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Zamknij"></button>
  </div>
  <div class="offcanvas-body">
    <form id="therapistForm">
      <div class="mb-3">
        <label class="form-label">Imiƒô i nazwisko</label>
        <input type="text" class="form-control" id="thName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Specjalizacja</label>
        <input type="text" class="form-control" id="thSpec" placeholder="np. SI, psycholog">
      </div>
      <div class="mb-3">
        <label class="form-label">Telefon</label>
        <input type="text" class="form-control" id="thPhone">
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="thActive" checked>
        <label class="form-check-label" for="thActive">Aktywny</label>
      </div>
      <div class="d-grid d-sm-flex gap-2">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Anuluj</button>
        <button id="thSaveBtn" class="btn btn-primary" type="submit">
          <span class="spinner-border spinner-border-sm d-none" id="thSpinner"></span>
          Zapisz
        </button>
      </div>
    </form>
  </div>
</div>

<div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="driverCanvas" aria-labelledby="driverCanvasLabel">
  <div class="offcanvas-header">
    <h5 id="driverCanvasLabel">Dodaj kierowcƒô</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Zamknij"></button>
  </div>
  <div class="offcanvas-body">
    <form id="driverForm">
      <div class="mb-3">
        <label class="form-label">Imiƒô i nazwisko</label>
        <input type="text" class="form-control" id="drName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Telefon</label>
        <input type="text" class="form-control" id="drPhone">
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="drActive" checked>
        <label class="form-check-label" for="drActive">Aktywny</label>
      </div>
      <div class="d-grid d-sm-flex gap-2">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="offcanvas">Anuluj</button>
        <button id="drSaveBtn" class="btn btn-primary" type="submit">
          <span class="spinner-border spinner-border-sm d-none" id="drSpinner"></span>
          Zapisz
        </button>
      </div>
    </form>
  </div>
</div>

<div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="clientPackagesCanvas">
  <div class="offcanvas-header">
    <h5 class="m-0">Pakiety klienta</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-2 text-muted"><span id="cpClientName">‚Äî</span></div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Grupa</th><th>Rodzaj</th><th>Start</th><th>Koniec</th>
            <th>Terapeuta/Kierowca</th><th>Z</th><th>Do</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="clientPackagesTbody">
          <tr><td colspan="8" class="text-center text-muted py-3">Brak danych</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end offcanvas-panel" tabindex="-1" id="therapistScheduleCanvas">
  <div class="offcanvas-header">
    <h5 class="m-0">Grafik terapeuty</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="mb-2 text-muted"><span id="tsTherapistName">‚Äî</span></div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Rodzaj</th><th>Klient</th><th>Start</th><th>Koniec</th><th>Z</th><th>Do</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="therapistScheduleTbody">
          <tr><td colspan="7" class="text-center text-muted py-3">Brak danych</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-----MOADEL----->

<div class="modal fade" id="packageTypeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Wybierz rodzaj zajƒôƒá</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Jaki rodzaj zajƒôƒá chcesz zaplanowaƒá dla tego klienta?</p>
        <div class="d-grid gap-2">
          <button class="btn btn-primary btn-lg" id="btnGoToIndividualPackage">Zajƒôcia Indywidualne</button>
          <button class="btn btn-info btn-lg" id="btnGoToTus">Sesja Grupowa TUS</button>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="clientPackagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="clientPackagesTitle">Pakiety klienta</h5>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="printPackagesBtn">
            Drukuj
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
        </div>
        <div class="modal-body" id="clientPackagesBody">
          </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="driverScheduleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="driverScheduleTitle">Kursy kierowcy</h5>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="printDriverBtn">Drukuj</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body" id="driverScheduleBody"><div class="text-muted">Brak danych</div></div>
    </div>
  </div>
</div>

<div class="modal fade" id="therapistReportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="therapistReportTitle">Zestawienie godzin terapeuty</h5>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="printTherapistReportBtn">Drukuj</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body" id="therapistReportBody">
        <div class="text-muted">Brak danych</div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="clientSelectModal" tabindex="-1" aria-labelledby="clientSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientSelectModalLabel">Dodaj Pakiet - Krok 1: Wybierz klienta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Wybierz klienta z listy, aby zaplanowaƒá dla niego nowy pakiet zdarze≈Ñ.</p>
        <select id="modalClientSelect" class="form-select form-select-lg">
          <option value="">≈Åadowanie listy klient√≥w...</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
        <button type="button" class="btn btn-primary" id="continueWithClientBtn">Dalej ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="absenceModal" tabindex="-1" aria-labelledby="absenceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="absenceModalLabel">Dodaj nieobecno≈õƒá</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body">
        <form id="absenceForm">
          <input type="hidden" id="absencePersonType">
          <input type="hidden" id="absencePersonId">
          <div class="mb-3">
            <label for="absenceStatus" class="form-label">Status</label>
            <select class="form-select" id="absenceStatus" required>
              <option value="Urlop">Urlop</option>
              <option value="L4">L4 (Chorobowe)</option>
              <option value="Szkolenie">Szkolenie</option>
              <option value="Inne">Inne</option>
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="absenceStartDate" class="form-label">Od</label>
              <input type="date" class="form-control" id="absenceStartDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="absenceEndDate" class="form-label">Do</label>
              <input type="date" class="form-control" id="absenceEndDate" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="absenceNotes" class="form-label">Notatki (opcjonalnie)</label>
            <textarea class="form-control" id="absenceNotes" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
        <button type="submit" form="absenceForm" class="btn btn-primary">Zapisz</button>
      </div>
    </div>
  </div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function formatMinutesAsHours(mins) {
  if (mins === null || typeof mins === 'undefined' || isNaN(mins)) {
    return "‚Äî"; // Zwraca my≈õlnik dla braku danych
  }
  const hours = Math.floor(mins / 60);
  const remainingMinutes = mins % 60;

  if (hours > 0 && remainingMinutes > 0) {
    return `${hours} h ${remainingMinutes} m`;
  }
  if (hours > 0) {
    return `${hours} h`;
  }
  return `${remainingMinutes} m`;
}
    const API = ""; // ten sam origin: http://127.0.0.1:5000

    let _clientEditId = null;
    let lastClients = [];


    const packageTypeModalEl = document.getElementById('packageTypeModal');
    const packageTypeModal = new bootstrap.Modal(packageTypeModalEl);
    let _clientIdForNewPackage = null; // Zmienna do przechowywania ID klienta



    // NOWY KOD DO WKLEJENIA
    let currentlyDisplayedClientIds = [];

    // Funkcja do filtrowania tabeli terapeut√≥w
    function filterTherapistsTable(selectedTherapistId) {
        const therapistsTbody = document.getElementById("therapistsTbody");
        const therapistRows = therapistsTbody.querySelectorAll("tr");

        // Je≈õli wybrano "wszyscy", poka≈º wszystkie wiersze
        if (selectedTherapistId === "all" || !selectedTherapistId) {
            therapistRows.forEach(row => row.style.display = "");
            return;
        }

        // W przeciwnym razie, poka≈º tylko wybrany wiersz
        therapistRows.forEach(row => {
            const rowId = row.querySelector("td")?.textContent;
            row.style.display = (rowId === selectedTherapistId) ? "" : "none";
        });
    }

    // Funkcja do filtrowania tabeli kierowc√≥w
    async function filterDriversTable(clientIds) {
        const driversTbody = document.getElementById("driversTbody");
        const driverRows = driversTbody.querySelectorAll("tr");
        const selectedTherapistId = document.getElementById("therapistFilter").value;

        // Je≈õli wybrano "wszyscy terapeuci", poka≈º wszystkich kierowc√≥w
        if (selectedTherapistId === "all") {
            driverRows.forEach(row => row.style.display = "");
            return;
        }

        // Je≈õli dla danego terapeuty nie ma klient√≥w, ukryj wszystkich kierowc√≥w
        if (!clientIds || clientIds.length === 0) {
            driverRows.forEach(row => row.style.display = "none");
            return;
        }

        try {
            // Pobierz pakiety dla wszystkich widocznych klient√≥w, aby znale≈∫ƒá powiƒÖzanych kierowc√≥w
            const fetchPromises = clientIds.map(cid =>
                fetch(`${API}/api/client/${cid}/packages`).then(res => res.ok ? res.json() : [])
            );

            const packagesPerClient = await Promise.all(fetchPromises);
            const allPackages = packagesPerClient.flat();

            const relevantDriverIds = new Set(
                allPackages.filter(pkg => pkg.driver_id).map(pkg => String(pkg.driver_id))
            );

            // Poka≈º tylko tych kierowc√≥w, kt√≥rych ID znaleziono w pakietach
            driverRows.forEach(row => {
                const rowId = row.querySelector("td")?.textContent;
                row.style.display = (rowId && relevantDriverIds.has(rowId)) ? "" : "none";
            });
        } catch (err) {
            console.error("B≈ÇƒÖd podczas filtrowania kierowc√≥w:", err);
            // W razie b≈Çƒôdu, dla bezpiecze≈Ñstwa poka≈º wszystkich kierowc√≥w
            driverRows.forEach(row => row.style.display = "");
        }
    }



    // DOM refs
    const monthInput = document.getElementById("monthInput");
    const reloadBtn = document.getElementById("reloadBtn");
    const reloadSpinner = document.getElementById("reloadSpinner");
    const reloadTxt = document.getElementById("reloadTxt");
    const tbody = document.getElementById("clientsTbody");
    const alertBox = document.getElementById("alertBox");
    const clientFilter = document.getElementById("clientFilter");
    const therapistFilter = document.getElementById("therapistFilter");
    const clientPackagesModal = new bootstrap.Modal(document.getElementById('clientPackagesModal'));




    // nowe referencje do select√≥w
    const thSelect = document.getElementById("thSelect");
    const pkDriverSelect = document.getElementById("pkDriverSelect");
    const dpDriverSelect = document.getElementById("dpDriverSelect");

    // Offcanvas init
    const packageCanvas = new bootstrap.Offcanvas('#packageCanvas');
    const allocCanvas = new bootstrap.Offcanvas('#allocCanvas');

    // Pakiet ‚Äì refs
    const pkgClientId = document.getElementById("pkgClientId");
    const pkgLabel = document.getElementById("pkgLabel");
    const thId = document.getElementById("thSelect");
    const thDate = document.getElementById("thDate");
    const thStart = document.getElementById("thStart");
    const thEnd = document.getElementById("thEnd");
    const thPlace = document.getElementById("thPlace");
    const withPickup = document.getElementById("withPickup");
    const withDropoff = document.getElementById("withDropoff");
    const pickupFields = document.getElementById("pickupFields");
    const dropoffFields = document.getElementById("dropoffFields");
    const pkDriverId = document.getElementById("pkDriverSelect");
    const pkVehicleId = document.getElementById("pkVehicleId");
    const pkStart = document.getElementById("pkStart");
    const pkEnd = document.getElementById("pkEnd");
    const pkFrom = document.getElementById("pkFrom");
    const pkTo = document.getElementById("pkTo");
    const dpDriverId = document.getElementById("dpDriverSelect");
    const dpVehicleId = document.getElementById("dpVehicleId");
    const dpStart = document.getElementById("dpStart");
    const dpEnd = document.getElementById("dpEnd");
    const dpFrom = document.getElementById("dpFrom");
    const dpTo = document.getElementById("dpTo");
    const pkgSaveBtn = document.getElementById("pkgSaveBtn");
    const pkgSpinner = document.getElementById("pkgSpinner");

    // Allocation ‚Äì refs
    const allocClientId = document.getElementById("allocClientId");
    const allocClientName = document.getElementById("allocClientName");
    const allocMonth = document.getElementById("allocMonth");
    const allocMinutes = document.getElementById("allocMinutes");
    const allocSaveBtn = document.getElementById("allocSaveBtn");
    const allocSpinner = document.getElementById("allocSpinner");

    const clientCanvasEl     = document.getElementById('clientCanvas');
    const therapistCanvasEl  = document.getElementById('therapistCanvas');
    const driverCanvasEl     = document.getElementById('driverCanvas');

    const clientOC    = clientCanvasEl ? bootstrap.Offcanvas.getOrCreateInstance(clientCanvasEl) : null;
    const therapistOC = therapistCanvasEl ? bootstrap.Offcanvas.getOrCreateInstance(therapistCanvasEl) : null;
    const driverOC    = driverCanvasEl ? bootstrap.Offcanvas.getOrCreateInstance(driverCanvasEl) : null;

// ===== zapamiƒôtywanie
let _lastClientPackages = { clientId: null, fullName: "", rows: [] };
    // Helpers
    function showAlert(msg, type="success") {
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    // Bezpieczny parser ≈Ça≈Ñcucha "YYYY-MM-DD HH:MM:SS" lub "YYYY-MM-DDTHH:MM:SS" jako CZAS LOKALNY
function parseLocalTimestamp(str){
  if (!str) return null;
  // zaakceptuj zar√≥wno " " jak i "T"
  const s = str.trim().replace('T', ' ');
  // YYYY-MM-DD HH:MM:SS
  const m = /^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/.exec(s);
  if (!m) return null;
  const [_, Y, M, D, h, mnt, sec] = m;
  // Konstruktor Date(y, m-1, d, h, m, s) tworzy ZAWSZE lokalny czas (bez przesuniƒôƒá strefowych)
  return new Date(
    Number(Y),
    Number(M) - 1,
    Number(D),
    Number(h),
    Number(mnt),
    Number(sec)
  );
}

function fmtLocalDateTime(str){
  const d = parseLocalTimestamp(str);
  if (!d) return "‚Äî";
  return d.toLocaleString("pl-PL", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}

function fmtLocalTime(str){
  const d = parseLocalTimestamp(str);
  if (!d) return "";
  return d.toLocaleTimeString("pl-PL", { hour:"2-digit", minute:"2-digit" });
}

function minutesBetweenLocal(a, b){
  const A = parseLocalTimestamp(a), B = parseLocalTimestamp(b);
  if (!A || !B) return 0;
  return Math.max(0, Math.round((B - A) / 60000));
}

function dateKeyPLLocal(str){
  const d = parseLocalTimestamp(str);
  if (!d) return { key:"", label:"" };
  const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const label = d.toLocaleDateString("pl-PL", { weekday:"long", day:"2-digit", month:"2-digit", year:"numeric" });
  return { key, label };
}

    function pad2(n){ return String(n).padStart(2,'0'); }
    function isoLocal(dateStr, timeStr){ return `${dateStr}T${timeStr}:00`; }
    function setBtnBusy(btn, spinnerEl, busy){
      if(busy){ spinnerEl.classList.remove('d-none'); btn.setAttribute('disabled','disabled'); }
      else { spinnerEl.classList.add('d-none'); btn.removeAttribute('disabled'); }
    }

    // Cache nazw klient√≥w
    let clientsNameCache = new Map();

    //const clientFilter = document.getElementById("clientFilter");
    //const therapistFilter = document.getElementById("therapistFilter");

  // za≈Çaduj terapeut√≥w do filtra (tylko aktywni, ≈ºeby lista by≈Ça kr√≥tsza)
  async function fillTherapistFilter() {
    try {
      const res = await fetch(`${API}/api/therapists`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const active = data.filter(t => t.active !== false);
      therapistFilter.innerHTML = `<option value="">‚Äî wszyscy terapeuci ‚Äî</option>` +
        active.map(t => `<option value="${t.id}">${t.full_name}${t.specialization ? " ‚Äì " + t.specialization : ""}</option>`).join("");
    } catch (err) {
      showAlert(`Nie uda≈Ço siƒô pobraƒá listy terapeut√≥w do filtra: ${err.message}`, "danger");
    }
  }

   // Funkcja, kt√≥ra od≈õwie≈ºa wszystkie widoki po zmianie filtra
  async function refreshAllViews() {
    await loadClients(); // Najpierw za≈Çaduj klient√≥w

    const selectedTherapistId = therapistFilter.value;
    filterTherapistsTable(selectedTherapistId);
    await filterDriversTable(currentlyDisplayedClientIds);
  }

  // Zaktualizowane event listenery
  clientFilter.addEventListener("input", refreshAllViews);
  therapistFilter.addEventListener("change", refreshAllViews);
  monthInput.addEventListener("change", () => {
    refreshAllViews();
    checkMonthlyGaps();
  });


  // inicjalizacja listy terapeut√≥w do filtra
  fillTherapistFilter();

    async function loadClients() {
  setBtnBusy(reloadBtn, reloadSpinner, true);
  tbody.innerHTML = `
    <tr><td colspan="9" class="text-center py-4">
      <div class="d-inline-flex align-items-center gap-2 text-muted">
        <div class="spinner-border spinner-border-sm"></div>
        <span>≈Åadowanie‚Ä¶</span>
      </div>
    </td></tr>`;

  const mk = monthInput.value;
  const q  = (clientFilter.value || "").trim();
  const tid = therapistFilter.value || "";

  const params = new URLSearchParams();
  if (mk)  params.set("month", mk);
  if (q)   params.set("q", q);
  if (tid) params.set("therapist_id", tid);

  try {
    const res = await fetch(`${API}/api/clients?` + params.toString());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    lastClients = data;
    currentlyDisplayedClientIds = data.map(c => c.client_id);

    clientsNameCache.clear();
    data.forEach(r => clientsNameCache.set(r.client_id, r.full_name));

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">Brak klient√≥w</td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(row => {

        // v--- ZMIENIONE LINIE ---v
        const quota = formatMinutesAsHours(row.minutes_quota);
        const used  = formatMinutesAsHours(row.minutes_used);
        const left  = formatMinutesAsHours(row.minutes_left);
        // ^--- ZMIENIONE LINIE ---^
        const statusBadge = row.needs_allocation
          ? `<span class="badge text-bg-warning">Brak przydzia≈Çu</span>`
          : `<span class="badge text-bg-success">OK</span>`;
        return `
          <tr>
            <td>${row.full_name}</td>
            <td class="d-none d-md-table-cell">${row.phone ?? ""}</td>
            <td class="d-none d-lg-table-cell">${row.address ?? ""}</td>
            <td><code>${row.month_key}</code></td>
            <td>${quota}</td>
            <td>${used}</td>
            <td>${left}</td>
            <td>${statusBadge}</td>
            <td class="text-end">
               </td>


          <td class="text-end">
            <div class="actions d-grid d-sm-inline-flex gap-1">
               <button class="btn btn-sm btn-success" onclick="aiSuggestForClient(${row.client_id})">ü§ñ Zaproponuj</button>
              <button class="btn btn-sm btn-primary" onclick="choosePackageType(${row.client_id})">Dodaj pakiet</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="openAllocationCanvas(${row.client_id}, '${row.month_key}', ${row.minutes_quota ?? 'null'})">Ustaw przydzia≈Ç</button>
              <button class="btn btn-sm btn-outline-primary" onclick="openClientPackages(${row.client_id}, '${row.full_name.replace(/'/g, "\\'")}')">Pakiety</button>
              <!--<button class="btn btn-sm btn-outline-primary" onclick="openClientEdit(${row.client_id})">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteClient(${row.client_id})">üóë</button>-->
            </div>
          </td>
        </tr>`;
    }).join("");

  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="9" class="text-danger py-4">B≈ÇƒÖd ≈Çadowania: ${e.message}</td></tr>`;
  } finally {
    setBtnBusy(reloadBtn, reloadSpinner, false);
  }
}

    document.getElementById("reloadBtn").addEventListener("click", loadClients);



   async function suggestForClient(clientId, dateStr){
  try{
    const res = await fetch(`${API}/api/ai/recommend?client_id=${clientId}&date=${encodeURIComponent(dateStr||"")}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();

    // TERAPEUCI ‚Äì zaznacz TOP i dopisz ‚≠ê (nie zmieniaj warto≈õci, tylko label)
    const topT = (j.therapists||[])[0];
    if (topT){
      [...thSelect.options].forEach(o=>{
        if (Number(o.value)===Number(topT.therapist_id)) o.textContent = `‚≠ê ${o.textContent}`;
      });
      thSelect.value = String(topT.therapist_id);
    }

    // KIEROWCY ‚Äì pickup/dropoff
    const topD = (j.drivers||[])[0];
    if (topD){
      [...pkDriverSelect.options].forEach(o=>{
        if (Number(o.value)===Number(topD.driver_id)) o.textContent = `‚≠ê ${o.textContent}`;
      });
      [...dpDriverSelect.options].forEach(o=>{
        if (Number(o.value)===Number(topD.driver_id)) o.textContent = `‚≠ê ${o.textContent}`;
      });
      pkDriverSelect.value = String(topD.driver_id);
      dpDriverSelect.value = String(topD.driver_id);
    }

    // preferencje czasu ‚Äì podpowiedz godzinƒô
    const tp = (j.time_prefs||[])[0];
    if (tp){
      // np. ustaw godzinƒô terapii na preferowanƒÖ
      thStart.value = String(tp.hour).padStart(2,"0")+":00";
      const endH = (tp.hour+1);
      thEnd.value   = String(endH).padStart(2,"0")+":00";
    }
  }catch(err){
    console.warn("AI suggest error:", err);
  }
}

    // ==== Pakiet ‚Äì otwarcie
// ==== Pakiet ‚Äì otwarcie (Z ZABEZPIECZENIEM) ====
    function openPackageCanvas(clientId) {
      // 1. Znajd≈∫ dane klienta w pamiƒôci podrƒôcznej
      const client = lastClients.find(c => c.client_id === clientId);

      // 2. Sprawd≈∫, czy klient ma zdefiniowany plan lekcji
      if (client && !client.has_unavailability_plan) {
        const confirmation = confirm(
          `Przed dodaniem pakietu, musisz najpierw zdefiniowaƒá plan lekcji tego klienta (np. godziny szkolne), aby uniknƒÖƒá konflikt√≥w.\n\nCzy chcesz teraz przej≈õƒá do strony zarzƒÖdzania dostƒôpno≈õciƒÖ?`
        );

        if (confirmation) {
          // Przekieruj na stronƒô dostƒôpno≈õci z ID klienta
          window.location.href = `dostepnosc.html?client_id=${clientId}`;
        }

        // Zatrzymaj dalsze wykonywanie funkcji
        return;
      }

      // 3. Je≈õli wszystko jest w porzƒÖdku, kontynuuj normalne otwieranie panelu
      _editingGroupId = null;
      pkgClientId.value = clientId;
      pkgLabel.value = "";
      thPlace.value = "Poradnia";

      const d = new Date();
      d.setDate(d.getDate() + 1);
      const dStr = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
      thDate.value = dStr;
      thStart.value = "09:00";
      thEnd.value = "10:00";

      loadTherapistsAndDrivers().catch(err => {
        showAlert(`Nie uda≈Ço siƒô pobraƒá listy terapeut√≥w/kierowc√≥w: ${err.message}`, "danger");
      });

      thSelect.value = "";
      pkDriverSelect.value = "";
      dpDriverSelect.value = "";

      withPickup.checked = false; pickupFields.classList.add("d-none");
      pkFrom.value = "Dom"; pkTo.value = "Poradnia";
      pkStart.value = "08:30"; pkEnd.value = "09:00";

      withDropoff.checked = false; dropoffFields.classList.add("d-none");
      dpFrom.value = "Poradnia"; dpTo.value = "Dom";
      dpStart.value = "10:05"; dpEnd.value = "10:35";

      document.getElementById("pkgStatus").value = "planned";
      packageCanvas.show();
    }



    window.openPackageCanvas = openPackageCanvas;

    // Toggle sekcji
    document.getElementById("withPickup").addEventListener("change", () => {
      pickupFields.classList.toggle("d-none", !withPickup.checked);
    });
    document.getElementById("withDropoff").addEventListener("change", () => {
      dropoffFields.classList.toggle("d-none", !withDropoff.checked);
    });

    // Submit pakietu
 document.getElementById("packageForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const client_id = Number(pkgClientId.value);
  const therapist_id = Number(thSelect.value || 0);
  if (!client_id || !therapist_id){
    showAlert("Uzupe≈Çnij klienta i terapeutƒô.", "warning");
    return;
  }

  const payload = {
    client_id, // backend PUT go nie u≈ºywa do zmiany klienta ‚Äì tylko informacyjnie
    label: pkgLabel.value || null,
    therapy: {
      therapist_id,
      starts_at: isoLocal(thDate.value, thStart.value),
      ends_at:   isoLocal(thDate.value, thEnd.value),
      place: thPlace.value || null
    },
    status: document.getElementById("pkgStatus").value
  };

  if (withPickup.checked){
    const id = Number(pkDriverSelect.value || 0);
    if (!id) { showAlert("Wybierz kierowcƒô (pickup) lub wy≈ÇƒÖcz pickup.", "warning"); return; }
    payload.pickup = {
      driver_id: id,
      vehicle_id: pkVehicleId.value ? Number(pkVehicleId.value) : null,
      starts_at: isoLocal(thDate.value, pkStart.value),
      ends_at:   isoLocal(thDate.value, pkEnd.value),
      from: pkFrom.value || null,
      to:   pkTo.value || null
    };
  } else {
    payload.pickup = null;
  }

  if (withDropoff.checked){
    const id = Number(dpDriverSelect.value || 0);
    if (!id) { showAlert("Wybierz kierowcƒô (dropoff) lub wy≈ÇƒÖcz dropoff.", "warning"); return; }
    payload.dropoff = {
      driver_id: id,
      vehicle_id: dpVehicleId.value ? Number(dpVehicleId.value) : null,
      starts_at: isoLocal(thDate.value, dpStart.value),
      ends_at:   isoLocal(thDate.value, dpEnd.value),
      from: dpFrom.value || null,
      to:   dpTo.value || null
    };
  } else {
    payload.dropoff = null;
  }

  // pre-check kolizji
  try{
    const checkRes = await fetch(`${API}/api/schedule/check`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const check = await checkRes.json();
    if (check.total > 0) {
      const msg = [
        check.therapy?.length ? `Terapeuta: ${check.therapy.length}` : null,
        check.pickup?.length  ? `Pickup: ${check.pickup.length}`     : null,
        check.dropoff?.length ? `Dropoff: ${check.dropoff.length}`   : null,
      ].filter(Boolean).join(" ‚Ä¢ ");
      const detailedMessage = "Wykryto nastƒôpujƒÖce kolizje:\n\n" + allMessages.join("\n");
      if (!confirm(`Wykryto kolizje (${msg}). Kontynuowaƒá zapis?`)) return;
    }
  } catch {}

  // zapisz
  try{
    setBtnBusy(pkgSaveBtn, pkgSpinner, true);
    let url, method;
    if (_editingGroupId){
      url = `${API}/api/groups/${_editingGroupId}`;
      method = "PUT";
    } else {
      url = `${API}/api/schedule/group`;
      method = "POST";
    }
    const res = await fetch(url, {
      method,
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    await assertOk(res);
    await res.json();

    packageCanvas.hide();
    showAlert(_editingGroupId ? "Zaktualizowano pakiet." : "Dodano pakiet.", "success");
    _editingGroupId = null;

    // od≈õwie≈º: saldo i ewentualnie otwarty modal pakiet√≥w
    loadClients();
    refreshClientPackagesModal();
  }catch(err){
    showAlert(`B≈ÇƒÖd zapisu pakietu: ${err.message}`, "danger");
  }finally{
    setBtnBusy(pkgSaveBtn, pkgSpinner, false);
  }
});

function choosePackageType(clientId) {
  _clientIdForNewPackage = clientId; // Zapisujemy ID klienta
  packageTypeModal.show(); // Pokazujemy okno wyboru
}

async function openPackageEdit(groupId){
  const modalEl = document.getElementById('clientPackagesModal');
  const modal    = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);

  // 1) Zamknij modal i poczekaj a≈º faktycznie siƒô schowa (wa≈ºne dla focusu)
  const waitHidden = new Promise(resolve => {
    const onHidden = () => { modalEl.removeEventListener('hidden.bs.modal', onHidden); resolve(); };
    modalEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
  });
  modal.hide();
  await waitHidden;

  // 2) Za≈Çaduj listy i dane pakietu (to co ju≈º mia≈Çe≈õ)
  try{
    await loadTherapistsAndDrivers();
    document.getElementById("thDate").addEventListener("change", fetchAISuggestions);

    const res = await fetch(`${API}/api/groups/${groupId}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const g = await res.json();

    _editingGroupId = g.group_id;

    // wype≈Çnianie formularza (jak wcze≈õniej)
    pkgClientId.value = g.client_id;
    pkgLabel.value = g.label || "";
    document.getElementById("pkgStatus").value = g.status || "planned";

    thSelect.value = g.therapy?.therapist_id || "";
    const [dStr, sStr, eStr] = (()=>{
      const d = (g.therapy?.starts_at || "").split("T")[0];
      const s = (g.therapy?.starts_at || "").split("T")[1]?.slice(0,5);
      const e = (g.therapy?.ends_at   || "").split("T")[1]?.slice(0,5);
      return [d, s, e];
    })();
    thDate.value = dStr || "";
    thStart.value = sStr || "";
    thEnd.value   = eStr || "";
    thPlace.value = g.therapy?.place || "Poradnia";

    // pickup
    if (g.pickup){
      withPickup.checked = true; pickupFields.classList.remove("d-none");
      pkDriverSelect.value = g.pickup.driver_id || "";
      pkVehicleId.value = g.pickup.vehicle_id ?? "";
      pkFrom.value = g.pickup.from || "";
      pkTo.value = g.pickup.to || "";
      pkStart.value = (g.pickup.starts_at||"").split("T")[1]?.slice(0,5) || "";
      pkEnd.value   = (g.pickup.ends_at  ||"").split("T")[1]?.slice(0,5) || "";
    } else {
      withPickup.checked = false; pickupFields.classList.add("d-none");
      pkDriverSelect.value = ""; pkVehicleId.value = "";
      pkFrom.value = "Dom"; pkTo.value = "Poradnia"; pkStart.value = ""; pkEnd.value = "";
    }

    // dropoff
    if (g.dropoff){
      withDropoff.checked = true; dropoffFields.classList.remove("d-none");
      dpDriverSelect.value = g.dropoff.driver_id || "";
      dpVehicleId.value = g.dropoff.vehicle_id ?? "";
      dpFrom.value = g.dropoff.from || "";
      dpTo.value = g.dropoff.to || "";
      dpStart.value = (g.dropoff.starts_at||"").split("T")[1]?.slice(0,5) || "";
      dpEnd.value   = (g.dropoff.ends_at  ||"").split("T")[1]?.slice(0,5) || "";
    } else {
      withDropoff.checked = false; dropoffFields.classList.add("d-none");
      dpDriverSelect.value = ""; dpVehicleId.value = "";
      dpFrom.value = "Poradnia"; dpTo.value = "Dom"; dpStart.value = ""; dpEnd.value = "";
    }

    // 3) Poka≈º offcanvas i USTAW FOCUS (np. na wyb√≥r terapeuty)
    packageCanvas.show();
    setTimeout(() => { try { thSelect.focus(); } catch(_){} }, 150);

  }catch(err){
    showAlert(`Nie uda≈Ço siƒô otworzyƒá edycji pakietu: ${err.message}`, "danger");
  }
}
window.openPackageEdit = openPackageEdit;

async function confirmDeletePackage(groupId) {
  if (!confirm("Czy na pewno chcesz trwale usunƒÖƒá ca≈Çy pakiet (terapiƒô i powiƒÖzane kursy)? Tej operacji nie mo≈ºna cofnƒÖƒá.")) {
    return;
  }

  try {
    const res = await fetch(`${API}/api/groups/${groupId}`, {
      method: "DELETE"
    });

    await assertOk(res); // U≈ºywamy istniejƒÖcej funkcji do sprawdzenia odpowiedzi

    showAlert("Pakiet zosta≈Ç pomy≈õlnie usuniƒôty.", "success");

    // Po usuniƒôciu od≈õwie≈º widok pakiet√≥w w modalu oraz g≈Ç√≥wnƒÖ listƒô klient√≥w (aby zaktualizowaƒá saldo)
    refreshClientPackagesModal();
    loadClients();

  } catch (err) {
    showAlert(`B≈ÇƒÖd podczas usuwania pakietu: ${err.message}`, "danger");
  }
}
window.confirmDeletePackage = confirmDeletePackage;

    // ==== Allocation ‚Äì otwarcie
    function openAllocationCanvas(clientId, monthKey, currentQuota) {
      allocClientId.value = clientId;
      allocClientName.value = clientsNameCache.get(clientId) || `ID ${clientId}`;
      allocMonth.value = monthKey || monthInput.value;
      allocMinutes.value = (currentQuota ?? 1200) / 60;
      allocCanvas.show();
    }
    window.openAllocationCanvas = openAllocationCanvas;

    // Submit allocation
    document.getElementById("allocForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const cid = Number(allocClientId.value);
      const mk = allocMonth.value;
      const q = Number(allocMinutes.value) * 60;

      if (!cid || !mk || isNaN(q) || q < 0) {
        showAlert("Uzupe≈Çnij poprawnie pola przydzia≈Çu.", "warning");
        return;
      }

      try {
        setBtnBusy(allocSaveBtn, allocSpinner, true);
        const res = await fetch(`${API}/api/suo/allocation`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ client_id: cid, month_key: mk, minutes_quota: q })
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(`HTTP ${res.status}: ${t}`);
        }
        await res.json();
        allocCanvas.hide();
        showAlert(`Ustawiono przydzia≈Ç ${q} min dla klienta #${cid} w ${mk}.`);
        loadClients();
      } catch (err) {
        showAlert(`B≈ÇƒÖd zapisu przydzia≈Çu: ${err.message}`, "danger");
      } finally {
        setBtnBusy(allocSaveBtn, allocSpinner, false);
      }
    });

    // Ustaw domy≈õlny miesiƒÖc i start
    (function initMonth(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      monthInput.value = `${y}-${m}`;
    })();
     refreshAllViews();


// Przyciski w menu
const addClientBtn = document.getElementById("addClientBtn");
if (addClientBtn && clientOC) {
    addClientBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      resetClientForm();
      _clientEditId = null;
      clientOC.show();
    });
}

const addTherapistBtn = document.getElementById("addTherapistBtn");
if (addTherapistBtn && therapistOC) {
    addTherapistBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      resetTherapistForm();
      _therapistEditId = null;
      therapistOC.show();
    });


const addDriverBtn = document.getElementById("addDriverBtn");
if (addDriverBtn && driverOC) {
    addDriverBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      resetDriverForm();
      driverOC.show();
    });
// ====== Klient
const clName = document.getElementById("clName");
const clPhone = document.getElementById("clPhone");
const clAddress = document.getElementById("clAddress");
const clActive = document.getElementById("clActive");
const clSaveBtn = document.getElementById("clSaveBtn");
const clSpinner = document.getElementById("clSpinner");

function resetClientForm(){ clName.value=""; clPhone.value=""; clAddress.value=""; clActive.checked=true; }

//usunƒÖ≈Çem 20.08.2025


// ====== Terapeuta
const thName = document.getElementById("thName");
const thSpec = document.getElementById("thSpec");
const thPhone2 = document.getElementById("thPhone"); // ID ju≈º istnieje w formularzu pakietu, ale tu u≈ºywamy osobnego thPhone2? -> uniknij konfliktu
// Uwaga: Mamy ju≈º element o id="thPhone" w formularzu terapeuty ‚Äì w pakiecie u≈ºywamy thId, wiƒôc konfliktu nie ma.
const thActiveChk = document.getElementById("thActive");
const thSaveBtn2 = document.getElementById("thSaveBtn");
const thSpinner2 = document.getElementById("thSpinner");

function resetTherapistForm(){ thName.value=""; thSpec.value=""; thPhone2.value=""; thActiveChk.checked=true; }

const therapistForm = document.getElementById("therapistForm");
if (therapistForm) {
    therapistForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = document.getElementById("thName").value.trim();
  const spec = document.getElementById("thSpec").value.trim();
  const phone = document.getElementById("thPhone").value.trim();
  const active = document.getElementById("thActive").checked;

  if(!name){ showAlert("Podaj imiƒô i nazwisko terapeuty.", "warning"); return; }

  const url = _therapistEditId ? `${API}/api/therapists/${_therapistEditId}` : `${API}/api/therapists`;
  const method = _therapistEditId ? "PUT" : "POST";
  const payload = { full_name: name, specialization: spec || null, phone: phone || null, active };

  const therapistCanvasEl = document.getElementById('therapistCanvas');

  try {
    const res = await fetch(url, { method, headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    await assertOk(res);
    await res.json();

    // Bezpo≈õrednie odwo≈Çanie siƒô do instancji Bootstrap i jej schowanie:
    bootstrap.Offcanvas.getInstance(therapistCanvasEl).hide();

    showAlert(_therapistEditId ? "Zaktualizowano terapeutƒô." : "Dodano terapeutƒô.", "success");
    _therapistEditId = null;
    loadTherapists();
    checkDailyGaps();
  } catch(err) {
    // Zamknij panel r√≥wnie≈º po b≈Çƒôdzie
    bootstrap.Offcanvas.getInstance(therapistCanvasEl).hide();
    showAlert(`B≈ÇƒÖd zapisu terapeuty: ${err.message}`, "danger");
  }
});


// ====== Kierowca
const drName = document.getElementById("drName");
const drPhone = document.getElementById("drPhone");
const drActiveChk = document.getElementById("drActive");
const drSaveBtn = document.getElementById("drSaveBtn");
const drSpinner = document.getElementById("drSpinner");

function resetDriverForm(){ drName.value=""; drPhone.value=""; drActiveChk.checked=true; }

document.getElementById("driverForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = document.getElementById("drName").value.trim();
  const phone = document.getElementById("drPhone").value.trim();
  const active = document.getElementById("drActive").checked;

  if (!name){ showAlert("Podaj imiƒô i nazwisko kierowcy.", "warning"); return; }
  if (!_driverEditId && existsDriverByName(name)){ showAlert("Taki kierowca ju≈º istnieje.", "warning"); return; }

  const btn = document.getElementById("drSaveBtn");
  const spn = document.getElementById("drSpinner");
  spn.classList.remove('d-none'); btn.setAttribute('disabled','disabled');

  const driverCanvasEl = document.getElementById('driverCanvas');

  try {
    const url = _driverEditId ? `${API}/api/drivers/${_driverEditId}` : `${API}/api/drivers`;
    const method = _driverEditId ? "PUT" : "POST";
    const payload = { full_name: name, phone: phone || null, active };

    const res = await fetch(url, { method, headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    await assertOk(res);
    await res.json();

    // Bezpo≈õrednie odwo≈Çanie siƒô do instancji Bootstrap i jej schowanie:
    bootstrap.Offcanvas.getInstance(driverCanvasEl).hide();

    showAlert(_driverEditId ? "Zaktualizowano kierowcƒô." : "Dodano kierowcƒô.", "success");
    _driverEditId = null;
    loadDrivers();
    checkDailyGaps();
  } catch (err) {
    // Zamknij panel r√≥wnie≈º po b≈Çƒôdzie
    bootstrap.Offcanvas.getInstance(driverCanvasEl).hide();
    showAlert(`B≈ÇƒÖd zapisu kierowcy: ${err.message}`, "danger");
  } finally {
    spn.classList.add('d-none'); btn.removeAttribute('disabled');
  }
});

    function showError(msg) {
  const box = document.getElementById("errorBox");
  box.textContent = msg;
  box.classList.remove("d-none");
  setTimeout(() => box.classList.add("d-none"), 5000); // znika po 5s
}

    async function submitForm(url, payload) {
  try {
    const res = await fetch(`${API}${url}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const errText = await res.text();
      throw new Error(errText || `B≈ÇƒÖd API (${res.status})`);
    }
    return await res.json();
  } catch (err) {
    showError(`Operacja nieudana: ${err.message}`);
    throw err;
  }
}
    // ===== Przyciski otwierajƒÖce offcanvasy dodawania
document.getElementById("btnOpenTherapistAdd").addEventListener("click", (e)=>{
  e.preventDefault();
  // czy≈õƒá formularz
  document.getElementById("thName").value = "";
  document.getElementById("thSpec").value = "";
  document.getElementById("thPhone").value = "";
  document.getElementById("thActive").checked = true;
  (new bootstrap.Offcanvas('#therapistCanvas')).show();
});
document.getElementById("btnOpenDriverAdd").addEventListener("click", (e)=>{
  e.preventDefault();
  document.getElementById("drName").value = "";
  document.getElementById("drPhone").value = "";
  document.getElementById("drActive").checked = true;
  (new bootstrap.Offcanvas('#driverCanvas')).show();
});

// ===== ≈Åadowanie i render listy terapeut√≥w
async function loadTherapists(){
  const tbody = document.getElementById("therapistsTbody");
  tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">≈Åadowanie‚Ä¶</td></tr>`;
  try{
    const res = await fetch(`${API}/api/therapists`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">Brak terapeut√≥w</td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(t => {
      const badge = t.active ? `<span class="badge text-bg-success">aktywny</span>`
                             : `<span class="badge text-bg-secondary">nieaktywny</span>`;
      return `
        <tr>
          <td>${t.id}</td>
          <td>${t.full_name}</td>
          <td class="d-none d-md-table-cell">${t.specialization ?? ""}</td>
          <td class="d-none d-lg-table-cell">${t.phone ?? ""}</td>
          <td>${badge}</td>
          <td class="text-end">
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-primary" onclick="openTherapistEdit(${t.id})">Edytuj</button>
              <button class="btn btn-sm btn-outline-warning" onclick="openAbsenceModal('therapist', ${t.id})">Dodaj L4/U</button>
              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteTherapist(${t.id})">Usu≈Ñ</button>
              <button class="btn btn-sm btn-outline-primary" onclick="openTherapistSchedule(${t.id}, '${(t.full_name || '').replace(/'/g, "\\'")}')">Grafik</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="openTherapistReport(${t.id}, '${(t.full_name || '').replace(/'/g, "\\'")}')">Zestawienie</button>
            </div>
          </td>
        </tr>`;
    }).join("");
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="6" class="text-danger py-3">B≈ÇƒÖd ≈Çadowania: ${err.message}</td></tr>`;
  }
}
window.loadTherapists = loadTherapists;

// ===== ≈Åadowanie i render listy kierowc√≥w
async function loadDrivers(){
  const tbody = document.getElementById("driversTbody");
  tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">≈Åadowanie‚Ä¶</td></tr>`;
  try{
    const res = await fetch(`${API}/api/drivers`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Brak kierowc√≥w</td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(d => {
    const badge = d.active ? `<span class="badge text-bg-success">aktywny</span>`
                           : `<span class="badge text-bg-secondary">nieaktywny</span>`;
    return `
      <tr>
        <td>${d.id}</td>
        <td>${d.full_name}</td>
        <td class="d-none d-lg-table-cell">${d.phone ?? ""}</td>
        <td>${badge}</td>
        <td class="text-end">
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick="openDriverEdit(${d.id})">Edytuj</button>
            <button class="btn btn-sm btn-outline-warning" onclick="openAbsenceModal('driver', ${d.id})">Dodaj L4/U</button>
            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDriver(${d.id})">Usu≈Ñ</button>
            <button class="btn btn-sm btn-outline-primary" onclick="openDriverSchedule(${d.id}, '${(d.full_name || '').replace(/'/g, "\\'")}')">Kursy</button>
          </div>
        </td>
      </tr>`;
  }).join("");
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="5" class="text-danger py-3">B≈ÇƒÖd ≈Çadowania: ${err.message}</td></tr>`;
  }
}
window.loadDrivers = loadDrivers;

// ===== Usuwanie (miƒôkkie: active=false). Dla twardego: dodaj ?hard=1
async function confirmDeleteTherapist(id){
  if(!confirm("UsunƒÖƒá terapeutƒô? (domy≈õlnie: oznacz jako nieaktywny)")) return;
  try{
    const res = await fetch(`${API}/api/therapists/${id}`, { method: "DELETE" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    loadTherapists();
    showAlert("Usuniƒôto terapeutƒô (lub oznaczono jako nieaktywnego).", "success");
  }catch(err){
    showAlert(`B≈ÇƒÖd usuwania terapeuty: ${err.message}`, "danger");
  }
}
window.confirmDeleteTherapist = confirmDeleteTherapist;

async function confirmDeleteDriver(id){
  if(!confirm("UsunƒÖƒá kierowcƒô? (domy≈õlnie: oznacz jako nieaktywnego)")) return;
  try{
    const res = await fetch(`${API}/api/drivers/${id}`, { method: "DELETE" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    loadDrivers();
    showAlert("Usuniƒôto kierowcƒô (lub oznaczono jako nieaktywnego).", "success");
  }catch(err){
    showAlert(`B≈ÇƒÖd usuwania kierowcy: ${err.message}`, "danger");
  }
}
window.confirmDeleteDriver = confirmDeleteDriver;

// ===== Po sukcesie dodawania ‚Äì od≈õwie≈º listy


async function assertOk(res) {
  if (res.ok) return;
  let msg = `HTTP ${res.status}`;
  try {
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) {
      const j = await res.json();
      if (j && j.error) msg = j.error;
    } else {
      msg = (await res.text()) || msg;
    }
  } catch {}
  const err = new Error(msg);
  err.status = res.status;
  throw err;
}

// ===== Start: za≈Çaduj od razu obie listy (opr√≥cz salda klient√≥w, kt√≥re ju≈º ≈Çadujesz)
loadTherapists();
loadDrivers();

    function existsClientByName(name){
  const needle = (name || "").trim().toLowerCase();
  if (!needle) return false;
  const rows = document.querySelectorAll("#clientsTbody tr");
  for (const tr of rows) {
    const td = tr.querySelector("td"); // 1. kolumna = Klient
    if (!td) continue;
    const val = td.textContent.trim().toLowerCase();
    if (val === needle) return true;
  }
  return false;
}

function existsTherapistByName(name){
  const needle = (name || "").trim().toLowerCase();
  if (!needle) return false;
  const rows = document.querySelectorAll("#therapistsTbody tr");
  for (const tr of rows) {
    const td = tr.children[1]; // 2. kolumna = Nazwa
    if (!td) continue;
    const val = td.textContent.trim().toLowerCase();
    if (val === needle) return true;
  }
  return false;
}

function existsDriverByName(name){
  const needle = (name || "").trim().toLowerCase();
  if (!needle) return false;
  const rows = document.querySelectorAll("#driversTbody tr");
  for (const tr of rows) {
    const td = tr.children[1]; // 2. kolumna = Nazwa
    if (!td) continue;
    const val = td.textContent.trim().toLowerCase();
    if (val === needle) return true;
  }
  return false;
}


// cache list
let _editingGroupId = null;
let therapistsList = [];
let driversList = [];

// helper do wype≈Çniania selecta
function fillSelect(selectEl, items, valueKey, labelFn) {
  const current = selectEl.value;
  selectEl.innerHTML = `<option value="">‚Äî wybierz ‚Äî</option>` +
    items.map(it => `<option value="${it[valueKey]}">${labelFn(it)}</option>`).join("");
  // spr√≥buj przywr√≥ciƒá, je≈õli istnieje
  if (current && [...selectEl.options].some(o => o.value === current)) {
    selectEl.value = current;
  }
}

// wczytaj listy (z prostym cache, od≈õwie≈ºane na ka≈ºde otwarcie panelu)
async function loadTherapistsAndDrivers() {
  const [tRes, dRes] = await Promise.all([
    fetch(`${API}/api/therapists`),
    fetch(`${API}/api/drivers`)
  ]);
  if (!tRes.ok) throw new Error(`Therapists HTTP ${tRes.status}`);
  if (!dRes.ok) throw new Error(`Drivers HTTP ${dRes.status}`);
  therapistsList = await tRes.json();
  driversList = await dRes.json();

  // tylko aktywni na listach wyboru (≈ºeby nie wybieraƒá nieaktywnych)
  const therapistsActive = therapistsList.filter(t => t.active !== false);
  const driversActive = driversList.filter(d => d.active !== false);

  fillSelect(thSelect, therapistsActive, "id", t => t.full_name + (t.specialization ? ` ‚Äì ${t.specialization}` : ""));
  fillSelect(pkDriverSelect, driversActive, "id", d => d.full_name + (d.phone ? ` ‚Äì ${d.phone}` : ""));
  fillSelect(dpDriverSelect, driversActive, "id", d => d.full_name + (d.phone ? ` ‚Äì ${d.phone}` : ""));
}

    // Format czasu kr√≥tko
function fmt(dtStr){
  if(!dtStr) return "‚Äî";
  const d = new Date(dtStr);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${day} ${hh}:${mm}`;
}

// === Klient ‚Üí Pakiety
const clientPackagesCanvas = new bootstrap.Offcanvas('#clientPackagesCanvas');

function groupByDate(items) {
  const groups = {};
  items.forEach(p => {
    const date = new Date(p.starts_at).toLocaleDateString("pl-PL"); // np. 19.08.2025
    if (!groups[date]) groups[date] = [];
    groups[date].push(p);
  });
  return groups;
}







// === Terapeuta ‚Üí Grafik
const therapistScheduleCanvas = new bootstrap.Offcanvas('#therapistScheduleCanvas');
async function openTherapistSchedule(tid, name){
  document.getElementById("tsTherapistName").textContent = name || `ID ${tid}`;
  const tbody = document.getElementById("therapistScheduleTbody");
  tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">≈Åadowanie‚Ä¶</td></tr>`;
  therapistScheduleCanvas.show();
  const mk = monthInput.value || "";
  try{
    const res = await fetch(`${API}/api/therapists/${tid}/schedule?month=${encodeURIComponent(mk)}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">Brak zdarze≈Ñ</td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(r => `
      <tr>
        <td><span class="badge text-bg-${r.kind==='therapy'?'primary':(r.kind==='pickup'?'info':'secondary')}">${r.kind}</span></td>
        <td>${r.client_name} <small class="text-muted">(#${r.client_id})</small></td>
        <td>${ fmtLocalDateTime(r.starts_at)}</td>
        <td>${fmtLocalDateTime(r.ends_at)}</td>
        <td>${r.place_from ?? "‚Äî"}</td>
        <td>${r.place_to ?? "‚Äî"}</td>
        <td>${r.status}</td>
      </tr>`).join("");
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="7" class="text-danger py-3">B≈ÇƒÖd: ${err.message}</td></tr>`;
  }
}
window.openTherapistSchedule = openTherapistSchedule;


let _lastDriverSchedule = { driverId: null, fullName: "", rows: [] };

async function openDriverSchedule(did, fullName){

  console.log("openDriverSchedule called with:", did, fullName);
  // sprawd≈∫, czy modal istnieje
  const modalEl = document.getElementById("driverScheduleModal");
  const titleEl = document.getElementById("driverScheduleTitle");
  const bodyEl  = document.getElementById("driverScheduleBody");
  if (!modalEl || !titleEl || !bodyEl) {
    showAlert("Brak szablonu modala kierowcy w HTML.", "danger");
    return;
  }

  titleEl.textContent = `Kursy: ${fullName || `ID ${did}`}`;
  bodyEl.innerHTML = `<div class="text-muted py-3">≈Åadowanie‚Ä¶</div>`;

  const mk = monthInput.value || "";
  try{
    const res = await fetch(`${API}/api/drivers/${did}/schedule?month=${encodeURIComponent(mk)}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    _lastDriverSchedule = { driverId: did, fullName: fullName || `ID ${did}`, rows: data };

    bodyEl.innerHTML = renderDriverScheduleHTML(_lastDriverSchedule.fullName, data);

    new bootstrap.Modal(modalEl).show();
  }catch(err){
    bodyEl.innerHTML = `<div class="text-danger py-3">B≈ÇƒÖd: ${err.message}</div>`;
  }
}
window.openDriverSchedule = openDriverSchedule;

document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "printDriverBtn") {
    e.preventDefault();
    printDriverSchedule();
  }
});

// Druk przez ukryty iframe (bez blokady popup)
function printDriverSchedule() {
  const { fullName, rows } = _lastDriverSchedule || {};
  if (!rows || !rows.length) { showAlert("Brak danych do wydruku kurs√≥w.", "warning"); return; }

  const content = renderDriverScheduleHTML(fullName, rows);
  const monthInfo = monthInput.value ? `<div><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>` : "";
  const html = `<!doctype html><html lang="pl"><head>
    <meta charset="utf-8"><title>Kursy kierowcy ‚Äì ${String(fullName).replace(/</g,'&lt;')}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>@media print{.badge{-webkit-print-color-adjust:exact;print-color-adjust:exact}body{font-size:12px}h6{margin-top:.5rem}table{page-break-inside:avoid}}body{padding:1rem}</style>
  </head><body>
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div><h4 class="mb-1">Kursy kierowcy</h4>
           <div><strong>Kierowca:</strong> ${String(fullName).replace(/</g,'&lt;')}</div>
           ${monthInfo}</div>
      <div class="text-end"><small class="text-muted">Wygenerowano: ${new Date().toLocaleString("pl-PL")}</small></div>
    </div>${content}</body></html>`;

  const iframe = document.createElement("iframe");
  Object.assign(iframe.style, {position:"fixed",right:"0",bottom:"0",width:"0",height:"0",border:"0"});
  iframe.setAttribute("aria-hidden", "true");
  document.body.appendChild(iframe);

  const ifrw = iframe.contentWindow;
  const ifrd = iframe.contentDocument || ifrw.document;
  ifrd.open(); ifrd.write(html); ifrd.close();

  let printed = false;
  const cleanup = () => setTimeout(() => iframe.remove(), 100);

  iframe.onload = () => {
    if (printed) return;
    printed = true;
    try { ifrw.focus(); setTimeout(() => { try { ifrw.print(); } catch(e){} }, 0); } catch(e){}
  };
  if (ifrw) ifrw.onafterprint = cleanup;
  setTimeout(cleanup, 5000);
}


// ≈Çadny format minut -> "X h Y min"
function minutesToHM(mins) {
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h && m) return `${h} h ${m} min`;
  if (h) return `${h} h`;
  return `${m} min`;
}
// Render HTML kurs√≥w kierowcy z grupowaniem po dacie + sumami
function renderDriverScheduleHTML(fullName, data) {

  const groups = new Map();
  let sumMonth = 0;

  for (const row of data) { // TU JEST 'row'
    const iso = row.starts_at || row.ends_at;
    if (!iso) continue;
    const { key, label } = dateKeyPLLocal(iso);

    if (!key) continue;
    if (!groups.has(key)) groups.set(key, { label, items: [], sumDay: 0 });

    const g = groups.get(key);
    const mins = minutesBetweenLocal(row.starts_at, row.ends_at); // TU TE≈ª 'row'

    g.sumDay += mins;
    sumMonth += mins;
    g.items.push(row);
  }

  const ordered = [...groups.entries()].sort(([a],[b]) => a.localeCompare(b));

  let html = `
    <div class="mb-2"><strong>Kierowca:</strong> ${fullName}</div>
    ${monthInput && monthInput.value ? `<div class="mb-2"><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>` : ""}
    <div class="mb-3">
      <span class="badge text-bg-dark">Razem w miesiƒÖcu: ${minutesToHM(sumMonth)}</span>
    </div>`;

  if (!ordered.length) {
    html += `<div class="text-muted">Brak kurs√≥w w wybranym zakresie.</div>`;
    return html;
  }

  for (const [, group] of ordered) {
    const header = `
      <div class="d-flex flex-wrap align-items-center justify-content-between mt-3 mb-2">
        <h6 class="m-0">${group.label}</h6>
        <span class="badge text-bg-primary">Suma dnia: ${minutesToHM(group.sumDay)}</span>
      </div>`;

    const rows = group.items
    .sort((a,b) => (a.starts_at||"").localeCompare(b.starts_at||""))
    .map(row => {
        const mins = minutesBetweenLocal(row.starts_at, row.ends_at);
        const route = [row.place_from, row.place_to].filter(Boolean).join(" ‚Üí ");
        return `
          <tr>
            <td><span class="badge text-bg-${row.kind === 'pickup' ? 'info' : 'secondary'}">${row.kind}</span></td>
            <td>${fmtLocalTime(row.starts_at)}‚Äì${fmtLocalTime(row.ends_at)}</td>
            <td>${minutesToHM(mins)}</td>
            <td>${row.client_name || `klient #${row.client_id ?? ""}`}</td>
            <td>${route || "‚Äî"}</td>
            <td>${row.vehicle_id ?? "‚Äî"}</td>

            <td>${route}</td>
            <td>${row.distance_km ? `${row.distance_km} km` : '‚Äî'}</td>
            <td><code>${row.status || ""}</code></td>
    <td>
          </tr>`;
      }).join("");

    html += `
      ${header}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Rodzaj</th><th>Godzina</th><th>Czas</th><th>Klient</th><th>Trasa</th><th>Pojazd</th><th>Status</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }

  return html;
}

// Druk przez ukryty iframe (jak u klienta)
function printDriverSchedule() {
  const { fullName, rows } = _lastDriverSchedule || {};
  if (!rows || !rows.length) {
    showAlert("Brak danych do wydruku kurs√≥w.", "warning");
    return;
  }
  const content = renderDriverScheduleHTML(fullName, rows);
  const monthInfo = (monthInput && monthInput.value)
    ? `<div><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>` : "";

  const html = `<!doctype html>
  <html lang="pl">
  <head>
    <meta charset="utf-8">
    <title>Kursy kierowcy ‚Äì ${String(fullName).replace(/</g,'&lt;')}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      @media print {
        .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { font-size: 12px; }
        h6 { margin-top: 0.5rem; }
        table { page-break-inside: avoid; }
      }
      body { padding: 1rem; }
    </style>
  </head>
  <body>
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="mb-1">Kursy kierowcy</h4>
        <div><strong>Kierowca:</strong> ${String(fullName).replace(/</g,'&lt;')}</div>
        ${monthInfo}
      </div>
      <div class="text-end">
        <small class="text-muted">Wygenerowano: ${new Date().toLocaleString("pl-PL")}</small>
      </div>
    </div>
    ${content}
  </body>
  </html>`;

  const iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.right = "0";
  iframe.style.bottom = "0";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  iframe.setAttribute("aria-hidden", "true");
  document.body.appendChild(iframe);

  const ifrw = iframe.contentWindow;
  const ifrd = iframe.contentDocument || ifrw.document;
  ifrd.open(); ifrd.write(html); ifrd.close();

  let printed = false;
  const cleanup = () => setTimeout(() => iframe.remove(), 100);

  iframe.onload = () => {
    if (printed) return;
    printed = true;
    try { ifrw.focus(); setTimeout(() => { try { ifrw.print(); } catch(e){} }, 0); } catch(e){}
  };
  if (ifrw) ifrw.onafterprint = cleanup;
  setTimeout(cleanup, 5000); // fallback
};

// ===== Render HTML (u≈ºywany w modalu i w wydruku)
// ===== Render HTML (u≈ºywany w modalu i w wydruku)
function renderClientPackagesHTML(fullName, data) {
  console.log("Dane otrzymane do renderowania pakiet√≥w:", data);

  const groups = new Map();
  for (const row of data) {
    const iso = row.starts_at || row.ends_at;
    if (!iso) {
      console.warn("Pominiƒôto wiersz - brak daty:", row);
      continue;
    }
    const { key, label } = dateKeyPLLocal(iso);
    if (!key) {
      console.warn("B≈ÇƒÖd klucza daty dla:", iso, row);
      continue;
    }
    if (!groups.has(key)) {
      groups.set(key, { label, items: [], sumTherapy: 0, sumAll: 0 });
    }
    const g = groups.get(key);
    const mins = minutesBetweenLocal(row.starts_at, row.ends_at);
    g.sumAll += mins;
    if (row.kind === "therapy") {
      g.sumTherapy += mins;
    }
    g.items.push(row);
  }
  const ordered = [...groups.entries()].sort(([a],[b]) => a.localeCompare(b));

  let html = `
    <div class="mb-2"><strong>Klient:</strong> ${fullName}</div>
    ${monthInput && monthInput.value ? `<div class="mb-3"><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>` : ""}`;

  if (!ordered.length) {
    html += `<div class="text-muted p-3">Brak pakiet√≥w w wybranym zakresie.</div>`;
    return html;
  }

  for (const [, group] of ordered) {
    const header = `
      <div class="d-flex flex-wrap align-items-center justify-content-between mt-3 mb-2">
        <h6 class="m-0">${group.label || 'Pakiet indywidualny'}</h6>
        <div class="d-flex gap-2">
          <span class="badge text-bg-primary">Terapia: ${group.sumTherapy} min</span>
          <span class="badge text-bg-secondary">Wszystkie: ${group.sumAll} min</span>
        </div>
      </div>`;

    const rows = group.items
    .sort((a,b) => (a.starts_at||"").localeCompare(b.starts_at||""))
    .map(row => {
        const who = row.kind === "therapy"
          ? (row.therapist_name || `terapeuta #${row.therapist_id || ""}`)
          : (row.driver_name    || `kierowca #${row.driver_id || ""}`);
        const route = row.kind === "therapy"
          ? (row.place_to || "")
          : [row.place_from, row.place_to].filter(Boolean).join(" ‚Üí ");
        const mins = minutesBetweenLocal(row.starts_at, row.ends_at);

        // --- POCZƒÑTEK POPRAWKI ---
        // Generujemy przyciski warunkowo, w zale≈ºno≈õci od typu pakietu
        let actionButtons = '';
        if (row.type === 'individual') {
            actionButtons = `
              <button class="btn btn-sm btn-outline-success" title="Oznacz jako wykonane" onclick="changeSlotStatus(${row.slot_id}, 'done')">‚úî</button>
              <button class="btn btn-sm btn-outline-danger" title="Oznacz jako anulowane" onclick="changeSlotStatus(${row.slot_id}, 'cancelled')">‚úñ</button>
              <button class="btn btn-outline-primary btn-sm" onclick="openPackageEdit('${row.group_id}')">Edytuj</button>
              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeletePackage('${row.group_id}')">Usu≈Ñ</button>
            `;
        } else { // Dla `type === 'tus'`
            actionButtons = `<small class="text-muted">ZarzƒÖdzaj w module TUS</small>`;
        }

        const typeBadge = row.type === 'tus'
            ? `<span class="badge text-bg-info">TUS</span>`
            : `<span class="badge text-bg-light text-dark border">${row.kind}</span>`;
        // --- KONIEC POPRAWKI ---

        return `
          <tr>
            <td>${typeBadge}</td>
            <td>${fmtLocalTime(row.starts_at)}‚Äì${fmtLocalTime(row.ends_at)}</td>
            <td>${mins || ""}</td>
            <td>${who}</td>
            <td>${route}</td>
            <td>${row.distance_km ? `${row.distance_km} km` : '‚Äî'}</td>
            <td><code>${row.status || ""}</code></td>
            <td class="text-end">${actionButtons}</td>
          </tr>`;
      }).join("");

    html += `
      ${header}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
              <tr>
                <th>Typ</th><th>Godzina</th><th>Min</th><th>Osoba</th><th>Trasa/Miejsce</th><th>Dystans</th><th>Status</th><th class="text-end">Akcje</th>
              </tr>
           </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }
  return html;
}





// ===== Otwieranie modala (PROSTSZY fetch)
async function openClientPackages(clientId, fullName) {
  try {
    const mk = monthInput.value;
    const qs = mk ? `?month=${encodeURIComponent(mk)}` : "";
    const res = await fetch(`${API}/api/client/${clientId}/packages${qs}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    _lastClientPackages = { clientId, fullName, rows: data };

    document.getElementById("clientPackagesTitle").textContent = `Pakiety: ${fullName}`;
    document.getElementById("clientPackagesBody").innerHTML = renderClientPackagesHTML(fullName, data);

    // pod≈ÇƒÖcz drukowanie TYLKO je≈õli przycisk jest w DOM
    const btn = document.getElementById("printPackagesBtn");
    if (btn) btn.onclick = () => printClientPackages();

    new bootstrap.Modal(document.getElementById("clientPackagesModal")).show();
  } catch (err) {
    showAlert(`B≈ÇƒÖd pobierania pakiet√≥w: ${err.message}`, "danger");
  }
}
window.openClientPackages = openClientPackages;


// ===== Druk pakiet√≥w przez iframe (bez blokady pop-up i bez duplikacji)
function printClientPackages() {
  const { fullName, rows } = _lastClientPackages || {};
  if (!rows || !rows.length) {
    showAlert("Brak danych do wydruku.", "warning");
    return;
  }

  // Zbuduj tre≈õƒá do druku (bez auto-print w ≈õrodku!)
  const content = renderClientPackagesHTML(fullName, rows);
  const monthInfo = (monthInput && monthInput.value)
    ? `<div><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>`
    : "";

  const html = `<!doctype html>
  <html lang="pl">
  <head>
    <meta charset="utf-8">
    <title>Pakiety ‚Äì ${String(fullName).replace(/</g,'&lt;')}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      @media print {
        .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { font-size: 12px; }
        h6 { margin-top: 0.5rem; }
        table { page-break-inside: avoid; }
      }
      body { padding: 1rem; }
    </style>
  </head>
  <body>
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="mb-1">Pakiety klienta</h4>
        <div><strong>Klient:</strong> ${String(fullName).replace(/</g,'&lt;')}</div>
        ${monthInfo}
      </div>
      <div class="text-end">
        <small class="text-muted">Wygenerowano: ${new Date().toLocaleString("pl-PL")}</small>
      </div>
    </div>
    ${content}
  </body>
  </html>`;

  // Stw√≥rz ukryty iframe (jednorazowy)
  const iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.right = "0";
  iframe.style.bottom = "0";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  iframe.setAttribute("aria-hidden", "true");
  document.body.appendChild(iframe);

  // Wpisz dokument do iframe
  const ifrw = iframe.contentWindow;
  const ifrd = iframe.contentDocument || ifrw.document;
  ifrd.open();
  ifrd.write(html);
  ifrd.close();

  // Flaga, by mieƒá pewno≈õƒá, ≈ºe druk wywo≈Çamy tylko RAZ
  let printed = false;

  // SprzƒÖtanie po wydruku
  const cleanup = () => {
    if (iframe.parentNode) {
      // ma≈Çe op√≥≈∫nienie, bo niekt√≥re przeglƒÖdarki ko≈ÑczƒÖ "onafterprint" asynchronicznie
      setTimeout(() => iframe.remove(), 100);
    }
  };

  // Pr√≥ba wydruku, gdy iframe siƒô za≈Çaduje
  iframe.onload = () => {
    // Je≈ºeli ju≈º drukowali≈õmy ‚Äì wyjd≈∫
    if (printed) return;
    printed = true;

    // Skup okno iframe i drukuj
    try {
      ifrw.focus();
      // Czasem trzeba daƒá 1 tick, aby style siƒô zbudowa≈Çy
      setTimeout(() => {
        try { ifrw.print(); } catch (e) {}
      }, 0);
    } catch (e) {
      // Awaryjnie poka≈º info, je≈õli co≈õ p√≥jdzie nie tak
      console.error("Print iframe error:", e);
    }
  };

  // PosprzƒÖtaj po zako≈Ñczeniu drukowania (wspierane w wiƒôkszo≈õci przeglƒÖdarek)
  if (ifrw) {
    ifrw.onafterprint = cleanup;
  }
  // Fallback ‚Äì gdyby onafterprint nie zadzia≈Ça≈Ç
  setTimeout(cleanup, 5000);
}



/** Od≈õwie≈ºa dane w oknie ‚ÄûPakiety klienta‚Äù i przerysowuje zawarto≈õƒá. */
async function refreshClientPackagesModal() {
  const { clientId, fullName } = _lastClientPackages || {};
  if (!clientId) return; // nic nie r√≥b, je≈õli nie mamy kontekstu

  const mk = monthInput.value;
  const qs = mk ? `?month=${encodeURIComponent(mk)}` : "";
  try {
    const res = await fetch(`${API}/api/client/${clientId}/packages${qs}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    _lastClientPackages.rows = data; // podmie≈Ñ cache
    document.getElementById("clientPackagesBody").innerHTML =
      renderClientPackagesHTML(fullName, data);
    // po przerysowaniu ‚Äì znowu pod≈ÇƒÖcz przyciski status√≥w (sƒÖ inline), nic wiƒôcej nie trzeba
  } catch (err) {
    showAlert(`B≈ÇƒÖd od≈õwie≈ºania pakiet√≥w: ${err.message}`, "danger");
  }
}

/** Zmienia status slotu, a po sukcesie od≈õwie≈ºa widok pakiet√≥w. */
async function changeSlotStatus(slotId, status) {
  try {
    const res = await fetch(`${API}/api/slots/${slotId}/status`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status })
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t}`);
    }
    await res.json();
    // po zmianie ‚Äì od≈õwie≈º modal
    await refreshClientPackagesModal();
    showAlert("Status zaktualizowany.", "success");
  } catch (err) {
    showAlert(`Nie uda≈Ço siƒô zmieniƒá statusu: ${err.message}`, "danger");
  }
}

    // --- Edycja klienta ---
// Otw√≥rz formularz w trybie edycji
function openClientEdit(cid){
  const cl = lastClients.find(c => c.client_id === cid);
  if (!cl) { showAlert("Nie znaleziono klienta w bie≈ºƒÖcej li≈õcie.", "warning"); return; }

  _clientEditId = cid;
  document.getElementById("clId").value = cid;
  document.getElementById("clName").value = cl.full_name || "";
  document.getElementById("clPhone").value = cl.phone || "";
  document.getElementById("clAddress").value = cl.address || "";
  // je≈õli masz w listingu 'active' ‚Äì przypisz; je≈õli nie, domy≈õl na true
  document.getElementById("clActive").checked = !(cl.active === false);

  (new bootstrap.Offcanvas('#clientCanvas')).show();
}

// Zmodyfikuj submit formularza klienta:
// Jeden JEDYNY handler dla formularza klienta
let _clientSubmitting = false;

document.getElementById("clientForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (_clientSubmitting) return;          // anty-dubel
  _clientSubmitting = true;

  const cid    = _clientEditId;           // null => dodawanie, liczba => edycja
  const name   = document.getElementById("clName").value.trim();
  const phone  = document.getElementById("clPhone").value.trim();
  const address= document.getElementById("clAddress").value.trim();
  const active = document.getElementById("clActive").checked;

  if (!name){
    showAlert("Podaj imiƒô i nazwisko klienta.", "warning");
    _clientSubmitting = false; return;
  }

  // pre-check tylko przy dodawaniu
  if (cid == null && existsClientByName(name)){
    showAlert("Taki klient ju≈º widnieje na li≈õcie (imiƒô i nazwisko).", "warning");
    _clientSubmitting = false; return;
  }

  const btn = document.getElementById("clSaveBtn");
  const spn = document.getElementById("clSpinner");
  spn.classList.remove('d-none'); btn.setAttribute('disabled','disabled');

  try{
    const url    = cid == null ? `${API}/api/clients` : `${API}/api/clients/${cid}`;
    const method = cid == null ? "POST" : "PUT";
    const payload= { full_name: name, phone: phone || null, address: address || null, active };

    const res = await fetch(url, {
      method,
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    await assertOk(res);
    await res.json();

    // zamknij JEDYNƒÑ instancjƒÖ
    clientOC.hide();

    showAlert(cid == null ? "Dodano klienta." : "Zmieniono dane klienta.", "success");
    _clientEditId = null;
    loadClients();
  } catch (err){
    showAlert(`B≈ÇƒÖd zapisu klienta: ${err.message}`, "danger");
  } finally {
    spn.classList.add('d-none'); btn.removeAttribute('disabled');
    _clientSubmitting = false;
  }
});


// Usuwanie klienta
async function confirmDeleteClient(cid){
  // Zmieniony, bardziej dosadny komunikat potwierdzajƒÖcy
  const confirmationText = "Czy na pewno chcesz TRWALE usunƒÖƒá tego klienta? Spowoduje to kaskadowe usuniƒôcie wszystkich jego pakiet√≥w, wizyt u terapeut√≥w i kurs√≥w z kierowcami. Tej operacji NIE MO≈ªNA cofnƒÖƒá.";

  if(!confirm(confirmationText)) return;

  try{
    // Ta czƒô≈õƒá jest ju≈º poprawna - wywo≈Çuje endpoint, kt√≥ry wykonuje twarde usuwanie
    const res = await fetch(`${API}/api/clients/${cid}`, { method: "DELETE" });
    await assertOk(res);

    // Zmieniony komunikat o sukcesie
    showAlert("Klient i wszystkie jego powiƒÖzania zosta≈Çy trwale usuniƒôte.", "success");
    loadClients();
  }catch(err){
    showAlert(`B≈ÇƒÖd usuwania klienta: ${err.message}`, "danger");
  }
}
window.confirmDeleteClient = confirmDeleteClient;

    let _therapistEditId = null;
async function openTherapistEdit(id){
  _therapistEditId = id;
  // pobierz dane
  const res = await fetch(`${API}/api/therapists?include_inactive=1`);
  const list = await res.json();
  const t = list.find(x => x.id === id);
  if(!t){ showAlert("Nie znaleziono terapeuty.", "danger"); return; }
  // wype≈Çnij formularz
  document.getElementById("thName").value = t.full_name || "";
  document.getElementById("thSpec").value = t.specialization || "";
  document.getElementById("thPhone").value = t.phone || "";
  document.getElementById("thActive").checked = !!t.active;
  (new bootstrap.Offcanvas('#therapistCanvas')).show();
}
window.openTherapistEdit = openTherapistEdit;

let _driverEditId = null;
async function openDriverEdit(id){
  _driverEditId = id;
  const res = await fetch(`${API}/api/drivers?include_inactive=1`);
  const list = await res.json();
  const d = list.find(x => x.id === id);
  if(!d){ showAlert("Nie znaleziono kierowcy.", "danger"); return; }
  document.getElementById("drName").value = d.full_name || "";
  document.getElementById("drPhone").value = d.phone || "";
  document.getElementById("drActive").checked = !!d.active;
  (new bootstrap.Offcanvas('#driverCanvas')).show();
}
window.openDriverEdit = openDriverEdit;

    const dayInput = document.getElementById("dayInput");
const gapsBox  = document.getElementById("gapsBox");

// init: dzi≈õ (lokalnie)
(function initDay(){
  const t = new Date();
  const ds = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
  dayInput.value = ds;
})();
dayInput.addEventListener("change", () => checkDailyGaps()); // auto-od≈õwie≈º

async function checkDailyGaps(){
  const d = dayInput.value; // YYYY-MM-DD
  if (!d) return;

  gapsBox.innerHTML = `
    <div class="alert alert-info d-flex align-items-center gap-2 mb-0">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div>Sprawdzam braki na <strong>${d}</strong>‚Ä¶</div>
    </div>`;

  try{
    const res = await fetch(`${API}/api/gaps/day?date=${encodeURIComponent(d)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const c = data.counts || {clients:0,therapists:0,drivers:0};
    const list = (arr, kind) => {
  if (!arr || !arr.length) return `<div class="text-muted">Brak</div>`;

  return `
    <details class="mt-2">
      <summary class="cursor-pointer">Poka≈º listƒô (${arr.length})</summary>
      <ul class="mb-0 mt-2">
        ${arr.map(x => {
          // Defensywne pobranie ID - szuka pod r√≥≈ºnymi mo≈ºliwymi nazwami
          const personId = x.id || x.client_id || x.therapist_id || x.driver_id;
          const fullName = x.full_name || 'Brak nazwy';

          let buttons = '';
          // Generuj przyciski tylko, je≈õli znaleziono jakiekolwiek ID
          if (personId) {
              if (kind === 'clients') {
                  buttons = `<button class="btn btn-sm btn-outline-primary ms-2" onclick="openPackageCanvas(${personId})">Dodaj pakiet</button>`;
              } else if (kind === 'therapists') {
                  buttons = `<button class="btn btn-sm btn-outline-primary ms-2" onclick="openTherapistSchedule(${personId}, '${fullName.replace(/'/g, "\\'")}')">Grafik</button>`;
              } else if (kind === 'drivers') {
                  buttons = `<button class="btn btn-sm btn-outline-primary ms-2" onclick="openDriverSchedule(${personId}, '${fullName.replace(/'/g, "\\'")}')">Kursy</button>`;
              }
          } else {
              buttons = `<span class="text-danger small ms-2">(Brak ID)</span>`;
          }

          return `<li>${fullName} ${buttons}</li>`;
        }).join("")}
      </ul>
    </details>`;
};

    gapsBox.innerHTML = `
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <div><strong>Braki na dzie≈Ñ:</strong> ${data.date}</div>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge text-bg-secondary">Klienci: ${c.clients}</span>
              <span class="badge text-bg-secondary">Terapeuci: ${c.therapists}</span>
              <span class="badge text-bg-secondary">Kierowcy: ${c.drivers}</span>
              <button class="btn btn-sm btn-outline-primary" onclick="checkDailyGaps()">Od≈õwie≈º</button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <h6 class="mb-1">Klienci bez zdarze≈Ñ</h6>
              ${list(data.clients || [], 'clients')}
            </div>
            <div class="col-12 col-lg-4">
              <h6 class="mb-1">Terapeuci bez terapii</h6>
              ${list(data.therapists || [], 'therapists')}
            </div>
            <div class="col-12 col-lg-4">
              <h6 class="mb-1">Kierowcy bez kurs√≥w</h6>
              ${list(data.drivers || [], 'drivers')}
            </div>
          </div>
        </div>
      </div>`;
  } catch (err){
    gapsBox.innerHTML = `<div class="alert alert-danger mb-0">B≈ÇƒÖd sprawdzania brak√≥w: ${err.message}</div>`;
  }
}

// odpal na starcie strony
checkDailyGaps();

// (opcjonalnie) po zapisie pakietu ‚Äì od≈õwie≈º ‚Äûbraki‚Äù
const _origPkgSubmit = document.getElementById("packageForm").onsubmit;
document.getElementById("packageForm").addEventListener("submit", async (e)=>{
  // Tw√≥j istniejƒÖcy handler robi fetch i loadClients();
  // Nic nie zmieniamy w jego ≈õrodku ‚Äì po sukcesie tylko do≈Ç√≥≈º:
  // (je≈õli masz wiele handler√≥w, wstaw to po sukcesie zapisu)
  setTimeout(checkDailyGaps, 300);
});

    document.getElementById("gapsMonthBtn").addEventListener("click", checkMonthlyGaps);

async function checkMonthlyGaps(){
  const mk = monthInput.value;
  if (!mk) { showAlert("Wybierz miesiƒÖc.", "warning"); return; }

  gapsBox.innerHTML = `
    <div class="alert alert-info d-flex align-items-center gap-2 mb-0">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div>Sprawdzam braki w miesiƒÖcu <strong>${mk}</strong>‚Ä¶</div>
    </div>`;

  try{
    const res = await fetch(`${API}/api/gaps/month?month=${encodeURIComponent(mk)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const c = data.counts || {clients:0,therapists:0,drivers:0};
    const list = (arr, kind) => {
  if (!arr.length) return `<div class="text-muted">Brak</div>`;

  return `
    <details class="mt-2">
      <summary>Lista (${arr.length})</summary>
      <ul class="mb-0 mt-2">
        ${arr.map(x => {
            // Nowa logika wy≈õwietlania statusu nieobecno≈õci
            let absenceBadge = '';
            if (x.absence_status) {
                const statusLabel = x.absence_status === 'L4' ? 'L4' : 'U';
                absenceBadge = `<span class="badge text-bg-danger ms-2" title="${x.absence_status}">${statusLabel}</span>`;
            }

            const personId = x.id; // Zak≈Çadamy, ≈ºe API zwraca teraz zawsze 'id'
            const fullName = x.full_name || 'Brak nazwy';

            let buttons = '';
            if (personId) {
                if (kind === 'clients') {
                    buttons = `<button class="btn btn-sm btn-outline-primary ms-2" onclick="openPackageCanvas(${personId})">Dodaj pakiet</button>`;
                } else { // Dla terapeut√≥w i kierowc√≥w
                    const scheduleFn = kind === 'therapists' ? 'openTherapistSchedule' : 'openDriverSchedule';
                    const scheduleLabel = kind === 'therapists' ? 'Grafik' : 'Kursy';
                    buttons = `<button class="btn btn-sm btn-outline-primary ms-2" onclick="${scheduleFn}(${personId}, '${fullName.replace(/'/g, "\\'")}')">${scheduleLabel}</button>`;
                }
            }
            return `<li>${fullName} ${absenceBadge} ${buttons}</li>`;
        }).join("")}
      </ul>
    </details>`;
};

    gapsBox.innerHTML = `
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <div><strong>Braki w miesiƒÖcu:</strong> ${data.month}</div>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge text-bg-secondary">Klienci: ${c.clients}</span>
              <span class="badge text-bg-secondary">Terapeuci: ${c.therapists}</span>
              <span class="badge text-bg-secondary">Kierowcy: ${c.drivers}</span>
              <button class="btn btn-sm btn-outline-primary" onclick="checkMonthlyGaps()">Od≈õwie≈º</button>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <h6 class="mb-1">Klienci bez zdarze≈Ñ w miesiƒÖcu</h6>
              ${list(data.clients || [], 'clients')}
            </div>
            <div class="col-12 col-lg-4">
              <h6 class="mb-1">Terapeuci bez terapii w miesiƒÖcu</h6>
              ${list(data.therapists || [], 'therapists')}
            </div>
            <div class="col-12 col-lg-4">
              <h6 class="mb-1">Kierowcy bez kurs√≥w w miesiƒÖcu</h6>
              ${list(data.drivers || [], 'drivers')}
            </div>
          </div>
        </div>
      </div>`;
  } catch (err){
    gapsBox.innerHTML = `<div class="alert alert-danger mb-0">B≈ÇƒÖd sprawdzania brak√≥w: ${err.message}</div>`;
  }
}


async function ensureOptionsLoaded(retries=40, delay=50){
  // czeka a≈º selecty bƒôdƒÖ mia≈Çy opcje
  while (retries-- > 0){
    const thOk = thSelect && thSelect.options && thSelect.options.length > 1;
    const pkOk = pkDriverSelect && pkDriverSelect.options && pkDriverSelect.options.length > 1;
    const dpOk = dpDriverSelect && dpDriverSelect.options && dpDriverSelect.options.length > 1;
    if (thOk || pkOk || dpOk) return;
    await new Promise(r => setTimeout(r, delay));
  }
}

async function fetchAISuggestions(){
  const client_id = Number(pkgClientId.value || 0);
  const date      = thDate.value;
  if(!client_id || !date){
    showAlert("Brakuje klienta albo daty do wygenerowania propozycji.", "warning");
    return;
  }

  // UPEWNIJ SIƒò, ≈ºe selecty sƒÖ ju≈º za≈Çadowane
  await ensureOptionsLoaded();

  const res = await fetch(`${API}/api/ai/suggest`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      client_id: client_id,
      date: date,
      therapy_window: ["08:00","17:00"],
      pickup_offset_min: 30,
      dropoff_offset_min: 30
    })
  });
  if(!res.ok){
    const t = await res.text();
    showAlert(`AI: b≈ÇƒÖd pobierania propozycji ‚Äì ${t || res.status}`, "danger");
    return;
  }
  const ai = await res.json();

  // --- TERAPIA: bierzemy TOP1 z tablicy
  const t0 = (ai.therapy || [])[0];
  if (t0){
    thSelect.value = String(t0.therapist_id || "");
    const s = new Date(t0.suggested_start);
    const e = new Date(t0.suggested_end);
    if (!isNaN(s)) thStart.value = `${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}`;
    if (!isNaN(e)) thEnd.value   = `${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}`;
    if (!thPlace.value) thPlace.value = "Poradnia";
  }

  // --- PICKUP: TOP1
  const p0 = (ai.drivers_pickup || [])[0];
  if (p0){
    withPickup.checked = true;
    pickupFields.classList.remove("d-none");
    pkDriverSelect.value = String(p0.driver_id || "");
    const ps = new Date(p0.suggested_start);
    const pe = new Date(p0.suggested_end);
    if (!isNaN(ps)) pkStart.value = `${String(ps.getHours()).padStart(2,'0')}:${String(ps.getMinutes()).padStart(2,'0')}`;
    if (!isNaN(pe)) pkEnd.value   = `${String(pe.getHours()).padStart(2,'0')}:${String(pe.getMinutes()).padStart(2,'0')}`;
    if (!pkFrom.value) pkFrom.value = "Dom";
    if (!pkTo.value)   pkTo.value   = "Poradnia";
  } else {
    withPickup.checked = false;
    pickupFields.classList.add("d-none");
  }

  // --- DROPOFF: TOP1
  const d0 = (ai.drivers_dropoff || [])[0];
  if (d0){
    withDropoff.checked = true;
    dropoffFields.classList.remove("d-none");
    dpDriverSelect.value = String(d0.driver_id || "");
    const ds = new Date(d0.suggested_start);
    const de = new Date(d0.suggested_end);
    if (!isNaN(ds)) dpStart.value = `${String(ds.getHours()).padStart(2,'0')}:${String(ds.getMinutes()).padStart(2,'0')}`;
    if (!isNaN(de)) dpEnd.value   = `${String(de.getHours()).padStart(2,'0')}:${String(de.getMinutes()).padStart(2,'0')}`;
    if (!dpFrom.value) dpFrom.value = "Poradnia";
    if (!dpTo.value)   dpTo.value   = "Dom";
  } else {
    withDropoff.checked = false;
    dropoffFields.classList.add("d-none");
  }

  showAlert("Wstawiono propozycjƒô pakietu (AI).", "success");
}

    window.aiSuggestForClient = async function(clientId){
    // otw√≥rz panel z domy≈õlnƒÖ datƒÖ i za≈Çaduj listy
    openPackageCanvas(clientId);
    // poczekaj a≈º selecty bƒôdƒÖ mia≈Çy opcje
    await ensureOptionsLoaded();
    // pobierz i wstaw propozycjƒô (terapeuta/godziny/kierowcy)
    await fetchAISuggestions();
  };

    // ====== Raport terapeuty ‚Äì cache ostatnio otwartego
let _lastTherapistReport = { therapistId: null, fullName: "", rows: [] };

// Ustaw, czy bierzemy tylko TERAPIE o statusie "done"
const REPORT_DONE_ONLY = true;

// Otw√≥rz modal i pobierz zdarzenia terapeuty w miesiƒÖcu
async function openTherapistReport(tid, fullName){
  const modalEl = document.getElementById("therapistReportModal");
  const titleEl = document.getElementById("therapistReportTitle");
  const bodyEl  = document.getElementById("therapistReportBody");
  if (!modalEl || !titleEl || !bodyEl){
    showAlert("Brak szablonu modala zestawienia terapeuty.", "danger");
    return;
  }

  titleEl.textContent = `Zestawienie: ${fullName || `ID ${tid}`}`;
  bodyEl.innerHTML = `<div class="text-muted py-3">≈Åadowanie‚Ä¶</div>`;

  // filtr po miesiƒÖcu z nag≈Ç√≥wka
  const mk = monthInput.value || "";
  try{
    const url = `${API}/api/therapists/${tid}/schedule?month=${encodeURIComponent(mk)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // Zostaw tylko TERAPIE; opcjonalnie tylko "done"
    const filtered = data.filter(r => r.kind === "therapy" && (!REPORT_DONE_ONLY || r.status === "done"));

    _lastTherapistReport = { therapistId: tid, fullName: fullName || `ID ${tid}`, rows: filtered };

    bodyEl.innerHTML = renderTherapistReportHTML(_lastTherapistReport.fullName, filtered);
    // pod≈ÇƒÖcz druk
    const btn = document.getElementById("printTherapistReportBtn");
    if (btn) btn.onclick = () => printTherapistReport();

    new bootstrap.Modal(modalEl).show();
  }catch(err){
    bodyEl.innerHTML = `<div class="text-danger py-3">B≈ÇƒÖd: ${err.message}</div>`;
  }
}
window.openTherapistReport = openTherapistReport;

// Render HTML dziennego zestawienia + sumy miesiƒôczne
function renderTherapistReportHTML(fullName, rows){
  // Grupuj po dniu
  const groups = new Map(); // key -> { label, items: [], sumDay: 0 }
  let sumMonth = 0;

  for (const r of rows){
    const iso = r.starts_at || r.ends_at;
    if (!iso) continue;
    const { key, label } = dateKeyPLLocal(iso);
    if (!key) continue;

    const mins = minutesBetweenLocal(r.starts_at, r.ends_at);
    if (!groups.has(key)) groups.set(key, { label, items: [], sumDay: 0 });
    const g = groups.get(key);
    g.items.push(r);
    g.sumDay += mins;
    sumMonth += mins;
  }

  const ordered = [...groups.entries()].sort(([a],[b]) => a.localeCompare(b));

  const mkInfo = (monthInput && monthInput.value)
    ? `<div class="mb-2"><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>` : "";

  let html = `
    <div class="mb-2"><strong>Terapeuta:</strong> ${String(fullName).replace(/</g,'&lt;')}</div>
    ${mkInfo}
    <div class="mb-3">
      <span class="badge text-bg-dark">Razem w miesiƒÖcu: ${minutesToHM(sumMonth)}</span>
      ${REPORT_DONE_ONLY ? `<span class="badge text-bg-secondary ms-2">Tylko status: done</span>` : ``}
    </div>`;

  if (!ordered.length){
    html += `<div class="text-muted">Brak zdarze≈Ñ spe≈ÇniajƒÖcych kryteria.</div>`;
    return html;
  }

  for (const [, group] of ordered){
    const header = `
      <div class="d-flex flex-wrap align-items-center justify-content-between mt-3 mb-2">
        <h6 class="m-0">${group.label}</h6>
        <span class="badge text-bg-primary">Suma dnia: ${minutesToHM(group.sumDay)}</span>
      </div>`;

    const rowsHtml = group.items
      .sort((a,b) => (a.starts_at||"").localeCompare(b.starts_at||""))
      .map(p => {
        const mins = minutesBetweenLocal(p.starts_at, p.ends_at);
        const place = p.place_to || "‚Äî";
        return `
          <tr>
            <td>${fmtLocalTime(p.starts_at)}‚Äì${fmtLocalTime(p.ends_at)}</td>
            <td>${minutesToHM(mins)}</td>
            <td>${p.client_name || `klient #${p.client_id ?? ""}`}</td>
            <td>${place}</td>
            <td><code>${p.status || ""}</code></td>
          </tr>`;
      }).join("");

    html += `
      ${header}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Godzina</th>
              <th>Czas</th>
              <th>Klient</th>
              <th>Miejsce</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      </div>`;
  }

  return html;
}

// Druk przez ukryty iframe (jak u kierowcy/klienta)
function printTherapistReport(){
  const { fullName, rows } = _lastTherapistReport || {};
  if (!rows || !rows.length){
    showAlert("Brak danych do wydruku.", "warning");
    return;
  }
  const content = renderTherapistReportHTML(fullName, rows);
  const monthInfo = (monthInput && monthInput.value)
    ? `<div><strong>MiesiƒÖc:</strong> ${monthInput.value}</div>` : "";

  const html = `<!doctype html>
  <html lang="pl">
  <head>
    <meta charset="utf-8">
    <title>Zestawienie terapeuty ‚Äì ${String(fullName).replace(/</g,'&lt;')}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      @media print {
        .badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { font-size: 12px; }
        h6 { margin-top: 0.5rem; }
        table { page-break-inside: avoid; }
      }
      body { padding: 1rem; }
    </style>
  </head>
  <body>
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h4 class="mb-1">Zestawienie miesiƒôczne ‚Äì terapeuta</h4>
        <div><strong>Terapeuta:</strong> ${String(fullName).replace(/</g,'&lt;')}</div>
        ${monthInfo}
        ${REPORT_DONE_ONLY ? `<div><strong>Filtr:</strong> tylko status <code>done</code></div>` : ``}
      </div>
      <div class="text-end">
        <small class="text-muted">Wygenerowano: ${new Date().toLocaleString("pl-PL")}</small>
      </div>
    </div>
    ${content}
  </body>
  </html>`;

  const iframe = document.createElement("iframe");
  Object.assign(iframe.style, {position:"fixed", right:"0", bottom:"0", width:"0", height:"0", border:"0"});
  iframe.setAttribute("aria-hidden", "true");
  document.body.appendChild(iframe);

  const ifrw = iframe.contentWindow;
  const ifrd = iframe.contentDocument || ifrw.document;
  ifrd.open(); ifrd.write(html); ifrd.close();

  let printed = false;
  const cleanup = () => setTimeout(() => iframe.remove(), 100);

  iframe.onload = () => {
    if (printed) return;
    printed = true;
    try { ifrw.focus(); setTimeout(() => { try { ifrw.print(); } catch(e){} }, 0); } catch(e){}
  };
  if (ifrw) ifrw.onafterprint = cleanup;
  setTimeout(cleanup, 5000);
}

    // === LOGIKA DLA NOWEGO PRZYCISKU "DODAJ PAKIET" ===

// 1. Pobierz referencje do nowych element√≥w
const clientSelectModalEl = document.getElementById('clientSelectModal');
const clientSelectModal = new bootstrap.Modal(clientSelectModalEl);
const modalClientSelect = document.getElementById('modalClientSelect');

// 2. Logika przycisku "Dodaj Pakiet"
document.getElementById('openClientSelectModalBtn').addEventListener('click', async () => {
  // Wype≈Çnij listƒô klient√≥w
  modalClientSelect.innerHTML = '<option value="">≈Åadowanie...</option>';
  modalClientSelect.disabled = true;

  try {
    // U≈ºywamy istniejƒÖcej zmiennej `lastClients`, aby nie odpytywaƒá API ponownie
    // lub odpytujemy API, je≈õli lista jest pusta
    let clientsToDisplay = lastClients;
    if (!clientsToDisplay || clientsToDisplay.length === 0) {
        const res = await fetch(`${API}/api/clients`);
        clientsToDisplay = await res.json();
    }

    // Bierzemy tylko aktywnych klient√≥w
    const activeClients = clientsToDisplay.filter(c => c.active !== false);

    if (activeClients.length > 0) {
      modalClientSelect.innerHTML = '<option value="">-- wybierz klienta --</option>' +
        activeClients.map(c => `<option value="${c.client_id}">${c.full_name}</option>`).join('');
    } else {
      modalClientSelect.innerHTML = '<option value="">Brak aktywnych klient√≥w</option>';
    }
  } catch (err) {
    modalClientSelect.innerHTML = `<option value="">B≈ÇƒÖd ≈Çadowania: ${err.message}</option>`;
  } finally {
    modalClientSelect.disabled = false;
  }

  // Poka≈º okno
  clientSelectModal.show();
});

// 3. Logika przycisku "Dalej" w oknie wyboru klienta
document.getElementById('continueWithClientBtn').addEventListener('click', () => {
  const selectedClientId = modalClientSelect.value;

  if (selectedClientId) {
    // Schowaj okno wyboru
    clientSelectModal.hide();

    // Otw√≥rz panel dodawania pakietu dla wybranego klienta
    // U≈ºywamy tutaj istniejƒÖcej funkcji openPackageCanvas!
    choosePackageType(Number(selectedClientId));
  } else {
    alert("Proszƒô wybraƒá klienta z listy.");
  }
});

// === LOGIKA DO AUTOMATYCZNEGO OTWIERANIA PANELU PAKIETU ===
document.addEventListener('DOMContentLoaded', () => {

    const checkUrlForPackageOpen = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const clientIdToOpen = urlParams.get('openPackageFor');

        if (clientIdToOpen) {
            // Poczekaj chwilƒô (p√≥≈Ç sekundy), aby daƒá stronie czas na za≈Çadowanie wszystkiego
            setTimeout(() => {
                // U≈ºyj istniejƒÖcej funkcji, aby otworzyƒá panel dla przekazanego ID klienta
                openPackageCanvas(Number(clientIdToOpen));

                // Opcjonalnie: Usu≈Ñ parametr z adresu URL, aby panel nie otwiera≈Ç siƒô ponownie przy ka≈ºdym od≈õwie≈ºeniu strony
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.pushState({path: newUrl}, '', newUrl);
            }, 500);
        }
    };

    // Uruchom sprawdzanie po za≈Çadowaniu strony
    checkUrlForPackageOpen();
});

// === LOGIKA DLA NIEOBECNO≈öCI ===

const absenceModalEl = document.getElementById('absenceModal');
const absenceModal = new bootstrap.Modal(absenceModalEl);
const absenceForm = document.getElementById('absenceForm');

function openAbsenceModal(personType, personId) {
  absenceForm.reset();
  document.getElementById('absencePersonType').value = personType;
  document.getElementById('absencePersonId').value = personId;
  absenceModal.show();
}

absenceForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        person_type: document.getElementById('absencePersonType').value,
        person_id: Number(document.getElementById('absencePersonId').value),
        status: document.getElementById('absenceStatus').value,
        start_date: document.getElementById('absenceStartDate').value,
        end_date: document.getElementById('absenceEndDate').value,
        notes: document.getElementById('absenceNotes').value
    };

    try {
        const response = await fetch(`${API}/api/absences`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error('B≈ÇƒÖd serwera podczas zapisywania nieobecno≈õci.');

        showAlert('Nieobecno≈õƒá zosta≈Ça pomy≈õlnie dodana.', 'success');
        absenceModal.hide();
        // Od≈õwie≈º widok brak√≥w, aby pokazaƒá nowƒÖ ikonkƒô
        checkMonthlyGaps();
    } catch (err) {
        showAlert(err.message, 'danger');
    }
});

      // Logika dla przycisk√≥w w oknie wyboru typu pakietu
document.getElementById('btnGoToIndividualPackage').addEventListener('click', () => {
    packageTypeModal.hide();
    // Wywo≈Çaj istniejƒÖcƒÖ funkcjƒô do tworzenia pakietu indywidualnego
    openPackageCanvas(_clientIdForNewPackage);
});

document.getElementById('btnGoToTus').addEventListener('click', async () => {
    packageTypeModal.hide();

    try {
        const response = await fetch(`${API}/api/clients/${_clientIdForNewPackage}/tus-groups`);
        if (!response.ok) throw new Error('B≈ÇƒÖd serwera przy sprawdzaniu grupy klienta.');

        const clientGroups = await response.json();

        if (clientGroups.length > 0) {
            // PRZYPADEK 1: Klient jest ju≈º w jednej grupie -> przejd≈∫ od razu do jej szczeg√≥≈Ç√≥w
            const groupId = clientGroups[0].id;
            window.location.href = `tus.html?openGroup=${groupId}`;
        } else {
            // PRZYPADEK 2: Klient nie nale≈ºy do ≈ºadnej grupy -> przejd≈∫ do strony og√≥lnej TUS
            alert("Ten klient nie jest jeszcze przypisany do ≈ºadnej grupy TUS. Zostaniesz przekierowany na g≈Ç√≥wnƒÖ stronƒô modu≈Çu, aby go dodaƒá do istniejƒÖcej grupy lub stworzyƒá nowƒÖ.");
            window.location.href = 'tus.html';
        }
    } catch (err) {
        alert(err.message);
    }
});

  </script>
</body>
</html>