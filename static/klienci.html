<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>ZarzƒÖdzanie Klientami</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    .table-actions .btn {
      width: 80px;
    }
  </style>
</head>
<body>

<div class="container">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">üë• ZarzƒÖdzanie Klientami</h1>
    <button class="btn btn-primary" id="addClientBtn">Dodaj nowego klienta</button>
  </header>

  <main class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Imiƒô i nazwisko</th>
              <th>Adres</th>
              <th>Telefon</th>
              <th class="text-end" style="width: 180px;">Akcje</th>
            </tr>
          </thead>
          <tbody id="clientsTableBody">
            </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientModalLabel">Dane Klienta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body">
        <form id="clientForm">
          <input type="hidden" id="clientId">
          <div class="mb-3">
            <label for="clientName" class="form-label">Imiƒô i nazwisko</label>
            <input type="text" class="form-control" id="clientName" required>
          </div>
          <div class="mb-3">
            <label for="clientAdres" class="form-label">Adres</label>
            <input type="text" class="form-control" id="clientAdres" required>
          </div>
          <div class="mb-3">
            <label for="clientPhone" class="form-label">Telefon</label>
            <input type="tel" class="form-control" id="clientPhone">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
        <button type="submit" class="btn btn-primary" form="clientForm" id="saveClientBtn">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          Zapisz
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

   // === POCZƒÑTEK: Prawdziwe API ===
  const API_URL = "https://odnowa.onrender.com/api/clients";

  const api = {
    // GET /api/clients
    getClients: async () => {
      const response = await fetch(API_URL);
      if (!response.ok) throw new Error('Nie uda≈Ço siƒô pobraƒá klient√≥w.');
      return response.json();
    },
    // POST /api/clients
    addClient: async (clientData) => {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(clientData)
      });
      if (!response.ok) throw new Error('B≈ÇƒÖd podczas dodawania klienta.');
      return response.json();
    },
    // PUT /api/clients/{id}
    updateClient: async (id, clientData) => {
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(clientData)
      });
      if (!response.ok) throw new Error('B≈ÇƒÖd podczas aktualizacji klienta.');
      return response.json();
    },
    // DELETE /api/clients/{id}
    deleteClient: async (id) => {
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE'
      });
      if (!response.ok) throw new Error('B≈ÇƒÖd podczas usuwania klienta.');
      // DELETE czƒôsto zwraca pustƒÖ odpowied≈∫, wiƒôc nie robimy .json()
      return { ok: true };
    }
  };
  // === KONIEC: Prawdziwe API ===


  const tableBody = document.getElementById('clientsTableBody');
  const clientModalEl = document.getElementById('clientModal');
  const clientModal = new bootstrap.Modal(clientModalEl);
  const clientForm = document.getElementById('clientForm');
  const modalTitle = document.getElementById('clientModalLabel');
  const saveBtn = document.getElementById('saveClientBtn');
  const saveBtnSpinner = saveBtn.querySelector('.spinner-border');

  // Funkcja do renderowania listy klient√≥w
 // Funkcja do renderowania listy klient√≥w
  const renderClients = async () => {
    // 1. Poka≈º "≈Çadowanie"
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">≈Åadowanie...</span></div></td></tr>`;

    try {
      // 2. Pobierz dane z prawdziwego API
      const clients = await api.getClients();

      // 3. Wyczy≈õƒá tabelƒô i sprawd≈∫, czy sƒÖ dane
      tableBody.innerHTML = '';
      if (clients.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted p-4">Brak klient√≥w w bazie.</td></tr>`;
        return;
      }

      // 4. Wygeneruj wiersze z poprawnymi nazwami p√≥l
      clients.forEach(client => {
        const tr = document.createElement('tr');

        // POPRAWIONE NAZWY: U≈ºywamy client.client_id oraz client.full_name
        // Dodano te≈º fallback '‚Äî' dla pustych p√≥l
        tr.innerHTML = `
          <td>${client.client_id}</td>
          <td>${client.full_name}</td>
          <td>${client.address || '‚Äî'}</td>
          <td>${client.phone || '‚Äî'}</td>
          <td class="text-end table-actions">
            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${client.client_id}">Edytuj</button>
            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${client.client_id}">Usu≈Ñ</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });

    } catch (error) {
      // 5. W razie b≈Çƒôdu sieciowego, wy≈õwietl komunikat
      console.error("B≈ÇƒÖd ≈Çadowania klient√≥w:", error);
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger p-4">WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania danych: ${error.message}</td></tr>`;
    }
  };

  // Otwieranie modala w trybie dodawania
  document.getElementById('addClientBtn').addEventListener('click', () => {
    clientForm.reset();
    document.getElementById('clientId').value = '';
    modalTitle.textContent = 'Dodaj nowego klienta';
    clientModal.show();
  });

  // Obs≈Çuga klikniƒôƒá na przyciski "Edytuj" i "Usu≈Ñ" (delegacja zdarze≈Ñ)
  // Obs≈Çuga klikniƒôƒá na przyciski "Edytuj" i "Usu≈Ñ" (delegacja zdarze≈Ñ)
  tableBody.addEventListener('click', async (e) => {
    const target = e.target;
    const allClients = await api.getClients(); // Pobieramy listƒô raz

    // Edycja
    if (target.classList.contains('edit-btn')) {
      const clientId = Number(target.dataset.id);
      const client = allClients.find(c => c.client_id === clientId);

      if (client) {
        // Poprawione ID pola i nazwy p√≥l
        document.getElementById('clientId').value = client.client_id;
        document.getElementById('clientName').value = client.full_name;
        document.getElementById('clientAdres').value = client.address;
        document.getElementById('clientPhone').value = client.phone;
        modalTitle.textContent = `Edytuj klienta #${client.client_id}`;
        clientModal.show();
      }
    }

    // Usuwanie
    if (target.classList.contains('delete-btn')) {
      const clientId = Number(target.dataset.id);
      if (confirm(`Czy na pewno chcesz TRWALE usunƒÖƒá klienta #${clientId}? Tej operacji nie mo≈ºna cofnƒÖƒá.`)) {
        await api.deleteClient(clientId);
        renderClients();
      }
    }
  });

  // Obs≈Çuga zapisu formularza (dodawanie lub edycja)
  clientForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    saveBtn.disabled = true;
    saveBtnSpinner.classList.remove('d-none');

    const clientId = Number(document.getElementById('clientId').value);
    const clientData = {
      full_name: document.getElementById('clientName').value,
      address: document.getElementById('clientAdres').value,
      phone: document.getElementById('clientPhone').value,
    };

    try {
      if (clientId) {
        // === EDYCJA KLIENTA ===
        // Po edycji, po prostu od≈õwie≈ºamy listƒô na bie≈ºƒÖcej stronie
        await api.updateClient(clientId, clientData);
        clientModal.hide();
        renderClients();
      } else {
        // === DODAWANIE NOWEGO KLIENTA ===
        const newClient = await api.addClient(clientData);

        // Zadaj pytanie u≈ºytkownikowi
        if (confirm("Klient zosta≈Ç pomy≈õlnie dodany. Czy chcesz od razu przypisaƒá mu pakiet?")) {
          // Tak: Przekieruj na stronƒô g≈Ç√≥wnƒÖ z ID nowego klienta w adresie URL
          window.location.href = `index.html?openPackageFor=${newClient.id}`; // U≈ºywamy ID zwr√≥conego przez API
        } else {
          // Nie: Zosta≈Ñ na stronie i tylko od≈õwie≈º listƒô
          clientModal.hide();
          renderClients();
        }
      }
    } catch (error) {
        alert(`WystƒÖpi≈Ç b≈ÇƒÖd: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtnSpinner.classList.add('d-none');
    }
  });

  // Inicjalizacja
  renderClients();
});
</script>
</body>

</html>


