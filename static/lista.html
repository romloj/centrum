<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Lista Obecności Klientów</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="menu_fab.css">
  <style>
    body {
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .main-container {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .header-section {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 2rem;
    }
    .controls-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    .status-present { color: #198754; font-weight: bold; }
    .status-absent { color: #dc3545; font-weight: bold; }
    .status-late { color: #fd7e14; font-weight: bold; }
    .status-excused { color: #0dcaf0; font-weight: bold; }
    .client-photo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #dee2e6;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }
    .summary-card {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
    }
    .debug-info {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 1rem;
        margin: 1rem;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.875rem;
    }

    

    @media (max-width: 768px) {
        .fab-container {
            bottom: 1rem;
            right: 1rem;
        }
        .fab-main {
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
        }
        .fab-button {
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
        }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Nagłówek -->
    <div class="header-section text-center">
      <h1 class="display-6 mb-2">📊 Lista Obecności Klientów</h1>
      <p class="lead mb-0">System zarządzania obecnością</p>
    </div>

    <!-- Kontrolki -->
    <div class="controls-section">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label"><strong>Data zajęć</strong></label>
          <input type="date" id="selectedDate" class="form-control">
        </div>
        <div class="col-md-6">
          <div class="d-grid gap-2 d-md-flex">
            <button class="btn btn-primary me-2" onclick="loadScheduledClients()">
              <i class="bi bi-arrow-clockwise"></i> Pobierz listę
            </button>
            <button class="btn btn-success" onclick="saveAllAttendance()">
              <i class="bi bi-check-circle"></i> Zapisz obecność
            </button>
            <button class="btn btn-info" onclick="toggleDebug()">
              <i class="bi bi-bug"></i> Debug
            </button>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Wyszukaj klienta...">
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info d-none"></div>

    <!-- Alert Box -->
    <div id="alertBox" class="m-3"></div>

    <!-- Tabela obecności -->
    <div class="table-responsive">
      <table class="table table-hover table-striped" id="attendanceTable">
        <thead class="table-dark">
          <tr>
            <th>Zdjęcie</th>
            <th>Imię i Nazwisko</th>
            <th>Telefon</th>
            <th>Terapeuta</th>
            <th>Godzina</th>
            <th>Status</th>
            <th>Uwagi</th>
          </tr>
        </thead>
        <tbody id="attendanceBody">
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2">Ładowanie danych...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Podsumowanie -->
    <div class="summary-card m-3 text-center">
      <div class="row">
        <div class="col-3">
          <h4 id="totalClients">0</h4>
          <small>Zaplanowani</small>
        </div>
        <div class="col-3">
          <h4 id="presentCount">0</h4>
          <small>Obecni</small>
        </div>
        <div class="col-3">
          <h4 id="absentCount">0</h4>
          <small>Nieobecni</small>
        </div>
        <div class="col-3">
          <h4 id="otherCount">0</h4>
          <small>Brak statusu</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Menu - TYLKO RAZ, na końcu body -->
    <div class="fab-container" id="fabContainer">
    <ul class="fab-menu">
        <li class="fab-item">
            <span class="fab-label">Plan terapeuty</span>
            <a href="therapist.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-heart-pulse"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Moduł TUS</span>
            <a href="tus.html" class="fab-button" title="Moduł TUS">
                <i class="bi bi-star-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Lista klientów</span>
            <a href="klienci.html" class="fab-button" title="Lista klientów">
                <i class="bi bi-people-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Historia klientów</span>
            <a href="client_history.html" class="fab-button" title="Historia klientów">
                <i class="bi bi-clock-history"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Moduł Kierowcy</span>
            <a href="drivers.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-car-front-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Strona główna</span>
            <a href="index.html" class="fab-button" title="Strona główna">
                <i class="bi bi-house-fill"></i>
            </a>
        </li>
    </ul>
    <button class="fab-main" id="fabMainBtn" aria-label="Rozwiń menu">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>
    <div class="fab-backdrop" id="fabBackdrop"></div>
  
    <!-- Skrypty -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="fab-menu.js"></script>
    <script src="panel.js"></script>
  <script>
    const API_URL = ""; // Pusty string = same origin
    let currentScheduledClients = [];
    let debugMode = false;

    document.addEventListener('DOMContentLoaded', () => {
      initializePage();
      setupEventListeners();
    });

     function setupEventListeners() {
  // Wyszukiwarka - bez zmian
  document.getElementById('searchInput').addEventListener('input', filterClients);

  // FAB Menu
  const fabContainer = document.getElementById('fabContainer');
  const fabMainBtn = document.getElementById('fabMainBtn');
  const fabBackdrop = document.getElementById('fabBackdrop');

  if (fabMainBtn) {
    fabMainBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      fabContainer.classList.toggle('open');
    });
  }

  if (fabBackdrop) {
    fabBackdrop.addEventListener('click', () => {
      fabContainer.classList.remove('open');
    });
  }

  // Zamknij menu po kliknięciu linku
  document.querySelectorAll('.fab-button').forEach(btn => {
    btn.addEventListener('click', () => {
      fabContainer.classList.remove('open');
    });
  });

  // Zamknij menu klawiszem ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && fabContainer.classList.contains('open')) {
      fabContainer.classList.remove('open');
    }
  });
}

    function toggleDebug() {
      debugMode = !debugMode;
      const debugEl = document.getElementById('debugInfo');
      debugEl.classList.toggle('d-none', !debugMode);
    }

    function logDebug(message, data = null) {
      console.log(message, data);
      if (debugMode) {
        const debugEl = document.getElementById('debugInfo');
        const timestamp = new Date().toLocaleTimeString();
        debugEl.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}</div>`;
        if (data) {
          debugEl.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      }
    }

    async function initializePage() {
      // Ustaw dzisiejszą datę
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('selectedDate').value = dateStr;

      // Automatycznie załaduj listę
      await loadScheduledClients();
    }

    async function loadScheduledClients() {
      const selectedDate = document.getElementById('selectedDate').value;

      if (!selectedDate) {
        showAlert('Wybierz datę', 'warning');
        return;
      }

      logDebug('Rozpoczynam ładowanie dla daty:', selectedDate);
      showAlert('Ładowanie listy klientów...', 'info');

      try {
        // OPCJA 1: Próba pobrania przez dedykowany endpoint scheduled-clients
        let scheduledClients = [];

        try {
          logDebug('Próbuję endpoint: /api/scheduled-clients');
          const response1 = await fetch(`${API_URL}/api/scheduled-clients?date=${selectedDate}`);

          if (response1.ok) {
            scheduledClients = await response1.json();
            logDebug('Otrzymano dane z /api/scheduled-clients:', scheduledClients);
          } else {
            logDebug('Endpoint /api/scheduled-clients niedostępny, próbuję alternatywę...');
            throw new Error('Endpoint niedostępny');
          }
        } catch (e1) {
          // OPCJA 2: Pobierz z głównego endpointu clients i przefiltruj
          logDebug('Próbuję endpoint: /api/clients');
          const response2 = await fetch(`${API_URL}/api/clients`);

          if (!response2.ok) {
            throw new Error(`Błąd API: ${response2.status}`);
          }

          const allClients = await response2.json();
          logDebug('Otrzymano wszystkich klientów:', allClients.length);

          // OPCJA 3: Pobierz pakiety/zajęcia dla tej daty
          try {
            logDebug('Próbuję pobrać zajęcia dla daty:', selectedDate);
            const eventsRes = await fetch(`${API_URL}/api/schedule/day?date=${selectedDate}`);

            if (eventsRes.ok) {
              const events = await eventsRes.json();
              logDebug('Otrzymano wydarzenia:', events);

              // Wyciągnij unikalne ID klientów z wydarzeń
              const clientIdsWithEvents = [...new Set(events.map(e => e.client_id).filter(Boolean))];

              // Filtruj klientów którzy mają zajęcia tego dnia
              scheduledClients = allClients.filter(c => clientIdsWithEvents.includes(c.client_id || c.id));

              // Dodaj informacje o terapeucie i godzinie z wydarzeń
              scheduledClients = scheduledClients.map(client => {
                const clientEvents = events.filter(e => e.client_id === (client.client_id || client.id));
                const therapyEvent = clientEvents.find(e => e.kind === 'therapy');

                return {
                  ...client,
                  therapist_name: therapyEvent?.therapist_name || 'Nieprzypisany',
                  session_time: therapyEvent?.starts_at ? therapyEvent.starts_at.split('T')[1]?.slice(0,5) : '09:00',
                  service_type: 'therapy'
                };
              });

              logDebug('Przefiltrowana lista klientów:', scheduledClients);
            } else {
              // Jeśli nie ma endpointu z wydarzeniami, zwróć wszystkich aktywnych
              scheduledClients = allClients.filter(c => c.active !== false);
              logDebug('Używam wszystkich aktywnych klientów:', scheduledClients.length);
            }
          } catch (e3) {
            logDebug('Błąd pobierania wydarzeń, używam wszystkich klientów');
            scheduledClients = allClients.filter(c => c.active !== false);
          }
        }

        currentScheduledClients = scheduledClients;
        logDebug('Finalna lista do wyświetlenia:', currentScheduledClients.length);

        // Pobierz istniejące dane obecności
        await loadExistingAttendance(selectedDate);

      } catch (error) {
        console.error('Błąd ładowania klientów:', error);
        logDebug('BŁĄD:', error.message);
        showAlert('Błąd ładowania danych: ' + error.message, 'danger');
        displayClients([]);
      }
    }

    async function loadExistingAttendance(date) {
      try {
        logDebug('Pobieram dane obecności dla:', date);
        const response = await fetch(`${API_URL}/api/attendance?date=${date}`);
        let attendanceData = [];

        if (response.ok) {
          attendanceData = await response.json();
          logDebug('Otrzymano dane obecności:', attendanceData);
        } else {
          logDebug('Brak zapisanej obecności dla tej daty');
        }

        // Połącz dane
        const clientsWithAttendance = currentScheduledClients.map(client => {
          const cid = client.client_id || client.id;
          const clientAttendance = attendanceData.find(a => a.client_id === cid);

          return {
            client_id: cid,
            full_name: client.full_name,
            phone: client.phone || 'Brak',
            email: client.email || 'Brak',
            photo_url: client.photo_url,
            therapist_name: client.therapist_name || 'Nieprzypisany',
            service_name: client.service_name || 'Zajęcia',
            session_time: clientAttendance?.session_time || client.session_time || '09:00',
            present: clientAttendance?.status || null,
            notes: clientAttendance?.notes || '',
            service_type: clientAttendance?.service_type || client.service_type || 'therapy',
            therapist_id: clientAttendance?.therapist_id || client.therapist_id || 1
          };
        });

        logDebug('Lista z obecnością:', clientsWithAttendance);
        displayClients(clientsWithAttendance);
        updateSummary(clientsWithAttendance);

        if (clientsWithAttendance.length === 0) {
          showAlert('Brak zaplanowanych zajęć na wybraną datę', 'info');
        } else {
          showAlert(`Załadowano ${clientsWithAttendance.length} klientów`, 'success');
        }

      } catch (error) {
        console.error('Błąd ładowania obecności:', error);
        logDebug('Błąd obecności:', error.message);

        // Wyświetl bez danych obecności
        const clients = currentScheduledClients.map(client => ({
          client_id: client.client_id || client.id,
          full_name: client.full_name,
          phone: client.phone || 'Brak',
          email: client.email || 'Brak',
          photo_url: client.photo_url,
          therapist_name: client.therapist_name || 'Nieprzypisany',
          service_name: client.service_name || 'Zajęcia',
          session_time: client.session_time || '09:00',
          present: null,
          notes: '',
          service_type: client.service_type || 'therapy',
          therapist_id: client.therapist_id || 1
        }));

        displayClients(clients);
        updateSummary(clients);
      }
    }

    function displayClients(clients) {
  const tbody = document.getElementById('attendanceBody');
  tbody.innerHTML = '';

  if (clients.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-muted py-4">
          <i class="bi bi-calendar-x display-4 d-block mb-2"></i>
          Brak zaplanowanych zajęć na wybraną datę
        </td>
      </tr>
    `;
    return;
  }

  clients.forEach(client => {
    const statusClass = getStatusClass(client.present);
    const initials = (client.full_name || 'K').charAt(0).toUpperCase();

    // SVG avatar zamiast via.placeholder.com
    const avatarSVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.35em' fill='white' font-size='18' font-family='Arial'%3E${initials}%3C/text%3E%3C/svg%3E`;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <img src="${client.photo_url || avatarSVG}"
             alt="${client.full_name || 'Klient'}"
             class="client-photo"
             onerror="this.src='${avatarSVG}'">
      </td>
      <td><strong>${client.full_name || 'Brak danych'}</strong></td>
      <td>${client.phone}</td>
      <td>${client.therapist_name}</td>
      <td>
        <input type="time" class="form-control form-control-sm"
               value="${client.session_time}"
               onchange="updateClientField(${client.client_id}, 'session_time', this.value)">
      </td>
      <td>
        <select class="form-select form-select-sm ${statusClass}"
                onchange="updateClientStatus(${client.client_id}, this.value)">
          <option value="">- Wybierz -</option>
          <option value="obecny" ${client.present === 'obecny' ? 'selected' : ''}>✅ Obecny</option>
          <option value="nieobecny" ${client.present === 'nieobecny' ? 'selected' : ''}>❌ Nieobecny</option>
          <option value="spóźniony" ${client.present === 'spóźniony' ? 'selected' : ''}>⏰ Spóźniony</option>
          <option value="usprawiedliwiony" ${client.present === 'usprawiedliwiony' ? 'selected' : ''}>📝 Usprawiedliwiony</option>
        </select>
      </td>
      <td>
        <input type="text" class="form-control form-control-sm"
               placeholder="Uwagi..."
               value="${client.notes}"
               onchange="updateClientField(${client.client_id}, 'notes', this.value)">
      </td>
    `;
    tbody.appendChild(row);
  });
}

    function getStatusClass(status) {
      switch(status) {
        case 'obecny': return 'status-present';
        case 'nieobecny': return 'status-absent';
        case 'spóźniony': return 'status-late';
        case 'usprawiedliwiony': return 'status-excused';
        default: return '';
      }
    }

    function updateClientStatus(clientId, status) {
      const client = currentScheduledClients.find(c => (c.client_id || c.id) === clientId);
      if (client) {
        client.present = status;
        updateSummary(currentScheduledClients);
      }
    }

    function updateClientField(clientId, field, value) {
      const client = currentScheduledClients.find(c => (c.client_id || c.id) === clientId);
      if (client) {
        client[field] = value;
      }
    }

    function updateSummary(clients) {
      const total = clients.length;
      const present = clients.filter(c => c.present === 'obecny').length;
      const absent = clients.filter(c => c.present === 'nieobecny').length;
      const other = total - present - absent;

      document.getElementById('totalClients').textContent = total;
      document.getElementById('presentCount').textContent = present;
      document.getElementById('absentCount').textContent = absent;
      document.getElementById('otherCount').textContent = other;
    }

    function filterClients() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#attendanceBody tr');

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    }

    async function saveAllAttendance() {
      const selectedDate = document.getElementById('selectedDate').value;

      if (!selectedDate) {
        showAlert('Wybierz datę przed zapisem', 'warning');
        return;
      }

      if (currentScheduledClients.length === 0) {
        showAlert('Brak klientów do zapisania', 'warning');
        return;
      }

      const attendanceData = currentScheduledClients
        .filter(client => client.present) // Tylko ze statusem
        .map(client => ({
          client_id: client.client_id || client.id,
          date: selectedDate,
          status: client.present,
          notes: client.notes || '',
          session_time: client.session_time || '09:00',
          service_type: client.service_type || 'therapy',
          therapist_id: client.therapist_id || 1
        }));

      if (attendanceData.length === 0) {
        showAlert('Brak danych do zapisania. Ustaw statusy obecności.', 'warning');
        return;
      }

      logDebug('Zapisuję obecność:', attendanceData);

      try {
        const response = await fetch(`${API_URL}/api/attendance/bulk`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: selectedDate,
            attendance: attendanceData
          })
        });

        if (response.ok) {
          const result = await response.json();
          showAlert(`✅ Obecność zapisana dla ${result.count || attendanceData.length} klientów`, 'success');
          logDebug('Zapis sukces:', result);
        } else {
          const errorText = await response.text();
          throw new Error(errorText || 'Błąd zapisu danych');
        }
      } catch (error) {
        showAlert('❌ Błąd podczas zapisywania: ' + error.message, 'danger');
        logDebug('Błąd zapisu:', error);
      }
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      if (type !== 'danger') {
        setTimeout(() => {
          const alert = alertBox.querySelector('.alert');
          if (alert) alert.remove();
        }, 5000);
      }
    }
  </script>
</body>

</html>

