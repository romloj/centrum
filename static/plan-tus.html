<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Plan TUS - Widok Globalny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { padding: 1rem; background-color: #f8f9fa; }
    .month-wrap { border:1px solid var(--bs-border-color); border-radius:.5rem; overflow:hidden; }
    .month-head { display:grid; grid-template-columns: repeat(7, 1fr); background: #fff; border-bottom:1px solid var(--bs-border-color); }
    .month-head div { padding:.5rem; font-weight:600; text-align:center; }
    .month-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
    .day-cell { min-height:140px; border-left:1px solid var(--bs-border-color); border-top:1px solid var(--bs-border-color); padding:.25rem; }
    .day-cell:nth-child(7n+1) { border-left:0; }
    .day-num { font-size:12px; color: var(--bs-secondary-color); }
    .muted-month { background-color: var(--bs-tertiary-bg); opacity:.7; }
    .day-chip {
        font-size: 11px; padding: .2rem .4rem; margin-top: .2rem;
        border-radius: .25rem; border: 1px solid;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block;
    }
      .fab-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1050;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
    }
    .fab-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--bs-primary);
        color: white;
        font-size: 1.8rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        text-decoration: none;
        transition: transform 0.3s ease, background-color 0.3s ease;
        border: none;
    }
    .fab-button:hover {
        transform: scale(1.1);
        background-color: var(--bs-primary-dark);
    }
    .fab-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        gap: 0.75rem;
        transform: scaleY(0);
        transform-origin: bottom;
        transition: transform 0.3s ease;
    }
    .fab-container.open .fab-menu {
        transform: scaleY(1);
    }
    .fab-menu-item a {
        width: 48px;
        height: 48px;
        font-size: 1.4rem;
        background-color: var(--bs-secondary);
    }
    .fab-container.open #fab-main-icon {
        transform: rotate(45deg);
    }
    #fab-main-icon {
        transition: transform 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <header class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <h1 class="h4 m-0">üóìÔ∏è Globalny Plan Grup TUS</h1>
      <div class="ms-auto d-flex gap-2">
        <input type="month" id="refMonth" class="form-control" style="width: 150px;" />
        <div class="btn-group">
          <button id="btnPrev" class="btn btn-outline-secondary">¬´</button>
          <button id="btnToday" class="btn btn-outline-secondary">Dzi≈õ</button>
          <button id="btnNext" class="btn btn-outline-secondary">¬ª</button>
        </div>
      </div>
    </header>
    <main id="calendarHost"></main>
  </div>
<!-- menu-->
    <div class="fab-container" id="fab-container">
    <ul class="fab-menu">
        <li class="fab-menu-item">
            <a href="therapist.html" class="fab-button" title="Plan terapeuty"><i class="bi bi-heart-pulse"></i></a>
        </li>
        <li class="fab-menu-item">
            <a href="tus.html" class="fab-button" title="Modu≈Ç TUS"><i class="bi bi-star-fill"></i></a>
        </li>
        <li class="fab-menu-item">
            <a href="klienci.html" class="fab-button" title="Lista klient√≥w"><i class="bi bi-people-fill"></i></a>
        </li>

         <li class="fab-menu-item">
            <a href="client_history.html" class="fab-button" title="Historia klient√≥w"><i class="bi bi-people-fill"></i></a>
        </li>
         <li class="fab-menu-item">
            <a href="index.html" class="fab-button" title="Strona g≈Ç√≥wna"><i class="bi bi-house-x-fill"></i></a>
        </li>



    </ul>
    <button class="fab-button" id="fab-main-btn" aria-label="Rozwi≈Ñ menu">
        <i class="bi bi-plus-lg" id="fab-main-icon"></i>
    </button>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = "/api";
    const DOW_SHORT = ["Pn", "Wt", "≈ör", "Cz", "Pt", "So", "Nd"];

    const refMonthInput = document.getElementById('refMonth');
    const calendarHost = document.getElementById('calendarHost');

    let currentDate = new Date();

    function fmtYYYYMMDD(date) {
        if (!date || isNaN(date)) return "";
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    const colorForId = (id) => {
      const h = (Number(id) * 47) % 360;
      return { bg: `hsl(${h} 75% 95%)`, border: `hsl(${h} 75% 80%)` };
    };

    const renderMonth = (sessions) => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstOfMonth = new Date(year, month, 1);
        const dow = (firstOfMonth.getDay() + 6) % 7;
        const startOfGrid = new Date(firstOfMonth);
        startOfGrid.setDate(firstOfMonth.getDate() - dow);

        const days = Array.from({ length: 42 }, (_, i) => new Date(startOfGrid.getFullYear(), startOfGrid.getMonth(), startOfGrid.getDate() + i));

        const eventsByDate = new Map();
        for (const s of sessions) {
            // --- OSTATECZNA POPRAWKA ---
            // Ucinamy datƒô do formatu RRRR-MM-DD, aby klucz by≈Ç sp√≥jny.
            const key = s.session_date.slice(0, 10);
            // --- KONIEC POPRAWKI ---

            if (!eventsByDate.has(key)) eventsByDate.set(key, []);
            eventsByDate.get(key).push(s);
        }

        const head = `<div class="month-head">${DOW_SHORT.map(d => `<div>${d}</div>`).join("")}</div>`;

        const grid = days.map(d => {
            const key = fmtYYYYMMDD(d);
            const items = eventsByDate.get(key) || [];
            const mutedClass = d.getMonth() !== month ? " muted-month" : "";

            const chips = items.map(item => {
                const colors = colorForId(item.group_id);
                const memberNames = (item.members || []).map(m => m.name).join(', ');
                const time = (item.session_time || '').slice(0, 5);
                return `<div class="day-chip" style="background-color:${colors.bg}; border-color:${colors.border};"
                             title="${item.group_name}: ${memberNames}">
                          <strong>${time ? time + ' -' : ''}</strong> ${item.group_name} (${item.therapist_name})
                        </div>`;
            }).join("");

            return `<div class="day-cell${mutedClass}">
                        <div class="day-num">${d.getDate()}</div>
                        ${chips}
                    </div>`;
        }).join("");

        calendarHost.innerHTML = `<div class="month-wrap">${head}<div class="month-grid">${grid}</div></div>`;
    };

    const loadAndRender = async () => {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        refMonthInput.value = `${year}-${month}`;
        calendarHost.innerHTML = '<div class="text-center p-5">≈Åadowanie...</div>';

        try {
            const response = await fetch(`${API_URL}/tus/schedule?month=${year}-${month}`);
            if (!response.ok) throw new Error(`B≈ÇƒÖd serwera: ${response.statusText}`);
            const sessions = await response.json();
            renderMonth(sessions);
        } catch (error) {
            calendarHost.innerHTML = `<div class="alert alert-danger">B≈ÇƒÖd ≈Çadowania planu: ${error.message}</div>`;
        }
    };

    const shiftMonth = (offset) => {
        currentDate.setMonth(currentDate.getMonth() + offset, 1);
        loadAndRender();
    };

    document.getElementById('btnPrev').addEventListener('click', () => shiftMonth(-1));
    document.getElementById('btnNext').addEventListener('click', () => shiftMonth(1));
    document.getElementById('btnToday').addEventListener('click', () => {
        currentDate = new Date();
        loadAndRender();
    });
    refMonthInput.addEventListener('change', () => {
        const [year, month] = refMonthInput.value.split('-').map(Number);
        currentDate = new Date(year, month - 1, 1);
        loadAndRender();
    });

    loadAndRender();
});
    document.addEventListener('DOMContentLoaded', () => {
        const fabContainer = document.getElementById('fab-container');
        const fabMainBtn = document.getElementById('fab-main-btn');

        fabMainBtn.addEventListener('click', () => {
            fabContainer.classList.toggle('open');
        });
    });

</script>
</body>
</html>