<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprawozdania z Dzia≈Çalno≈õci</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
        }

        .back-btn {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        .settings-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .settings-panel h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .report-preview {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 500px;
            overflow-x: auto;
        }

        .official-form {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.3;
            width: 100%;
        }

        .official-form table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            table-layout: fixed;
        }

        .official-form th,
        .official-form td {
            border: 1px solid #000;
            padding: 6px 8px;
            vertical-align: top;
            word-wrap: break-word;
        }

        .official-form th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        .official-form .section-header {
            background-color: #e0e0e0;
            font-weight: bold;
            padding: 10px;
            text-align: left;
        }

        .official-form .centered {
            text-align: center;
        }

        .official-form .small-text {
            font-size: 9pt;
        }

        .official-form .signature-area {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid #000;
        }

        .form-field {
            min-height: 20px;
            display: block;
            width: 100%;
        }

        .editable-field {
            border-bottom: 1px dashed #666;
            cursor: text;
            min-height: 18px;
        }

        .editable-field:focus {
            outline: none;
            background-color: #f0f8ff;
            border-bottom: 1px solid #667eea;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .settings-panel,
            .header,
            .back-btn,
            .btn {
                display: none !important;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .report-preview {
                box-shadow: none;
                padding: 20px;
            }
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .settings-panel {
                position: static;
            }
        }

        .form-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .form-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Sprawozdania z Dzia≈Çalno≈õci</h1>
            <a href="index.html" class="back-btn">‚Üê Powr√≥t</a>
        </div>

        <div class="content-grid">
            <div class="settings-panel">
                <h3>Ustawienia Sprawozdania</h3>

                <!-- SEKCJA: Wyszukiwanie KRS -->
                <div class="form-group" style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="color: #667eea; font-size: 16px;">üîç Pobierz dane z KRS</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="text" id="krsSearch" placeholder="Wpisz numer KRS..."
                               style="flex: 1;" maxlength="10">
                        <button class="btn btn-primary" onclick="fetchKRSData()"
                                style="width: auto; padding: 10px 20px; margin: 0;">
                            üîç Szukaj
                        </button>
                    </div>
                    <div id="krsStatus" style="margin-top: 10px; font-size: 13px;"></div>
                </div>

                <div class="form-group">
                    <label>Typ sprawozdania</label>
                    <select id="reportType" onchange="generateReport()">
                        <option value="official">Oficjalne (MS)</option>
                        <option value="summary">Podsumowanie</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Rok sprawozdawczy</label>
                    <select id="yearSelect" onchange="generateReport()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>

                <!-- SEKCJA: Dane podstawowe fundacji -->
                <div class="form-section">
                    <h4>Dane podstawowe fundacji</h4>
                    <div class="form-group">
                        <label>Nazwa fundacji</label>
                        <input type="text" id="foundationName" value="Fundacja Odnowa" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>NIP fundacji</label>
                        <input type="text" id="foundationNIP" placeholder="123-456-78-90" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>REGON fundacji</label>
                        <input type="text" id="foundationREGON" placeholder="123456789" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>KRS fundacji</label>
                        <input type="text" id="foundationKRS" placeholder="0000123456" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Data wpisu do KRS</label>
                        <input type="text" id="krsDate" placeholder="RRRR-MM-DD" onchange="generateReport()">
                    </div>
                </div>

                <!-- SEKCJA: Adres fundacji -->
                <div class="form-section">
                    <h4>Adres fundacji</h4>
                    <div class="form-group">
                        <label>Ulica</label>
                        <input type="text" id="foundationStreet" placeholder="ul. Przyk≈Çadowa" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Numer domu</label>
                        <input type="text" id="foundationHouseNo" placeholder="123" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Miejscowo≈õƒá</label>
                        <input type="text" id="foundationCity" placeholder="Warszawa" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Kod pocztowy</label>
                        <input type="text" id="foundationPostalCode" placeholder="00-001" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Wojew√≥dztwo</label>
                        <input type="text" id="foundationProvince" placeholder="mazowieckie" onchange="generateReport()">
                    </div>
                </div>

                <!-- SEKCJA: Cz≈Çonkowie zarzƒÖdu -->
                <div class="form-section">
                    <h4>Cz≈Çonkowie zarzƒÖdu</h4>
                    <div class="form-group">
                        <label>Prezes</label>
                        <input type="text" id="boardPresident" placeholder="Jan Kowalski" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Wiceprezes</label>
                        <input type="text" id="boardVicePresident" placeholder="Anna Nowak" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Cz≈Çonek zarzƒÖdu</label>
                        <input type="text" id="boardMember" placeholder="Piotr Wi≈õniewski" onchange="generateReport()">
                    </div>
                </div>

                <!-- SEKCJA: Cele statutowe -->
                <div class="form-section">
                    <h4>Cele statutowe</h4>
                    <div class="form-group">
                        <label>Wszystkie cele statutowe fundacji</label>
                        <textarea id="foundationGoals" placeholder="Wpisz cele statutowe fundacji..." onchange="generateReport()"></textarea>
                    </div>
                </div>

                <!-- SEKCJA: Dane finansowe -->
                <div class="form-section">
                    <h4>Dane finansowe</h4>
                    <div class="form-group">
                        <label>Przychody z dzia≈Çalno≈õci statutowej (przelew)</label>
                        <input type="number" id="incomeStatutory" placeholder="0" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Koszty realizacji cel√≥w statutowych</label>
                        <input type="number" id="costsStatutory" placeholder="0" onchange="generateReport()">
                    </div>

                    <div class="form-group">
                        <label>Koszty administracyjne</label>
                        <input type="number" id="costsAdmin" placeholder="0" onchange="generateReport()">
                    </div>
                </div>

                <!-- SEKCJA: Filtry projekt√≥w -->
                <div class="form-section">
                    <h4>Filtry projekt√≥w</h4>
                    <div class="form-group">
                        <label>Szukaj projektu</label>
                        <div style="position: relative;">
                            <input type="text" id="searchProject" placeholder="üîç Wpisz nazwƒô projektu..."
                                   oninput="generateReport()"
                                   style="padding-left: 35px;">
                            <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999;">üîç</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Status projekt√≥w</label>
                        <select id="statusFilter" onchange="generateReport()">
                            <option value="">Wszystkie</option>
                            <option value="w_trakcie">W trakcie</option>
                            <option value="zako≈Ñczony">Zako≈Ñczone</option>
                            <option value="planowany">Planowane</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateReport()">üîÑ Od≈õwie≈º Sprawozdanie</button>
                <button class="btn btn-success" onclick="downloadDOCX()">üì• Pobierz DOCX</button>
                <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Drukuj PDF</button>
            </div>

            <div class="report-preview" id="reportPreview">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>≈Åadowanie danych...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let projectsData = [];

        // Za≈Çaduj dane przy starcie
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
        });

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                projectsData = await response.json();
                generateReport();
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania projekt√≥w:', error);
                document.getElementById('reportPreview').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Uwaga:</strong> Nie uda≈Ço siƒô za≈Çadowaƒá danych projekt√≥w.
                        Upewnij siƒô, ≈ºe serwer API jest uruchomiony.
                    </div>
                `;
            }
        }

        async function fetchKRSData() {
            const krsNumber = document.getElementById('krsSearch').value.trim();
            const statusDiv = document.getElementById('krsStatus');

            if (!krsNumber) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è Podaj numer KRS</span>';
                return;
            }

            // Walidacja numeru KRS (10 cyfr)
            if (!/^\d{10}$/.test(krsNumber)) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è Numer KRS musi mieƒá 10 cyfr</span>';
                return;
            }

            statusDiv.innerHTML = '<span style="color: #667eea;">‚è≥ Pobieranie danych...</span>';

            try {
                const response = await fetch('/api/foundation/fetch-krs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ krs: krsNumber })
                });

                const data = await response.json();

                if (response.ok) {
                    // Wype≈Çnij pola danymi z KRS
                    document.getElementById('foundationName').value = data.name || '';
                    document.getElementById('foundationNIP').value = data.nip || '';
                    document.getElementById('foundationREGON').value = data.regon || '';
                    document.getElementById('foundationKRS').value = data.krs || '';
                    document.getElementById('foundationStreet').value = data.street || '';
                    document.getElementById('foundationCity').value = data.city || '';
                    document.getElementById('foundationPostalCode').value = data.postalCode || '';

                    statusDiv.innerHTML = '<span style="color: #28a745;">‚úì Dane pobrane i zapisane!</span>';

                    // Automatycznie od≈õwie≈º sprawozdanie
                    setTimeout(() => {
                        generateReport();
                        statusDiv.innerHTML = '';
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ö†Ô∏è ${data.error}</span>`;
                }
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia z serwerem</span>';
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;

            if (reportType === 'official') {
                generateOfficialReport();
            } else {
                generateSummaryReport();
            }
        }

        function generateOfficialReport() {
            const year = document.getElementById('yearSelect').value;
            const foundationName = document.getElementById('foundationName').value;
            const foundationNIP = document.getElementById('foundationNIP').value;
            const foundationREGON = document.getElementById('foundationREGON').value;
            const foundationKRS = document.getElementById('foundationKRS').value;
            const krsDate = document.getElementById('krsDate').value;
            const foundationStreet = document.getElementById('foundationStreet').value;
            const foundationHouseNo = document.getElementById('foundationHouseNo').value;
            const foundationCity = document.getElementById('foundationCity').value;
            const foundationPostalCode = document.getElementById('foundationPostalCode').value;
            const foundationProvince = document.getElementById('foundationProvince').value;
            const boardPresident = document.getElementById('boardPresident').value;
            const boardVicePresident = document.getElementById('boardVicePresident').value;
            const boardMember = document.getElementById('boardMember').value;
            const foundationGoals = document.getElementById('foundationGoals').value;
            const incomeStatutory = document.getElementById('incomeStatutory').value;
            const costsStatutory = document.getElementById('costsStatutory').value;
            const costsAdmin = document.getElementById('costsAdmin').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredProjects = projectsData.filter(project => {
                const projectYear = project.start_date ? new Date(project.start_date).getFullYear() : null;
                const yearMatch = !project.start_date || projectYear == year ||
                                 (project.end_date && new Date(project.end_date).getFullYear() == year);
                const statusMatch = !statusFilter || project.status === statusFilter;
                return yearMatch && statusMatch;
            });

            const stats = calculateStatistics(filteredProjects);
            const activityDescription = generateActivityDescription(filteredProjects, year, stats);

            const reportHTML = `
                <div class="official-form">
                    <table>
                        <thead>
                            <tr>
                                <th colspan="18" class="centered">
                                    <p><strong>Sprawozdanie z dzia≈Çalno≈õci fundacji</strong></p>
                                    <p>za rok ${year}</p>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="18">
                                    <p>Podstawa prawna:</p>
                                    <p><em>Ustawa z dnia 6 kwietnia 1984 r. o fundacjach</em> (Dz.U. 2020 r. poz. 2167 oraz z 2022 r. poz. 2185)</p>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="18">
                                    <ul>
                                        <li>Sprawozdawca wype≈Çnia tylko przeznaczone dla niego bia≈Çe pola;</li>
                                        <li>We wszystkich polach, w kt√≥rych nie bƒôdƒÖ wpisane odpowiednie informacje, nale≈ºy wstawiƒá pojedynczy znak my≈õlnika <strong>(‚Äì)</strong>;</li>
                                        <li>Pola wyboru nale≈ºy uzupe≈Çniƒá przez wstawienie pojedynczego znaku X.</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="18"><strong>Nazwa organu sprawujƒÖcego nadz√≥r:</strong> <span class="editable-field form-field" contenteditable="true">Minister Sprawiedliwo≈õci</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">I. Dane fundacji</td>
                            </tr>
                            <tr>
                                <td colspan="2">1. Nazwa fundacji</td>
                                <td colspan="16"><span class="editable-field form-field" contenteditable="true">${foundationName}</span></td>
                            </tr>
                            <tr>
                                <td colspan="2" rowspan="4">2. Adres siedziby i dane kontaktowe</td>
                                <td colspan="3">1. Kraj:</td>
                                <td colspan="6"><span class="editable-field form-field" contenteditable="true">Polska</span></td>
                                <td colspan="7">2. Wojew√≥dztwo:</td>
                            </tr>
                            <tr>
                                <td colspan="3">4. Gmina:</td>
                                <td colspan="6"><span class="editable-field form-field" contenteditable="true">${foundationCity}</span></td>
                                <td colspan="7">5. Ulica:</td>
                            </tr>
                            <tr>
                                <td colspan="3">7. Nr lokalu:</td>
                                <td colspan="6"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="7">8. Miejscowo≈õƒá:</td>
                            </tr>
                            <tr>
                                <td colspan="3">10. Nr telefonu (fakultatywne):</td>
                                <td colspan="6"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="7">12. Nr faksu (fakultatywne):</td>
                            </tr>
                            <tr>
                                <td colspan="18">13. Adres do korespondencji (je≈ºeli jest inny ni≈º adres siedziby): <span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18">14. Adres strony internetowej (je≈ºeli fundacja posiada stronƒô www): <span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td>3. Nr REGON:</td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">${foundationREGON || '‚Äì'}</span></td>
                                <td colspan="2">4. Data wpisu do KRS:</td>
                                <td colspan="5"><span class="editable-field form-field" contenteditable="true">${krsDate || '‚Äì'}</span></td>
                                <td colspan="4">5. Nr KRS:</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">${foundationKRS || '‚Äì'}</span></td>
                            </tr>
                            <tr>
                                <td rowspan="2">6. Dane cz≈Çonk√≥w zarzƒÖdu fundacji / dane likwidatora (wed≈Çug aktualnego wpisu w KRS)</td>
                                <td colspan="9">Imiƒô i nazwisko</td>
                                <td colspan="8">Funkcja</td>
                            </tr>
                            <tr>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">${boardPresident || '‚Äì'}</span></td>
                                <td colspan="8"><span class="editable-field form-field" contenteditable="true">Prezes</span></td>
                            </tr>
                            <tr>
                                <td>7. Numer NIP fundacji</td>
                                <td colspan="17"><span class="editable-field form-field" contenteditable="true">${foundationNIP || '‚Äì'}</span></td>
                            </tr>
                            <tr>
                                <td>8. Wszystkie cele statutowe fundacji</td>
                                <td colspan="17"><span class="editable-field form-field" contenteditable="true">${foundationGoals || '‚Äì'}</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">II. Charakterystyka dzia≈Çalno≈õci fundacji w okresie sprawozdawczym <em>(dane odnoszƒÖ siƒô do faktycznie wykonywanej dzia≈Çalno≈õci w roku sprawozdawczym)</em></td>
                            </tr>
                            <tr>
                                <td colspan="18">1. Zasady, formy i zakres dzia≈Çalno≈õci statutowej z podaniem realizacji cel√≥w statutowych</td>
                            </tr>
                            <tr>
                                <td colspan="18"><span class="editable-field form-field" contenteditable="true" style="min-height: 100px;">${activityDescription}</span></td>
                            </tr>
                            <tr>
                                <td colspan="18">2. Opis g≈Ç√≥wnych zdarze≈Ñ prawnych w dzia≈Çalno≈õci fundacji o skutkach finansowych</td>
                            </tr>
                            <tr>
                                <td colspan="18"><span class="editable-field form-field" contenteditable="true" style="min-height: 80px;">W okresie sprawozdawczym nie wystƒÖpi≈Çy szczeg√≥lne zdarzenia prawne o istotnych skutkach finansowych.</span></td>
                            </tr>
                            <tr>
                                <td colspan="9">3. Informacja o tym, czy fundacja prowadzi≈Ça dzia≈Çalno≈õƒá gospodarczƒÖ w okresie sprawozdawczym <em>(zaznaczyƒá odpowiednie pole, w przypadku zaznaczenia odpowiedzi TAK nale≈ºy wype≈Çniƒá rubrykƒô 5 oraz czƒô≈õƒá III rubrykƒô 3)</em></td>
                                <td colspan="3" class="centered"><strong>NIE</strong></td>
                                <td colspan="3" class="centered"><span class="editable-field form-field" contenteditable="true">X</span></td>
                                <td colspan="2" class="centered"><strong>TAK</strong></td>
                                <td class="centered"><span class="editable-field form-field" contenteditable="true"></span></td>
                            </tr>
                            <tr>
                                <td colspan="18" style="text-align: left;">4. Informacja o prowadzonej dzia≈Çalno≈õci gospodarczej wed≈Çug wpisu do rejestru przedsiƒôbiorc√≥w KRS w okresie sprawozdawczym <em>(nale≈ºy podaƒá kody PKD dzia≈Çalno≈õci gospodarczej wpisanej do rejestru przedsiƒôbiorc√≥w KRS wraz z ich opisem s≈Çownym oraz kody i opis s≈Çowny faktycznie prowadzonej dzia≈Çalno≈õci gospodarczej)</em></td>
                            </tr>
                            <tr>
                                <td colspan="18"><span class="editable-field form-field" contenteditable="true" style="min-height: 60px;">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18">5. Czy zarzƒÖd lub rada fundacji w okresie sprawozdawczym podejmowa≈Ç uchwa≈Çy (<em>je≈õli tak, to nale≈ºy do≈ÇƒÖczyƒá odpisy wszystkich uchwa≈Ç podjƒôtych w okresie objƒôtym sprawozdaniem)</em></td>
                            </tr>
                            <tr>
                                <td colspan="18"><span class="editable-field form-field" contenteditable="true" style="min-height: 60px;">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">III. Informacja o wysoko≈õci uzyskanych przychod√≥w</td>
                            </tr>
                            <tr>
                                <td colspan="3" rowspan="3">1. ≈ÅƒÖczna kwota uzyskanych przychod√≥w (suma punkt√≥w a-c)</td>
                                <td colspan="6" class="centered">Kwota <em>(w podziale na formy p≈Çatno≈õci)</em></td>
                                <td colspan="9" class="centered">Inne formy przychodu</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="centered"><p>Przelew</p><p><em>(dotyczy wszystkich rodzaj√≥w p≈Çatno≈õci bezgot√≥wkowych)</em></p></td>
                                <td colspan="2" class="centered">Got√≥wka</td>
                                <td colspan="9" class="centered">Warto≈õƒá innych form przychodu</td>
                            </tr>
                            <tr>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">${formatMoney(incomeStatutory || 0)} PLN</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">a. Przychody z dzia≈Çalno≈õci statutowej</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">${formatMoney(incomeStatutory || 0)} PLN</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">b. Przychody z dzia≈Çalno≈õci gospodarczej</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">c. Pozosta≈Çe przychody</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">2. Informacja o ≈∫r√≥d≈Çach przychod√≥w</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">a. Przychody z dzia≈Çalno≈õci odp≈Çatnej w ramach cel√≥w statutowych</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">b. Ze ≈∫r√≥de≈Ç publicznych og√≥≈Çem, w tym:</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">- ze ≈õrodk√≥w bud≈ºetu pa≈Ñstwa</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">- ze ≈õrodk√≥w bud≈ºetu jednostek samorzƒÖdu terytorialnego</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">- ze ≈õrodk√≥w Unii Europejskiej</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">c. Od os√≥b fizycznych</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">d. Od os√≥b prawnych</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">e. Pozosta≈Çe ≈∫r√≥d≈Ça przychod√≥w</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">IV. Informacja o poniesionych kosztach w okresie sprawozdawczym</td>
                            </tr>
                            <tr>
                                <td colspan="3" rowspan="3">1. ≈ÅƒÖczna kwota poniesionych koszt√≥w (suma punkt√≥w a-c)</td>
                                <td colspan="6" class="centered">Kwota <em>(w podziale na formy p≈Çatno≈õci)</em></td>
                                <td colspan="9" class="centered">Inne formy koszt√≥w</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="centered"><p>Przelew</p><p><em>(dotyczy wszystkich rodzaj√≥w p≈Çatno≈õci bezgot√≥wkowych)</em></p></td>
                                <td colspan="2" class="centered">Got√≥wka</td>
                                <td colspan="9" class="centered">Warto≈õƒá innych form koszt√≥w</td>
                            </tr>
                            <tr>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">${formatMoney((parseInt(costsStatutory || 0) + parseInt(costsAdmin || 0)))} PLN</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">a. Koszty realizacji cel√≥w statutowych</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">${formatMoney(costsStatutory || 0)} PLN</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">b. Koszty dzia≈Çalno≈õci gospodarczej</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">c. Koszty administracyjne</td>
                                <td colspan="4"><span class="editable-field form-field" contenteditable="true">${formatMoney(costsAdmin || 0)} PLN</span></td>
                                <td colspan="2"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                                <td colspan="9"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">V. Informacja o zatrudnieniu i wynagrodzeniu</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. Liczba os√≥b zatrudnionych w fundacji w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">2. ≈ÅƒÖczna kwota wynagrodze≈Ñ wyp≈Çaconych w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">VI. Informacja o sk≈Çadnikach majƒÖtkowych</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. Warto≈õƒá sk≈Çadnik√≥w majƒÖtkowych na dzie≈Ñ 31 grudnia roku sprawozdawczego</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">VII. Informacja o ≈õrodkach pieniƒô≈ºnych</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈örodki pieniƒô≈ºne na rachunkach bankowych na dzie≈Ñ 31 grudnia roku sprawozdawczego</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="3">2. ≈örodki pieniƒô≈ºne w kasie na dzie≈Ñ 31 grudnia roku sprawozdawczego</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">VIII. Informacja o zobowiƒÖzaniach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna kwota zobowiƒÖza≈Ñ na dzie≈Ñ 31 grudnia roku sprawozdawczego</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">IX. Informacja o otrzymanych darowiznach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá otrzymanych darowizn w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">X. Informacja o udzielonych darowiznach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá udzielonych darowizn w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">XI. Informacja o otrzymanych dotacjach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá otrzymanych dotacji w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">XII. Informacja o udzielonych dotacjach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá udzielonych dotacji w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">XIII. Informacja o otrzymanych po≈ºyczkach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá otrzymanych po≈ºyczek w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">XIV. Informacja o udzielonych po≈ºyczkach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá udzielonych po≈ºyczek w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">XV. Informacja o otrzymanych wp≈Çatach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá otrzymanych wp≈Çat w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                            <tr>
                                <td colspan="18" class="section-header">XVI. Informacja o udzielonych wp≈Çatach</td>
                            </tr>
                            <tr>
                                <td colspan="3">1. ≈ÅƒÖczna warto≈õƒá udzielonych wp≈Çat w okresie sprawozdawczym</td>
                                <td colspan="15"><span class="editable-field form-field" contenteditable="true">‚Äì</span></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="signature-area">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="width: 45%;">
                                <p>................................................</p>
                                <p class="small-text">miejscowo≈õƒá, data</p>
                            </div>
                            <div style="width: 45%;">
                                <p>................................................</p>
                                <p class="small-text">podpisy cz≈Çonk√≥w zarzƒÖdu fundacji</p>
                            </div>
                        </div>
                    </div>

                    <p style="margin-top: 40px; font-size: 9pt; color: #666; text-align: center;">
                        <em>Sprawozdanie wygenerowane automatycznie: ${new Date().toLocaleDateString('pl-PL')}</em>
                    </p>
                </div>
            `;

            document.getElementById('reportPreview').innerHTML = reportHTML;
        }

        function generateActivityDescription(projects, year, stats) {
            let description = `W roku ${year} fundacja realizowa≈Ça swoje cele statutowe poprzez prowadzenie ${stats.totalProjects} ${getProjectWord(stats.totalProjects)}. `;

            if (stats.totalBeneficiaries > 0) {
                description += `Z dzia≈Çalno≈õci fundacji skorzysta≈Ço ≈ÇƒÖcznie ${stats.totalBeneficiaries} ${getBeneficiaryWord(stats.totalBeneficiaries)}. `;
            }

            if (projects.length > 0) {
                description += `\n\nRealizowane projekty obejmowa≈Çy nastƒôpujƒÖce obszary:\n\n`;

                projects.forEach((project, index) => {
                    description += `${index + 1}. <strong>${project.title}</strong>\n`;
                    if (project.description) {
                        description += `${project.description}\n`;
                    }
                    description += `Status: ${getStatusLabel(project.status)}`;
                    if (project.start_date) {
                        description += `, okres realizacji: od ${formatDate(project.start_date)}`;
                        if (project.end_date) {
                            description += ` do ${formatDate(project.end_date)}`;
                        }
                    }
                    if (project.beneficiaries_count) {
                        description += `, liczba beneficjent√≥w: ${project.beneficiaries_count}`;
                    }
                    description += `.\n\n`;
                });
            }

            description += `Wszystkie realizowane dzia≈Çania by≈Çy zgodne ze statutem fundacji i s≈Çu≈ºy≈Çy osiƒÖganiu cel√≥w statutowych.`;

            return description.replace(/\n/g, '<br>');
        }

        function generateSummaryReport() {
            const year = document.getElementById('yearSelect').value;
            const foundationName = document.getElementById('foundationName').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredProjects = projectsData.filter(project => {
                const projectYear = project.start_date ? new Date(project.start_date).getFullYear() : null;
                const yearMatch = !project.start_date || projectYear == year ||
                                 (project.end_date && new Date(project.end_date).getFullYear() == year);
                const statusMatch = !statusFilter || project.status === statusFilter;
                return yearMatch && statusMatch;
            });

            const stats = calculateStatistics(filteredProjects);

            const reportHTML = `
                <div class="report-content">
                    <div class="report-header">
                        <h2>Sprawozdanie z Dzia≈Çalno≈õci</h2>
                        <p><strong>${foundationName}</strong></p>
                        <p>Rok ${year}</p>
                    </div>

                    ${filteredProjects.length === 0 ? `
                        <div class="alert alert-info">
                            <strong>Brak danych:</strong> Nie znaleziono projekt√≥w spe≈ÇniajƒÖcych wybrane kryteria dla roku ${year}.
                        </div>
                    ` : ''}

                    <div class="report-section">
                        <h3>1. Podsumowanie Dzia≈Çalno≈õci</h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <span class="stat-value">${stats.totalProjects}</span>
                                <span class="stat-label">Realizowanych<br>Projekt√≥w</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-value">${stats.totalBeneficiaries}</span>
                                <span class="stat-label">Beneficjent√≥w</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-value">${formatMoney(stats.totalBudget)}</span>
                                <span class="stat-label">Bud≈ºet (PLN)</span>
                            </div>
                        </div>
                        <p>
                            W roku ${year} ${foundationName} zrealizowa≈Ça ≈ÇƒÖcznie <strong>${stats.totalProjects} ${getProjectWord(stats.totalProjects)}</strong>.
                            ${stats.completed > 0 ? `Zako≈Ñczono <strong>${stats.completed} ${getProjectWord(stats.completed)}</strong>.` : ''}
                            ${stats.planned > 0 ? `Zaplanowano <strong>${stats.planned} ${getProjectWord(stats.planned)}</strong>.` : ''}
                        </p>
                        ${stats.totalBeneficiaries > 0 ? `
                        <p>
                            Z dzia≈Çalno≈õci fundacji skorzysta≈Ço ≈ÇƒÖcznie <strong>${stats.totalBeneficiaries} ${getBeneficiaryWord(stats.totalBeneficiaries)}</strong>.
                        </p>
                        ` : ''}
                    </div>

                    ${filteredProjects.length > 0 ? `
                    <div class="report-section">
                        <h3>2. Realizowane Projekty</h3>
                        <div class="project-list">
                            ${filteredProjects.map((project, index) => `
                                <div class="project-item">
                                    <h4>${index + 1}. ${project.title}</h4>
                                    ${project.description ? `<p>${project.description}</p>` : ''}
                                    <div class="project-meta">
                                        <span class="meta-badge">Status: ${getStatusLabel(project.status)}</span>
                                        ${project.start_date ? `<span class="meta-badge">Od: ${formatDate(project.start_date)}</span>` : ''}
                                        ${project.end_date ? `<span class="meta-badge">Do: ${formatDate(project.end_date)}</span>` : ''}
                                        ${project.budget ? `<span class="meta-badge">Bud≈ºet: ${formatMoney(project.budget)} PLN</span>` : ''}
                                        ${project.beneficiaries_count ? `<span class="meta-badge">Beneficjenci: ${project.beneficiaries_count}</span>` : ''}
                                        ${project.coordinator ? `<span class="meta-badge">Koordynator: ${project.coordinator}</span>` : ''}
                                    </div>
                                    ${project.partners ? `<p style="margin-top: 8px;"><strong>Partnerzy:</strong> ${project.partners}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="report-section">
                        <h3>3. Wnioski i Perspektywy</h3>
                        <p>
                            Rok ${year} by≈Ç okresem ${stats.totalProjects > 5 ? 'intensywnej' : 'systematycznej'} dzia≈Çalno≈õci ${foundationName}.
                            ${stats.completed > 0 ? `Zako≈Ñczenie ${stats.completed} ${getProjectWord(stats.completed)} potwierdza skuteczno≈õƒá realizowanych dzia≈Ça≈Ñ.` : ''}
                            ${stats.inProgress > 0 ? `Kontynuacja ${stats.inProgress} ${getProjectWord(stats.inProgress)} zapewnia ciƒÖg≈Ço≈õƒá wsparcia dla beneficjent√≥w.` : ''}
                        </p>
                        ${stats.planned > 0 ? `
                        <p>
                            Planowanie ${stats.planned} ${stats.planned === 1 ? 'nowego projektu' : 'nowych projekt√≥w'}
                            ≈õwiadczy o dynamicznym rozwoju organizacji i odpowiedzi na potrzeby spo≈Çeczne.
                        </p>
                        ` : ''}
                    </div>

                    <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #e0e0e0; text-align: center; color: #666;">
                        <p>Sprawozdanie wygenerowane: ${new Date().toLocaleDateString('pl-PL')}</p>
                    </div>
                </div>
            `;

            document.getElementById('reportPreview').innerHTML = reportHTML;
        }

        function calculateStatistics(projects) {
            return {
                totalProjects: projects.length,
                inProgress: projects.filter(p => p.status === 'w_trakcie').length,
                completed: projects.filter(p => p.status === 'zako≈Ñczony').length,
                planned: projects.filter(p => p.status === 'planowany').length,
                totalBeneficiaries: projects.reduce((sum, p) => sum + (parseInt(p.beneficiaries_count) || 0), 0),
                totalBudget: projects.reduce((sum, p) => sum + (parseFloat(p.budget) || 0), 0)
            };
        }

        function getStatusLabel(status) {
            const labels = {
                'planowany': 'Planowany',
                'w_trakcie': 'W trakcie',
                'zako≈Ñczony': 'Zako≈Ñczony'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL');
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('pl-PL', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getProjectWord(count) {
            if (count === 1) return 'projekt';
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return 'projekty';
            return 'projekt√≥w';
        }

        function getBeneficiaryWord(count) {
            if (count === 1) return 'beneficjent';
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return 'beneficjent√≥w';
            return 'beneficjent√≥w';
        }

        async function downloadDOCX() {
    const year = document.getElementById('yearSelect').value;
    const foundationName = document.getElementById('foundationName').value;
    const foundationNIP = document.getElementById('foundationNIP').value;
    const foundationREGON = document.getElementById('foundationREGON').value;
    const foundationKRS = document.getElementById('foundationKRS').value;
    const krsDate = document.getElementById('krsDate').value;
    const foundationStreet = document.getElementById('foundationStreet').value;
    const foundationHouseNo = document.getElementById('foundationHouseNo').value;
    const foundationCity = document.getElementById('foundationCity').value;
    const foundationPostalCode = document.getElementById('foundationPostalCode').value;
    const foundationProvince = document.getElementById('foundationProvince').value;
    const boardPresident = document.getElementById('boardPresident').value;
    const boardVicePresident = document.getElementById('boardVicePresident').value;
    const boardMember = document.getElementById('boardMember').value;
    const foundationGoals = document.getElementById('foundationGoals').value;
    const incomeStatutory = document.getElementById('incomeStatutory').value;
    const costsStatutory = document.getElementById('costsStatutory').value;
    const costsAdmin = document.getElementById('costsAdmin').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const reportType = document.getElementById('reportType').value;

    let filteredProjects = projectsData.filter(project => {
        const projectYear = project.start_date ? new Date(project.start_date).getFullYear() : null;
        const yearMatch = !project.start_date || projectYear == year ||
                         (project.end_date && new Date(project.end_date).getFullYear() == year);
        const statusMatch = !statusFilter || project.status === statusFilter;
        return yearMatch && statusMatch;
    });

    const stats = calculateStatistics(filteredProjects);
    const activityDescription = generateActivityDescription(filteredProjects, year, stats);

    const { Document, Paragraph, TextRun, Table, TableCell, TableRow, WidthType, AlignmentType, HeadingLevel, BorderStyle } = docx;

    let sections = [];

    if (reportType === 'official') {
        // Nag≈Ç√≥wek dokumentu
        sections.push(
            new Paragraph({
                text: "Sprawozdanie z dzia≈Çalno≈õci fundacji",
                heading: HeadingLevel.HEADING_1,
                alignment: AlignmentType.CENTER,
                spacing: { after: 200 }
            }),
            new Paragraph({
                text: `za rok ${year}`,
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            }),
            new Paragraph({
                text: "Podstawa prawna: Ustawa z dnia 6 kwietnia 1984 r. o fundacjach (Dz.U. 2020 r. poz. 2167 oraz z 2022 r. poz. 2185)",
                alignment: AlignmentType.LEFT,
                spacing: { after: 400 }
            })
        );

        // Instrukcje wype≈Çniania
        sections.push(
            new Paragraph({
                text: "Instrukcja:",
                spacing: { before: 200, after: 100 }
            }),
            new Paragraph({
                text: "- Sprawozdawca wype≈Çnia tylko przeznaczone dla niego bia≈Çe pola;",
                spacing: { after: 50 }
            }),
            new Paragraph({
                text: "- We wszystkich polach, w kt√≥rych nie bƒôdƒÖ wpisane odpowiednie informacje, nale≈ºy wstawiƒá pojedynczy znak my≈õlnika (‚Äì);",
                spacing: { after: 50 }
            }),
            new Paragraph({
                text: "- Pola wyboru nale≈ºy uzupe≈Çniƒá przez wstawienie pojedynczego znaku X.",
                spacing: { after: 400 }
            })
        );

        // Sekcja I - Dane fundacji
        sections.push(
            new Paragraph({
                text: "I. Dane fundacji",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            })
        );

        // Tabela z danymi fundacji
        const foundationDataTable = new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
                top: { style: BorderStyle.SINGLE },
                bottom: { style: BorderStyle.SINGLE },
                left: { style: BorderStyle.SINGLE },
                right: { style: BorderStyle.SINGLE },
                insideHorizontal: { style: BorderStyle.SINGLE },
                insideVertical: { style: BorderStyle.SINGLE },
            },
            rows: [
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "1. Nazwa fundacji" })],
                            width: { size: 30, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: foundationName || "‚Äì" })],
                            width: { size: 70, type: WidthType.PERCENTAGE }
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "2. Adres siedziby" })],
                            rowSpan: 4
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: `Kraj: Polska, Wojew√≥dztwo: ${foundationProvince || "‚Äì"}` })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: `Gmina: ${foundationCity || "‚Äì"}, Ulica: ${foundationStreet || "‚Äì"}` })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: `Nr lokalu: ‚Äì, Miejscowo≈õƒá: ${foundationCity || "‚Äì"}` })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: `Nr telefonu: ‚Äì, Adres e-mail: ‚Äì` })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "3. Nr REGON" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: foundationREGON || "‚Äì" })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "4. Data wpisu do KRS" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: krsDate || "‚Äì" })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "5. Nr KRS" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: foundationKRS || "‚Äì" })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "6. Cz≈Çonkowie zarzƒÖdu" })]
                        }),
                        new TableCell({
                            children: [
                                new Paragraph({ text: `${boardPresident || "‚Äì"} - Prezes` }),
                                new Paragraph({ text: `${boardVicePresident || "‚Äì"} - Wiceprezes` }),
                                new Paragraph({ text: `${boardMember || "‚Äì"} - Cz≈Çonek` })
                            ]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "7. NIP fundacji" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: foundationNIP || "‚Äì" })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "8. Cele statutowe" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: foundationGoals || "‚Äì" })]
                        })
                    ]
                })
            ]
        });

        sections.push(foundationDataTable);

        // Sekcja II - Charakterystyka dzia≈Çalno≈õci
        sections.push(
            new Paragraph({
                text: "II. Charakterystyka dzia≈Çalno≈õci fundacji w okresie sprawozdawczym",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            }),
            new Paragraph({
                text: "1. Zasady, formy i zakres dzia≈Çalno≈õci statutowej z podaniem realizacji cel√≥w statutowych",
                bold: true,
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: activityDescription.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, ''),
                spacing: { after: 400 }
            }),
            new Paragraph({
                text: "2. Opis g≈Ç√≥wnych zdarze≈Ñ prawnych w dzia≈Çalno≈õci fundacji o skutkach finansowych",
                bold: true,
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: "W okresie sprawozdawczym nie wystƒÖpi≈Çy szczeg√≥lne zdarzenia prawne o istotnych skutkach finansowych.",
                spacing: { after: 400 }
            })
        );

        // Sekcja III - Informacja o przychodach
        sections.push(
            new Paragraph({
                text: "III. Informacja o wysoko≈õci uzyskanych przychod√≥w",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            })
        );

        const incomeTable = new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
                top: { style: BorderStyle.SINGLE },
                bottom: { style: BorderStyle.SINGLE },
                left: { style: BorderStyle.SINGLE },
                right: { style: BorderStyle.SINGLE },
                insideHorizontal: { style: BorderStyle.SINGLE },
                insideVertical: { style: BorderStyle.SINGLE },
            },
            rows: [
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "≈πr√≥d≈Ço przychodu" })],
                            width: { size: 40, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "Przelew", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "Got√≥wka", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "Inne formy", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "≈ÅƒÖczna kwota przychod√≥w" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: `${formatMoney(incomeStatutory || 0)} PLN`, alignment: AlignmentType.RIGHT })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "a. Przychody z dzia≈Çalno≈õci statutowej" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: `${formatMoney(incomeStatutory || 0)} PLN`, alignment: AlignmentType.RIGHT })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "b. Przychody z dzia≈Çalno≈õci gospodarczej" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "c. Pozosta≈Çe przychody" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                })
            ]
        });

        sections.push(incomeTable);

        // Sekcja IV - Informacja o kosztach
        sections.push(
            new Paragraph({
                text: "IV. Informacja o poniesionych kosztach w okresie sprawozdawczym",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            })
        );

        const costsTable = new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
                top: { style: BorderStyle.SINGLE },
                bottom: { style: BorderStyle.SINGLE },
                left: { style: BorderStyle.SINGLE },
                right: { style: BorderStyle.SINGLE },
                insideHorizontal: { style: BorderStyle.SINGLE },
                insideVertical: { style: BorderStyle.SINGLE },
            },
            rows: [
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "Rodzaj kosztu" })],
                            width: { size: 40, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "Przelew", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "Got√≥wka", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "Inne formy", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "≈ÅƒÖczna kwota koszt√≥w" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: `${formatMoney((parseInt(costsStatutory || 0) + parseInt(costsAdmin || 0)))} PLN`, alignment: AlignmentType.RIGHT })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "a. Koszty realizacji cel√≥w statutowych" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: `${formatMoney(costsStatutory || 0)} PLN`, alignment: AlignmentType.RIGHT })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "b. Koszty dzia≈Çalno≈õci gospodarczej" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                }),
                new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ text: "c. Koszty administracyjne" })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: `${formatMoney(costsAdmin || 0)} PLN`, alignment: AlignmentType.RIGHT })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        }),
                        new TableCell({
                            children: [new Paragraph({ text: "‚Äì", alignment: AlignmentType.CENTER })]
                        })
                    ]
                })
            ]
        });

        sections.push(costsTable);

        // Pozosta≈Çe sekcje (skr√≥cone dla przyk≈Çadu)
        sections.push(
            new Paragraph({
                text: "V. Informacja o zatrudnieniu i wynagrodzeniu",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            }),
            new Paragraph({
                text: "1. Liczba os√≥b zatrudnionych w fundacji w okresie sprawozdawczym: ‚Äì",
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: "2. ≈ÅƒÖczna kwota wynagrodze≈Ñ wyp≈Çaconych w okresie sprawozdawczym: ‚Äì",
                spacing: { after: 400 }
            }),

            new Paragraph({
                text: "VI. Informacja o sk≈Çadnikach majƒÖtkowych",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            }),
            new Paragraph({
                text: "1. Warto≈õƒá sk≈Çadnik√≥w majƒÖtkowych na dzie≈Ñ 31 grudnia roku sprawozdawczego: ‚Äì",
                spacing: { after: 400 }
            }),

            new Paragraph({
                text: "VII. Informacja o ≈õrodkach pieniƒô≈ºnych",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            }),
            new Paragraph({
                text: "1. ≈örodki pieniƒô≈ºne na rachunkach bankowych na dzie≈Ñ 31 grudnia roku sprawozdawczego: ‚Äì",
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: "2. ≈örodki pieniƒô≈ºne w kasie na dzie≈Ñ 31 grudnia roku sprawozdawczego: ‚Äì",
                spacing: { after: 400 }
            })
        );

        // Podpisy
        sections.push(
            new Paragraph({
                text: "",
                spacing: { before: 800 }
            }),
            new Paragraph({
                text: "........................................          ........................................",
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: "     miejscowo≈õƒá, data                              podpisy cz≈Çonk√≥w zarzƒÖdu fundacji",
                alignment: AlignmentType.CENTER
            }),
            new Paragraph({
                text: "",
                spacing: { before: 400 }
            }),
            new Paragraph({
                text: `Sprawozdanie wygenerowane automatycznie: ${new Date().toLocaleDateString('pl-PL')}`,
                italics: true,
                alignment: AlignmentType.CENTER
            })
        );

    } else {
        // Sprawozdanie podsumowujƒÖce
        sections = [
            new Paragraph({
                text: "Sprawozdanie z Dzia≈Çalno≈õci",
                heading: HeadingLevel.HEADING_1,
                alignment: AlignmentType.CENTER,
                spacing: { after: 200 }
            }),
            new Paragraph({
                text: foundationName,
                bold: true,
                alignment: AlignmentType.CENTER,
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: `Rok ${year}`,
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            }),
            new Paragraph({
                text: "1. Podsumowanie Dzia≈Çalno≈õci",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            }),
            new Paragraph({
                children: [
                    new TextRun({ text: "Liczba realizowanych projekt√≥w: ", bold: true }),
                    new TextRun(`${stats.totalProjects}`)
                ],
                spacing: { after: 100 }
            }),
            new Paragraph({
                children: [
                    new TextRun({ text: "Liczba beneficjent√≥w: ", bold: true }),
                    new TextRun(`${stats.totalBeneficiaries}`)
                ],
                spacing: { after: 100 }
            }),
            new Paragraph({
                children: [
                    new TextRun({ text: "Ca≈Çkowity bud≈ºet: ", bold: true }),
                    new TextRun(`${formatMoney(stats.totalBudget)} PLN`)
                ],
                spacing: { after: 200 }
            }),
            new Paragraph({
                text: `W roku ${year} ${foundationName} zrealizowa≈Ça ≈ÇƒÖcznie ${stats.totalProjects} ${getProjectWord(stats.totalProjects)}.`,
                spacing: { after: 400 }
            }),
            new Paragraph({
                text: "2. Realizowane Projekty",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            })
        ];

        filteredProjects.forEach((project, index) => {
            sections.push(
                new Paragraph({
                    children: [
                        new TextRun({ text: `${index + 1}. ${project.title}`, bold: true })
                    ],
                    spacing: { before: 200, after: 100 }
                })
            );

            if (project.description) {
                sections.push(new Paragraph({ text: project.description, spacing: { after: 100 } }));
            }

            let details = [];
            if (project.status) details.push(`Status: ${getStatusLabel(project.status)}`);
            if (project.start_date) details.push(`Od: ${formatDate(project.start_date)}`);
            if (project.end_date) details.push(`Do: ${formatDate(project.end_date)}`);
            if (project.budget) details.push(`Bud≈ºet: ${formatMoney(project.budget)} PLN`);
            if (project.beneficiaries_count) details.push(`Beneficjenci: ${project.beneficiaries_count}`);
            if (project.coordinator) details.push(`Koordynator: ${project.coordinator}`);

            sections.push(new Paragraph({ text: details.join(' | '), spacing: { after: 100 } }));

            if (project.partners) {
                sections.push(new Paragraph({
                    children: [
                        new TextRun({ text: "Partnerzy: ", bold: true }),
                        new TextRun(project.partners)
                    ],
                    spacing: { after: 100 }
                }));
            }
        });

        sections.push(
            new Paragraph({
                text: "3. Wnioski i Perspektywy",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 400, after: 200 }
            }),
            new Paragraph({
                text: `Rok ${year} by≈Ç okresem ${stats.totalProjects > 5 ? 'intensywnej' : 'systematycznej'} dzia≈Çalno≈õci ${foundationName}.`,
                spacing: { after: 400 }
            }),
            new Paragraph({
                text: "",
                spacing: { before: 600 }
            }),
            new Paragraph({
                text: `Sprawozdanie wygenerowane: ${new Date().toLocaleDateString('pl-PL')}`,
                italics: true,
                alignment: AlignmentType.CENTER
            })
        );
    }

    const doc = new Document({
        sections: [{
            properties: {},
            children: sections
        }]
    });

    const blob = await docx.Packer.toBlob(doc);
    const fileName = `Sprawozdanie_${foundationName.replace(/\s+/g, '_')}_${year}.docx`;
    saveAs(blob, fileName);
}
    </script>
</body>
</html>
