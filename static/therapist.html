<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Panel terapeuty – grafik</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 16px; }
    .toolbar .form-select, .toolbar .form-control { max-width: 280px }
    .toolbar .view-toggle .btn { min-width: 96px }

    /* — Tydzień — */
    .cal-wrap { overflow:auto; border:1px solid var(--bs-border-color); border-radius:.5rem; }
    .cal-grid { display:grid; grid-template-columns: 80px repeat(7, 1fr); }
    .cal-head { position:sticky; top:0; z-index:2; background:var(--bs-body-bg); border-bottom:1px solid var(--bs-border-color); }
    .cal-head div { padding:.5rem; font-weight:600; text-align:center; border-left:1px solid var(--bs-border-color); }
    .cal-head div:first-child { border-left:0; text-align:left; }
    .cal-row { height:24px; border-top:1px dotted var(--bs-border-color); font-size:12px; }
    .cal-row label { display:inline-block; padding:2px 6px; color: var(--bs-secondary-color); }
    .cal-col { position:relative; border-left:1px solid var(--bs-border-color); }
    .cal-event { position:absolute; left:4px; right:4px; border-radius:.5rem; padding:2px 6px; font-size:12px; line-height:1.2; overflow:hidden; background:rgba(13,110,253,.12); border:1px solid rgba(13,110,253,.35); }
    .cal-event.done { background: rgba(25,135,84,.15); border-color: rgba(25,135,84,.35); }
    .cal-event.planned { background: rgba(13,110,253,.12); border-color: rgba(13,110,253,.35); }
    .cal-event.cancelled { background: rgba(220,53,69,.10); border-color: rgba(220,53,69,.35); text-decoration:line-through; }
    .cal-event.all { color: #000; }
    .cal-legend { display:flex; gap:.5rem; flex-wrap:wrap; padding:.5rem; border-top:1px solid var(--bs-border-color); font-size:12px; color: var(--bs-secondary-color) }
    .cal-legend .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; margin-right:.25rem; vertical-align:baseline; }

    /* — Miesiąc — */
    .month-wrap { border:1px solid var(--bs-border-color); border-radius:.5rem; overflow:hidden; }
    .month-head { display:grid; grid-template-columns: repeat(7, 1fr); background:var(--bs-body-bg); border-bottom:1px solid var(--bs-border-color); position:sticky; top:0; z-index:2; }
    .month-head div { padding:.5rem; font-weight:600; text-align:center; border-left:1px solid var(--bs-border-color); }
    .month-head div:first-child { border-left:0; }
    .month-grid { display:grid; grid-template-columns: repeat(7, 1fr); }
    .day-cell { min-height:120px; border-left:1px solid var(--bs-border-color); border-top:1px solid var(--bs-border-color); padding:.25rem .25rem .25rem .5rem; position:relative; }
    .day-cell:nth-child(7n+1) { border-left:0; }
    .day-num { font-size:12px; color: var(--bs-secondary-color); }
    .day-chip { display:inline-block; margin:.15rem .15rem 0 0; padding:.1rem .35rem; border-radius:999px; font-size:11px; border:1px solid transparent; background:rgba(13,110,253,.12); }
    .day-chip.done { background:rgba(25,135,84,.15); border-color:rgba(25,135,84,.35) }
    .day-chip.cancelled { background:rgba(220,53,69,.12); border-color:rgba(220,53,69,.35); text-decoration:line-through }
    .day-chip .mini { opacity:.7 }
    .muted-month { opacity:.55 }
    .sticky-month-title { position:sticky; top:0; background:var(--bs-body-bg); z-index:3; padding:.25rem 0 .5rem 0; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <header class="d-flex flex-wrap align-items-center gap-2 mb-3 toolbar">
      <h1 class="h5 m-0">Panel terapeuty – grafik</h1>
      <div class="ms-auto"></div>

      <div class="btn-group view-toggle" role="group" aria-label="View toggle">
        <input type="radio" class="btn-check" name="viewMode" id="vmWeek" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="vmWeek">Tydzień</label>
        <input type="radio" class="btn-check" name="viewMode" id="vmMonth" autocomplete="off">
        <label class="btn btn-outline-primary" for="vmMonth">Miesiąc</label>
      </div>

      <select id="tpTherapistSelect" class="form-select">
        <option value="all">— wszyscy terapeuci —</option>
      </select>

      <input type="date" id="tpRefDate" class="form-control" />
      <input type="month" id="tpRefMonth" class="form-control d-none" />

      <div class="btn-group">
        <button id="tpPrev" class="btn btn-outline-secondary">«</button>
        <button id="tpToday" class="btn btn-outline-secondary">Dziś</button>
        <button id="tpNext" class="btn btn-outline-secondary">»</button>
      </div>
      <button id="tpPrint" class="btn btn-outline-secondary">Drukuj</button>
    </header>

    <div id="alertBox" class="mb-3"></div>

    <div id="calendarHost">
      <!-- tutaj renderuję tydzień lub miesiąc -->
    </div>
  </div>

  <script>
    const API = ""; // ten sam origin

    // — helpery —
    function showAlert(msg, type="success"){
      const box = document.getElementById("alertBox");
      box.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    }



    function initials(name){
      if(!name) return "";
      return name.split(/\s+/).filter(Boolean).slice(0,3).map(w=>w[0].toUpperCase()).join("");
    }
    function colorForId(id){
      const h = (Number(id)*47) % 360;
      const s = 75, l = 80, borderL = 60;
      return { bg:`hsl(${h} ${s}% ${l}%)`, border:`hsl(${h} ${s}% ${borderL}%)`, text: l < 60 ? "#fff" : "#000" };
    }
    const dowShort = ["Pn","Wt","Śr","Cz","Pt","So","Nd"];

    // — stan —
    const TP_START_HOUR = 7, TP_END_HOUR=20, PX_PER_MIN=24/30;
    let _state = {
      mode: "week",            // "week" | "month"
      therapistId: "all",
      refDate: new Date(),
      refMonth: new Date(),
      therapists: [],
      rows: []                 // bieżący dataset (wg trybu i filtra)
    };

    // — init —
    (async function init(){
      const t = new Date();
      document.getElementById("tpRefDate").value = t.toISOString().slice(0,10);
      document.getElementById("tpRefMonth").value = t.toISOString().slice(0,7);
      _state.refDate = t; _state.refMonth = new Date(t.getFullYear(), t.getMonth(), 1);

      // terapeuci
      try{
        const res = await fetch(`${API}/api/therapists`);
        _state.therapists = (await res.json()).filter(x => x.active !== false);
        const sel = document.getElementById("tpTherapistSelect");
        sel.innerHTML =
          `<option value="all">— wszyscy terapeuci —</option>` +
          _state.therapists.map(t => `<option value="${t.id}">${t.full_name}${t.specialization?` – ${t.specialization}`:""}</option>`).join("");
      }catch(e){ showAlert(`Błąd ładowania terapeutów: ${e.message}`, "danger"); }

      // UI
      document.getElementById("vmWeek").addEventListener("change", () => switchMode("week"));
      document.getElementById("vmMonth").addEventListener("change", () => switchMode("month"));
      document.getElementById("tpTherapistSelect").addEventListener("change", reloadData);
      document.getElementById("tpRefDate").addEventListener("change", e => { _state.refDate = new Date(e.target.value); reloadData(); });
      document.getElementById("tpRefMonth").addEventListener("change", e => {
        const [y,m] = e.target.value.split("-").map(Number);
        _state.refMonth = new Date(y, m-1, 1);
        reloadData();
      });

      document.getElementById("tpPrev").addEventListener("click", shiftPrev);
      document.getElementById("tpNext").addEventListener("click", shiftNext);
      document.getElementById("tpToday").addEventListener("click", goToday);
      document.getElementById("tpPrint").addEventListener("click", printView);

      // query params
      const qp = new URLSearchParams(location.search);
      const qpTid = qp.get("therapist_id");
      const qpDate = qp.get("date");
      const qpMonth= qp.get("month");
      const qpMode = qp.get("mode"); // week/month
      if (qpMode === "month") { document.getElementById("vmMonth").checked = true; switchMode("month", false); }
      if (qpMonth) { document.getElementById("tpRefMonth").value = qpMonth; const [y,m]=qpMonth.split("-").map(Number); _state.refMonth = new Date(y,m-1,1); }
      if (qpDate) { document.getElementById("tpRefDate").value = qpDate; _state.refDate = new Date(qpDate); }
      if (qpTid)  { document.getElementById("tpTherapistSelect").value = qpTid === "all" ? "all" : String(Number(qpTid)); _state.therapistId = document.getElementById("tpTherapistSelect").value; }

      reloadData();
    })();

    // — nawigacja —
    function switchMode(mode, reload=true){
      _state.mode = mode;
      document.getElementById("tpRefDate").classList.toggle("d-none", mode!=="week");
      document.getElementById("tpRefMonth").classList.toggle("d-none", mode!=="month");
      if (reload) reloadData();
    }
    function shiftPrev(){
      if (_state.mode==="week"){
        const d = new Date(_state.refDate); d.setDate(d.getDate()-7);
        _state.refDate = d; document.getElementById("tpRefDate").value = d.toISOString().slice(0,10);
      } else {
        const d = new Date(_state.refMonth.getFullYear(), _state.refMonth.getMonth()-1, 1);
        _state.refMonth = d; document.getElementById("tpRefMonth").value = d.toISOString().slice(0,7);
      }
      reloadData();
    }
    function shiftNext(){
      if (_state.mode==="week"){
        const d = new Date(_state.refDate); d.setDate(d.getDate()+7);
        _state.refDate = d; document.getElementById("tpRefDate").value = d.toISOString().slice(0,10);
      } else {
        const d = new Date(_state.refMonth.getFullYear(), _state.refMonth.getMonth()+1, 1);
        _state.refMonth = d; document.getElementById("tpRefMonth").value = d.toISOString().slice(0,7);
      }
      reloadData();
    }
    function goToday(){
      if (_state.mode==="week"){
        const t = new Date(); _state.refDate=t; document.getElementById("tpRefDate").value=t.toISOString().slice(0,10);
      } else {
        const t = new Date(); const m = new Date(t.getFullYear(), t.getMonth(), 1);
        _state.refMonth=m; document.getElementById("tpRefMonth").value=m.toISOString().slice(0,7);
      }
      reloadData();
    }

    // — ładowanie danych (dla obu trybów) —
    async function reloadData(){
      _state.therapistId = document.getElementById("tpTherapistSelect").value || "all";

      // w obu trybach i „all” korzystamy z istniejącego endpointu /api/therapists/{id}/schedule?month=YYYY-MM
      const monthKey = (_state.mode==="week" ? _state.refDate : _state.refMonth);
      const mk = `${monthKey.getFullYear()}-${String(monthKey.getMonth()+1).padStart(2,'0')}`;

      const host = document.getElementById("calendarHost");
      host.innerHTML = `<div class="text-muted p-3">Ładowanie…</div>`;

      try{
        if (_state.therapistId === "all"){
          const promises = _state.therapists.map(t =>
            fetch(`${API}/api/therapists/${t.id}/schedule?month=${encodeURIComponent(mk)}`)
              .then(r=>r.ok?r.json():[])
              .then(rows => rows.filter(r=>r.kind==='therapy').map(r => ({...r, therapist_id: t.id, therapist_name: t.full_name })))
          );
          _state.rows = (await Promise.all(promises)).flat();
        } else {
          const tid = Number(_state.therapistId);
          const res = await fetch(`${API}/api/therapists/${tid}/schedule?month=${encodeURIComponent(mk)}`);
          const data = await res.json();
          _state.rows = (data||[]).filter(r=>r.kind==='therapy').map(r=>({...r, therapist_id: tid}));
        }

        if (_state.mode === "week") renderWeek();
        else renderMonth();
      }catch(e){
        host.innerHTML = `<div class="text-danger p-3">Błąd ładowania: ${e.message}</div>`;
      }
    }

    // — tydzień —
    function weekRange(date){
      const d = new Date(date);
      const dow = (d.getDay()+6)%7; // 0=pn
      const start = new Date(d); start.setDate(d.getDate() - dow); start.setHours(0,0,0,0);
      const days = Array.from({length:7}, (_,i)=> new Date(start.getFullYear(), start.getMonth(), start.getDate()+i));
      return { start, days };
    }

    function renderWeek(){
      const host = document.getElementById("calendarHost");
      const { days } = weekRange(_state.refDate);

      // head (dni na górze)
      const head = `<div class="cal-head cal-grid">
        <div style="padding:.5rem">Godz.</div>
        ${days.map((d,i)=>`<div>${dowShort[i]}<br><small>${d.toLocaleDateString("pl-PL")}</small></div>`).join("")}
      </div>`;

      // lewa kolumna z godzinami
      let times = `<div>`;
      for (let h=TP_START_HOUR; h<=TP_END_HOUR; h++){
        times += `<div class="cal-row"><label>${String(h).padStart(2,'0')}:00</label></div>`;
        if (h!==TP_END_HOUR) times += `<div class="cal-row"></div>`;
      }
      times += `</div>`;
      const colHeight = ((TP_END_HOUR-TP_START_HOUR+1)*2)*24; // 2x24px
      const cols = days.map(d => `<div class="cal-col" data-day="${d.toISOString().slice(0,10)}" style="height:${colHeight}px"></div>`).join("");

       host.innerHTML = `<div class="cal-wrap">
        ${head}<div class="cal-grid">${times}${cols}</div>
        <div class="cal-legend">
          <span><span class="swatch" style="background:rgba(13,110,253,.3); border:1px solid rgba(13,110,253,.5)"></span> planned</span>
          <span><span class="swatch" style="background:rgba(25,135,84,.3); border:1px solid rgba(25,135,84,.5)"></span> done</span>
          <span><span class="swatch" style="background:rgba(220,53,69,.25); border:1px solid rgba(220,53,69,.5)"></span> cancelled</span>
          ${_state.therapistId==="all" ? `<span class="ms-2">Kolor = terapeuta (inicjały na chipie)</span>` : ``}
        </div>
      </div>`;

      const dayMap = new Map([...host.querySelectorAll(".cal-col")].map(el => [el.getAttribute("data-day"), el]));

     for (const r of _state.rows) {
      const d = parseLocalTimestamp(r.starts_at);
      const e = parseLocalTimestamp(r.ends_at);
      if (!d || !e) continue;

      const key = d.toISOString().slice(0,10);
      if (!dayMap.has(key)) continue;

        const top = ((d.getHours()-TP_START_HOUR)*60 + d.getMinutes()) * PX_PER_MIN;
        const height = Math.max(18, Math.max(0, (e - d)/60000) * PX_PER_MIN);

        const el = document.createElement("div");
        el.className = `cal-event ${r.status||"planned"} ${_state.therapistId==="all"?'all':''}`;
        if (_state.therapistId==="all"){
          const c = colorForId(r.therapist_id || 0);
          el.style.background = c.bg; el.style.borderColor=c.border; el.style.color=c.text;
        }
        el.style.top = `${top}px`; el.style.height = `${height}px`;

        const tName = r.therapist_name || "";
        const tag = _state.therapistId==="all" ? `<span class="badge rounded-pill text-bg-light border me-1" style="background:rgba(255,255,255,.6);">${initials(tName)}</span>` : ``;

        el.innerHTML = `
          <div><strong>${fmtLocalTime(r.starts_at)}–${fmtLocalTime(r.ends_at)}</strong></div>
          <div class="text-truncate">${tag}${(r.client_name || `klient #${r.client_id??""}`)}</div>
          ${r.place_to ? `<div class="text-truncate"><small>${r.place_to}</small></div>` : ``}
        `;
        dayMap.get(key).appendChild(el);
      }
    }

    // — miesiąc —
    function monthMatrix(firstDay){
      // start na poniedziałek poprzedzający 1. dzień (lub ten sam, jeśli 1. to pn)
      const first = new Date(firstDay.getFullYear(), firstDay.getMonth(), 1);
      const offset = (first.getDay()+6)%7; // 0=pn
      const start = new Date(first); start.setDate(first.getDate()-offset); start.setHours(0,0,0,0);
      // 6 tygodni × 7 dni, by objąć pełny zakres
      return Array.from({length:42}, (_,i)=> new Date(start.getFullYear(), start.getMonth(), start.getDate()+i));
    }

    function renderMonth(){
  const host = document.getElementById("calendarHost");
  const days = monthMatrix(_state.refMonth);
  const thisMonth = _state.refMonth.getMonth();

  const head = `<div class="month-head">
    ${dowShort.map(d=>`<div>${d}</div>`).join("")}
  </div>`;

  const map = new Map();
  for (const r of _state.rows){
    const s = parseLocalTimestamp(r.starts_at);
    if (!s) continue;
    const k = `${s.getFullYear()}-${String(s.getMonth() + 1).padStart(2, '0')}-${String(s.getDate()).padStart(2, '0')}`;
    if (!map.has(k)) map.set(k, []);
    map.get(k).push(r);
  }

  const grid = days.map(d => {
    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    const items = map.get(key) || [];
    const muted = d.getMonth() !== thisMonth ? " muted-month" : "";
    const chips = items.slice(0,8).map(r => {
      const cls = `day-chip ${r.status||"planned"}`;
      if (_state.therapistId==="all"){
        const c = colorForId(r.therapist_id || 0);
        return `<span class="${cls}" style="background:${c.bg}; border-color:${c.border}; color:${c.text}">
          <span class="mini">${fmtLocalTime(r.starts_at)}–${fmtLocalTime(r.ends_at)}</span> • ${initials(r.therapist_name||"")}
        </span>`;
      } else {
        return `<span class="${cls}">
          <span class="mini">${fmtLocalTime(r.starts_at)}–${fmtLocalTime(r.ends_at)}</span> • ${(r.client_name || `#${r.client_id??""}`)}
        </span>`;
      }
    }).join("");
    const more = items.length>8 ? `<div><small class="text-muted">+${items.length-8} więcej…</small></div>` : "";

    // ⬇️ TU DODANY data-date
    return `<div class="day-cell${muted}" data-date="${key}">
      <div class="day-num">${d.getDate()}</div>
      ${chips}${more}
    </div>`;
  }).join("");

  const title = `${_state.refMonth.toLocaleDateString("pl-PL", {month:"long", year:"numeric"})}`;

  host.innerHTML = `
    <div class="sticky-month-title"><h5 class="m-0">${title}</h5></div>
    <div class="month-wrap">
      ${head}
      <div class="month-grid">${grid}</div>
    </div>`;
}


       // Nadaj data-date po układzie z ekranu (lewo->prawo, góra->dół)
function decorateCalendarHostWithDates(host){
  // spróbuj wykryć tryb i punkt startowy z kontrolek
  const mode = (window._state?.mode) || "week";
  const mondayOf = d=>{ const r=new Date(d), w=(r.getDay()+6)%7; r.setDate(r.getDate()-w); return r; };
  const parseISO = s => { const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(s); if(!m) return null; const d=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(d)?null:d; };

  let start;
  if (mode === "month"){
    const mk = document.querySelector("#tpMonth")?.value || "";
    if (/^\d{4}-\d{2}$/.test(mk)){
      const [y,m] = mk.split("-").map(Number);
      const first = new Date(y, m-1, 1);
      start = mondayOf(first);
    }
  } else {
    const wk = document.querySelector("#tpWeekStart")?.value || "";
    start = /^\d{4}-\d{2}-\d{2}$/.test(wk) ? new Date(wk) : null;
  }
  // absolutny ostatni fallback: pierwsza liczba dnia na widoku -> cofnij do poniedziałku
  if (!start){
    const firstCell = host.querySelector(".cal-day");
    if (!firstCell) return false;
    const num = Number(firstCell.querySelector(".day-number")?.textContent?.trim() || "");
    // spróbuj znaleźć jakąś datę z dataset, headera itp.
    const probeISO = firstCell.getAttribute("data-date") || document.querySelector("[data-current-date]")?.getAttribute("data-current-date");
    const base = probeISO ? parseISO(probeISO) : new Date();
    if (!base) return false;
    base.setDate(num || 1);
    start = (mode === "month") ? mondayOf(new Date(base.getFullYear(), base.getMonth(), 1))
                               : mondayOf(base);
  }

  // idąc po .cal-day ustaw data-date sekwencyjnie
  const cells = host.querySelectorAll(".cal-day:not([data-date])");
  if (!cells.length) return true;

  let d = new Date(start);
  cells.forEach((el, idx) => {
    if (idx>0) d.setDate(d.getDate()+1);
    el.setAttribute("data-date", d.toISOString().slice(0,10));
  });
  return true;
}


// helper: poczekaj N ms
const _sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

// helper: rozpoznaj strukturę kalendarza i zwróć {mode, nodes, mapDateByIndex}
function _probeCalendar(){
  const host = document.getElementById("calendarHost");
  // najpierw miesiąc z data-date
  let nodes = [...host.querySelectorAll(".month-grid .day-cell[data-date]")];
  if (nodes.length) return { mode:"month", nodes };

  // miesiąc bez data-date (kolejność siatki; użyj fallbacków w printView)
  nodes = [...host.querySelectorAll(".month-grid .day-cell")];
  if (nodes.length) return { mode:"month", nodes };

  // tydzień (masz data-day)
  nodes = [...host.querySelectorAll(".cal-grid .cal-col[data-day]")];
  if (nodes.length) return { mode:"week", nodes };

  // ewentualnie tygodniowe kolumny bez atrybutu – po kolejności (fallback)
  nodes = [...host.querySelectorAll(".cal-grid .cal-col")];
  if (nodes.length) return { mode:"week", nodes };

  return { mode: (window._state?.mode || "week"), nodes: [] };
}


async function printView(_retry=0){
  const host = document.getElementById("calendarHost");
  if (!host){ showAlert?.("Brak kontenera grafiku do wydruku.", "warning"); return; }

  // jeżeli jeszcze „Ładowanie…”, daj DOMowi dokończyć
  if (host.textContent?.trim().startsWith("Ładowanie") && _retry < 1){
    await _sleep(60);
  }

  // 1) rozpoznaj strukturę aktualnego widoku
  let { mode, nodes } = _probeCalendar();

  // jeśli brak węzłów – jedna próba odświeżenia
  if (!nodes.length && _retry < 1){
    if (typeof reloadData === "function") { try { await reloadData(); } catch{} }
    await _sleep(80);
    ({ mode, nodes } = _probeCalendar());
  }

  // === narzędzia dat/formatowania
  const mondayOf = d => { const r=new Date(d), w=(r.getDay()+6)%7; r.setDate(r.getDate()-w); r.setHours(0,0,0,0); return r; };
  const fmtISO    = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const sanitize  = s => String(s).replace(/[<>&]/g, ch => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[ch]));

  // 2) zbuduj mapę ISO->zdarzenia
  const eventsByDate = new Map();

  if (nodes.length){
    // --- STANDARD: zbieramy z DOM (tydzień/miesiąc)
    if (mode === "week"){
      const start = mondayOf(window._state?.refDate || new Date());
      const cols = nodes.slice(0,7); // pn–nd
      cols.forEach((col, i) => {
        const d = new Date(start); d.setDate(start.getDate()+i);
        const iso = fmtISO(d);
        let evs = [...col.querySelectorAll(".cal-event")].map(ev => {
          const time = ev.querySelector("strong")?.textContent?.trim() || "";
          const full = ev.textContent.replace(/\s+/g," ").trim();
          const body = time ? full.replace(time,"").trim() : full;
          return time ? `${time}${body ? " • "+body : ""}` : full;
        }).filter(Boolean);
        if (!evs.length){
          const raw = col.textContent.replace(/\s+/g," ").trim();
          if (raw) evs = [raw];
        }
        eventsByDate.set(iso, evs);
      });
    } else {
      // month z DOM
      // miesiąc z DOM
      const ref = window._state?.refMonth || new Date();
      const firstOfMonth = new Date(ref.getFullYear(), ref.getMonth(), 1);
      const gridStart = mondayOf(firstOfMonth);

      nodes.forEach((cell, idx) => {
        // jeśli masz data-date – bierz je, inaczej wylicz po kolejności
        const iso = cell.getAttribute("data-date") ||
                    fmtISO(new Date(gridStart.getFullYear(), gridStart.getMonth(), gridStart.getDate()+idx));
        let evs = [...cell.querySelectorAll(".day-chip")].map(x => x.textContent.replace(/\s+/g," ").trim()).filter(Boolean);
        if (!evs.length){
          const clone = cell.cloneNode(true);
          clone.querySelectorAll(".day-num").forEach(x=>x.remove());
          const raw = clone.textContent.replace(/\s+/g," ").trim();
          if (raw) evs = [raw];
        }
        eventsByDate.set(iso, evs);
});

    }
  } else if (mode === "month" && Array.isArray(window._state?.rows)) {
    // --- FALLBACK: widok miesięczny BEZ DOM — buduj wprost ze stanu
    const rows = (window._state.rows || []).filter(r => r && r.starts_at);
    for (const r of rows){
      const d = new Date((r.starts_at||"").replace(" ","T"));
      if (isNaN(d)) continue;
      const iso = fmtISO(d);
      const labelTime = d.toLocaleTimeString("pl-PL", {hour:"2-digit", minute:"2-digit"});
      const who = (window._state?.therapistId === "all")
        ? (r.therapist_name ? ` • ${r.therapist_name}` : "")
        : (r.client_name ? ` • ${r.client_name}` : (r.client_id ? ` • #${r.client_id}` : ""));
      const line = `${labelTime}${who}`;
      if (!eventsByDate.has(iso)) eventsByDate.set(iso, []);
      eventsByDate.get(iso).push(line);
    }
    // jeśli i tak nic nie ma – pokaż błąd
    if (![...eventsByDate.values()].some(a => a && a.length)){
      showAlert?.("Brak rozpoznanych komórek dni do wydruku i brak danych w _state.rows.", "warning");
      return;
    }
  } else {
    showAlert?.("Brak rozpoznanych komórek dni do wydruku (sprawdź .cal-col/.cal-day/.day-cell albo data-date).", "warning");
    return;
  }

  // 3) ustal zakres (7 kolumn zawsze)
  let startDate, endDate;
  if (mode === "week"){
    startDate = mondayOf(window._state?.refDate || new Date());
    endDate = new Date(startDate); endDate.setDate(startDate.getDate()+6);
  } else {
    const m = window._state?.refMonth || new Date();
    const first = new Date(m.getFullYear(), m.getMonth(), 1);
    const last  = new Date(m.getFullYear(), m.getMonth()+1, 0);
    startDate = mondayOf(first);
    const tmp = new Date(last);
    const dow = (tmp.getDay()+6)%7;
    tmp.setDate(tmp.getDate() + (6 - dow));
    endDate = tmp;
  }

  // 4) render wierszy po 7 dni
  const rowsOut = [];
  let cur = new Date(startDate);
  while (cur <= endDate){
    const tds = [];
    for (let i=0;i<7;i++){
      const iso = fmtISO(cur);
      const dayNum = cur.getDate();
      const evs = eventsByDate.get(iso) || [];
      const evHtml = evs.map(txt => `<div class="event">${sanitize(txt)}</div>`).join("");
      tds.push(`<td data-date="${iso}"><div class="day-head"><span class="day-number">${dayNum}</span></div><div class="events">${evHtml}</div></td>`);
      cur.setDate(cur.getDate()+1);
    }
    rowsOut.push(`<tr>${tds.join("")}</tr>`);
  }

  // 5) nagłówek: kto
  const sel = document.getElementById("tpTherapistSelect");
  const isAll = sel?.value === "all";
  const therapistName = isAll ? "Wszyscy terapeuci"
    : (sel?.options?.[sel.selectedIndex]?.textContent || (window._state?.therapistId ? `ID ${_state.therapistId}` : ""));

  // 6) dokument do druku
  const html = `<!doctype html><html lang="pl"><head>
    <meta charset="utf-8">
    <title>Grafik – ${mode==='week'?'tydzień':'miesiąc'}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      @page { size: A4 landscape; margin: 10mm; }
      *{box-sizing:border-box} html,body{height:100%}
      body{font:11px/1.35 Arial,Helvetica,sans-serif; color:#111; margin:0; padding:0;}
      .doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin:0 0 10px 0;padding:0 2mm;}
      .doc-header h1{font-size:18px; margin:0 0 2px 0;}
      .muted{color:#666;font-size:10px}
      table.calendar{width:100%; border-collapse:collapse; table-layout:fixed;}
      .calendar th,.calendar td{border:1px solid #333; vertical-align:top; padding:3px 4px;}
      .calendar thead th{background:#f1f3f4; text-align:center; font-weight:700; font-size:11px; white-space:nowrap;}
      .calendar td{height:${mode==='week' ? '38mm' : '28mm'}; overflow:hidden;}
      .day-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
      .day-number{font-weight:700; font-size:12px}
      .events{font-size:10px}
      .event{margin:2px 0; padding:2px 3px; border:1px solid #777; border-radius:3px; page-break-inside:avoid; word-wrap:break-word;}
      .calendar tbody tr:nth-child(even) td { background:#fcfcfc; }
    </style>
  </head><body>
    <div class="doc-header">
      <div>
        <h1>Grafik – ${mode==='week'?'tydzień':'miesiąc'}</h1>
        <div>${isAll ? "" : "<strong>Terapeuta:</strong> "}${therapistName ? therapistName.replace(/</g,"&lt;") : ""}</div>
      </div>
      <div class="muted">Wygenerowano: ${new Date().toLocaleString("pl-PL")}</div>
    </div>
    <table class="calendar">
      <thead><tr><th>Pon</th><th>Wt</th><th>Śr</th><th>Czw</th><th>Pt</th><th>Sob</th><th>Nd</th></tr></thead>
      <tbody>${rowsOut.join("")}</tbody>
    </table>
  </body></html>`;

  // 7) druk przez ukryty iframe
  const iframe = document.createElement("iframe");
  Object.assign(iframe.style, {position:"fixed", right:"0", bottom:"0", width:"0", height:"0", border:"0"});
  iframe.setAttribute("aria-hidden","true");
  document.body.appendChild(iframe);
  const ifrw = iframe.contentWindow, ifrd = iframe.contentDocument || ifrw.document;
  ifrd.open(); ifrd.write(html); ifrd.close();
  let printed=false; const cleanup=()=>setTimeout(()=>iframe.remove(),100);
  iframe.onload = () => { if(printed) return; printed=true; try{ ifrw.focus(); setTimeout(()=>{ try{ ifrw.print(); }catch(_){ } }, 0); }catch(_){} };
  if (ifrw) ifrw.onafterprint = cleanup; setTimeout(cleanup, 5000);
}
// Bezpieczny parser łańcucha "YYYY-MM-DD HH:MM:SS" lub "YYYY-MM-DDTHH:MM:SS" jako CZAS LOKALNY
function parseLocalTimestamp(str){
  if (!str) return null;
  // zaakceptuj zarówno " " jak i "T"
  const s = str.trim().replace('T', ' ');
  // YYYY-MM-DD HH:MM:SS
  const m = /^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/.exec(s);
  if (!m) return null;
  const [_, Y, M, D, h, mnt, sec] = m;
  // Konstruktor Date(y, m-1, d, h, m, s) tworzy ZAWSZE lokalny czas (bez przesunięć strefowych)
  return new Date(
    Number(Y),
    Number(M) - 1,
    Number(D),
    Number(h),
    Number(mnt),
    Number(sec)
  );
}

function fmtLocalDateTime(str){
  const d = parseLocalTimestamp(str);
  if (!d) return "—";
  return d.toLocaleString("pl-PL", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}

function fmtLocalTime(str){
  const d = parseLocalTimestamp(str);
  if (!d) return "";
  return d.toLocaleTimeString("pl-PL", { hour:"2-digit", minute:"2-digit" });
}

function minutesBetweenLocal(a, b){
  const A = parseLocalTimestamp(a), B = parseLocalTimestamp(b);
  if (!A || !B) return 0;
  return Math.max(0, Math.round((B - A) / 60000));
}

function dateKeyPLLocal(str){
  const d = parseLocalTimestamp(str);
  if (!d) return { key:"", label:"" };
  const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const label = d.toLocaleDateString("pl-PL", { weekday:"long", day:"2-digit", month:"2-digit", year:"numeric" });
  return { key, label };
}



  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
