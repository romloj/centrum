<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <title>ModuÅ‚ TUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="menu_fab.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .select2-container--bootstrap-5 .select2-selection {
      min-height: 38px;
    }
    .select2-container--bootstrap-5 .select2-selection__rendered {
      padding-top: 4px;
    }
      /* Style dla mini-kalendarza w modalu TUS */
.session-calendar {
    border: 1px solid var(--bs-border-color);
    border-radius: .5rem;
    background: #fff;
}
.session-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: .5rem;
    border-bottom: 1px solid var(--bs-border-color);
}
.session-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
}
.session-calendar-dow {
    font-size: .75rem;
    font-weight: 600;
    color: var(--bs-secondary-color);
    padding: .25rem 0;
}
.session-calendar-day {
    font-size: .8rem;
    padding: .5rem 0;
    border-top: 1px solid var(--bs-border-color);
    cursor: pointer;
    position: relative;
}
.session-calendar-day:hover {
    background-color: var(--bs-primary-bg-subtle);
}
.session-calendar-day.other-month {
    color: var(--bs-secondary-color);
    opacity: .6;
}
/* KÃ³Å‚ko oznaczajÄ…ce zaplanowanÄ… sesjÄ™ */
.session-calendar-day.scheduled::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--bs-primary);
}
/* Styl dla zaznaczonego dnia */
.session-calendar-day.selected {
    background-color: var(--bs-primary);
    color: #fff;
    font-weight: 600;
    border-radius: 50%;
}
      /* Styl dla regularnego dnia zajÄ™Ä‡ (szablonu) */
.session-calendar-day.is-selected-day {
    background-color: var(--bs-info-bg-subtle);
    font-weight: bold;
}

  </style>
</head>

<body>

  <div class="container py-4">
    <header class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
      <h1 class="h3 m-0">ğŸ‘¥ ModuÅ‚ TUS â€“ Grupy</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#topicsModal">Tematy</button>
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#behaviorsModal">Zachowania</button>
        <button class="btn btn-primary" id="addGroupBtn">StwÃ³rz nowÄ… grupÄ™</button>
      </div>
    </header>

    <main id="groupsContainer" class="row g-4"></main>
  </div>

  <div class="modal fade" id="groupDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupDetailsTitle">SzczegÃ³Å‚y grupy</h5>
          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-danger btn-sm" id="deleteGroupFromDetailsBtn" style="display:none">UsuÅ„ grupÄ™</button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Zamknij</button>
          </div>
        </div>
        <div class="modal-body" id="groupDetailsBody">
          </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupModalTitle">Dane grupy</h5>
        </div>
        <div class="modal-body">
          <form id="groupForm" novalidate>
            <div class="mb-3">
              <label for="groupName" class="form-label">Nazwa grupy</label>
              <input type="text" class="form-control" id="groupName" required />
            </div>
            <div class="mb-3">
              <label for="therapistSelect" class="form-label">Terapeuta prowadzÄ…cy</label>
              <select class="form-select" id="therapistSelect"></select>
            </div>
            <div class="mb-3">
              <label for="assistantTherapistSelect" class="form-label">Terapeuta wspomagajÄ…cy (opcjonalnie)</label>
              <select class="form-select" id="assistantTherapistSelect"></select>
            </div>

            <div class="mb-3">
              <label for="clientSelect" class="form-label">Uczestnicy</label>
              <select class="form-select" id="clientSelect" multiple></select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="submit" form="groupForm" class="btn btn-primary" id="saveGroupBtn">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="topicsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tematy TUS</h5>
        </div>
        <div class="modal-body">
          <form id="addTopicForm" class="d-flex gap-2 mb-3">
            <input type="text" class="form-control" id="newTopicTitle" placeholder="TytuÅ‚ tematu" required />
            <button type="submit" class="btn btn-success">Dodaj</button>
          </form>
          <ul class="list-group" id="topicsList"></ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="behaviorsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Zachowania do modelowania</h5>
        </div>
        <div class="modal-body">
          <form id="addBehaviorForm" class="row g-2 align-items-end mb-3">
            <div class="col-8">
              <label class="form-label">Nazwa</label>
              <input type="text" class="form-control" id="newBehaviorTitle" placeholder="np. czekanie na swojÄ… kolej" required />
            </div>
            <div class="col-4">
              <label class="form-label">DomyÅ›lny max</label>
              <input type="number" class="form-control" id="newBehaviorMax" value="3" min="1" max="10" />
            </div>
            <div class="col-12">
              <button class="btn btn-success">Dodaj zachowanie</button>
            </div>
          </form>
          <ul id="behaviorsList" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="scoringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Punktacja sesji</h5>
        </div>
        <div class="modal-body">
          <div id="scoringBody"></div>
        </div>
        <div class="modal-footer">
          <input type="hidden" id="scoringSessionId" />
          <input type="hidden" id="scoringGroupId" />
          <button class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
          <button id="saveScoresBtn" class="btn btn-primary">Zapisz punktacjÄ™</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="topicHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Historia zrealizowanych tematÃ³w</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="topicHistoryBody">
          </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="bonusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bonusModalTitle">Bonusy Indywidualne</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Wpisz punkty bonusowe dla kaÅ¼dego uczestnika poniÅ¼ej.</p>
          <div id="bonusModalSessionInfo" class="mb-3"></div>
          <form id="bonusForm">
            <div id="bonusParticipantsContainer">
              </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="button" class="btn btn-primary" id="saveBonusesBtn">Zapisz Bonusy</button>
        </div>
      </div>
    </div>
  </div>
<!-- Floating Action Menu - TYLKO RAZ, na koÅ„cu body -->
    <div class="fab-container" id="fabContainer">
    <ul class="fab-menu">
        <li class="fab-item">
            <span class="fab-label">Plan terapeuty</span>
            <a href="therapist1.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-heart-pulse"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">ModuÅ‚ TUS</span>
            <a href="tus.html" class="fab-button" title="ModuÅ‚ TUS">
                <i class="bi bi-star-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Lista klientÃ³w</span>
            <a href="klienci.html" class="fab-button" title="Lista klientÃ³w">
                <i class="bi bi-people-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Historia klientÃ³w</span>
            <a href="client_history.html" class="fab-button" title="Historia klientÃ³w">
                <i class="bi bi-clock-history"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">ModuÅ‚ Kierowcy</span>
            <a href="drivers.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-car-front-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Strona gÅ‚Ã³wna</span>
            <a href="index.html" class="fab-button" title="Strona gÅ‚Ã³wna">
                <i class="bi bi-house-fill"></i>
            </a>
        </li>
    </ul>
    <button class="fab-main" id="fabMainBtn" aria-label="RozwiÅ„ menu">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>
    <div class="fab-backdrop" id="fabBackdrop"></div>

    <!-- Skrypty-->

    <script src="fab-menu.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    $(function() {

      // ==========================================================
      // === INICJALIZACJA I ZMIENNE GLOBALNE =====================
      // ==========================================================

      const API_BASE = ''; // Pusty string, jeÅ›li API jest w tej samej domenie
      let currentGroupId = null; // null = tryb tworzenia, liczba = tryb edycji

      // Inicjalizacja instancji modali Bootstrapa
      const groupDetailsModal = new bootstrap.Modal(document.getElementById('groupDetailsModal'));
      const groupModal = new bootstrap.Modal(document.getElementById('groupModal'));
      const scoringModal = new bootstrap.Modal(document.getElementById('scoringModal'));
      const topicHistoryModal = new bootstrap.Modal(document.getElementById('topicHistoryModal'));
      const bonusModal = new bootstrap.Modal(document.getElementById('bonusModal'));
      const topicsModal = new bootstrap.Modal(document.getElementById('topicsModal'));
      const behaviorsModal = new bootstrap.Modal(document.getElementById('behaviorsModal'));


      // ==========================================================
      // === FUNKCJE POMOCNICZE I API =============================
      // ==========================================================

      /**
       * Uniwersalna funkcja do zapytaÅ„ API, obsÅ‚ugujÄ…ca bÅ‚Ä™dy i format JSON.
       * @param {string} url - Adres URL endpointu API.
       * @param {object} options - Opcje dla `fetch`, np. `method`, `headers`, `body`.
       * @returns {Promise<any>} - Rozstrzyga do sparsowanej odpowiedzi JSON.
       */
      async function fetchJSON(url, options) {
        try {
          const res = await fetch(url, options);
          const text = await res.text();
          const ct = res.headers.get('content-type') || '';

          if (!ct.includes('application/json')) {
            throw new Error(`OdpowiedÅº serwera nie jest w formacie JSON (HTTP ${res.status}) â€” ${text.slice(0, 200)}`);
          }

          const data = JSON.parse(text);
          if (!res.ok) {
            const msg = (data && (data.error || data.message)) || `BÅ‚Ä…d serwera (HTTP ${res.status})`;
            throw new Error(msg);
          }
          return data;
        } catch (e) {
          // PrzekaÅ¼ dalej bÅ‚Ä…d, aby mÃ³gÅ‚ byÄ‡ obsÅ‚uÅ¼ony w wywoÅ‚ujÄ…cej funkcji
          throw e;
        }
      }

      /** Inicjalizuje kontrolki Select2 w formularzu dodawania/edycji grupy. */
      function initGroupFormSelect2() {
        $('#therapistSelect, #assistantTherapistSelect').select2({
          theme: 'bootstrap-5',
          dropdownParent: $('#groupModal'),
          placeholder: 'Wybierz terapeutÄ™',
          allowClear: true,
          width: '100%'
        });


        $('#clientSelect').select2({
          theme: 'bootstrap-5',
          dropdownParent: $('#groupModal'),
          placeholder: 'Wybierz uczestnikÃ³w',
          width: '100%'
        });
      }

       function showAlert(msg, type = "success") {
    const alertBox = document.getElementById('alertBox');
    // Upewnij siÄ™, Å¼e element alertBox istnieje w Twoim HTML
    if (alertBox) {
        alertBox.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
    } else {
        // JeÅ›li nie ma dedykowanego miejsca, uÅ¼yj standardowego alertu
        alert(msg);
    }
}

      // ==========================================================
      // === GÅÃ“WNE FUNKCJE ÅADUJÄ„CE DANE =========================
      // ==========================================================

      /** Åaduje i wyÅ›wietla listÄ™ wszystkich grup na stronie gÅ‚Ã³wnej. */
      async function loadGroups() {
            try {
                const groups = await fetchJSON(`${API_BASE}/api/tus/groups-summary`);
                const $container = $('#groupsContainer').empty();

                if (!groups || !groups.length) {
                    $container.html('<div class="col-12"><p class="text-center text-muted">Brak grup. StwÃ³rz pierwszÄ…!</p></div>');
                    return;
                }

                groups.forEach(g => {
                    const progressPercent = (g.target_points > 0) ? (g.total_points_collected / g.target_points * 100) : 0;

                    // --- POCZÄ„TEK POPRAWKI ---
                    // Wprowadzamy nowÄ…, potrÃ³jnÄ… logikÄ™ dla statusu celu.
                    const statusMessage = g.target_points > 0
                        ? (g.points_remaining > 0 ? `${g.points_remaining} pkt do celu` : 'Cel osiÄ…gniÄ™ty! ğŸ‰')
                        : 'Nie ustawiono celu';
                    // --- KONIEC POPRAWKI ---

                    const cardHtml = `
                      <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                          <div class="card-header">
                            <h5 class="card-title mb-0">${g.name}</h5>
                            <small class="text-muted">${g.therapist_name ?? 'Brak terapeuty'}</small>
                          </div>
                          <div class="card-body">
                            <p class="card-text mb-2"><strong>Uczestnicy:</strong> ${g.member_count}</p>
                            <p class="card-text"><strong>Ostatni temat:</strong> ${g.last_topic || '<em>Brak sesji</em>'}</p>
                            <hr>
                            <h6 class="card-subtitle mb-2 text-muted">PostÄ™p w tym pÃ³Å‚roczu</h6>
                            <p class="mb-1"><strong>Zebrano:</strong> ${g.total_points_collected} / ${g.target_points > 0 ? g.target_points : '?'} pkt</p>
                            <div class="progress mb-2" style="height: 20px;">
                              <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%"
                                   aria-valuenow="${g.total_points_collected}" aria-valuemin="0" aria-valuemax="${g.target_points}">
                              </div>
                            </div>
                            <small class="d-block text-center text-muted mt-1">
                                ${statusMessage}
                            </small>
                            <p class="card-text mt-2"><strong>Nagroda:</strong> ${g.reward || '<em>Nie ustawiono</em>'}</p>
                          </div>
                          <div class="card-footer d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-primary btn-sm view-group-btn" data-group-id="${g.id}">ZarzÄ…dzaj</button>
                            <button class="btn btn-secondary btn-sm edit-group-btn" data-group-id="${g.id}">Edytuj</button>
                          </div>
                        </div>
                      </div>`;
                    $container.append(cardHtml);
                });
            } catch (e) {
                console.error(e);
                $('#groupsContainer').html(`<div class="col-12"><div class="alert alert-danger">Nie moÅ¼na zaÅ‚adowaÄ‡ grup: ${e.message}</div></div>`);
            }
        }

      /**
       * Pobiera listy terapeutÃ³w i klientÃ³w, a nastÄ™pnie wypeÅ‚nia nimi kontrolki Select2 w formularzu grupy.
       * @param {object} [prefill] - Opcjonalny obiekt z danymi do wstÄ™pnego wypeÅ‚nienia formularza (edycja).
       */
      async function loadTherapistsAndClients(prefill = {}) {
        const [therapists, clients] = await Promise.all([
          fetchJSON(`${API_BASE}/api/therapists`),
          fetchJSON(`${API_BASE}/api/clients`)
        ]);

        const activeTherapists = (therapists || []).filter(t => t.active);
        const activeClients = (clients || []).filter(c => c.active);

        const $therapistSelect = $('#therapistSelect').empty().append(new Option('', ''));
        const $assistantSelect = $('#assistantTherapistSelect').empty().append(new Option('', ''));
        activeTherapists.forEach(t => {
          $therapistSelect.append(new Option(t.full_name, String(t.id)));
          $assistantSelect.append(new Option(t.full_name, String(t.id)));
        });

        const $clientSelect = $('#clientSelect').empty();
        activeClients.forEach(c => $clientSelect.append(new Option(c.full_name, String(c.client_id || c.id))));

        initGroupFormSelect2(); // Zainicjuj Select2 po wypeÅ‚nieniu opcji

        // WypeÅ‚nij formularz danymi, jeÅ›li sÄ… dostÄ™pne (tryb edycji)
        if (prefill.name) $('#groupName').val(prefill.name);
        if (prefill.therapist_id) $('#therapistSelect').val(String(prefill.therapist_id)).trigger('change');
        if (prefill.assistant_therapist_id) $('#assistantTherapistSelect').val(String(prefill.assistant_therapist_id)).trigger('change');
        if (prefill.client_ids) $('#clientSelect').val(prefill.client_ids.map(String)).trigger('change');
      }

      /** Pobiera listÄ™ tematÃ³w i wyÅ›wietla jÄ… w modalu tematÃ³w. */
      async function loadTopicsModalList() {
        const $list = $('#topicsList').html('<li class="list-group-item text-muted">Åadowanie...</li>');
        try {
          const topics = await fetchJSON(`${API_BASE}/api/tus/topics`);
          $list.empty();
          if (!topics || topics.length === 0) {
            $list.append('<li class="list-group-item text-muted">Brak zdefiniowanych tematÃ³w.</li>');
            return;
          }
          topics.forEach(t => $list.append(`<li class="list-group-item">${t.title}</li>`));
        } catch (e) {
          console.error(e);
          $list.html('<li class="list-group-item text-danger">BÅ‚Ä…d Å‚adowania tematÃ³w.</li>');
        }
      }

      /** Pobiera listÄ™ zachowaÅ„ i wyÅ›wietla jÄ… w modalu zachowaÅ„. */
      async function reloadBehaviorsModal() {
        const $list = $('#behaviorsList').html('<li class="list-group-item text-muted">Åadowanieâ€¦</li>');
        try {
          const items = await fetchJSON(`${API_BASE}/api/tus/behaviors`);
          $list.empty();
          if (!items || !items.length) {
            $list.append('<li class="list-group-item text-muted">Brak zdefiniowanych zachowaÅ„.</li>');
            return;
          }
          items.forEach(b => {
            $list.append(`
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${b.title} <small class="text-muted">(domyÅ›lny max ${b.default_max_points ?? 3})</small></span>
                <button class="btn btn-outline-danger btn-sm del-beh" data-id="${b.id}">UsuÅ„</button>
              </li>`);
          });
        } catch (e) {
          console.error(e);
          $list.html('<li class="list-group-item text-danger">BÅ‚Ä…d Å‚adowania zachowaÅ„.</li>');
        }
      }


      // ==========================================================
      // === FUNKCJE ZARZÄ„DZAJÄ„CE MODALAMI ========================
      // ==========================================================


 async function saveSchedule(groupId, scheduleDays) {
        try {
            const response = await fetch(`/api/tus/groups/${groupId}/schedule`, {
                method: 'PUT', // <-- UPEWNIJ SIÄ˜, Å»E JEST TUTAJ 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ schedule_days: scheduleDays }),
            });

            if (!response.ok) {
                throw new Error('BÅ‚Ä…d serwera: ' + response.status);
            }

            // Sukces
            console.log("Harmonogram zapisany!");

        } catch (error) {
            console.error("Nie udaÅ‚o siÄ™ zapisaÄ‡ harmonogramu:", error);
        }
    }

      /**
       * Otwiera gÅ‚Ã³wny, interaktywny modal ze szczegÃ³Å‚ami grupy, sesjami i opcjami.
       * @param {number} groupId - ID grupy do wyÅ›wietlenia.
       */
      // W pliku tus.html znajdÅº i podmieÅ„ tÄ™ funkcjÄ™

async function openGroupDetails(groupId) {
Â  Â  try {
Â  Â  Â  Â  const g = await fetchJSON(`${API_BASE}/api/tus/groups/${groupId}`);
Â  Â  Â  Â  const [bonusDetails, bonusHistory] = await Promise.all([
Â  Â  Â  Â  Â  Â fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/bonus-details`),
Â  Â  Â  Â  Â  Â fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/general-bonus-history`)
Â  Â  Â  Â  ]);

Â  Â  Â  Â  $('#groupDetailsTitle').text(`ZarzÄ…dzaj grupÄ…: ${g.name}`);
Â  Â  Â  Â  $('#deleteGroupFromDetailsBtn').show().data('group-id', g.id);

Â  Â  Â  Â  // --- LOGIKA KALENDARZA (bez zmian) ---
Â  Â  Â  Â  let calendarCurrentDate = new Date();
Â  Â  Â  Â  const scheduledDates = new Set(g.sessions.map(s => s.session_date.slice(0, 10)));
Â  Â  Â  Â  const DOW_SHORT = ["Nd", "Pn", "Wt", "Åšr", "Cz", "Pt", "So"];
Â  Â  Â  Â  let selectedDates = new Set(g.schedule_days || []);

Â  Â  Â  Â  function renderSessionCalendar() {
Â  Â  Â  Â  Â  Â  const year = calendarCurrentDate.getFullYear();
Â  Â  Â  Â  Â  Â  const month = calendarCurrentDate.getMonth();
Â  Â  Â  Â  Â  Â  const calendarEl = document.getElementById('sessionCalendar');
Â  Â  Â  Â  Â  Â  if (!calendarEl) return;

Â  Â  Â  Â  Â  Â  const firstOfMonth = new Date(year, month, 1);
Â  Â  Â  Â  Â  Â  const lastOfMonth = new Date(year, month + 1, 0);
Â  Â  Â  Â  Â  Â  const startDay = firstOfMonth.getDay();

Â  Â  Â  Â  Â  Â  let headerHtml = `<div class="session-calendar-header"><button type="button" class="btn btn-sm btn-outline-secondary cal-prev-month">Â«</button><strong class="mx-2">${firstOfMonth.toLocaleString('pl-PL', { month: 'long', year: 'numeric' })}</strong><button type="button" class="btn btn-sm btn-outline-secondary cal-next-month">Â»</button></div>`;
Â  Â  Â  Â  Â  Â  let gridHtml = `<div class="session-calendar-grid">`;
Â  Â  Â  Â  Â  Â  DOW_SHORT.forEach(day => gridHtml += `<div class="session-calendar-dow">${day}</div>`);
Â  Â  Â  Â  Â  Â  for (let i = 0; i < startDay; i++) { gridHtml += `<div class="session-calendar-day other-month"></div>`; }

      Â  Â  Â  Â  Â  Â  for (let i = 1; i <= lastOfMonth.getDate(); i++) {
                const dayDate = new Date(year, month, i);
                
                // UÅ»YJ TEGO SAMEGO FORMATU CO W LIÅšCIE SESJI
                const dateString = dayDate.toISOString().split('T')[0]; // Format YYYY-MM-DD
                const isScheduled = scheduledDates.has(dateString);
                const isSelected = selectedDates.has(dateString);
                
                let classes = 'session-calendar-day';
                if (isScheduled) classes += ' scheduled';
                if (isSelected) classes += ' is-selected-day';
                gridHtml += `<div class="${classes}" data-date="${dateString}">${i}</div>`;
        Â  Â  Â  Â  Â  Â  }
        Â  Â  Â  Â  Â  Â  gridHtml += `</div>`;
        Â  Â  Â  Â  Â  Â  calendarEl.innerHTML = `<div class="session-calendar">${headerHtml}${gridHtml}</div>`;
      Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PRZYGOTOWANIE DANYCH ---
Â  Â  Â  Â  const currentYear = new Date().getFullYear();
Â  Â  Â  Â  let schoolYearOptionsHtml = '';
Â  Â  Â  Â  for (let i = 0; i < 5; i++) {
Â  Â  Â  Â  Â  Â  const yearStart = currentYear - i;
Â  Â  Â  Â  Â  Â  const yearEnd = yearStart + 1;
Â  Â  Â  Â  Â  Â  schoolYearOptionsHtml += `<option value="${yearStart}">${yearStart}/${yearEnd}</option>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  // const membersListHtml = (g.members || []).map(m => `<li>${m.full_name}</li>`).join('') || '<li class="text-muted">Brak uczestnikÃ³w</li>'; // JuÅ¼ niepotrzebne

Â  Â  Â  Â  // --- HTML dla listy obecnoÅ›ci ---
Â  Â  Â  Â  const membersChecklistHtml = (g.members || []).length > 0
Â  Â  Â  Â  Â  Â  ? (g.members || []).map(m => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-check">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input class="form-check-input new-session-attendance" type="checkbox" value="${m.id}" id="att-new-${m.id}" checked>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-check-label" for="att-new-${m.id}">${m.full_name}</label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('')
Â  Â  Â  Â  Â  Â  : '<p class="text-muted small">Brak uczestnikÃ³w w grupie.</p>';

Â  Â  Â  Â  // --- Reszta danych (sesje, bonusy itd.) ---
Â  Â  Â  Â  const sessionsMap = new Map();
Â  Â  Â  Â  (g.sessions || []).forEach(session => {
Â  Â  Â  Â  Â  Â  if (session.id && !sessionsMap.has(session.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionsMap.set(session.id, session);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  const uniqueSessions = Array.from(sessionsMap.values());
Â  Â  Â  Â  uniqueSessions.sort((a, b) => new Date(b.session_date) - new Date(a.session_date));
Â  Â  Â  Â  const sessionsListHtml = uniqueSessions.map(s => {
          let whenLabel = 'BÅ‚Ä™dna data';
          try {
              if (s.session_date) {
                  const dateObj = new Date(s.session_date);
                  if (!isNaN(dateObj.getTime())) {
                      // UÅ»YJ TEGO SAMEGO FORMATU CO W KALENDARZU
                      const dateString = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
                      const timePart = s.session_time ? ` ${s.session_time.substring(0, 5)}` : '';
                      whenLabel = dateObj.toLocaleDateString('pl-PL') + timePart;
                      
                      // DODATKOWO: Zapisz datÄ™ w tym samym formacie do scheduledDates
                      scheduledDates.add(dateString);
                  } else {
                      whenLabel = `${s.session_date}${s.session_time ? ' ' + s.session_time.substring(0,5) : ''}`;
                  }
              }
          } catch (e) {
              console.error('BÅ‚Ä…d formatowania daty:', e);
              whenLabel = `${s.session_date}${s.session_time ? ' ' + s.session_time : ''}`;
          }
Â  Â  Â  Â  Â  Â  return `<li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2"><span>${whenLabel} â€” ${s.topic_title || 'bez tematu'}</span><div class="btn-group btn-group-sm"><button class="btn btn-outline-success bonus-session-btn" data-session-id="${s.id}">Bonusy sesji</button><button class="btn btn-outline-primary score-session-btn" data-session-id="${s.id}" data-group-id="${g.id}">OceÅ„</button><button class="btn btn-outline-danger delete-session-btn" data-session-id="${s.id}" data-group-id="${g.id}">UsuÅ„</button></div></li>`;
Â  Â  Â  Â  }).join('') || '<li class="list-group-item text-muted">Brak sesji</li>';
Â  Â  Â  Â  const bonusTableRowsHtml = (g.members || []).map(member => {
Â  Â  Â  Â  Â  Â  const details = bonusDetails.find(d => d.client_id === member.id) || {};
Â  Â  Â  Â  Â  Â  return `<tr><td>${member.full_name}</td><td class="text-center border-end">${details.behavior_points || 0}</td><td class="text-center">${details.session_bonus_points || 0}</td><td class="text-center">${details.general_bonus_points || 0}</td><td class="text-center fw-bold fs-5">${details.total_points || 0}</td></tr>`;
Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  const memberOptionsHtml = (g.members || []).map(m => `<option value="${m.id}">${m.full_name}</option>`).join('');
Â  Â  Â  Â  const bonusHistoryHtml = bonusHistory.length > 0 ? bonusHistory.map(h => {
Â  Â  Â  Â  Â  Â  const date = new Date(h.awarded_at).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
Â  Â  Â  Â  Â  Â  return `<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${h.client_name}</strong> otrzymaÅ‚ <strong>${h.points} pkt.</strong><br><small class="text-muted">PowÃ³d: ${h.reason || 'Brak'}</small></div><span class="badge bg-secondary rounded-pill">${date}</span></li>`;
Â  Â  Â  Â  }).join('') : '<li class="list-group-item text-muted">Brak przyznanych bonusÃ³w ogÃ³lnych.</li>';

Â  Â  Â  Â  // --- ZMIENIONY UKÅAD HTML ---
Â  Â  Â  Â  $('#groupDetailsBody').html(`
Â  Â  Â  Â  Â  Â  <ul class="nav nav-tabs" id="groupTabs" role="tablist">
Â  Â  Â  Â  Â  Â  Â  <li class="nav-item" role="presentation"><button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions-panel" type="button" role="tab">Sesje i Uczestnicy</button></li>
Â  Â  Â  Â  Â  Â  Â  <li class="nav-item" role="presentation"><button class="nav-link" id="bonuses-tab" data-bs-toggle="tab" data-bs-target="#bonuses-panel" type="button" role="tab">â­ Punktacja i Bonusy</button></li>
Â  Â  Â  Â  Â  Â  Â  <li class="nav-item" role="presentation"><button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals-panel" type="button" role="tab">Cele i PostÄ™py</button></li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  <div class="tab-content pt-3">
Â  Â  Â  Â  Â  Â  Â  <div class="tab-pane fade show active" id="sessions-panel" role="tabpanel">
    <h6>Lista Sesji</h6>
    <ul class="list-group mb-3">${sessionsListHtml}</ul>
    <hr>

    <form id="addSessionForm" data-group-id="${g.id}">
        <!-- ZMIENIONA SEKCJA - ELEMENTY OBOK SIEBIE -->
        <div class="row g-3">
            <!-- Lewa kolumna - ObecnoÅ›Ä‡ -->
            <div class="col-lg-3 col-md-4">
                <label class="form-label mb-1 fw-bold">ObecnoÅ›Ä‡ (dla nowej sesji):</label>
                <div class="p-2 border rounded bg-white" style="max-height: 250px; overflow-y: auto;">
                    ${membersChecklistHtml}
                </div>
            </div>
            
            <!-- Åšrodkowa kolumna - Kalendarz -->
            <div class="col-lg-4 col-md-4">
                <label class="form-label mb-1 fw-bold">Szablon dni:</label>
                <div id="sessionCalendar"></div>
                <div class="d-grid mt-2">
                    <button type="button" id="saveScheduleBtn" class="btn btn-info btn-sm">Zapisz zaznaczone dni</button>
                </div>
            </div>
            
            <!-- Prawa kolumna - Formularz sesji -->
            <div class="col-lg-5 col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">Dodaj nowÄ… sesjÄ™</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="sessionDateInput" class="form-label">Data</label>
                                <input type="date" class="form-control" name="date" id="sessionDateInput" required>
                            </div>
                            <div class="col-6">
                                <label for="sessionTimeInput" class="form-label">Godzina</label>
                                <input type="time" class="form-control" name="time" id="sessionTimeInput" required>
                            </div>
                            <div class="col-12">
                                <label for="sessionTopicInput" class="form-label">Temat</label>
                                <input type="text" id="sessionTopicInput" class="form-control" placeholder="Wpisz temat zajÄ™Ä‡..." required>
                            </div>
                            <div class="col-12">
                                <label for="sessionBehaviorsSelect" class="form-label">Zachowania do modelowania (max 4)</label>
                                <select id="sessionBehaviorsSelect" class="form-select" multiple></select>
                            </div>
                        </div>
                        <div class="col-12 mt-3">
                            <button class="btn btn-primary w-100" type="submit">Dodaj sesjÄ™</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- KONIEC ZMIENIONEJ SEKCJI -->
    </form>
</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tab-pane fade" id="bonuses-panel" role="tabpanel">
Â  Â  Â  Â  Â  Â  Â  Â  <h5>Zbiorcza punktacja</h5><div class="table-responsive mb-4"><table class="table table-bordered table-striped"><thead class="table-light"><tr><th>Uczestnik</th><th class="text-center border-end">Pkt. za zachowania</th><th class="text-center">Bonusy z sesji</th><th class="text-center">Super bonusy</th><th class="text-center">SUMA PUNKTÃ“W</th></tr></thead><tbody>${bonusTableRowsHtml}</tbody></table></div><hr/>
Â  Â  Â  Â  Â  Â  Â  Â  <h5>Przyznaj bonus ogÃ³lny</h5><form id="awardGeneralBonusForm" class="row g-2 align-items-end" data-group-id="${g.id}"><div class="col-md-5"><label for="bonusClientSelect" class="form-label">Uczestnik</label><select id="bonusClientSelect" name="client_id" class="form-select" required>${memberOptionsHtml}</select></div><div class="col-md-2"><label for="bonusPointsInput" class="form-label">Punkty</label><input type="number" id="bonusPointsInput" name="points" class="form-control" min="1" required></div><div class="col-md-5"><label for="bonusReasonInput" class="form-label">PowÃ³d (wymagany)</label><input type="text" id="bonusReasonInput" name="reason" class="form-control" placeholder="Np. Pomoc koledze" required></div><div class="col-12"><button type="submit" class="btn btn-success">Przyznaj punkty</button></div></form><hr class="my-4"/>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="accordion" id="bonusHistoryAccordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory">PokaÅ¼ / Ukryj historiÄ™ bonusÃ³w ogÃ³lnych</button></h2><div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#bonusHistoryAccordion"><div class="accordion-body p-0"><ul class="list-group list-group-flush">${bonusHistoryHtml}</ul></div></div></div></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="tab-pane fade" id="goals-panel" role="tabpanel">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h6>ğŸ¯ Cele i nagrody semestralne</h6><div class="card mb-3"><div class="card-body"><form id="groupTargetForm" data-group-id="${g.id}"><div class="row g-2 align-items-end"><div class="col-md-5"><label class="form-label">Rok szkolny</label><select class="form-select" name="school_year_start" required>${schoolYearOptionsHtml}</select></div><div class="col-md-7"><label class="form-label">Semestr</label><select class="form-select" name="semester" required><option value="1">I PÃ³Å‚rocze (WrzesieÅ„ - StyczeÅ„)</option><option value="2">II PÃ³Å‚rocze (Luty - Czerwiec)</option></select></div><div class="col-6"><label class="form-label">Cel (pkt)</label><input type="number" class="form-control" name="points" min="0" required></div><div class="col-6"><label class="form-label">Nagroda</label><input type="text" class="form-control" name="reward"></div><div class="col-12"><button type="submit" class="btn btn-primary btn-sm w-100">Zapisz cel</button></div></div></form></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="d-flex align-items-end gap-2 mb-3"><div><label class="form-label mb-0"><strong>Podsumowanie dla roku szkolnego</strong></label><select class="form-select" id="bonusYearSelect">${schoolYearOptionsHtml}</select></div><button type="button" class="btn btn-primary" id="bonusScopeRefreshBtn" data-group-id="${g.id}">PokaÅ¼</button><button type="button" class="btn btn-secondary" id="hideBonusesBtn" style="display: none;">Ukryj</button></div><div id="bonusesSummary" class="mb-3"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `);
Â  Â  Â  Â  // --- KONIEC POPRAWKI HTML ---

Â  Â  Â  Â  renderSessionCalendar();
Â  Â  Â  Â  function fmtYYYYMMDD(date) { return date ? date.toISOString().split('T')[0] : ""; }
Â  Â  Â  Â  const calendarEl = document.getElementById('sessionCalendar');
Â  Â  Â  Â  if (calendarEl) {
Â  Â  Â  Â  Â  Â  calendarEl.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.classList.contains('cal-prev-month')) { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1); renderSessionCalendar(); }
Â  Â  Â  Â  Â  Â  Â  Â  else if (e.target.classList.contains('cal-next-month')) { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1); renderSessionCalendar(); }
Â  Â  Â  Â  Â  Â  Â  Â  else if (e.target.classList.contains('session-calendar-day') && e.target.dataset.date) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const clickedDateString = e.target.dataset.date;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedDates.has(clickedDateString) ? selectedDates.delete(clickedDateString) : selectedDates.add(clickedDateString);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderSessionCalendar();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  const saveScheduleBtn = document.getElementById('saveScheduleBtn');
Â  Â  Â  Â  if (saveScheduleBtn) {
Â  Â  Â  Â  Â  Â  saveScheduleBtn.setAttribute('type', 'button'); 
Â  Â  Â  Â  Â  Â  saveScheduleBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const payload = { schedule_days: Array.from(selectedDates) };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await fetchJSON(`/api/tus/groups/${groupId}/schedule`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert('Harmonogram zostaÅ‚ zapisany!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`BÅ‚Ä…d zapisu harmonogramu: ${err.message}`, 'danger');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const behaviors = await fetchJSON(`${API_BASE}/api/tus/behaviors`);
Â  Â  Â  Â  const $behaviorSelect = $('#sessionBehaviorsSelect').empty();
Â  Â  Â  Â  (behaviors || []).forEach(b => $behaviorSelect.append(new Option(`${b.title} (max ${b.default_max_points ?? 3})`, String(b.id))));
Â  Â  Â  Â  $behaviorSelect.select2({ theme: 'bootstrap-5', width: '100%', placeholder: 'Wybierz do 4 zachowaÅ„', maximumSelectionLength: 4, dropdownParent: $('#groupDetailsModal') });

Â  Â  Â  Â  groupDetailsModal.show();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert(`Nie udaÅ‚o siÄ™ otworzyÄ‡ szczegÃ³Å‚Ã³w grupy: ${e.message}`);
Â  Â  }
}

      /**
       * Otwiera modal do przyznawania bonusÃ³w indywidualnych dla danej sesji.
       * @param {number} sessionId - ID sesji.
       */
      async function openBonusModal(sessionId) {
        const $container = $('#bonusParticipantsContainer').html('<p class="text-muted">Åadowanie...</p>');
        $('#saveBonusesBtn').data('session-id', sessionId);
        bonusModal.show();

        try {
          const [session, existingBonuses] = await Promise.all([
            fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}`),
            fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/bonuses`)
          ]);

          const sessionDate = new Date(session.session_date).toLocaleDateString('pl-PL');
          $('#bonusModalTitle').text(`Bonusy dla sesji z dnia ${sessionDate}`);
          $('#bonusModalSessionInfo').html(`<strong>Temat:</strong> ${session.topic_title || 'Brak'}`);

          if (!session.members || session.members.length === 0) {
            $container.html('<p class="text-danger">Brak uczestnikÃ³w w tej sesji.</p>');
            return;
          }

          const participantsHtml = session.members.map(member => `
            <div class="input-group mb-2">
              <span class="input-group-text w-75">${member.full_name}</span>
              <input type="number" class="form-control bonus-points-input"
                     data-client-id="${member.id}"
                     min="0"
                     value="${existingBonuses[member.id] || 0}">
            </div>`).join('');
          $container.html(participantsHtml);
        } catch (err) {
          $container.html(`<p class="text-danger">BÅ‚Ä…d Å‚adowania danych: ${err.message}</p>`);
        }
      }

      /**
Â  Â  Â  Â * Otwiera modal do oceniania zachowaÅ„ dla danej sesji.
Â  Â  Â  Â * @param {number} sessionId - ID sesji.
Â  Â  Â  Â * @param {number} groupId - ID grupy (do odÅ›wieÅ¼enia widoku).
Â  Â  Â  Â */
Â  Â  Â  /**
Â  Â  Â  Â * Otwiera modal do oceniania zachowaÅ„ dla danej sesji. (Wersja 2.0 - z poprawkÄ…)
Â  Â  Â  Â * @param {number} sessionId - ID sesji.
Â  Â  Â  Â * @param {number} groupId - ID grupy (do odÅ›wieÅ¼enia widoku).
Â  Â  Â  Â */
Â  Â  Â  async function openScoringModal(sessionId, groupId) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const data = await fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/scores`);

Â  Â  Â  Â  Â  // 1. Najpierw sprawdÅº, czy w ogÃ³le sÄ… czÅ‚onkowie
Â  Â  Â  Â  Â  if (!data.members || data.members.length === 0) {
Â  Â  Â  Â  Â  Â  $('#scoringBody').html(`<div class="alert alert-warning mb-0">Do tej sesji nie przypisano Å¼adnych uczestnikÃ³w.</div>`);
Â  Â  Â  Â  Â  Â  // WyÅ‚Ä…cz przycisk zapisu, jeÅ›li nie ma kogo zapisaÄ‡
Â  Â  Â  Â  Â  Â  $('#saveScoresBtn').prop('disabled', true);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // 2. Buduj nagÅ‚Ã³wek (thead) - kolumny obecnoÅ›ci i osoby sÄ… ZAWSZE
Â  Â  Â  Â  Â  Â  let thead = '<tr><th class="text-center">ObecnoÅ›Ä‡</th><th>Osoba</th>';
Â  Â  Â  Â  Â  Â  const hasBehaviors = data.behaviors && data.behaviors.length > 0;

Â  Â  Â  Â  Â  Â  // Dodaj kolumny zachowaÅ„ i sumy tylko jeÅ›li zachowania istniejÄ…
Â  Â  Â  Â  Â  Â  if (hasBehaviors) {
Â  Â  Â  Â  Â  Â  Â  data.behaviors.forEach(b => thead += `<th>${b.title}<br><small>max ${b.max_points}</small></th>`);
Â  Â  Â  Â  Â  Â  Â  thead += '<th class="text-end">Suma</th>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  thead += '</tr>';

Â  Â  Â  Â  Â  Â  // 3. Buduj ciaÅ‚o tabeli (tbody)
Â  Â  Â  Â  Â  Â  let tbody = '';
Â  Â  Â  Â  Â  Â  data.members.forEach(m => {
Â  Â  Â  Â  Â  Â  Â  // KomÃ³rka obecnoÅ›ci (zawsze)
Â  Â  Â  Â  Â  Â  Â  const isPresent = m.is_present === undefined ? true : m.is_present;
Â  Â  Â  Â  Â  Â  Â  const checkedAttr = isPresent ? 'checked' : '';
Â  Â  Â  Â  Â  Â  Â  const attendanceTd = `<td class="text-center align-middle"><input class="form-check-input attendance-check" type="checkbox" ${checkedAttr}></td>`;

Â  Â  Â  Â  Â  Â  Â  // KomÃ³rka imienia (zawsze)
Â  Â  Â  Â  Â  Â  Â  const nameTd = `<td>${m.full_name}</td>`;

Â  Â  Â  Â  Â  Â  Â  let scoreTds = '';
Â  Â  Â  Â  Â  Â  Â  let sumTd = '';
Â  Â  Â  Â  Â  Â  Â  let sum = 0;

Â  Â  Â  Â  Â  Â  Â  // Dodaj komÃ³rki ocen i sumy tylko jeÅ›li zachowania istniejÄ…
Â  Â  Â  Â  Â  Â  Â  if (hasBehaviors) {
Â  Â  Â  Â  Â  Â  Â  Â  data.behaviors.forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = (data.scores?.[m.id]?.[b.behavior_id]) ?? 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  sum += Number(val) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  scoreTds += `<td style="width:120px"><input type="number" class="form-control form-control-sm score-input" data-cid="${m.id}" data-bid="${b.behavior_id}" value="${val}" min="0" max="${b.max_points}"></td>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  sumTd = `<td class="sum-cell text-end fw-bold">${sum}</td>`;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // ZÅ‚Ã³Å¼ wiersz
Â  Â  Â  Â  Â  Â  Â  tbody += `<tr data-cid="${m.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${attendanceTd}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nameTd}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${scoreTds}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${sumTd}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 4. Wstaw gotowy HTML do modala
Â  Â  Â  Â  Â  Â  $('#scoringBody').html(`
Â  Â  Â  Â  Â  Â  Â  ${!hasBehaviors ? '<div class="alert alert-info mb-2">Brak zachowaÅ„ do oceny. MoÅ¼esz zapisaÄ‡ tylko obecnoÅ›Ä‡.</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  Â  Â  Â  <table class="table table-sm table-bordered align-middle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>${thead}</thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${tbody}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  </div>`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // WÅ‚Ä…cz przycisk zapisu
Â  Â  Â  Â  Â  Â  $('#saveScoresBtn').prop('disabled', false);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Ustaw ID i pokaÅ¼ modal (bez zmian)
Â  Â  Â  Â  Â  $('#scoringSessionId').val(String(sessionId));
Â  Â  Â  Â  Â  $('#scoringGroupId').val(String(groupId));
Â  Â  Â  Â  Â  scoringModal.show();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  alert('Nie udaÅ‚o siÄ™ wczytaÄ‡ danych do punktacji: ' + e.message);
Â  Â  Â  Â  }
Â  Â  Â  }

      /**
       * OdÅ›wieÅ¼a i wyÅ›wietla podsumowanie bonusÃ³w dla grupy w danym roku.
       * @param {number} groupId - ID grupy.
       * @param {number} year - Rok do wyÅ›wietlenia.
       */
      async function refreshBonusesSummary(groupId, schoolYearStart) {
        const container = $('#bonusesSummary').html(`<div class="alert alert-info mb-0">Åadowanie podsumowania bonusÃ³wâ€¦</div>`);
        try {
            const data = await fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/bonuses?school_year_start=${schoolYearStart}`);

            const createPanel = (semesterData, semesterNum, yearLabel) => {
                const scopeLabel = semesterNum === 1 ? 'I PÃ³Å‚rocze' : 'II PÃ³Å‚rocze';
                return `
                  <div class="col-lg-6">
                    <div class="card h-100">
                      <div class="card-header fw-bold">${scopeLabel} ${yearLabel}</div>
                      <div class="card-body">
                        <p class="mb-1"><strong>Cel:</strong> ${semesterData.target_points} pkt</p>
                        <p class="mb-3"><strong>Nagroda:</strong> ${semesterData.reward}</p>
                        <h6 class="card-title">PostÄ™p</h6>
                        <p class="mb-1"><strong>Zebrano bonusÃ³w:</strong> ${semesterData.points_collected} pkt</p>
                        <p class="mb-0 fs-5"><strong>PozostaÅ‚o do celu: <span class="fw-bold text-primary">${semesterData.points_remaining} pkt</span></strong></p>
                      </div>
                    </div>
                  </div>`;
            };

            container.html(`
                <div class="row g-3">
                    ${createPanel(data.semester_1, 1, data.school_year_label)}
                    ${createPanel(data.semester_2, 2, data.school_year_label)}
                </div>`);
            $('#hideBonusesBtn').show();
        } catch (e) {
            console.error(e);
            container.html(`<div class="alert alert-danger">${e.message}</div>`);
        }
    }

      // ==========================================================
      // === GÅÃ“WNY BLOK EVENT LISTENERÃ“W =========================
      // ==========================================================

      // --- Przyciski na stronie gÅ‚Ã³wnej ---
      $('#addGroupBtn').on('click', async () => {
        currentGroupId = null;
        $('#groupModalTitle').text('Nowa grupa');
        $('#groupForm')[0].reset();
        try {
          await loadTherapistsAndClients();
          groupModal.show();
        } catch (e) {
          console.error(e);
          alert('Nie udaÅ‚o siÄ™ pobraÄ‡ list terapeutÃ³w i uczestnikÃ³w.');
        }
      });

      $('#groupsContainer').on('click', '.view-group-btn', function() {
        openGroupDetails($(this).data('group-id'));
      });

      $('#groupsContainer').on('click', '.edit-group-btn', async function() {
        const gid = $(this).data('group-id');
        try {
          const g = await fetchJSON(`${API_BASE}/api/tus/groups/${gid}`);
          currentGroupId = g.id;
          $('#groupModalTitle').text(`Edytuj grupÄ™: ${g.name}`);
          await loadTherapistsAndClients({
            name: g.name,
            therapist_id: g.therapist_id,
            assistant_therapist_id: g.assistant_therapist_id,
            client_ids: (g.members || []).map(m => m.id)
          });
          groupModal.show();
        } catch (e) {
          console.error(e);
          alert('Nie udaÅ‚o siÄ™ pobraÄ‡ danych grupy do edycji.');
        }
      });

      // --- Formularz dodawania/edycji grupy ---
      $('#groupForm').on('submit', async function(e) {
        e.preventDefault();
        const payload = {
          name: ($('#groupName').val() || '').trim(),
          therapist_id: parseInt($('#therapistSelect').val(), 10) || null,
          assistant_therapist_id: parseInt($('#assistantTherapistSelect').val(), 10) || null,
          client_ids: ($('#clientSelect').val() || []).map(v => parseInt(v, 10))
        };

        if (!payload.name || !payload.therapist_id || payload.client_ids.length === 0) {
          return alert('Nazwa grupy, terapeuta prowadzÄ…cy i co najmniej jeden uczestnik sÄ… wymagani.');
        }

        const url = currentGroupId ? `${API_BASE}/api/tus/groups/${currentGroupId}` : `${API_BASE}/api/tus/groups`;
        const method = currentGroupId ? 'PUT' : 'POST';

        try {
          await fetchJSON(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          groupModal.hide();
          await loadGroups();
        } catch (err) {
          console.error(err);
          alert('Nie udaÅ‚o siÄ™ zapisaÄ‡ grupy: ' + err.message);
        }
      });

      // ZASTÄ„P CAÅY TEN BLOK - OD 'submit' DO KOÅƒCOWEGO '});'
      $(document).on('submit', '#addSessionForm', async function(e) {
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  const $form = $(this);
Â  Â  Â  Â  Â  const gid = $form.data('group-id');

Â  Â  Â  Â  Â  const dateValue = $form.find('input[name="date"]').val();
Â  Â  Â  Â  Â  const timeValue = $form.find('input[name="time"]').val();

Â  Â  Â  Â  Â  if (!dateValue || !timeValue) {
Â  Â  Â  Â  Â  Â  Â  alert('Data i godzina sÄ… wymagane!');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  let timeFormatted = timeValue.length === 5 ? timeValue + ':00' : timeValue;
Â  Â  Â  Â  Â  const topicTitle = ($('#sessionTopicInput').val() || '').trim();

Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  group_id: gid,
Â  Â  Â  Â  Â  Â  Â  topic_title: topicTitle,
Â  Â  Â  Â  Â  Â  Â  session_date: `${dateValue}T${timeFormatted}`,
Â  Â  Â  Â  Â  Â  Â  behavior_ids: ($('#sessionBehaviorsSelect').val() || []).map(v => parseInt(v, 10))
Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  // --- NOWA SEKCJA: Zbieranie obecnoÅ›ci z formularza ---
Â  Â  Â  Â  Â  const present_client_ids = [];
Â  Â  Â  Â  Â  $form.find('.new-session-attendance:checked').each(function() {
Â  Â  Â  Â  Â  Â  Â  present_client_ids.push(parseInt($(this).val(), 10));
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  payload.present_client_ids = present_client_ids;
Â  Â  Â  Â  Â  // --- KONIEC NOWEJ SEKCJI ---

Â  Â  Â  Â  Â  if (!payload.topic_title) {
Â  Â  Â  Â  Â  Â  Â  return alert('Temat jest wymagany.');
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // Zaktualizowany log, aby pokazaÄ‡ nowe dane
Â  Â  Â  Â  Â  console.log("WysyÅ‚ane dane sesji (z topic_title i obecnoÅ›ciÄ…):", JSON.stringify(payload, null, 2));

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  await fetchJSON(`${API_BASE}/api/tus/sessions`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  await openGroupDetails(gid); // OdÅ›wieÅ¼ widok
Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  console.error("BÅ‚Ä…d podczas tworzenia sesji:", err);
Â  Â  Â  Â  Â  Â  Â  alert('Nie udaÅ‚o siÄ™ dodaÄ‡ sesji: ' + err.message);
Â  Â  Â  Â  Â  }
Â  Â  Â  });
      // KONIEC BLOKU DO ZASTÄ„PIENIA
      $(document).on('click', '.delete-session-btn', async function() {
    const sid = $(this).data('session-id');
    const gid = $(this).data('group-id');

    // --- POCZÄ„TEK NOWEJ LOGIKI PYTAÅƒ ---
    // Pytanie 1: Potwierdzenie usuniÄ™cia sesji
    if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ sesjÄ™? Spowoduje to usuniÄ™cie punktÃ³w za zachowania i bonusÃ³w PRZYPISANYCH do tej konkretnej sesji.')) {
        return; // Anuluj, jeÅ›li uÅ¼ytkownik kliknie "Anuluj"
    }

    // Pytanie 2: Opcjonalne usuniÄ™cie wszystkich bonusÃ³w w grupie
    const deleteAllBonuses = confirm(
        'PYTANIE DODATKOWE:\n\nCzy chcesz usunÄ…Ä‡ rÃ³wnieÅ¼ WSZYSTKIE bonusy (sesyjne i ogÃ³lne) dla caÅ‚ej grupy?\n\n' +
        '-> Kliknij "OK", aby wyczyÅ›ciÄ‡ wszystkie bonusy w tej grupie.\n' +
        '-> Kliknij "Anuluj", aby usunÄ…Ä‡ tylko tÄ™ jednÄ… sesjÄ™ i jej punkty.'
    );
    // --- KONIEC NOWEJ LOGIKI PYTAÅƒ ---

    try {
        // Dodajemy nowy parametr do zapytania, informujÄ…cy serwer o decyzji uÅ¼ytkownika
        await fetchJSON(`${API_BASE}/api/tus/sessions/${sid}?delete_all_bonuses=${deleteAllBonuses}`, {
            method: 'DELETE'
        });

        alert('âœ… Sesja zostaÅ‚a usuniÄ™ta.');
        await openGroupDetails(gid);

    } catch (e) {
        alert('Nie udaÅ‚o siÄ™ usunÄ…Ä‡ sesji: ' + e.message);
    }
});

      $(document).on('click', '.score-session-btn', function() {
        openScoringModal($(this).data('session-id'), $(this).data('group-id'));
      });

      $(document).on('click', '.bonus-session-btn', function() {
        openBonusModal($(this).data('session-id'));
      });

      $(document).on('submit', '#groupTargetForm', async function(e) {
            e.preventDefault();
            const $form = $(this);
            const gid = $form.data('group-id');

            // --- POPRAWIONE ODCZYTYWANIE WARTOÅšCI Z FORMULARZA ---
            const payload = {
                school_year_start: parseInt($form.find('select[name="school_year_start"]').val(), 10),
                semester: parseInt($form.find('select[name="semester"]').val(), 10),
                points: parseInt($form.find('input[name="points"]').val(), 10),
                reward: ($form.find('input[name="reward"]').val() || '').trim()
            };

            // --- POPRAWIONA WALIDACJA ---
            if (!payload.school_year_start || isNaN(payload.points)) {
                alert('Rok szkolny i cel (punkty) sÄ… wymagane.');
                return;
            }

            try {
                await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/target`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                alert('âœ… Cel zostaÅ‚ zapisany.');

                // Automatycznie odÅ›wieÅ¼ widok podsumowania po zapisaniu celu
                await refreshBonusesSummary(gid, payload.school_year_start);

            } catch (err) {
                console.error(err);
                alert('Nie udaÅ‚o siÄ™ zapisaÄ‡ celu: ' + err.message);
            }
        });

      $(document).on('click', '#bonusScopeRefreshBtn', function() {
        const gid = $(this).data('group-id');
        const year = parseInt($('#bonusYearInput').val(), 10) || new Date().getFullYear();
        refreshBonusesSummary(gid, year);
      });

      $(document).on('click', '#hideBonusesBtn', function() {
        $('#bonusesSummary').empty();
        $(this).hide();
      });

      $(document).on('click', '#showTopicHistoryBtn', async function() {
        const gid = $(this).data('group-id');
        const $body = $('#topicHistoryBody').html('<p class="text-center text-muted">Åadowanie...</p>');
        topicHistoryModal.show();

        try {
          const historyData = await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/topic-history`);
          if (Object.keys(historyData).length === 0) {
            $body.html('<p class="text-center">Brak danych do wyÅ›wietlenia.</p>');
            return;
          }
          let finalHtml = '';
          for (const clientId in historyData) {
            const clientData = historyData[clientId];
            const itemsHtml = clientData.history.map(item => {
              const date = new Date(item.date).toLocaleDateString('pl-PL');
              return `<li><strong>${item.topic}</strong> <small class="text-muted">(${date} w: ${item.group_name})</small></li>`;
            }).join('');
            finalHtml += `<h6 class="mt-3 border-bottom pb-1">${clientData.client_name}</h6><ul class="list-unstyled">${itemsHtml}</ul>`;
          }
          $body.html(finalHtml);
        } catch (err) {
          $body.html(`<div class="alert alert-danger">${err.message}</div>`);
        }
      });

      $(document).on('submit', '#awardGeneralBonusForm', async function(e) {
        e.preventDefault();
        const $form = $(this);
        const gid = $form.data('group-id');
        const payload = {
          client_id: parseInt($form.find('select[name="client_id"]').val(), 10),
          points: parseInt($form.find('input[name="points"]').val(), 10),
          reason: ($form.find('input[name="reason"]').val() || '').trim()
        };

        if (!payload.client_id || !payload.points || payload.points <= 0) {
          return alert('Wybierz uczestnika i podaj poprawnÄ… liczbÄ™ punktÃ³w (wiÄ™kszÄ… od 0).');
        }

        try {
          await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/award-general-bonus`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          alert('âœ… Bonus zostaÅ‚ przyznany!');
          await openGroupDetails(gid);

        } catch (err) {
          alert('Nie udaÅ‚o siÄ™ przyznaÄ‡ bonusu: ' + err.message);
        }
      });

            const saveScheduleBtn = document.getElementById('saveScheduleBtn');
            if(saveScheduleBtn) {
                saveScheduleBtn.addEventListener('click', async () => {
                    try {
                        // Zapisujemy tablicÄ™ dat, a nie dni tygodnia
                        const payload = { schedule_days: Array.from(selectedDates) };
                        await fetchJSON(`/api/tus/groups/${groupId}/schedule`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        showAlert('Szablon tygodnia zostaÅ‚ zapisany!', 'success');
                    } catch (err) {
                        showAlert(`BÅ‚Ä…d zapisu szablonu: ${err.message}`, 'danger');
                    }
                });
            }


      // --- Akcje w modalu oceniania (scoring) ---
      $(document).on('input', '.score-input', function() {
        const $row = $(this).closest('tr');
        let sum = 0;
        $row.find('.score-input').each(function() {
          sum += parseInt($(this).val() || '0', 10);
        });
        $row.find('.sum-cell').text(sum);
      });

      $('#saveScoresBtn').on('click', async function() {
Â  Â  Â  Â  const sid = parseInt($('#scoringSessionId').val(), 10);
Â  Â  Â  Â  const gid = parseInt($('#scoringGroupId').val(), 10);
Â  Â  Â  Â  
Â  Â  Â  Â  const payload = { scores: [], attendance: [] };

Â  Â  Â  Â  $('#scoringBody tbody tr').each(function() {
Â  Â  Â  Â  Â  const client_id = parseInt($(this).data('cid'), 10);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Zbieranie danych o obecnoÅ›ci (zawsze)
Â  Â  Â  Â  Â  const is_present = $(this).find('.attendance-check').is(':checked');
Â  Â  Â  Â  Â  payload.attendance.push({ client_id, is_present });

Â  Â  Â  Â  Â  // Zbieranie punktÃ³w (tylko jeÅ›li istniejÄ… inputy ocen)
Â  Â  Â  Â  Â  const items = [];
Â  Â  Â  Â  Â  const $scoreInputs = $(this).find('.score-input');

Â  Â  Â  Â  Â  if ($scoreInputs.length > 0) {
Â  Â  Â  Â  Â  Â  $scoreInputs.each(function() {
Â  Â  Â  Â  Â  Â  Â  items.push({
Â  Â  Â  Â  Â  Â  Â  Â  behavior_id: parseInt($(this).data('bid'), 10),
Â  Â  Â  Â  Â  Â  Â  Â  points: parseInt($(this).val(), 10) || 0
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  payload.scores.push({ client_id, items });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // Logika zapisu jest taka sama, backend obsÅ‚uÅ¼y pustÄ… tablicÄ™ 'scores'
Â  Â  Â  Â  Â  await fetchJSON(`${API_BASE}/api/tus/sessions/${sid}/scores`, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  scoringModal.hide();
Â  Â  Â  Â  Â  alert('âœ… Punktacja i obecnoÅ›Ä‡ zostaÅ‚y zapisane.');
Â  Â  Â  Â  Â  await openGroupDetails(gid);
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  alert('Nie udaÅ‚o siÄ™ zapisaÄ‡ punktacji: ' + e.message);
Â  Â  Â  Â  }
Â  Â  Â  });

      // --- Akcje w modalu bonusÃ³w ---
      $('#saveBonusesBtn').on('click', async function() {
        const sessionId = $(this).data('session-id');
        const bonuses = [];
        $('.bonus-points-input').each(function() {
          bonuses.push({
            client_id: $(this).data('client-id'),
            points: parseInt($(this).val(), 10) || 0
          });
        });

        try {
          await fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/bonuses`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bonuses })
          });
          bonusModal.hide();
          alert('âœ… Bonusy zostaÅ‚y zapisane.');
          // Automatyczne odÅ›wieÅ¼enie widoku grupy, jeÅ›li jest otwarty
          const activeModal = document.querySelector('#groupDetailsModal.show');
          if(activeModal){
            const groupId = $(activeModal).find('#deleteGroupFromDetailsBtn').data('group-id');
            if(groupId){
              await openGroupDetails(groupId);
            }
          }
        } catch (err) {
          alert(`BÅ‚Ä…d zapisu bonusÃ³w: ${err.message}`);
        }
      });

      // --- Akcje w modalu TematÃ³w ---
      $('#topicsModal').on('shown.bs.modal', loadTopicsModalList);
      $('#addTopicForm').on('submit', async function(e) {
        e.preventDefault();
        const title = ($('#newTopicTitle').val() || '').trim();
        if (!title) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/topics`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title })
          });
          $('#newTopicTitle').val('');
          await loadTopicsModalList();
        } catch (err) {
          alert('Nie udaÅ‚o siÄ™ dodaÄ‡ tematu: ' + err.message);
        }
      });

      // --- Akcje w modalu ZachowaÅ„ ---
      $('#behaviorsModal').on('shown.bs.modal', reloadBehaviorsModal);
      $('#addBehaviorForm').on('submit', async function(e) {
        e.preventDefault();
        const payload = {
          title: ($('#newBehaviorTitle').val() || '').trim(),
          default_max_points: parseInt($('#newBehaviorMax').val() || '3', 10)
        };
        if (!payload.title) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/behaviors`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          $('#newBehaviorTitle').val('');
          $('#newBehaviorMax').val('3');
          await reloadBehaviorsModal();
        } catch (err) {
          alert('Nie udaÅ‚o siÄ™ dodaÄ‡ zachowania: ' + err.message);
        }
      });

      $(document).on('click', '.del-beh', async function() {
        const id = $(this).data('id');
        if (!confirm('UsunÄ…Ä‡ to zachowanie ze sÅ‚ownika?')) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/behaviors/${id}`, { method: 'DELETE' });
          await reloadBehaviorsModal();
        } catch (err) {
          alert('Nie udaÅ‚o siÄ™ usunÄ…Ä‡ zachowania: ' + err.message);
        }
      });

      // ==========================================================
      // === FUNKCJE URUCHOMIENIOWE ===============================
      // ==========================================================

      /**
       * Sprawdza, czy w URL znajduje siÄ™ parametr `openGroup` i jeÅ›li tak,
       * automatycznie otwiera modal szczegÃ³Å‚Ã³w dla wskazanej grupy.
       */
      function openGroupFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const groupIdToOpen = urlParams.get('openGroup');
        if (groupIdToOpen) {
          setTimeout(() => {
            console.log(`PrÃ³ba automatycznego otwarcia grupy o ID: ${groupIdToOpen}`);
            openGroupDetails(groupIdToOpen).catch(err => {
              console.error(`Nie udaÅ‚o siÄ™ otworzyÄ‡ grupy z URL: ${err.message}`);
              alert(`Nie moÅ¼na byÅ‚o otworzyÄ‡ grupy o ID ${groupIdToOpen}. ByÄ‡ moÅ¼e zostaÅ‚a usuniÄ™ta.`);
            });
          }, 500); // OpÃ³Åºnienie, aby daÄ‡ UI czas na zaÅ‚adowanie
        }
      }

      // Inicjalne zaÅ‚adowanie grup i sprawdzenie URL
      loadGroups();
      openGroupFromUrl();

    });


  </script>
</body>

</html>





















