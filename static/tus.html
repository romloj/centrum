<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <title>Modu≈Ç TUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="menu_fab.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .select2-container--bootstrap-5 .select2-selection {
      min-height: 38px;
    }
    .select2-container--bootstrap-5 .select2-selection__rendered {
      padding-top: 4px;
    }
      /* Style dla mini-kalendarza w modalu TUS */
.session-calendar {
    border: 1px solid var(--bs-border-color);
    border-radius: .5rem;
    background: #fff;
}
.session-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: .5rem;
    border-bottom: 1px solid var(--bs-border-color);
}
.session-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
}
.session-calendar-dow {
    font-size: .75rem;
    font-weight: 600;
    color: var(--bs-secondary-color);
    padding: .25rem 0;
}
.session-calendar-day {
    font-size: .8rem;
    padding: .5rem 0;
    border-top: 1px solid var(--bs-border-color);
    cursor: pointer;
    position: relative;
}
.session-calendar-day:hover {
    background-color: var(--bs-primary-bg-subtle);
}
.session-calendar-day.other-month {
    color: var(--bs-secondary-color);
    opacity: .6;
}
/* K√≥≈Çko oznaczajƒÖce zaplanowanƒÖ sesjƒô */
.session-calendar-day.scheduled::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--bs-primary);
}
/* Styl dla zaznaczonego dnia */
.session-calendar-day.selected {
    background-color: var(--bs-primary);
    color: #fff;
    font-weight: 600;
    border-radius: 50%;
}
      /* Styl dla regularnego dnia zajƒôƒá (szablonu) */
.session-calendar-day.is-selected-day {
    background-color: var(--bs-info-bg-subtle);
    font-weight: bold;
}

  </style>
</head>

<body>

  <div class="container py-4">
    <header class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
      <h1 class="h3 m-0">üë• Modu≈Ç TUS ‚Äì Grupy</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#topicsModal">Tematy</button>
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#behaviorsModal">Zachowania</button>
        <button class="btn btn-primary" id="addGroupBtn">Stw√≥rz nowƒÖ grupƒô</button>
      </div>
    </header>

    <main id="groupsContainer" class="row g-4"></main>
  </div>

  <div class="modal fade" id="groupDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupDetailsTitle">Szczeg√≥≈Çy grupy</h5>
          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-danger btn-sm" id="deleteGroupFromDetailsBtn" style="display:none">Usu≈Ñ grupƒô</button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Zamknij</button>
          </div>
        </div>
        <div class="modal-body" id="groupDetailsBody">
          </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="groupModalTitle">Dane grupy</h5>
        </div>
        <div class="modal-body">
          <form id="groupForm" novalidate>
            <div class="mb-3">
              <label for="groupName" class="form-label">Nazwa grupy</label>
              <input type="text" class="form-control" id="groupName" required />
            </div>
            <div class="mb-3">
              <label for="therapistSelect" class="form-label">Terapeuta prowadzƒÖcy</label>
              <select class="form-select" id="therapistSelect"></select>
            </div>
            <div class="mb-3">
              <label for="assistantTherapistSelect" class="form-label">Terapeuta wspomagajƒÖcy (opcjonalnie)</label>
              <select class="form-select" id="assistantTherapistSelect"></select>
            </div>

            <div class="mb-3">
              <label for="clientSelect" class="form-label">Uczestnicy</label>
              <select class="form-select" id="clientSelect" multiple></select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="submit" form="groupForm" class="btn btn-primary" id="saveGroupBtn">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="topicsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tematy TUS</h5>
        </div>
        <div class="modal-body">
          <form id="addTopicForm" class="d-flex gap-2 mb-3">
            <input type="text" class="form-control" id="newTopicTitle" placeholder="Tytu≈Ç tematu" required />
            <button type="submit" class="btn btn-success">Dodaj</button>
          </form>
          <ul class="list-group" id="topicsList"></ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="behaviorsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Zachowania do modelowania</h5>
        </div>
        <div class="modal-body">
          <form id="addBehaviorForm" class="row g-2 align-items-end mb-3">
            <div class="col-8">
              <label class="form-label">Nazwa</label>
              <input type="text" class="form-control" id="newBehaviorTitle" placeholder="np. czekanie na swojƒÖ kolej" required />
            </div>
            <div class="col-4">
              <label class="form-label">Domy≈õlny max</label>
              <input type="number" class="form-control" id="newBehaviorMax" value="3" min="1" max="10" />
            </div>
            <div class="col-12">
              <button class="btn btn-success">Dodaj zachowanie</button>
            </div>
          </form>
          <ul id="behaviorsList" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="scoringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Punktacja sesji</h5>
        </div>
        <div class="modal-body">
          <div id="scoringBody"></div>
        </div>
        <div class="modal-footer">
          <input type="hidden" id="scoringSessionId" />
          <input type="hidden" id="scoringGroupId" />
          <button class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
          <button id="saveScoresBtn" class="btn btn-primary">Zapisz punktacjƒô</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="topicHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Historia zrealizowanych temat√≥w</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="topicHistoryBody">
          </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="bonusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bonusModalTitle">Bonusy Indywidualne</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Wpisz punkty bonusowe dla ka≈ºdego uczestnika poni≈ºej.</p>
          <div id="bonusModalSessionInfo" class="mb-3"></div>
          <form id="bonusForm">
            <div id="bonusParticipantsContainer">
              </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="button" class="btn btn-primary" id="saveBonusesBtn">Zapisz Bonusy</button>
        </div>
      </div>
    </div>
  </div>
<!-- Floating Action Menu - TYLKO RAZ, na ko≈Ñcu body -->
    <div class="fab-container" id="fabContainer">
    <ul class="fab-menu">
        <li class="fab-item">
            <span class="fab-label">Plan terapeuty</span>
            <a href="therapist1.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-heart-pulse"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Modu≈Ç TUS</span>
            <a href="tus.html" class="fab-button" title="Modu≈Ç TUS">
                <i class="bi bi-star-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Lista klient√≥w</span>
            <a href="klienci.html" class="fab-button" title="Lista klient√≥w">
                <i class="bi bi-people-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Historia klient√≥w</span>
            <a href="client_history.html" class="fab-button" title="Historia klient√≥w">
                <i class="bi bi-clock-history"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Modu≈Ç Kierowcy</span>
            <a href="drivers.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-car-front-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Strona g≈Ç√≥wna</span>
            <a href="index.html" class="fab-button" title="Strona g≈Ç√≥wna">
                <i class="bi bi-house-fill"></i>
            </a>
        </li>
    </ul>
    <button class="fab-main" id="fabMainBtn" aria-label="Rozwi≈Ñ menu">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>
    <div class="fab-backdrop" id="fabBackdrop"></div>

    <!-- Skrypty-->

    <script src="fab-menu.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    $(function() {

      // ==========================================================
      // === INICJALIZACJA I ZMIENNE GLOBALNE =====================
      // ==========================================================

      const API_BASE = ''; // Pusty string, je≈õli API jest w tej samej domenie
      let currentGroupId = null; // null = tryb tworzenia, liczba = tryb edycji

      // Inicjalizacja instancji modali Bootstrapa
      const groupDetailsModal = new bootstrap.Modal(document.getElementById('groupDetailsModal'));
      const groupModal = new bootstrap.Modal(document.getElementById('groupModal'));
      const scoringModal = new bootstrap.Modal(document.getElementById('scoringModal'));
      const topicHistoryModal = new bootstrap.Modal(document.getElementById('topicHistoryModal'));
      const bonusModal = new bootstrap.Modal(document.getElementById('bonusModal'));
      const topicsModal = new bootstrap.Modal(document.getElementById('topicsModal'));
      const behaviorsModal = new bootstrap.Modal(document.getElementById('behaviorsModal'));


      // ==========================================================
      // === FUNKCJE POMOCNICZE I API =============================
      // ==========================================================

      /**
       * Uniwersalna funkcja do zapyta≈Ñ API, obs≈ÇugujƒÖca b≈Çƒôdy i format JSON.
       * @param {string} url - Adres URL endpointu API.
       * @param {object} options - Opcje dla `fetch`, np. `method`, `headers`, `body`.
       * @returns {Promise<any>} - Rozstrzyga do sparsowanej odpowiedzi JSON.
       */
      async function fetchJSON(url, options) {
        try {
          const res = await fetch(url, options);
          const text = await res.text();
          const ct = res.headers.get('content-type') || '';

          if (!ct.includes('application/json')) {
            throw new Error(`Odpowied≈∫ serwera nie jest w formacie JSON (HTTP ${res.status}) ‚Äî ${text.slice(0, 200)}`);
          }

          const data = JSON.parse(text);
          if (!res.ok) {
            const msg = (data && (data.error || data.message)) || `B≈ÇƒÖd serwera (HTTP ${res.status})`;
            throw new Error(msg);
          }
          return data;
        } catch (e) {
          // Przeka≈º dalej b≈ÇƒÖd, aby m√≥g≈Ç byƒá obs≈Çu≈ºony w wywo≈ÇujƒÖcej funkcji
          throw e;
        }
      }

      /** Inicjalizuje kontrolki Select2 w formularzu dodawania/edycji grupy. */
      function initGroupFormSelect2() {
        $('#therapistSelect, #assistantTherapistSelect').select2({
          theme: 'bootstrap-5',
          dropdownParent: $('#groupModal'),
          placeholder: 'Wybierz terapeutƒô',
          allowClear: true,
          width: '100%'
        });


        $('#clientSelect').select2({
          theme: 'bootstrap-5',
          dropdownParent: $('#groupModal'),
          placeholder: 'Wybierz uczestnik√≥w',
          width: '100%'
        });
      }

       function showAlert(msg, type = "success") {
    const alertBox = document.getElementById('alertBox');
    // Upewnij siƒô, ≈ºe element alertBox istnieje w Twoim HTML
    if (alertBox) {
        alertBox.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
    } else {
        // Je≈õli nie ma dedykowanego miejsca, u≈ºyj standardowego alertu
        alert(msg);
    }
}

      // ==========================================================
      // === G≈Å√ìWNE FUNKCJE ≈ÅADUJƒÑCE DANE =========================
      // ==========================================================

      /** ≈Åaduje i wy≈õwietla listƒô wszystkich grup na stronie g≈Ç√≥wnej. */
      async function loadGroups() {
            try {
                const groups = await fetchJSON(`${API_BASE}/api/tus/groups-summary`);
                const $container = $('#groupsContainer').empty();

                if (!groups || !groups.length) {
                    $container.html('<div class="col-12"><p class="text-center text-muted">Brak grup. Stw√≥rz pierwszƒÖ!</p></div>');
                    return;
                }

                groups.forEach(g => {
                    const progressPercent = (g.target_points > 0) ? (g.total_points_collected / g.target_points * 100) : 0;

                    // --- POCZƒÑTEK POPRAWKI ---
                    // Wprowadzamy nowƒÖ, potr√≥jnƒÖ logikƒô dla statusu celu.
                    const statusMessage = g.target_points > 0
                        ? (g.points_remaining > 0 ? `${g.points_remaining} pkt do celu` : 'Cel osiƒÖgniƒôty! üéâ')
                        : 'Nie ustawiono celu';
                    // --- KONIEC POPRAWKI ---

                    const cardHtml = `
                      <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                          <div class="card-header">
                            <h5 class="card-title mb-0">${g.name}</h5>
                            <small class="text-muted">${g.therapist_name ?? 'Brak terapeuty'}</small>
                          </div>
                          <div class="card-body">
                            <p class="card-text mb-2"><strong>Uczestnicy:</strong> ${g.member_count}</p>
                            <p class="card-text"><strong>Ostatni temat:</strong> ${g.last_topic || '<em>Brak sesji</em>'}</p>
                            <hr>
                            <h6 class="card-subtitle mb-2 text-muted">Postƒôp w tym p√≥≈Çroczu</h6>
                            <p class="mb-1"><strong>Zebrano:</strong> ${g.total_points_collected} / ${g.target_points > 0 ? g.target_points : '?'} pkt</p>
                            <div class="progress mb-2" style="height: 20px;">
                              <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%"
                                   aria-valuenow="${g.total_points_collected}" aria-valuemin="0" aria-valuemax="${g.target_points}">
                              </div>
                            </div>
                            <small class="d-block text-center text-muted mt-1">
                                ${statusMessage}
                            </small>
                            <p class="card-text mt-2"><strong>Nagroda:</strong> ${g.reward || '<em>Nie ustawiono</em>'}</p>
                          </div>
                          <div class="card-footer d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-primary btn-sm view-group-btn" data-group-id="${g.id}">ZarzƒÖdzaj</button>
                            <button class="btn btn-secondary btn-sm edit-group-btn" data-group-id="${g.id}">Edytuj</button>
                          </div>
                        </div>
                      </div>`;
                    $container.append(cardHtml);
                });
            } catch (e) {
                console.error(e);
                $('#groupsContainer').html(`<div class="col-12"><div class="alert alert-danger">Nie mo≈ºna za≈Çadowaƒá grup: ${e.message}</div></div>`);
            }
        }

      /**
       * Pobiera listy terapeut√≥w i klient√≥w, a nastƒôpnie wype≈Çnia nimi kontrolki Select2 w formularzu grupy.
       * @param {object} [prefill] - Opcjonalny obiekt z danymi do wstƒôpnego wype≈Çnienia formularza (edycja).
       */
      async function loadTherapistsAndClients(prefill = {}) {
        const [therapists, clients] = await Promise.all([
          fetchJSON(`${API_BASE}/api/therapists`),
          fetchJSON(`${API_BASE}/api/clients`)
        ]);

        const activeTherapists = (therapists || []).filter(t => t.active);
        const activeClients = (clients || []).filter(c => c.active);

        const $therapistSelect = $('#therapistSelect').empty().append(new Option('', ''));
        const $assistantSelect = $('#assistantTherapistSelect').empty().append(new Option('', ''));
        activeTherapists.forEach(t => {
          $therapistSelect.append(new Option(t.full_name, String(t.id)));
          $assistantSelect.append(new Option(t.full_name, String(t.id)));
        });

        const $clientSelect = $('#clientSelect').empty();
        activeClients.forEach(c => $clientSelect.append(new Option(c.full_name, String(c.client_id || c.id))));

        initGroupFormSelect2(); // Zainicjuj Select2 po wype≈Çnieniu opcji

        // Wype≈Çnij formularz danymi, je≈õli sƒÖ dostƒôpne (tryb edycji)
        if (prefill.name) $('#groupName').val(prefill.name);
        if (prefill.therapist_id) $('#therapistSelect').val(String(prefill.therapist_id)).trigger('change');
        if (prefill.assistant_therapist_id) $('#assistantTherapistSelect').val(String(prefill.assistant_therapist_id)).trigger('change');
        if (prefill.client_ids) $('#clientSelect').val(prefill.client_ids.map(String)).trigger('change');
      }

      /** Pobiera listƒô temat√≥w i wy≈õwietla jƒÖ w modalu temat√≥w. */
      async function loadTopicsModalList() {
        const $list = $('#topicsList').html('<li class="list-group-item text-muted">≈Åadowanie...</li>');
        try {
          const topics = await fetchJSON(`${API_BASE}/api/tus/topics`);
          $list.empty();
          if (!topics || topics.length === 0) {
            $list.append('<li class="list-group-item text-muted">Brak zdefiniowanych temat√≥w.</li>');
            return;
          }
          topics.forEach(t => $list.append(`<li class="list-group-item">${t.title}</li>`));
        } catch (e) {
          console.error(e);
          $list.html('<li class="list-group-item text-danger">B≈ÇƒÖd ≈Çadowania temat√≥w.</li>');
        }
      }

      /** Pobiera listƒô zachowa≈Ñ i wy≈õwietla jƒÖ w modalu zachowa≈Ñ. */
      async function reloadBehaviorsModal() {
        const $list = $('#behaviorsList').html('<li class="list-group-item text-muted">≈Åadowanie‚Ä¶</li>');
        try {
          const items = await fetchJSON(`${API_BASE}/api/tus/behaviors`);
          $list.empty();
          if (!items || !items.length) {
            $list.append('<li class="list-group-item text-muted">Brak zdefiniowanych zachowa≈Ñ.</li>');
            return;
          }
          items.forEach(b => {
            $list.append(`
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${b.title} <small class="text-muted">(domy≈õlny max ${b.default_max_points ?? 3})</small></span>
                <button class="btn btn-outline-danger btn-sm del-beh" data-id="${b.id}">Usu≈Ñ</button>
              </li>`);
          });
        } catch (e) {
          console.error(e);
          $list.html('<li class="list-group-item text-danger">B≈ÇƒÖd ≈Çadowania zachowa≈Ñ.</li>');
        }
      }


      // ==========================================================
      // === FUNKCJE ZARZƒÑDZAJƒÑCE MODALAMI ========================
      // ==========================================================


 async function saveSchedule(groupId, scheduleDays) {
        try {
            const response = await fetch(`/api/tus/groups/${groupId}/schedule`, {
                method: 'PUT', // <-- UPEWNIJ SIƒò, ≈ªE JEST TUTAJ 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ schedule_days: scheduleDays }),
            });

            if (!response.ok) {
                throw new Error('B≈ÇƒÖd serwera: ' + response.status);
            }

            // Sukces
            console.log("Harmonogram zapisany!");

        } catch (error) {
            console.error("Nie uda≈Ço siƒô zapisaƒá harmonogramu:", error);
        }
    }

      /**
       * Otwiera g≈Ç√≥wny, interaktywny modal ze szczeg√≥≈Çami grupy, sesjami i opcjami.
       * @param {number} groupId - ID grupy do wy≈õwietlenia.
       */
      // W pliku tus.html znajd≈∫ i podmie≈Ñ tƒô funkcjƒô

async function openGroupDetails(groupId) {
        try {
            const g = await fetchJSON(`${API_BASE}/api/tus/groups/${groupId}`);
            const [bonusDetails, bonusHistory] = await Promise.all([
               fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/bonus-details`),
               fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/general-bonus-history`)
            ]);

            $('#groupDetailsTitle').text(`ZarzƒÖdzaj grupƒÖ: ${g.name}`);
            $('#deleteGroupFromDetailsBtn').show().data('group-id', g.id);

            // --- LOGIKA KALENDARZA ---
            let calendarCurrentDate = new Date();
            const scheduledDates = new Set(g.sessions.map(s => s.session_date.slice(0, 10)));
            const DOW_SHORT = ["Nd", "Pn", "Wt", "≈ör", "Cz", "Pt", "So"];
            let selectedDates = new Set(g.schedule_days || []);

            function renderSessionCalendar() {
                const year = calendarCurrentDate.getFullYear();
                const month = calendarCurrentDate.getMonth();
                const calendarEl = document.getElementById('sessionCalendar');
                if (!calendarEl) return;

                const firstOfMonth = new Date(year, month, 1);
                const lastOfMonth = new Date(year, month + 1, 0);
                const startDay = firstOfMonth.getDay();

                let headerHtml = `<div class="session-calendar-header"><button type="button" class="btn btn-sm btn-outline-secondary cal-prev-month">¬´</button><strong class="mx-2">${firstOfMonth.toLocaleString('pl-PL', { month: 'long', year: 'numeric' })}</strong><button type="button" class="btn btn-sm btn-outline-secondary cal-next-month">¬ª</button></div>`;
                let gridHtml = `<div class="session-calendar-grid">`;
                DOW_SHORT.forEach(day => gridHtml += `<div class="session-calendar-dow">${day}</div>`);
                for (let i = 0; i < startDay; i++) { gridHtml += `<div class="session-calendar-day other-month"></div>`; }

                for (let i = 1; i <= lastOfMonth.getDate(); i++) {
                    const dayDate = new Date(year, month, i);
                    const dateString = fmtYYYYMMDD(dayDate);

                    const isScheduled = scheduledDates.has(dateString);
                    const isSelected = selectedDates.has(dateString);

                    let classes = 'session-calendar-day';
                    if (isScheduled) classes += ' scheduled';
                    if (isSelected) classes += ' is-selected-day';

                    gridHtml += `<div class="${classes}" data-date="${dateString}">${i}</div>`;
                }
            gridHtml += `</div>`;
            calendarEl.innerHTML = `<div class="session-calendar">${headerHtml}${gridHtml}</div>`;
        }

        // --- KONIEC NOWEJ SEKCJI: Logika Kalendarza ---

        const currentYear = new Date().getFullYear();
        let schoolYearOptionsHtml = '';
        for (let i = 0; i < 5; i++) {
            const yearStart = currentYear - i;
            const yearEnd = yearStart + 1;
            schoolYearOptionsHtml += `<option value="${yearStart}">${yearStart}/${yearEnd}</option>`;
        }

        const membersListHtml = (g.members || []).map(m => `<li>${m.full_name}</li>`).join('') || '<li class="text-muted">Brak uczestnik√≥w</li>';

        // --- POCZƒÑTEK POPRAWKI ---
        // Tworzymy Map u≈ºywajƒÖc ID sesji jako klucza, co automatycznie usuwa duplikaty
        const sessionsMap = new Map();
        (g.sessions || []).forEach(session => {
            if (session.id && !sessionsMap.has(session.id)) {
                sessionsMap.set(session.id, session);
            }
        });
        const uniqueSessions = Array.from(sessionsMap.values());

        // Sortujemy sesje od najnowszych do najstarszych
        uniqueSessions.sort((a, b) => {
            const dateA = new Date(a.session_date);
            const dateB = new Date(b.session_date);
            return dateB - dateA; // MalejƒÖco (najnowsze najpierw)
        });

        const sessionsListHtml = uniqueSessions.map(s => {
    // POPRAWIONE WY≈öWIETLANIE DATY
    let whenLabel = 'B≈Çƒôdna data';

    try {
        if (s.session_date) {
            // Bezpieczne formatowanie daty
            const dateObj = new Date(s.session_date);
            if (!isNaN(dateObj.getTime())) {
                const timePart = s.session_time ?
                    ` ${s.session_time.substring(0, 5)}` : ''; // Pokazuj tylko HH:MM

                whenLabel = dateObj.toLocaleDateString('pl-PL') + timePart;
            } else {
                // Fallback - poka≈º surowe dane
                whenLabel = `${s.session_date}${s.session_time ? ' ' + s.session_time.substring(0,5) : ''}`;
            }
        }
    } catch (e) {
        console.error('B≈ÇƒÖd formatowania daty:', e);
        whenLabel = `${s.session_date}${s.session_time ? ' ' + s.session_time : ''}`;
    }

    return `
      <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span>${whenLabel} ‚Äî ${s.topic_title || 'bez tematu'}</span>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-success bonus-session-btn" data-session-id="${s.id}">Bonusy sesji</button>
          <button class="btn btn-outline-primary score-session-btn" data-session-id="${s.id}" data-group-id="${g.id}">Oce≈Ñ</button>
          <button class="btn btn-outline-danger delete-session-btn" data-session-id="${s.id}" data-group-id="${g.id}">Usu≈Ñ</button>
        </div>
      </li>`;
}).join('') || '<li class="list-group-item text-muted">Brak sesji</li>';

        const bonusTableRowsHtml = (g.members || []).map(member => {
            const details = bonusDetails.find(d => d.client_id === member.id) || {};
            return `
              <tr>
                <td>${member.full_name}</td>
                <td class="text-center border-end">${details.behavior_points || 0}</td>
                <td class="text-center">${details.session_bonus_points || 0}</td>
                <td class="text-center">${details.general_bonus_points || 0}</td>
                <td class="text-center fw-bold fs-5">${details.total_points || 0}</td>
              </tr>`;
        }).join('');

        const memberOptionsHtml = (g.members || []).map(m => `<option value="${m.id}">${m.full_name}</option>`).join('');

        const bonusHistoryHtml = bonusHistory.length > 0 ? bonusHistory.map(h => {
            const date = new Date(h.awarded_at).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${h.client_name}</strong> otrzyma≈Ç <strong>${h.points} pkt.</strong><br><small class="text-muted">Pow√≥d: ${h.reason || 'Brak'}</small></div>
                    <span class="badge bg-secondary rounded-pill">${date}</span>
                </li>`;
        }).join('') : '<li class="list-group-item text-muted">Brak przyznanych bonus√≥w og√≥lnych.</li>';

        $('#groupDetailsBody').html(`
            <ul class="nav nav-tabs" id="groupTabs" role="tablist">
              <li class="nav-item" role="presentation"><button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions-panel" type="button" role="tab">Sesje i Uczestnicy</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="bonuses-tab" data-bs-toggle="tab" data-bs-target="#bonuses-panel" type="button" role="tab">‚≠ê Punktacja i Bonusy</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals-panel" type="button" role="tab">Cele i Postƒôpy</button></li>
            </ul>

            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="sessions-panel" role="tabpanel">
                <div class="row">
                  <div class="col-lg-5">
                    <h6>Uczestnicy</h6>
                    <ul class="list-unstyled">${membersListHtml}</ul>
                    <div id="sessionCalendar" class="mt-4"></div>
                        <div class="d-grid mt-2">
                            <button id="saveScheduleBtn" class="btn btn-info btn-sm">Zapisz zaznaczone dni</button>

                    </div>
                  </div>
                  <div class="col-lg-7">
                    <h6>Lista Sesji</h6>
                    <ul class="list-group mb-3">${sessionsListHtml}</ul>
                    <div class="card">
                      <div class="card-body">
                        <h6 class="card-title">Dodaj nowƒÖ sesjƒô</h6>
                        <form id="addSessionForm" data-group-id="${g.id}">
                           <div class="row g-2">
                            <div class="col-6"><label class="form-label">Data</label><input type="date" class="form-control" name="date" id="sessionDateInput" required></div>
                            <div class="col-6"><label class="form-label">Godzina</label><input type="time" class="form-control" name="time" required></div>
                            <div class="col-12"><label class="form-label">Temat</label><input type="text"  id="sessionTopicSelect" class="form-control placeholder="Temat zajƒôƒá" required></div>
                           
                            <!--<div class="col-12"><label class="form-label">Temat</label><select id="sessionTopicSelect" class="form-select" required></select></div>-->
                            <div class="col-12"><label class="form-label">Zachowania do modelowania (max 4)</label><select id="sessionBehaviorsSelect" class="form-select" multiple></select></div>
                            <div class="col-12"><button class="btn btn-primary w-100" type="submit">Dodaj sesjƒô</button></div>
                           </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="bonuses-panel" role="tabpanel">
                <h5>Zbiorcza punktacja</h5>
                <div class="table-responsive mb-4"><table class="table table-bordered table-striped">
                    <thead class="table-light"><tr><th>Uczestnik</th><th class="text-center border-end">Pkt. za zachowania</th><th class="text-center">Bonusy z sesji</th><th class="text-center">Super bonusy</th><th class="text-center">SUMA PUNKT√ìW</th></tr></thead>
                    <tbody>${bonusTableRowsHtml}</tbody>
                </table></div><hr/>
                <h5>Przyznaj bonus og√≥lny</h5>
                <form id="awardGeneralBonusForm" class="row g-2 align-items-end" data-group-id="${g.id}">
                  <div class="col-md-5"><label for="bonusClientSelect" class="form-label">Uczestnik</label><select id="bonusClientSelect" name="client_id" class="form-select" required>${memberOptionsHtml}</select></div>
                  <div class="col-md-2"><label for="bonusPointsInput" class="form-label">Punkty</label><input type="number" id="bonusPointsInput" name="points" class="form-control" min="1" required></div>
                  <div class="col-md-5"><label for="bonusReasonInput" class="form-label">Pow√≥d (wymagany)</label><input type="text" id="bonusReasonInput" name="reason" class="form-control" placeholder="Np. Pomoc koledze" required></div>
                  <div class="col-12"><button type="submit" class="btn btn-success">Przyznaj punkty</button></div>
                </form><hr class="my-4"/>
                <div class="accordion" id="bonusHistoryAccordion"><div class="accordion-item">
                  <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory">Poka≈º / Ukryj historiƒô bonus√≥w og√≥lnych</button></h2>
                  <div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#bonusHistoryAccordion"><div class="accordion-body p-0">
                      <ul class="list-group list-group-flush">${bonusHistoryHtml}</ul>
                  </div></div>
                </div></div>
              </div>

              <div class="tab-pane fade" id="goals-panel" role="tabpanel">
                 <h6>üéØ Cele i nagrody semestralne</h6>
                 <div class="card mb-3"><div class="card-body">
                     <form id="groupTargetForm" data-group-id="${g.id}">
                       <div class="row g-2 align-items-end">
                         <div class="col-md-5"><label class="form-label">Rok szkolny</label>
                            <select class="form-select" name="school_year_start" required>${schoolYearOptionsHtml}</select>
                         </div>
                         <div class="col-md-7"><label class="form-label">Semestr</label>
                            <select class="form-select" name="semester" required><option value="1">I P√≥≈Çrocze (Wrzesie≈Ñ - Stycze≈Ñ)</option><option value="2">II P√≥≈Çrocze (Luty - Czerwiec)</option></select>
                         </div>
                         <div class="col-6"><label class="form-label">Cel (pkt)</label><input type="number" class="form-control" name="points" min="0" required></div>
                         <div class="col-6"><label class="form-label">Nagroda</label><input type="text" class="form-control" name="reward"></div>
                         <div class="col-12"><button type="submit" class="btn btn-primary btn-sm w-100">Zapisz cel</button></div>
                       </div>
                     </form>
                 </div></div>
                 <div class="d-flex align-items-end gap-2 mb-3">
                   <div><label class="form-label mb-0"><strong>Podsumowanie dla roku szkolnego</strong></label>
                      <select class="form-select" id="bonusYearSelect">${schoolYearOptionsHtml}</select>
                   </div>
                   <button type="button" class="btn btn-primary" id="bonusScopeRefreshBtn" data-group-id="${g.id}">Poka≈º</button>
                   <button type="button" class="btn btn-secondary" id="hideBonusesBtn" style="display: none;">Ukryj</button>
                 </div>
                 <div id="bonusesSummary" class="mb-3"></div>
              </div>
              </div>
        `);


        renderSessionCalendar();


        function fmtYYYYMMDD(date) {
        if (!date || isNaN(date)) return "";
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }
        // Dodajemy event listenery dla kalendarza
        const calendarEl = document.getElementById('sessionCalendar');
            if (calendarEl) {
                calendarEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('cal-prev-month')) {
                        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
                        renderSessionCalendar();
                    } else if (e.target.classList.contains('cal-next-month')) {
                        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
                        renderSessionCalendar();
                    } else if (e.target.classList.contains('session-calendar-day') && e.target.dataset.date) {
                        const clickedDateString = e.target.dataset.date;
                        if (selectedDates.has(clickedDateString)) {
                            selectedDates.delete(clickedDateString);
                        } else {
                            selectedDates.add(clickedDateString);
                        }
                        renderSessionCalendar();
                    }
                });
            }


            const saveScheduleBtn = document.getElementById('saveScheduleBtn');
            if (saveScheduleBtn) {
                saveScheduleBtn.addEventListener('click', async () => {
                    try {
                        const payload = { schedule_days: Array.from(selectedDates) };
                        await fetchJSON(`/api/tus/groups/${groupId}/schedule`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        showAlert('Harmonogram zosta≈Ç zapisany!', 'success');
                    } catch (err) {
                        showAlert(`B≈ÇƒÖd zapisu harmonogramu: ${err.message}`, 'danger');
                    }
                });
            }



        const topics = await fetchJSON(`${API_BASE}/api/tus/topics`);
        const $topicSelect = $('#sessionTopicSelect').empty();
        (topics || []).forEach(t => $topicSelect.append(new Option(t.title, String(t.id))));

        const behaviors = await fetchJSON(`${API_BASE}/api/tus/behaviors`);
        const $behaviorSelect = $('#sessionBehaviorsSelect').empty();
        (behaviors || []).forEach(b => $behaviorSelect.append(new Option(`${b.title} (max ${b.default_max_points ?? 3})`, String(b.id))));
        $behaviorSelect.select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Wybierz do 4 zachowa≈Ñ',
            maximumSelectionLength: 4,
            dropdownParent: $('#groupDetailsModal')
        });

        groupDetailsModal.show();
    } catch (e) {
        console.error(e);
        alert(`Nie uda≈Ço siƒô otworzyƒá szczeg√≥≈Ç√≥w grupy: ${e.message}`);
    }
}


      /**
       * Otwiera modal do przyznawania bonus√≥w indywidualnych dla danej sesji.
       * @param {number} sessionId - ID sesji.
       */
      async function openBonusModal(sessionId) {
        const $container = $('#bonusParticipantsContainer').html('<p class="text-muted">≈Åadowanie...</p>');
        $('#saveBonusesBtn').data('session-id', sessionId);
        bonusModal.show();

        try {
          const [session, existingBonuses] = await Promise.all([
            fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}`),
            fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/bonuses`)
          ]);

          const sessionDate = new Date(session.session_date).toLocaleDateString('pl-PL');
          $('#bonusModalTitle').text(`Bonusy dla sesji z dnia ${sessionDate}`);
          $('#bonusModalSessionInfo').html(`<strong>Temat:</strong> ${session.topic_title || 'Brak'}`);

          if (!session.members || session.members.length === 0) {
            $container.html('<p class="text-danger">Brak uczestnik√≥w w tej sesji.</p>');
            return;
          }

          const participantsHtml = session.members.map(member => `
            <div class="input-group mb-2">
              <span class="input-group-text w-75">${member.full_name}</span>
              <input type="number" class="form-control bonus-points-input"
                     data-client-id="${member.id}"
                     min="0"
                     value="${existingBonuses[member.id] || 0}">
            </div>`).join('');
          $container.html(participantsHtml);
        } catch (err) {
          $container.html(`<p class="text-danger">B≈ÇƒÖd ≈Çadowania danych: ${err.message}</p>`);
        }
      }

      /**
       * Otwiera modal do oceniania zachowa≈Ñ dla danej sesji.
       * @param {number} sessionId - ID sesji.
       * @param {number} groupId - ID grupy (do od≈õwie≈ºenia widoku).
       */
      async function openScoringModal(sessionId, groupId) {
        try {
          const data = await fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/scores`);

          if (!data.behaviors || data.behaviors.length === 0) {
            $('#scoringBody').html(`<div class="alert alert-warning mb-0">Do tej sesji nie przypisano ≈ºadnych zachowa≈Ñ do modelowania.</div>`);
          } else {
            let thead = '<tr><th>Osoba</th>';
            data.behaviors.forEach(b => thead += `<th>${b.title}<br><small>max ${b.max_points}</small></th>`);
            thead += '<th class="text-end">Suma</th></tr>';

            let tbody = '';
            data.members.forEach(m => {
              let sum = 0;
              let tds = '';
              data.behaviors.forEach(b => {
                const val = (data.scores?.[m.id]?.[b.behavior_id]) ?? 0;
                sum += Number(val) || 0;
                tds += `<td style="width:120px"><input type="number" class="form-control form-control-sm score-input" data-cid="${m.id}" data-bid="${b.behavior_id}" value="${val}" min="0" max="${b.max_points}"></td>`;
              });
              tbody += `<tr data-cid="${m.id}"><td>${m.full_name}</td>${tds}<td class="sum-cell text-end fw-bold">${sum}</td></tr>`;
            });

            $('#scoringBody').html(`
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>${thead}</thead>
                  <tbody>${tbody}</tbody>
                </table>
              </div>`);
          }

          $('#scoringSessionId').val(String(sessionId));
          $('#scoringGroupId').val(String(groupId));
          scoringModal.show();
        } catch (e) {
          console.error(e);
          alert('Nie uda≈Ço siƒô wczytaƒá danych do punktacji: ' + e.message);
        }
      }

      /**
       * Od≈õwie≈ºa i wy≈õwietla podsumowanie bonus√≥w dla grupy w danym roku.
       * @param {number} groupId - ID grupy.
       * @param {number} year - Rok do wy≈õwietlenia.
       */
      async function refreshBonusesSummary(groupId, schoolYearStart) {
        const container = $('#bonusesSummary').html(`<div class="alert alert-info mb-0">≈Åadowanie podsumowania bonus√≥w‚Ä¶</div>`);
        try {
            const data = await fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/bonuses?school_year_start=${schoolYearStart}`);

            const createPanel = (semesterData, semesterNum, yearLabel) => {
                const scopeLabel = semesterNum === 1 ? 'I P√≥≈Çrocze' : 'II P√≥≈Çrocze';
                return `
                  <div class="col-lg-6">
                    <div class="card h-100">
                      <div class="card-header fw-bold">${scopeLabel} ${yearLabel}</div>
                      <div class="card-body">
                        <p class="mb-1"><strong>Cel:</strong> ${semesterData.target_points} pkt</p>
                        <p class="mb-3"><strong>Nagroda:</strong> ${semesterData.reward}</p>
                        <h6 class="card-title">Postƒôp</h6>
                        <p class="mb-1"><strong>Zebrano bonus√≥w:</strong> ${semesterData.points_collected} pkt</p>
                        <p class="mb-0 fs-5"><strong>Pozosta≈Ço do celu: <span class="fw-bold text-primary">${semesterData.points_remaining} pkt</span></strong></p>
                      </div>
                    </div>
                  </div>`;
            };

            container.html(`
                <div class="row g-3">
                    ${createPanel(data.semester_1, 1, data.school_year_label)}
                    ${createPanel(data.semester_2, 2, data.school_year_label)}
                </div>`);
            $('#hideBonusesBtn').show();
        } catch (e) {
            console.error(e);
            container.html(`<div class="alert alert-danger">${e.message}</div>`);
        }
    }

      // ==========================================================
      // === G≈Å√ìWNY BLOK EVENT LISTENER√ìW =========================
      // ==========================================================

      // --- Przyciski na stronie g≈Ç√≥wnej ---
      $('#addGroupBtn').on('click', async () => {
        currentGroupId = null;
        $('#groupModalTitle').text('Nowa grupa');
        $('#groupForm')[0].reset();
        try {
          await loadTherapistsAndClients();
          groupModal.show();
        } catch (e) {
          console.error(e);
          alert('Nie uda≈Ço siƒô pobraƒá list terapeut√≥w i uczestnik√≥w.');
        }
      });

      $('#groupsContainer').on('click', '.view-group-btn', function() {
        openGroupDetails($(this).data('group-id'));
      });

      $('#groupsContainer').on('click', '.edit-group-btn', async function() {
        const gid = $(this).data('group-id');
        try {
          const g = await fetchJSON(`${API_BASE}/api/tus/groups/${gid}`);
          currentGroupId = g.id;
          $('#groupModalTitle').text(`Edytuj grupƒô: ${g.name}`);
          await loadTherapistsAndClients({
            name: g.name,
            therapist_id: g.therapist_id,
            assistant_therapist_id: g.assistant_therapist_id,
            client_ids: (g.members || []).map(m => m.id)
          });
          groupModal.show();
        } catch (e) {
          console.error(e);
          alert('Nie uda≈Ço siƒô pobraƒá danych grupy do edycji.');
        }
      });

      // --- Formularz dodawania/edycji grupy ---
      $('#groupForm').on('submit', async function(e) {
        e.preventDefault();
        const payload = {
          name: ($('#groupName').val() || '').trim(),
          therapist_id: parseInt($('#therapistSelect').val(), 10) || null,
          assistant_therapist_id: parseInt($('#assistantTherapistSelect').val(), 10) || null,
          client_ids: ($('#clientSelect').val() || []).map(v => parseInt(v, 10))
        };

        if (!payload.name || !payload.therapist_id || payload.client_ids.length === 0) {
          return alert('Nazwa grupy, terapeuta prowadzƒÖcy i co najmniej jeden uczestnik sƒÖ wymagani.');
        }

        const url = currentGroupId ? `${API_BASE}/api/tus/groups/${currentGroupId}` : `${API_BASE}/api/tus/groups`;
        const method = currentGroupId ? 'PUT' : 'POST';

        try {
          await fetchJSON(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          groupModal.hide();
          await loadGroups();
        } catch (err) {
          console.error(err);
          alert('Nie uda≈Ço siƒô zapisaƒá grupy: ' + err.message);
        }
      });

      // --- Akcje wewnƒÖtrz modala szczeg√≥≈Ç√≥w grupy (delegacja zdarze≈Ñ) ---
      $(document).on('click', '#deleteGroupFromDetailsBtn', async function() {
        const gid = $(this).data('group-id');
        if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô grupƒô oraz wszystkie jej sesje i dane?')) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/groups/${gid}`, { method: 'DELETE' });
          groupDetailsModal.hide();
          await loadGroups();
        } catch (e) {
          alert('Nie uda≈Ço siƒô usunƒÖƒá grupy: ' + e.message);
        }
      });

      $(document).on('submit', '#addSessionForm', async function(e) {
    e.preventDefault();
    const $form = $(this);
    const gid = $form.data('group-id');

    const dateValue = $form.find('input[name="date"]').val(); // Format: YYYY-MM-DD
    const timeValue = $form.find('input[name="time"]').val(); // Format: HH:MM

    console.log("Surowa data:", dateValue, "Surowy czas:", timeValue);

    // UPEWNIJ SIƒò ≈ªE DANE SƒÑ POPRAWNE
    if (!dateValue || !timeValue) {
        alert('Data i godzina sƒÖ wymagane!');
        return;
    }

    // FORMATUJ CZAS - upewnij siƒô ≈ºe ma sekundy
    let timeFormatted = timeValue;
    if (timeValue.length === 5) { // Format HH:MM
        timeFormatted = timeValue + ':00';
    }

    const payload = {
        group_id: gid,
        topic_id: parseInt($('#sessionTopicSelect').val(), 10),
        session_date: `${dateValue}T${timeFormatted}`, // Format: "YYYY-MM-DDTHH:MM:SS"
        behavior_ids: ($('#sessionBehaviorsSelect').val() || []).map(v => parseInt(v, 10))
    };

    console.log("Wysy≈Çane dane sesji:", JSON.stringify(payload, null, 2));

    if (!payload.topic_id) {
        return alert('Temat jest wymagany.');
    }

    try {
        const response = await fetchJSON(`${API_BASE}/api/tus/sessions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        console.log("Odpowied≈∫ serwera:", response);
        await openGroupDetails(gid);
    } catch (err) {
        console.error("B≈ÇƒÖd podczas tworzenia sesji:", err);
        alert('Nie uda≈Ço siƒô dodaƒá sesji: ' + err.message);
    }
});
      $(document).on('click', '.delete-session-btn', async function() {
    const sid = $(this).data('session-id');
    const gid = $(this).data('group-id');

    // --- POCZƒÑTEK NOWEJ LOGIKI PYTA≈É ---
    // Pytanie 1: Potwierdzenie usuniƒôcia sesji
    if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô sesjƒô? Spowoduje to usuniƒôcie punkt√≥w za zachowania i bonus√≥w PRZYPISANYCH do tej konkretnej sesji.')) {
        return; // Anuluj, je≈õli u≈ºytkownik kliknie "Anuluj"
    }

    // Pytanie 2: Opcjonalne usuniƒôcie wszystkich bonus√≥w w grupie
    const deleteAllBonuses = confirm(
        'PYTANIE DODATKOWE:\n\nCzy chcesz usunƒÖƒá r√≥wnie≈º WSZYSTKIE bonusy (sesyjne i og√≥lne) dla ca≈Çej grupy?\n\n' +
        '-> Kliknij "OK", aby wyczy≈õciƒá wszystkie bonusy w tej grupie.\n' +
        '-> Kliknij "Anuluj", aby usunƒÖƒá tylko tƒô jednƒÖ sesjƒô i jej punkty.'
    );
    // --- KONIEC NOWEJ LOGIKI PYTA≈É ---

    try {
        // Dodajemy nowy parametr do zapytania, informujƒÖcy serwer o decyzji u≈ºytkownika
        await fetchJSON(`${API_BASE}/api/tus/sessions/${sid}?delete_all_bonuses=${deleteAllBonuses}`, {
            method: 'DELETE'
        });

        alert('‚úÖ Sesja zosta≈Ça usuniƒôta.');
        await openGroupDetails(gid);

    } catch (e) {
        alert('Nie uda≈Ço siƒô usunƒÖƒá sesji: ' + e.message);
    }
});

      $(document).on('click', '.score-session-btn', function() {
        openScoringModal($(this).data('session-id'), $(this).data('group-id'));
      });

      $(document).on('click', '.bonus-session-btn', function() {
        openBonusModal($(this).data('session-id'));
      });

      $(document).on('submit', '#groupTargetForm', async function(e) {
            e.preventDefault();
            const $form = $(this);
            const gid = $form.data('group-id');

            // --- POPRAWIONE ODCZYTYWANIE WARTO≈öCI Z FORMULARZA ---
            const payload = {
                school_year_start: parseInt($form.find('select[name="school_year_start"]').val(), 10),
                semester: parseInt($form.find('select[name="semester"]').val(), 10),
                points: parseInt($form.find('input[name="points"]').val(), 10),
                reward: ($form.find('input[name="reward"]').val() || '').trim()
            };

            // --- POPRAWIONA WALIDACJA ---
            if (!payload.school_year_start || isNaN(payload.points)) {
                alert('Rok szkolny i cel (punkty) sƒÖ wymagane.');
                return;
            }

            try {
                await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/target`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                alert('‚úÖ Cel zosta≈Ç zapisany.');

                // Automatycznie od≈õwie≈º widok podsumowania po zapisaniu celu
                await refreshBonusesSummary(gid, payload.school_year_start);

            } catch (err) {
                console.error(err);
                alert('Nie uda≈Ço siƒô zapisaƒá celu: ' + err.message);
            }
        });

      $(document).on('click', '#bonusScopeRefreshBtn', function() {
        const gid = $(this).data('group-id');
        const year = parseInt($('#bonusYearInput').val(), 10) || new Date().getFullYear();
        refreshBonusesSummary(gid, year);
      });

      $(document).on('click', '#hideBonusesBtn', function() {
        $('#bonusesSummary').empty();
        $(this).hide();
      });

      $(document).on('click', '#showTopicHistoryBtn', async function() {
        const gid = $(this).data('group-id');
        const $body = $('#topicHistoryBody').html('<p class="text-center text-muted">≈Åadowanie...</p>');
        topicHistoryModal.show();

        try {
          const historyData = await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/topic-history`);
          if (Object.keys(historyData).length === 0) {
            $body.html('<p class="text-center">Brak danych do wy≈õwietlenia.</p>');
            return;
          }
          let finalHtml = '';
          for (const clientId in historyData) {
            const clientData = historyData[clientId];
            const itemsHtml = clientData.history.map(item => {
              const date = new Date(item.date).toLocaleDateString('pl-PL');
              return `<li><strong>${item.topic}</strong> <small class="text-muted">(${date} w: ${item.group_name})</small></li>`;
            }).join('');
            finalHtml += `<h6 class="mt-3 border-bottom pb-1">${clientData.client_name}</h6><ul class="list-unstyled">${itemsHtml}</ul>`;
          }
          $body.html(finalHtml);
        } catch (err) {
          $body.html(`<div class="alert alert-danger">${err.message}</div>`);
        }
      });

      $(document).on('submit', '#awardGeneralBonusForm', async function(e) {
        e.preventDefault();
        const $form = $(this);
        const gid = $form.data('group-id');
        const payload = {
          client_id: parseInt($form.find('select[name="client_id"]').val(), 10),
          points: parseInt($form.find('input[name="points"]').val(), 10),
          reason: ($form.find('input[name="reason"]').val() || '').trim()
        };

        if (!payload.client_id || !payload.points || payload.points <= 0) {
          return alert('Wybierz uczestnika i podaj poprawnƒÖ liczbƒô punkt√≥w (wiƒôkszƒÖ od 0).');
        }

        try {
          await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/award-general-bonus`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          alert('‚úÖ Bonus zosta≈Ç przyznany!');
          await openGroupDetails(gid);

        } catch (err) {
          alert('Nie uda≈Ço siƒô przyznaƒá bonusu: ' + err.message);
        }
      });

            const saveScheduleBtn = document.getElementById('saveScheduleBtn');
            if(saveScheduleBtn) {
                saveScheduleBtn.addEventListener('click', async () => {
                    try {
                        // Zapisujemy tablicƒô dat, a nie dni tygodnia
                        const payload = { schedule_days: Array.from(selectedDates) };
                        await fetchJSON(`/api/tus/groups/${groupId}/schedule`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        showAlert('Szablon tygodnia zosta≈Ç zapisany!', 'success');
                    } catch (err) {
                        showAlert(`B≈ÇƒÖd zapisu szablonu: ${err.message}`, 'danger');
                    }
                });
            }


      // --- Akcje w modalu oceniania (scoring) ---
      $(document).on('input', '.score-input', function() {
        const $row = $(this).closest('tr');
        let sum = 0;
        $row.find('.score-input').each(function() {
          sum += parseInt($(this).val() || '0', 10);
        });
        $row.find('.sum-cell').text(sum);
      });

      $('#saveScoresBtn').on('click', async function() {
        const sid = parseInt($('#scoringSessionId').val(), 10);
        const gid = parseInt($('#scoringGroupId').val(), 10);
        const payload = { scores: [] };

        $('#scoringBody tbody tr').each(function() {
          const client_id = parseInt($(this).data('cid'), 10);
          const items = [];
          $(this).find('.score-input').each(function() {
            items.push({
              behavior_id: parseInt($(this).data('bid'), 10),
              points: parseInt($(this).val(), 10) || 0
            });
          });
          payload.scores.push({ client_id, items });
        });

        try {
          await fetchJSON(`${API_BASE}/api/tus/sessions/${sid}/scores`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          scoringModal.hide();
          alert('‚úÖ Punktacja zosta≈Ça zapisana.');
          await openGroupDetails(gid); // Od≈õwie≈º widok
        } catch (e) {
          alert('Nie uda≈Ço siƒô zapisaƒá punktacji: ' + e.message);
        }
      });

      // --- Akcje w modalu bonus√≥w ---
      $('#saveBonusesBtn').on('click', async function() {
        const sessionId = $(this).data('session-id');
        const bonuses = [];
        $('.bonus-points-input').each(function() {
          bonuses.push({
            client_id: $(this).data('client-id'),
            points: parseInt($(this).val(), 10) || 0
          });
        });

        try {
          await fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/bonuses`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bonuses })
          });
          bonusModal.hide();
          alert('‚úÖ Bonusy zosta≈Çy zapisane.');
          // Automatyczne od≈õwie≈ºenie widoku grupy, je≈õli jest otwarty
          const activeModal = document.querySelector('#groupDetailsModal.show');
          if(activeModal){
            const groupId = $(activeModal).find('#deleteGroupFromDetailsBtn').data('group-id');
            if(groupId){
              await openGroupDetails(groupId);
            }
          }
        } catch (err) {
          alert(`B≈ÇƒÖd zapisu bonus√≥w: ${err.message}`);
        }
      });

      // --- Akcje w modalu Temat√≥w ---
      $('#topicsModal').on('shown.bs.modal', loadTopicsModalList);
      $('#addTopicForm').on('submit', async function(e) {
        e.preventDefault();
        const title = ($('#newTopicTitle').val() || '').trim();
        if (!title) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/topics`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title })
          });
          $('#newTopicTitle').val('');
          await loadTopicsModalList();
        } catch (err) {
          alert('Nie uda≈Ço siƒô dodaƒá tematu: ' + err.message);
        }
      });

      // --- Akcje w modalu Zachowa≈Ñ ---
      $('#behaviorsModal').on('shown.bs.modal', reloadBehaviorsModal);
      $('#addBehaviorForm').on('submit', async function(e) {
        e.preventDefault();
        const payload = {
          title: ($('#newBehaviorTitle').val() || '').trim(),
          default_max_points: parseInt($('#newBehaviorMax').val() || '3', 10)
        };
        if (!payload.title) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/behaviors`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          $('#newBehaviorTitle').val('');
          $('#newBehaviorMax').val('3');
          await reloadBehaviorsModal();
        } catch (err) {
          alert('Nie uda≈Ço siƒô dodaƒá zachowania: ' + err.message);
        }
      });

      $(document).on('click', '.del-beh', async function() {
        const id = $(this).data('id');
        if (!confirm('UsunƒÖƒá to zachowanie ze s≈Çownika?')) return;
        try {
          await fetchJSON(`${API_BASE}/api/tus/behaviors/${id}`, { method: 'DELETE' });
          await reloadBehaviorsModal();
        } catch (err) {
          alert('Nie uda≈Ço siƒô usunƒÖƒá zachowania: ' + err.message);
        }
      });

      // ==========================================================
      // === FUNKCJE URUCHOMIENIOWE ===============================
      // ==========================================================

      /**
       * Sprawdza, czy w URL znajduje siƒô parametr `openGroup` i je≈õli tak,
       * automatycznie otwiera modal szczeg√≥≈Ç√≥w dla wskazanej grupy.
       */
      function openGroupFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const groupIdToOpen = urlParams.get('openGroup');
        if (groupIdToOpen) {
          setTimeout(() => {
            console.log(`Pr√≥ba automatycznego otwarcia grupy o ID: ${groupIdToOpen}`);
            openGroupDetails(groupIdToOpen).catch(err => {
              console.error(`Nie uda≈Ço siƒô otworzyƒá grupy z URL: ${err.message}`);
              alert(`Nie mo≈ºna by≈Ço otworzyƒá grupy o ID ${groupIdToOpen}. Byƒá mo≈ºe zosta≈Ça usuniƒôta.`);
            });
          }, 500); // Op√≥≈∫nienie, aby daƒá UI czas na za≈Çadowanie
        }
      }

      // Inicjalne za≈Çadowanie grup i sprawdzenie URL
      loadGroups();
      openGroupFromUrl();

    });
      document.addEventListener('DOMContentLoaded', () => {
        const fabContainer = document.getElementById('fab-container');
        const fabMainBtn = document.getElementById('fab-main-btn');

        fabMainBtn.addEventListener('click', () => {
            fabContainer.classList.toggle('open');
        });
    });
  </script>
</body>

</html>


