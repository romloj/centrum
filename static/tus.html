<!doctype html>
<html lang="pl">

<head>
ย <meta charset="utf-8" />
ย <title>Moduล TUS</title>
ย <meta name="viewport" content="width=device-width, initial-scale=1" />

ย <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

ย <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
ย <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
ย ย <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
ย ย <link rel="stylesheet" href="menu_fab.css">
ย <style>
ย ย body {
ย ย ย background-color: #f8f9fa;
ย ย }
ย ย .select2-container--bootstrap-5 .select2-selection {
ย ย ย min-height: 38px;
ย ย }
ย ย .select2-container--bootstrap-5 .select2-selection__rendered {
ย ย ย padding-top: 4px;
ย ย }
ย ย ย /* Style dla mini-kalendarza w modalu TUS */
.session-calendar {
ย ย border: 1px solid var(--bs-border-color);
ย ย border-radius: .5rem;
ย ย background: #fff;
}
.session-calendar-header {
ย ย display: flex;
ย ย justify-content: space-between;
ย ย align-items: center;
ย ย padding: .5rem;
ย ย border-bottom: 1px solid var(--bs-border-color);
}
.session-calendar-grid {
ย ย display: grid;
ย ย grid-template-columns: repeat(7, 1fr);
ย ย text-align: center;
}
.session-calendar-dow {
ย ย font-size: .75rem;
ย ย font-weight: 600;
ย ย color: var(--bs-secondary-color);
ย ย padding: .25rem 0;
}
.session-calendar-day {
ย ย font-size: .8rem;
ย ย padding: .5rem 0;
ย ย border-top: 1px solid var(--bs-border-color);
ย ย cursor: pointer;
ย ย position: relative;
}
.session-calendar-day:hover {
ย ย background-color: var(--bs-primary-bg-subtle);
}
.session-calendar-day.other-month {
ย ย color: var(--bs-secondary-color);
ย ย opacity: .6;
}
/* Kรณลko oznaczajฤce zaplanowanฤ sesjฤ */
.session-calendar-day.scheduled::after {
ย ย content: '';
ย ย position: absolute;
ย ย bottom: 4px;
ย ย left: 50%;
ย ย transform: translateX(-50%);
ย ย width: 6px;
ย ย height: 6px;
ย ย border-radius: 50%;
ย ย background-color: var(--bs-primary);
}
/* Styl dla zaznaczonego dnia */
.session-calendar-day.selected {
ย ย background-color: var(--bs-primary);
ย ย color: #fff;
ย ย font-weight: 600;
ย ย border-radius: 50%;
}
ย ย ย /* Styl dla regularnego dnia zajฤฤ (szablonu) */
.session-calendar-day.is-selected-day {
ย ย background-color: var(--bs-info-bg-subtle);
ย ย font-weight: bold;
}

ย </style>
</head>

<body>

ย <div class="container py-4">
ย ย <header class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
ย ย ย <h1 class="h3 m-0">๐ฅ Moduล TUS โ Grupy</h1>
ย ย ย <div class="d-flex gap-2">
ย ย ย ย <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#topicsModal">Tematy</button>
ย ย ย ย <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#behaviorsModal">Zachowania</button>
ย ย ย ย <button class="btn btn-primary" id="addGroupBtn">Stwรณrz nowฤ grupฤ</button>
ย ย ย </div>
ย ย </header>

ย ย <main id="groupsContainer" class="row g-4"></main>
ย </div>

ย <div class="modal fade" id="groupDetailsModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog modal-xl">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title" id="groupDetailsTitle">Szczegรณลy grupy</h5>
ย ย ย ย ย <div class="ms-auto d-flex gap-2">
ย ย ย ย ย ย <button class="btn btn-outline-danger btn-sm" id="deleteGroupFromDetailsBtn" style="display:none">Usuล grupฤ</button>
ย ย ย ย ย ย <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Zamknij</button>
ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body" id="groupDetailsBody">
ย ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>

ย <div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title" id="groupModalTitle">Dane grupy</h5>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body">
ย ย ย ย ย <form id="groupForm" novalidate>
ย ย ย ย ย ย <div class="mb-3">
ย ย ย ย ย ย ย <label for="groupName" class="form-label">Nazwa grupy</label>
ย ย ย ย ย ย ย <input type="text" class="form-control" id="groupName" required />
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="mb-3">
ย ย ย ย ย ย ย <label for="therapistSelect" class="form-label">Terapeuta prowadzฤcy</label>
ย ย ย ย ย ย ย <select class="form-select" id="therapistSelect"></select>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="mb-3">
ย ย ย ย ย ย ย <label for="assistantTherapistSelect" class="form-label">Terapeuta wspomagajฤcy (opcjonalnie)</label>
ย ย ย ย ย ย ย <select class="form-select" id="assistantTherapistSelect"></select>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="mb-3">
ย ย ย ย ย ย ย <label for="clientSelect" class="form-label">Uczestnicy</label>
ย ย ย ย ย ย ย <select class="form-select" id="clientSelect" multiple></select>
ย ย ย ย ย ย </div>
ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย ย ย <div class="modal-footer">
ย ย ย ย ย <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anuluj</button>
ย ย ย ย ย <button type="submit" form="groupForm" class="btn btn-primary" id="saveGroupBtn">Zapisz</button>
ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>

ย <div class="modal fade" id="topicsModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title">Tematy TUS</h5>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body">
ย ย ย ย ย <form id="addTopicForm" class="d-flex gap-2 mb-3">
ย ย ย ย ย ย <input type="text" class="form-control" id="newTopicTitle" placeholder="Tytuล tematu" required />
ย ย ย ย ย ย <button type="submit" class="btn btn-success">Dodaj</button>
ย ย ย ย ย </form>
ย ย ย ย ย <ul class="list-group" id="topicsList"></ul>
ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>

ย <div class="modal fade" id="behaviorsModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title">Zachowania do modelowania</h5>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body">
ย ย ย ย ย <form id="addBehaviorForm" class="row g-2 align-items-end mb-3">
ย ย ย ย ย ย <div class="col-8">
ย ย ย ย ย ย ย <label class="form-label">Nazwa</label>
ย ย ย ย ย ย ย <input type="text" class="form-control" id="newBehaviorTitle" placeholder="np. czekanie na swojฤ kolej" required />
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="col-4">
ย ย ย ย ย ย ย <label class="form-label">Domyลlny max</label>
ย ย ย ย ย ย ย <input type="number" class="form-control" id="newBehaviorMax" value="3" min="1" max="10" />
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="col-12">
ย ย ย ย ย ย ย <button class="btn btn-success">Dodaj zachowanie</button>
ย ย ย ย ย ย </div>
ย ย ย ย ย </form>
ย ย ย ย ย <ul id="behaviorsList" class="list-group"></ul>
ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>

ย <div class="modal fade" id="scoringModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog modal-xl modal-dialog-scrollable">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title">Punktacja sesji</h5>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body">
ย ย ย ย ย <div id="scoringBody"></div>
ย ย ย ย </div>
ย ย ย ย <div class="modal-footer">
ย ย ย ย ย <input type="hidden" id="scoringSessionId" />
ย ย ย ย ย <input type="hidden" id="scoringGroupId" />
ย ย ย ย ย <button class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
ย ย ย ย ย <button id="saveScoresBtn" class="btn btn-primary">Zapisz punktacjฤ</button>
ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>

ย <div class="modal fade" id="topicHistoryModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog modal-lg modal-dialog-scrollable">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title">Historia zrealizowanych tematรณw</h5>
ย ย ย ย ย <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body" id="topicHistoryBody">
ย ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>

ย <div class="modal fade" id="bonusModal" tabindex="-1" aria-hidden="true">
ย ย <div class="modal-dialog">
ย ย ย <div class="modal-content">
ย ย ย ย <div class="modal-header">
ย ย ย ย ย <h5 class="modal-title" id="bonusModalTitle">Bonusy Indywidualne</h5>
ย ย ย ย ย <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
ย ย ย ย </div>
ย ย ย ย <div class="modal-body">
ย ย ย ย ย <p class="text-muted">Wpisz punkty bonusowe dla kaลผdego uczestnika poniลผej.</p>
ย ย ย ย ย <div id="bonusModalSessionInfo" class="mb-3"></div>
ย ย ย ย ย <form id="bonusForm">
ย ย ย ย ย ย <div id="bonusParticipantsContainer">
ย ย ย ย ย ย ย </div>
ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย ย ย <div class="modal-footer">
ย ย ย ย ย <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
ย ย ย ย ย <button type="button" class="btn btn-primary" id="saveBonusesBtn">Zapisz Bonusy</button>
ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย </div>
ย ย <div class="fab-container" id="fabContainer">
ย ย <ul class="fab-menu">
ย ย ย ย <li class="fab-item">
ย ย ย ย ย ย <span class="fab-label">Plan terapeuty</span>
ย ย ย ย ย ย <a href="therapist1.html" class="fab-button" title="Plan terapeuty">
ย ย ย ย ย ย ย ย <i class="bi bi-heart-pulse"></i>
ย ย ย ย ย ย </a>
ย ย ย ย </li>
ย ย ย ย <li class="fab-item">
ย ย ย ย ย ย <span class="fab-label">Moduล TUS</span>
ย ย ย ย ย ย <a href="tus.html" class="fab-button" title="Moduล TUS">
ย ย ย ย ย ย ย ย <i class="bi bi-star-fill"></i>
ย ย ย ย ย ย </a>
ย ย ย ย </li>
ย ย ย ย <li class="fab-item">
ย ย ย ย ย ย <span class="fab-label">Lista klientรณw</span>
ย ย ย ย ย ย <a href="klienci.html" class="fab-button" title="Lista klientรณw">
ย ย ย ย ย ย ย ย <i class="bi bi-people-fill"></i>
ย ย ย ย ย ย </a>
ย ย ย ย </li>
ย ย ย ย <li class="fab-item">
ย ย ย ย ย ย <span class="fab-label">Historia klientรณw</span>
ย ย ย ย ย ย <a href="client_history.html" class="fab-button" title="Historia klientรณw">
ย ย ย ย ย ย ย ย <i class="bi bi-clock-history"></i>
ย ย ย ย ย ย </a>
ย ย ย ย </li>
ย ย ย ย <li class="fab-item">
ย ย ย ย ย ย <span class="fab-label">Moduล Kierowcy</span>
ย ย ย ย ย ย <a href="drivers.html" class="fab-button" title="Plan terapeuty">
ย ย ย ย ย ย ย ย <i class="bi bi-car-front-fill"></i>
ย ย ย ย ย ย </a>
ย ย ย ย </li>
ย ย ย ย <li class="fab-item">
ย ย ย ย ย ย <span class="fab-label">Strona gลรณwna</span>
ย ย ย ย ย ย <a href="index.html" class="fab-button" title="Strona gลรณwna">
ย ย ย ย ย ย ย ย <i class="bi bi-house-fill"></i>
ย ย ย ย ย ย </a>
ย ย ย ย </li>
ย ย </ul>
ย ย <button class="fab-main" id="fabMainBtn" aria-label="Rozwiล menu">
ย ย ย ย <i class="bi bi-plus-lg"></i>
ย ย </button>
</div>
ย ย <div class="fab-backdrop" id="fabBackdrop"></div>

ย ย ย ย <script src="fab-menu.js"></script>
ย <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
ย <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
ย <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

ย <script>
ย ย $(function() {

ย ย ย // ==========================================================
ย ย ย // === INICJALIZACJA I ZMIENNE GLOBALNE =====================
ย ย ย // ==========================================================

ย ย ย const API_BASE = ''; // Pusty string, jeลli API jest w tej samej domenie
ย ย ย let currentGroupId = null; // null = tryb tworzenia, liczba = tryb edycji

ย ย ย // Inicjalizacja instancji modali Bootstrapa
ย ย ย const groupDetailsModal = new bootstrap.Modal(document.getElementById('groupDetailsModal'));
ย ย ย const groupModal = new bootstrap.Modal(document.getElementById('groupModal'));
ย ย ย const scoringModal = new bootstrap.Modal(document.getElementById('scoringModal'));
ย ย ย const topicHistoryModal = new bootstrap.Modal(document.getElementById('topicHistoryModal'));
ย ย ย const bonusModal = new bootstrap.Modal(document.getElementById('bonusModal'));
ย ย ย const topicsModal = new bootstrap.Modal(document.getElementById('topicsModal'));
ย ย ย const behaviorsModal = new bootstrap.Modal(document.getElementById('behaviorsModal'));


ย ย ย // ==========================================================
ย ย ย // === FUNKCJE POMOCNICZE I API =============================
ย ย ย // ==========================================================

ย ย ย /**
ย ย ย ย* Uniwersalna funkcja do zapytaล API, obsลugujฤca bลฤdy i format JSON.
ย ย ย ย* @param {string} url - Adres URL endpointu API.
ย ย ย ย* @param {object} options - Opcje dla `fetch`, np. `method`, `headers`, `body`.
ย ย ย ย* @returns {Promise<any>} - Rozstrzyga do sparsowanej odpowiedzi JSON.
ย ย ย ย*/
ย ย ย async function fetchJSON(url, options) {
ย ย ย ย try {
ย ย ย ย ย const res = await fetch(url, options);
ย ย ย ย ย const text = await res.text();
ย ย ย ย ย const ct = res.headers.get('content-type') || '';

ย ย ย ย ย if (!ct.includes('application/json')) {
ย ย ย ย ย ย throw new Error(`Odpowiedลบ serwera nie jest w formacie JSON (HTTP ${res.status}) โ ${text.slice(0, 200)}`);
ย ย ย ย ย }

ย ย ย ย ย const data = JSON.parse(text);
ย ย ย ย ย if (!res.ok) {
ย ย ย ย ย ย const msg = (data && (data.error || data.message)) || `Bลฤd serwera (HTTP ${res.status})`;
ย ย ย ย ย ย throw new Error(msg);
ย ย ย ย ย }
ย ย ย ย ย return data;
ย ย ย ย } catch (e) {
ย ย ย ย ย // Przekaลผ dalej bลฤd, aby mรณgล byฤ obsลuลผony w wywoลujฤcej funkcji
ย ย ย ย ย throw e;
ย ย ย ย }
ย ย ย }

ย ย ย /** Inicjalizuje kontrolki Select2 w formularzu dodawania/edycji grupy. */
ย ย ย function initGroupFormSelect2() {
ย ย ย ย $('#therapistSelect, #assistantTherapistSelect').select2({
ย ย ย ย ย theme: 'bootstrap-5',
ย ย ย ย ย dropdownParent: $('#groupModal'),
ย ย ย ย ย placeholder: 'Wybierz terapeutฤ',
ย ย ย ย ย allowClear: true,
ย ย ย ย ย width: '100%'
ย ย ย ย });


ย ย ย ย $('#clientSelect').select2({
ย ย ย ย ย theme: 'bootstrap-5',
ย ย ย ย ย dropdownParent: $('#groupModal'),
ย ย ย ย ย placeholder: 'Wybierz uczestnikรณw',
ย ย ย ย ย width: '100%'
ย ย ย ย });
ย ย ย }

ย ย ย ยfunction showAlert(msg, type = "success") {
ย ย const alertBox = document.getElementById('alertBox');
ย ย // Upewnij siฤ, ลผe element alertBox istnieje w Twoim HTML
ย ย if (alertBox) {
ย ย ย ย alertBox.innerHTML = `
ย ย ย ย ย ย <div class="alert alert-${type} alert-dismissible fade show" role="alert">
ย ย ย ย ย ย ย ย ${msg}
ย ย ย ย ย ย ย ย <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
ย ย ย ย ย ย </div>`;
ย ย } else {
ย ย ย ย // Jeลli nie ma dedykowanego miejsca, uลผyj standardowego alertu
ย ย ย ย alert(msg);
ย ย }
}

ย ย ย // ==========================================================
ย ย ย // === GลรWNE FUNKCJE ลADUJฤCE DANE =========================
ย ย ย // ==========================================================

ย ย ย /** ลaduje i wyลwietla listฤ wszystkich grup na stronie gลรณwnej. */
ย ย ย async function loadGroups() {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const groups = await fetchJSON(`${API_BASE}/api/tus/groups-summary`);
ย ย ย ย ย ย ย ย const $container = $('#groupsContainer').empty();

ย ย ย ย ย ย ย ย if (!groups || !groups.length) {
ย ย ย ย ย ย ย ย ย ย $container.html('<div class="col-12"><p class="text-center text-muted">Brak grup. Stwรณrz pierwszฤ!</p></div>');
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย groups.forEach(g => {
ย ย ย ย ย ย ย ย ย ย const progressPercent = (g.target_points > 0) ? (g.total_points_collected / g.target_points * 100) : 0;

ย ย ย ย ย ย ย ย ย ย // --- POCZฤTEK POPRAWKI ---
ย ย ย ย ย ย ย ย ย ย // Wprowadzamy nowฤ, potrรณjnฤ logikฤ dla statusu celu.
ย ย ย ย ย ย ย ย ย ย const statusMessage = g.target_points > 0
ย ย ย ย ย ย ย ย ย ย ย ย ? (g.points_remaining > 0 ? `${g.points_remaining} pkt do celu` : 'Cel osiฤgniฤty! ๐')
ย ย ย ย ย ย ย ย ย ย ย ย : 'Nie ustawiono celu';
ย ย ย ย ย ย ย ย ย ย // --- KONIEC POPRAWKI ---

ย ย ย ย ย ย ย ย ย ย const cardHtml = `
ย ย ย ย ย ย ย ย ย ย ย <div class="col-md-6 col-lg-4">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="card h-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="card-header">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h5 class="card-title mb-0">${g.name}</h5>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <small class="text-muted">${g.therapist_name ?? 'Brak terapeuty'}</small>
ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="card-text mb-2"><strong>Uczestnicy:</strong> ${g.member_count}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="card-text"><strong>Ostatni temat:</strong> ${g.last_topic || '<em>Brak sesji</em>'}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <hr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h6 class="card-subtitle mb-2 text-muted">Postฤp w tym pรณลroczu</h6>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-1"><strong>Zebrano:</strong> ${g.total_points_collected} / ${g.target_points > 0 ? g.target_points : '?'} pkt</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="progress mb-2" style="height: 20px;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยaria-valuenow="${g.total_points_collected}" aria-valuemin="0" aria-valuemax="${g.target_points}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <small class="d-block text-center text-muted mt-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${statusMessage}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </small>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="card-text mt-2"><strong>Nagroda:</strong> ${g.reward || '<em>Nie ustawiono</em>'}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="card-footer d-flex gap-2 justify-content-end">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-outline-primary btn-sm view-group-btn" data-group-id="${g.id}">Zarzฤdzaj</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-secondary btn-sm edit-group-btn" data-group-id="${g.id}">Edytuj</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย </div>`;
ย ย ย ย ย ย ย ย ย ย $container.append(cardHtml);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error(e);
ย ย ย ย ย ย ย ย $('#groupsContainer').html(`<div class="col-12"><div class="alert alert-danger">Nie moลผna zaลadowaฤ grup: ${e.message}</div></div>`);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย /**
ย ย ย ย* Pobiera listy terapeutรณw i klientรณw, a nastฤpnie wypeลnia nimi kontrolki Select2 w formularzu grupy.
ย ย ย ย* @param {object} [prefill] - Opcjonalny obiekt z danymi do wstฤpnego wypeลnienia formularza (edycja).
ย ย ย ย*/
ย ย ย async function loadTherapistsAndClients(prefill = {}) {
ย ย ย ย const [therapists, clients] = await Promise.all([
ย ย ย ย ย fetchJSON(`${API_BASE}/api/therapists`),
ย ย ย ย ย fetchJSON(`${API_BASE}/api/clients`)
ย ย ย ย ]);

ย ย ย ย const activeTherapists = (therapists || []).filter(t => t.active);
ย ย ย ย const activeClients = (clients || []).filter(c => c.active);

ย ย ย ย const $therapistSelect = $('#therapistSelect').empty().append(new Option('', ''));
ย ย ย ย const $assistantSelect = $('#assistantTherapistSelect').empty().append(new Option('', ''));
ย ย ย ย activeTherapists.forEach(t => {
ย ย ย ย ย $therapistSelect.append(new Option(t.full_name, String(t.id)));
ย ย ย ย ย $assistantSelect.append(new Option(t.full_name, String(t.id)));
ย ย ย ย });

ย ย ย ย const $clientSelect = $('#clientSelect').empty();
ย ย ย ย activeClients.forEach(c => $clientSelect.append(new Option(c.full_name, String(c.client_id || c.id))));

ย ย ย ย initGroupFormSelect2(); // Zainicjuj Select2 po wypeลnieniu opcji

ย ย ย ย // Wypeลnij formularz danymi, jeลli sฤ dostฤpne (tryb edycji)
ย ย ย ย if (prefill.name) $('#groupName').val(prefill.name);
ย ย ย ย if (prefill.therapist_id) $('#therapistSelect').val(String(prefill.therapist_id)).trigger('change');
ย ย ย ย if (prefill.assistant_therapist_id) $('#assistantTherapistSelect').val(String(prefill.assistant_therapist_id)).trigger('change');
ย ย ย ย if (prefill.client_ids) $('#clientSelect').val(prefill.client_ids.map(String)).trigger('change');
ย ย ย }

ย ย ย /** Pobiera listฤ tematรณw i wyลwietla jฤ w modalu tematรณw. */
ย ย ย async function loadTopicsModalList() {
ย ย ย ย const $list = $('#topicsList').html('<li class="list-group-item text-muted">ลadowanie...</li>');
ย ย ย ย try {
ย ย ย ย ย const topics = await fetchJSON(`${API_BASE}/api/tus/topics`);
ย ย ย ย ย $list.empty();
ย ย ย ย ย if (!topics || topics.length === 0) {
ย ย ย ย ย ย $list.append('<li class="list-group-item text-muted">Brak zdefiniowanych tematรณw.</li>');
ย ย ย ย ย ย return;
ย ย ย ย ย }
ย ย ย ย ย topics.forEach(t => $list.append(`<li class="list-group-item">${t.title}</li>`));
ย ย ย ย } catch (e) {
ย ย ย ย ย console.error(e);
ย ย ย ย ย $list.html('<li class="list-group-item text-danger">Bลฤd ลadowania tematรณw.</li>');
ย ย ย ย }
ย ย ย }

ย ย ย /** Pobiera listฤ zachowaล i wyลwietla jฤ w modalu zachowaล. */
ย ย ย async function reloadBehaviorsModal() {
ย ย ย ย const $list = $('#behaviorsList').html('<li class="list-group-item text-muted">ลadowanieโฆ</li>');
ย ย ย ย try {
ย ย ย ย ย const items = await fetchJSON(`${API_BASE}/api/tus/behaviors`);
ย ย ย ย ย $list.empty();
ย ย ย ย ย if (!items || !items.length) {
ย ย ย ย ย ย $list.append('<li class="list-group-item text-muted">Brak zdefiniowanych zachowaล.</li>');
ย ย ย ย ย ย return;
ย ย ย ย ย }
ย ย ย ย ย items.forEach(b => {
ย ย ย ย ย ย $list.append(`
ย ย ย ย ย ย ย <li class="list-group-item d-flex justify-content-between align-items-center">
ย ย ย ย ย ย ย ย <span>${b.title} <small class="text-muted">(domyลlny max ${b.default_max_points ?? 3})</small></span>
ย ย ย ย ย ย ย ย <button class="btn btn-outline-danger btn-sm del-beh" data-id="${b.id}">Usuล</button>
ย ย ย ย ย ย ย </li>`);
ย ย ย ย ย });
ย ย ย ย } catch (e) {
ย ย ย ย ย console.error(e);
ย ย ย ย ย $list.html('<li class="list-group-item text-danger">Bลฤd ลadowania zachowaล.</li>');
ย ย ย ย }
ย ย ย }


ย ย ย // ==========================================================
ย ย ย // === FUNKCJE ZARZฤDZAJฤCE MODALAMI ========================
ย ย ย // ==========================================================


ยasync function saveSchedule(groupId, scheduleDays) {
ย ย ย ย try {
ย ย ย ย ย ย const response = await fetch(`/api/tus/groups/${groupId}/schedule`, {
ย ย ย ย ย ย ย ย method: 'PUT', // <-- UPEWNIJ SIฤ, ลปE JEST TUTAJ 'PUT'
ย ย ย ย ย ย ย ย headers: {
ย ย ย ย ย ย ย ย ย ย 'Content-Type': 'application/json',
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย body: JSON.stringify({ schedule_days: scheduleDays }),
ย ย ย ย ย ย });

ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย throw new Error('Bลฤd serwera: ' + response.status);
ย ย ย ย ย ย }

ย ย ย ย ย ย // Sukces
ย ย ย ย ย ย console.log("Harmonogram zapisany!");

ย ย ย ย } catch (error) {
ย ย ย ย ย ย console.error("Nie udaลo siฤ zapisaฤ harmonogramu:", error);
ย ย ย ย }
ย ย }

ย ย ย /**
ย ย ย ย* Otwiera gลรณwny, interaktywny modal ze szczegรณลami grupy, sesjami i opcjami.
ย ย ย ย* @param {number} groupId - ID grupy do wyลwietlenia.
ย ย ย ย*/
ย ย ย // W pliku tus.html znajdลบ i podmieล tฤ funkcjฤ

async function openGroupDetails(groupId) {
ย ย try {
ย ย ย ย const g = await fetchJSON(`${API_BASE}/api/tus/groups/${groupId}`);
ย ย ย ย const [bonusDetails, bonusHistory] = await Promise.all([
ย ย ย ย ย ยfetchJSON(`${API_BASE}/api/tus/groups/${groupId}/bonus-details`),
ย ย ย ย ย ยfetchJSON(`${API_BASE}/api/tus/groups/${groupId}/general-bonus-history`)
ย ย ย ย ]);

ย ย ย ย $('#groupDetailsTitle').text(`Zarzฤdzaj grupฤ: ${g.name}`);
ย ย ย ย $('#deleteGroupFromDetailsBtn').show().data('group-id', g.id);

ย ย ย ย // --- LOGIKA KALENDARZA (bez zmian) ---
ย ย ย ย let calendarCurrentDate = new Date();
ย ย ย ย const scheduledDates = new Set(g.sessions.map(s => s.session_date.slice(0, 10)));
ย ย ย ย const DOW_SHORT = ["Nd", "Pn", "Wt", "ลr", "Cz", "Pt", "So"];
ย ย ย ย let selectedDates = new Set(g.schedule_days || []);

ย ย ย ย function renderSessionCalendar() {
ย ย ย ย ย ย const year = calendarCurrentDate.getFullYear();
ย ย ย ย ย ย const month = calendarCurrentDate.getMonth();
ย ย ย ย ย ย const calendarEl = document.getElementById('sessionCalendar');
ย ย ย ย ย ย if (!calendarEl) return;

ย ย ย ย ย ย const firstOfMonth = new Date(year, month, 1);
ย ย ย ย ย ย const lastOfMonth = new Date(year, month + 1, 0);
ย ย ย ย ย ย const startDay = firstOfMonth.getDay();

ย ย ย ย ย ย let headerHtml = `<div class="session-calendar-header"><button type="button" class="btn btn-sm btn-outline-secondary cal-prev-month">ยซ</button><strong class="mx-2">${firstOfMonth.toLocaleString('pl-PL', { month: 'long', year: 'numeric' })}</strong><button type="button" class="btn btn-sm btn-outline-secondary cal-next-month">ยป</button></div>`;
ย ย ย ย ย ย let gridHtml = `<div class="session-calendar-grid">`;
ย ย ย ย ย ย DOW_SHORT.forEach(day => gridHtml += `<div class="session-calendar-dow">${day}</div>`);
ย ย ย ย ย ย for (let i = 0; i < startDay; i++) { gridHtml += `<div class="session-calendar-day other-month"></div>`; }

ย ย ย ย ย ย ย ย ย for (let i = 1; i <= lastOfMonth.getDate(); i++) {
ย ย ย ย ย ย ย ย const dayDate = new Date(year, month, i);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // UลปYJ TEGO SAMEGO FORMATU CO W LIลCIE SESJI
ย ย ย ย ย ย ย ย const dateString = dayDate.toISOString().split('T')[0]; // Format YYYY-MM-DD
ย ย ย ย ย ย ย ย const isScheduled = scheduledDates.has(dateString);
ย ย ย ย ย ย ย ย const isSelected = selectedDates.has(dateString);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย let classes = 'session-calendar-day';
ย ย ย ย ย ย ย ย if (isScheduled) classes += ' scheduled';
ย ย ย ย ย ย ย ย if (isSelected) classes += ' is-selected-day';
ย ย ย ย ย ย ย ย gridHtml += `<div class="${classes}" data-date="${dateString}">${i}</div>`;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย gridHtml += `</div>`;
ย ย ย ย ย ย ย ย ย ย calendarEl.innerHTML = `<div class="session-calendar">${headerHtml}${gridHtml}</div>`;
ย ย ย ย ย ย ย }

ย ย ย ย // --- PRZYGOTOWANIE DANYCH ---
ย ย ย ย const currentYear = new Date().getFullYear();
ย ย ย ย let schoolYearOptionsHtml = '';
ย ย ย ย for (let i = 0; i < 5; i++) {
ย ย ย ย ย ย const yearStart = currentYear - i;
ย ย ย ย ย ย const yearEnd = yearStart + 1;
ย ย ย ย ย ย schoolYearOptionsHtml += `<option value="${yearStart}">${yearStart}/${yearEnd}</option>`;
ย ย ย ย }
ย ย ย ย // const membersListHtml = (g.members || []).map(m => `<li>${m.full_name}</li>`).join('') || '<li class="text-muted">Brak uczestnikรณw</li>'; // Juลผ niepotrzebne

ย ย ย ย // --- HTML dla listy obecnoลci ---
ย ย ย ย const membersChecklistHtml = (g.members || []).length > 0
ย ย ย ย ย ย ? (g.members || []).map(m => `
ย ย ย ย ย ย ย ย <div class="form-check">
ย ย ย ย ย ย ย ย ย <input class="form-check-input new-session-attendance" type="checkbox" value="${m.id}" id="att-new-${m.id}" checked>
ย ย ย ย ย ย ย ย ย <label class="form-check-label" for="att-new-${m.id}">${m.full_name}</label>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `).join('')
ย ย ย ย ย ย : '<p class="text-muted small">Brak uczestnikรณw w grupie.</p>';

ย ย ย ย // --- Reszta danych (sesje, bonusy itd.) ---
ย ย ย ย const sessionsMap = new Map();
ย ย ย ย (g.sessions || []).forEach(session => {
ย ย ย ย ย ย if (session.id && !sessionsMap.has(session.id)) {
ย ย ย ย ย ย ย ย sessionsMap.set(session.id, session);
ย ย ย ย ย ย }
ย ย ย ย });
ย ย ย ย const uniqueSessions = Array.from(sessionsMap.values());
ย ย ย ย uniqueSessions.sort((a, b) => new Date(b.session_date) - new Date(a.session_date));
ย ย ย ย const sessionsListHtml = uniqueSessions.map(s => {
ย ย ย ย ย let whenLabel = 'Bลฤdna data';
ย ย ย ย ย try {
ย ย ย ย ย ย ย if (s.session_date) {
ย ย ย ย ย ย ย ย ย const dateObj = new Date(s.session_date);
ย ย ย ย ย ย ย ย ย if (!isNaN(dateObj.getTime())) {
ย ย ย ย ย ย ย ย ย ย ย // UลปYJ TEGO SAMEGO FORMATU CO W KALENDARZU
ย ย ย ย ย ย ย ย ย ย ย const dateString = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
ย ย ย ย ย ย ย ย ย ย ย const timePart = s.session_time ? ` ${s.session_time.substring(0, 5)}` : '';
ย ย ย ย ย ย ย ย ย ย ย whenLabel = dateObj.toLocaleDateString('pl-PL') + timePart;
ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย // DODATKOWO: Zapisz datฤ w tym samym formacie do scheduledDates
ย ย ย ย ย ย ย ย ย ย ย scheduledDates.add(dateString);
ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย whenLabel = `${s.session_date}${s.session_time ? ' ' + s.session_time.substring(0,5) : ''}`;
ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย }
ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย console.error('Bลฤd formatowania daty:', e);
ย ย ย ย ย ย ย whenLabel = `${s.session_date}${s.session_time ? ' ' + s.session_time : ''}`;
ย ย ย ย ย }
ย ย ย ย ย ย return `<li class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2"><span>${whenLabel} โ ${s.topic_title || 'bez tematu'}</span><div class="btn-group btn-group-sm"><button class="btn btn-outline-success bonus-session-btn" data-session-id="${s.id}">Bonusy sesji</button><button class="btn btn-outline-primary score-session-btn" data-session-id="${s.id}" data-group-id="${g.id}">Oceล</button><button class="btn btn-outline-danger delete-session-btn" data-session-id="${s.id}" data-group-id="${g.id}">Usuล</button></div></li>`;
ย ย ย ย }).join('') || '<li class="list-group-item text-muted">Brak sesji</li>';
ย ย ย ย const bonusTableRowsHtml = (g.members || []).map(member => {
ย ย ย ย ย ย const details = bonusDetails.find(d => d.client_id === member.id) || {};
ย ย ย ย ย ย return `<tr><td>${member.full_name}</td><td class="text-center border-end">${details.behavior_points || 0}</td><td class="text-center">${details.session_bonus_points || 0}</td><td class="text-center">${details.general_bonus_points || 0}</td><td class="text-center fw-bold fs-5">${details.total_points || 0}</td></tr>`;
ย ย ย ย }).join('');
ย ย ย ย const memberOptionsHtml = (g.members || []).map(m => `<option value="${m.id}">${m.full_name}</option>`).join('');
ย ย ย ย const bonusHistoryHtml = bonusHistory.length > 0 ? bonusHistory.map(h => {
ย ย ย ย ย ย const date = new Date(h.awarded_at).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
ย ย ย ย ย ย return `<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${h.client_name}</strong> otrzymaล <strong>${h.points} pkt.</strong><br><small class="text-muted">Powรณd: ${h.reason || 'Brak'}</small></div><span class="badge bg-secondary rounded-pill">${date}</span></li>`;
ย ย ย ย }).join('') : '<li class="list-group-item text-muted">Brak przyznanych bonusรณw ogรณlnych.</li>';

ย ย ย ย // --- ZMIENIONY UKลAD HTML ---
ย ย ย ย $('#groupDetailsBody').html(`
ย ย ย ย ย ย <ul class="nav nav-tabs" id="groupTabs" role="tablist">
ย ย ย ย ย ย ย <li class="nav-item" role="presentation"><button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions-panel" type="button" role="tab">Sesje i Uczestnicy</button></li>
ย ย ย ย ย ย ย <li class="nav-item" role="presentation"><button class="nav-link" id="bonuses-tab" data-bs-toggle="tab" data-bs-target="#bonuses-panel" type="button" role="tab">โญ Punktacja i Bonusy</button></li>
ย ย ย ย ย ย ย <li class="nav-item" role="presentation"><button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals-panel" type="button" role="tab">Cele i Postฤpy</button></li>
ย ย ย ย ย ย </ul>
ย ย ย ย ย ย <div class="tab-content pt-3">
ย ย ย ย ย ย ย <div class="tab-pane fade show active" id="sessions-panel" role="tabpanel">
ย ย <h6>Lista Sesji</h6>
ย ย <ul class="list-group mb-3">${sessionsListHtml}</ul>
ย ย <hr>

ย ย <form id="addSessionForm" data-group-id="${g.id}">
ย ย ย ย ย ย ย ย <div class="row g-3">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-lg-3 col-md-4">
ย ย ย ย ย ย ย ย <label class="form-label mb-1 fw-bold">Obecnoลฤ (dla nowej sesji):</label>
ย ย ย ย ย ย ย ย <div class="p-2 border rounded bg-white" style="max-height: 250px; overflow-y: auto;">
ย ย ย ย ย ย ย ย ย ย ${membersChecklistHtml}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-lg-4 col-md-4">
ย ย ย ย ย ย ย ย <label class="form-label mb-1 fw-bold">Szablon dni:</label>
ย ย ย ย ย ย ย ย <div id="sessionCalendar"></div>
ย ย ย ย ย ย ย ย <div class="d-grid mt-2">
ย ย ย ย ย ย ย ย ย ย <button type="button" id="saveScheduleBtn" class="btn btn-info btn-sm">Zapisz zaznaczone dni</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-lg-5 col-md-4">
ย ย ย ย ย ย ย ย <div class="card h-100">
ย ย ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย ย ย <h6 class="card-title">Dodaj nowฤ sesjฤ</h6>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="row g-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="sessionDateInput" class="form-label">Data</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="date" class="form-control" name="date" id="sessionDateInput" required>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="sessionTimeInput" class="form-label">Godzina</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="time" class="form-control" name="time" id="sessionTimeInput" required>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-12">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="sessionTopicInput" class="form-label">Temat</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="sessionTopicInput" class="form-control" placeholder="Wpisz temat zajฤฤ..." required>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-12">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="sessionBehaviorsSelect" class="form-label">Zachowania do modelowania (max 4)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="sessionBehaviorsSelect" class="form-select" multiple></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-12 mt-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-primary w-100" type="submit">Dodaj sesjฤ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย ย ย </form>
</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="tab-pane fade" id="bonuses-panel" role="tabpanel">
ย ย ย ย ย ย ย ย <h5>Zbiorcza punktacja</h5><div class="table-responsive mb-4"><table class="table table-bordered table-striped"><thead class="table-light"><tr><th>Uczestnik</th><th class="text-center border-end">Pkt. za zachowania</th><th class="text-center">Bonusy z sesji</th><th class="text-center">Super bonusy</th><th class="text-center">SUMA PUNKTรW</th></tr></thead><tbody>${bonusTableRowsHtml}</tbody></table></div><hr/>
ย ย ย ย ย ย ย ย <h5>Przyznaj bonus ogรณlny</h5><form id="awardGeneralBonusForm" class="row g-2 align-items-end" data-group-id="${g.id}"><div class="col-md-5"><label for="bonusClientSelect" class="form-label">Uczestnik</label><select id="bonusClientSelect" name="client_id" class="form-select" required>${memberOptionsHtml}</select></div><div class="col-md-2"><label for="bonusPointsInput" class="form-label">Punkty</label><input type="number" id="bonusPointsInput" name="points" class="form-control" min="1" required></div><div class="col-md-5"><label for="bonusReasonInput" class="form-label">Powรณd (wymagany)</label><input type="text" id="bonusReasonInput" name="reason" class="form-control" placeholder="Np. Pomoc koledze" required></div><div class="col-12"><button type="submit" class="btn btn-success">Przyznaj punkty</button></div></form><hr class="my-4"/>
ย ย ย ย ย ย ย ย <div class="accordion" id="bonusHistoryAccordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory">Pokaลผ / Ukryj historiฤ bonusรณw ogรณlnych</button></h2><div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#bonusHistoryAccordion"><div class="accordion-body p-0"><ul class="list-group list-group-flush">${bonusHistoryHtml}</ul></div></div></div></div>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย <div class="tab-pane fade" id="goals-panel" role="tabpanel">
ย ย ย ย ย ย ย ย ย<h6>๐ฏ Cele i nagrody semestralne</h6><div class="card mb-3"><div class="card-body"><form id="groupTargetForm" data-group-id="${g.id}"><div class="row g-2 align-items-end"><div class="col-md-5"><label class="form-label">Rok szkolny</label><select class="form-select" name="school_year_start" required>${schoolYearOptionsHtml}</select></div><div class="col-md-7"><label class="form-label">Semestr</label><select class="form-select" name="semester" required><option value="1">I Pรณลrocze (Wrzesieล - Styczeล)</option><option value="2">II Pรณลrocze (Luty - Czerwiec)</option></select></div><div class="col-6"><label class="form-label">Cel (pkt)</label><input type="number" class="form-control" name="points" min="0" required></div><div class="col-6"><label class="form-label">Nagroda</label><input type="text" class="form-control" name="reward"></div><div class="col-12"><button type="submit" class="btn btn-primary btn-sm w-100">Zapisz cel</button></div></div></form></div></div>
ย ย ย ย ย ย ย ย ย<div class="d-flex align-items-end gap-2 mb-3"><div><label class="form-label mb-0"><strong>Podsumowanie dla roku szkolnego</strong></label><select class="form-select" id="bonusYearSelect">${schoolYearOptionsHtml}</select></div><button type="button" class="btn btn-primary" id="bonusScopeRefreshBtn" data-group-id="${g.id}">Pokaลผ</button><button type="button" class="btn btn-secondary" id="hideBonusesBtn" style="display: none;">Ukryj</button></div><div id="bonusesSummary" class="mb-3"></div>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย `);
ย ย ย ย // --- KONIEC POPRAWKI HTML ---

ย ย ย ย renderSessionCalendar();
ย ย ย ย function fmtYYYYMMDD(date) { return date ? date.toISOString().split('T')[0] : ""; }
ย ย ย ย const calendarEl = document.getElementById('sessionCalendar');
ย ย ย ย if (calendarEl) {
ย ย ย ย ย ย calendarEl.addEventListener('click', (e) => {
ย ย ย ย ย ย ย ย if (e.target.classList.contains('cal-prev-month')) { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1); renderSessionCalendar(); }
ย ย ย ย ย ย ย ย else if (e.target.classList.contains('cal-next-month')) { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1); renderSessionCalendar(); }
ย ย ย ย ย ย ย ย else if (e.target.classList.contains('session-calendar-day') && e.target.dataset.date) {
ย ย ย ย ย ย ย ย ย ย const clickedDateString = e.target.dataset.date;
ย ย ย ย ย ย ย ย ย ย selectedDates.has(clickedDateString) ? selectedDates.delete(clickedDateString) : selectedDates.add(clickedDateString);
ย ย ย ย ย ย ย ย ย ย renderSessionCalendar();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย }
ย ย ย ย const saveScheduleBtn = document.getElementById('saveScheduleBtn');
ย ย ย ย if (saveScheduleBtn) {
ย ย ย ย ย ย saveScheduleBtn.setAttribute('type', 'button');ย
ย ย ย ย ย ย saveScheduleBtn.addEventListener('click', async () => {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย const payload = { schedule_days: Array.from(selectedDates) };
ย ย ย ย ย ย ย ย ย ย await fetchJSON(`/api/tus/groups/${groupId}/schedule`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
ย ย ย ย ย ย ย ย ย ย showAlert('Harmonogram zostaล zapisany!', 'success');
ย ย ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย ย ย showAlert(`Bลฤd zapisu harmonogramu: ${err.message}`, 'danger');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย const behaviors = await fetchJSON(`${API_BASE}/api/tus/behaviors`);
ย ย ย ย const $behaviorSelect = $('#sessionBehaviorsSelect').empty();
ย ย ย ย (behaviors || []).forEach(b => $behaviorSelect.append(new Option(`${b.title} (max ${b.default_max_points ?? 3})`, String(b.id))));
ย ย ย ย $behaviorSelect.select2({ theme: 'bootstrap-5', width: '100%', placeholder: 'Wybierz do 4 zachowaล', maximumSelectionLength: 4, dropdownParent: $('#groupDetailsModal') });

ย ย ย ย groupDetailsModal.show();
ย ย } catch (e) {
ย ย ย ย console.error(e);
ย ย ย ย alert(`Nie udaลo siฤ otworzyฤ szczegรณลรณw grupy: ${e.message}`);
ย ย }
}

ย ย ย /**
ย ย ย ย* Otwiera modal do przyznawania bonusรณw indywidualnych dla danej sesji.
ย ย ย ย* @param {number} sessionId - ID sesji.
ย ย ย ย*/
ย ย ย async function openBonusModal(sessionId) {
ย ย ย ย const $container = $('#bonusParticipantsContainer').html('<p class="text-muted">ลadowanie...</p>');
ย ย ย ย $('#saveBonusesBtn').data('session-id', sessionId);
ย ย ย ย bonusModal.show();

ย ย ย ย try {
ย ย ย ย ย const [session, existingBonuses] = await Promise.all([
ย ย ย ย ย ย fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}`),
ย ย ย ย ย ย fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/bonuses`)
ย ย ย ย ย ]);

ย ย ย ย ย const sessionDate = new Date(session.session_date).toLocaleDateString('pl-PL');
ย ย ย ย ย $('#bonusModalTitle').text(`Bonusy dla sesji z dnia ${sessionDate}`);
ย ย ย ย ย $('#bonusModalSessionInfo').html(`<strong>Temat:</strong> ${session.topic_title || 'Brak'}`);

ย ย ย ย ย if (!session.members || session.members.length === 0) {
ย ย ย ย ย ย $container.html('<p class="text-danger">Brak uczestnikรณw w tej sesji.</p>');
ย ย ย ย ย ย return;
ย ย ย ย ย }

ย ย ย ย ย const participantsHtml = session.members.map(member => `
ย ย ย ย ย ย <div class="input-group mb-2">
ย ย ย ย ย ย ย <span class="input-group-text w-75">${member.full_name}</span>
ย ย ย ย ย ย ย <input type="number" class="form-control bonus-points-input"
ย ย ย ย ย ย ย ย ย ย ยdata-client-id="${member.id}"
ย ย ย ย ย ย ย ย ย ย ยmin="0"
ย ย ย ย ย ย ย ย ย ย ยvalue="${existingBonuses[member.id] || 0}">
ย ย ย ย ย ย </div>`).join('');
ย ย ย ย ย $container.html(participantsHtml);
ย ย ย ย } catch (err) {
ย ย ย ย ย $container.html(`<p class="text-danger">Bลฤd ลadowania danych: ${err.message}</p>`);
ย ย ย ย }
ย ย ย }

ย ย ย /**
ย ย ย ย* Otwiera modal do oceniania zachowaล dla danej sesji.
ย ย ย ย* @param {number} sessionId - ID sesji.
ย ย ย ย* @param {number} groupId - ID grupy (do odลwieลผenia widoku).
ย ย ย ย*/
ย ย ย /**
ย ย ย ย* Otwiera modal do oceniania zachowaล dla danej sesji. (Wersja 2.0 - z poprawkฤ)
ย ย ย ย* @param {number} sessionId - ID sesji.
ย ย ย ย* @param {number} groupId - ID grupy (do odลwieลผenia widoku).
ย ย ย ย*/
ย ย ย async function openScoringModal(sessionId, groupId) {
ย ย ย ย try {
ย ย ย ย ย const data = await fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/scores`);

ย ย ย ย ย // 1. Najpierw sprawdลบ, czy w ogรณle sฤ czลonkowie
ย ย ย ย ย if (!data.members || data.members.length === 0) {
ย ย ย ย ย ย $('#scoringBody').html(`<div class="alert alert-warning mb-0">Do tej sesji nie przypisano ลผadnych uczestnikรณw.</div>`);
ย ย ย ย ย ย // Wyลฤcz przycisk zapisu, jeลli nie ma kogo zapisaฤ
ย ย ย ย ย ย $('#saveScoresBtn').prop('disabled', true);
ย ย ย ย ย } else {
ย ย ย ย ย ย // 2. Buduj nagลรณwek (thead) - kolumny obecnoลci i osoby sฤ ZAWSZE
ย ย ย ย ย ย let thead = '<tr><th class="text-center">Obecnoลฤ</th><th>Osoba</th>';
ย ย ย ย ย ย const hasBehaviors = data.behaviors && data.behaviors.length > 0;

ย ย ย ย ย ย // Dodaj kolumny zachowaล i sumy tylko jeลli zachowania istniejฤ
ย ย ย ย ย ย if (hasBehaviors) {
ย ย ย ย ย ย ย data.behaviors.forEach(b => thead += `<th>${b.title}<br><small>max ${b.max_points}</small></th>`);
ย ย ย ย ย ย ย thead += '<th class="text-end">Suma</th>';
ย ย ย ย ย ย }
ย ย ย ย ย ย thead += '</tr>';

ย ย ย ย ย ย // 3. Buduj ciaลo tabeli (tbody)
ย ย ย ย ย ย let tbody = '';
ย ย ย ย ย ย data.members.forEach(m => {
ย ย ย ย ย ย ย // Komรณrka obecnoลci (zawsze)
ย ย ย ย ย ย ย const isPresent = m.is_present === undefined ? true : m.is_present;
ย ย ย ย ย ย ย const checkedAttr = isPresent ? 'checked' : '';
ย ย ย ย ย ย ย const attendanceTd = `<td class="text-center align-middle"><input class="form-check-input attendance-check" type="checkbox" ${checkedAttr}></td>`;

ย ย ย ย ย ย ย // Komรณrka imienia (zawsze)
ย ย ย ย ย ย ย const nameTd = `<td>${m.full_name}</td>`;

ย ย ย ย ย ย ย let scoreTds = '';
ย ย ย ย ย ย ย let sumTd = '';
ย ย ย ย ย ย ย let sum = 0;

ย ย ย ย ย ย ย // Dodaj komรณrki ocen i sumy tylko jeลli zachowania istniejฤ
ย ย ย ย ย ย ย if (hasBehaviors) {
ย ย ย ย ย ย ย ย data.behaviors.forEach(b => {
ย ย ย ย ย ย ย ย ย const val = (data.scores?.[m.id]?.[b.behavior_id]) ?? 0;
ย ย ย ย ย ย ย ย ย sum += Number(val) || 0;
ย ย ย ย ย ย ย ย ย scoreTds += `<td style="width:120px"><input type="number" class="form-control form-control-sm score-input" data-cid="${m.id}" data-bid="${b.behavior_id}" value="${val}" min="0" max="${b.max_points}"></td>`;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย sumTd = `<td class="sum-cell text-end fw-bold">${sum}</td>`;
ย ย ย ย ย ย ย }
ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย // Zลรณลผ wiersz
ย ย ย ย ย ย ย tbody += `<tr data-cid="${m.id}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ${attendanceTd}
ย ย ย ย ย ย ย ย ย ย ย ย ย ${nameTd}
ย ย ย ย ย ย ย ย ย ย ย ย ย ${scoreTds}
ย ย ย ย ย ย ย ย ย ย ย ย ย ${sumTd}
ย ย ย ย ย ย ย ย ย ย ย ย </tr>`;
ย ย ย ย ย ย });

ย ย ย ย ย ย // 4. Wstaw gotowy HTML do modala
ย ย ย ย ย ย $('#scoringBody').html(`
ย ย ย ย ย ย ย ${!hasBehaviors ? '<div class="alert alert-info mb-2">Brak zachowaล do oceny. Moลผesz zapisaฤ tylko obecnoลฤ.</div>' : ''}
ย ย ย ย ย ย ย <div class="table-responsive">
ย ย ย ย ย ย ย ย <table class="table table-sm table-bordered align-middle">
ย ย ย ย ย ย ย ย ย <thead>${thead}</thead>
ย ย ย ย ย ย ย ย ย <tbody>${tbody}</tbody>
ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย </div>`);
ย ย ย ย ย ยย
ย ย ย ย ย ย // Wลฤcz przycisk zapisu
ย ย ย ย ย ย $('#saveScoresBtn').prop('disabled', false);
ย ย ย ย ย }

ย ย ย ย ย // Ustaw ID i pokaลผ modal (bez zmian)
ย ย ย ย ย $('#scoringSessionId').val(String(sessionId));
ย ย ย ย ย $('#scoringGroupId').val(String(groupId));
ย ย ย ย ย scoringModal.show();
ย ย ย ย } catch (e) {
ย ย ย ย ย console.error(e);
ย ย ย ย ย alert('Nie udaลo siฤ wczytaฤ danych do punktacji: ' + e.message);
ย ย ย ย }
ย ย ย }

ย ย ย /**
ย ย ย ย* Odลwieลผa i wyลwietla podsumowanie bonusรณw dla grupy w danym roku.
ย ย ย ย* @param {number} groupId - ID grupy.
ย ย ย ย* @param {number} year - Rok do wyลwietlenia.
ย ย ย ย*/
ย ย ย async function refreshBonusesSummary(groupId, schoolYearStart) {
ย ย ย ย const container = $('#bonusesSummary').html(`<div class="alert alert-info mb-0">ลadowanie podsumowania bonusรณwโฆ</div>`);
ย ย ย ย try {
ย ย ย ย ย ย const data = await fetchJSON(`${API_BASE}/api/tus/groups/${groupId}/bonuses?school_year_start=${schoolYearStart}`);

ย ย ย ย ย ย const createPanel = (semesterData, semesterNum, yearLabel) => {
ย ย ย ย ย ย ย ย const scopeLabel = semesterNum === 1 ? 'I Pรณลrocze' : 'II Pรณลrocze';
ย ย ย ย ย ย ย ย return `
ย ย ย ย ย ย ย ย ย <div class="col-lg-6">
ย ย ย ย ย ย ย ย ย ย <div class="card h-100">
ย ย ย ย ย ย ย ย ย ย ย <div class="card-header fw-bold">${scopeLabel} ${yearLabel}</div>
ย ย ย ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-1"><strong>Cel:</strong> ${semesterData.target_points} pkt</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-3"><strong>Nagroda:</strong> ${semesterData.reward}</p>
ย ย ย ย ย ย ย ย ย ย ย ย <h6 class="card-title">Postฤp</h6>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-1"><strong>Zebrano bonusรณw:</strong> ${semesterData.points_collected} pkt</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="mb-0 fs-5"><strong>Pozostaลo do celu: <span class="fw-bold text-primary">${semesterData.points_remaining} pkt</span></strong></p>
ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย </div>`;
ย ย ย ย ย ย };

ย ย ย ย ย ย container.html(`
ย ย ย ย ย ย ย ย <div class="row g-3">
ย ย ย ย ย ย ย ย ย ย ${createPanel(data.semester_1, 1, data.school_year_label)}
ย ย ย ย ย ย ย ย ย ย ${createPanel(data.semester_2, 2, data.school_year_label)}
ย ย ย ย ย ย ย ย </div>`);
ย ย ย ย ย ย $('#hideBonusesBtn').show();
ย ย ย ย } catch (e) {
ย ย ย ย ย ย console.error(e);
ย ย ย ย ย ย container.html(`<div class="alert alert-danger">${e.message}</div>`);
ย ย ย ย }
ย ย }

ย ย ย // ==========================================================
ย ย ย // === GลรWNY BLOK EVENT LISTENERรW =========================
ย ย ย // ==========================================================

ย ย ย // --- Przyciski na stronie gลรณwnej ---
ย ย ย $('#addGroupBtn').on('click', async () => {
ย ย ย ย currentGroupId = null;
ย ย ย ย $('#groupModalTitle').text('Nowa grupa');
ย ย ย ย $('#groupForm')[0].reset();
ย ย ย ย try {
ย ย ย ย ย await loadTherapistsAndClients();
ย ย ย ย ย groupModal.show();
ย ย ย ย } catch (e) {
ย ย ย ย ย console.error(e);
ย ย ย ย ย alert('Nie udaลo siฤ pobraฤ list terapeutรณw i uczestnikรณw.');
ย ย ย ย }
ย ย ย });

ย ย ย $('#groupsContainer').on('click', '.view-group-btn', function() {
ย ย ย ย openGroupDetails($(this).data('group-id'));
ย ย ย });

ย ย ย $('#groupsContainer').on('click', '.edit-group-btn', async function() {
ย ย ย ย const gid = $(this).data('group-id');
ย ย ย ย try {
ย ย ย ย ย const g = await fetchJSON(`${API_BASE}/api/tus/groups/${gid}`);
ย ย ย ย ย currentGroupId = g.id;
ย ย ย ย ย $('#groupModalTitle').text(`Edytuj grupฤ: ${g.name}`);
ย ย ย ย ย await loadTherapistsAndClients({
ย ย ย ย ย ย name: g.name,
ย ย ย ย ย ย therapist_id: g.therapist_id,
ย ย ย ย ย ย assistant_therapist_id: g.assistant_therapist_id,
ย ย ย ย ย ย client_ids: (g.members || []).map(m => m.id)
ย ย ย ย ย });
ย ย ย ย ย groupModal.show();
ย ย ย ย } catch (e) {
ย ย ย ย ย console.error(e);
ย ย ย ย ย alert('Nie udaลo siฤ pobraฤ danych grupy do edycji.');
ย ย ย ย }
ย ย ย });

ย ย ย // --- Formularz dodawania/edycji grupy ---
ย ย ย $('#groupForm').on('submit', async function(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย const payload = {
ย ย ย ย ย name: ($('#groupName').val() || '').trim(),
ย ย ย ย ย therapist_id: parseInt($('#therapistSelect').val(), 10) || null,
ย ย ย ย ย assistant_therapist_id: parseInt($('#assistantTherapistSelect').val(), 10) || null,
ย ย ย ย ย client_ids: ($('#clientSelect').val() || []).map(v => parseInt(v, 10))
ย ย ย ย };

ย ย ย ย if (!payload.name || !payload.therapist_id || payload.client_ids.length === 0) {
ย ย ย ย ย return alert('Nazwa grupy, terapeuta prowadzฤcy i co najmniej jeden uczestnik sฤ wymagani.');
ย ย ย ย }

ย ย ย ย const url = currentGroupId ? `${API_BASE}/api/tus/groups/${currentGroupId}` : `${API_BASE}/api/tus/groups`;
ย ย ย ย const method = currentGroupId ? 'PUT' : 'POST';

ย ย ย ย try {
ย ย ย ย ย await fetchJSON(url, {
ย ย ย ย ย ย method,
ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย });
ย ย ย ย ย groupModal.hide();
ย ย ย ย ย await loadGroups();
ย ย ย ย } catch (err) {
ย ย ย ย ย console.error(err);
ย ย ย ย ย alert('Nie udaลo siฤ zapisaฤ grupy: ' + err.message);
ย ย ย ย }
ย ย ย });

ย ย ย // ZASTฤP CAลY TEN BLOK - OD 'submit' DO KOลCOWEGO '});'
ย ย ย $(document).on('submit', '#addSessionForm', async function(e) {
ย ย ย ย ย e.preventDefault();
ย ย ย ย ย const $form = $(this);
ย ย ย ย ย const gid = $form.data('group-id');

ย ย ย ย ย const dateValue = $form.find('input[name="date"]').val();
ย ย ย ย ย const timeValue = $form.find('input[name="time"]').val();

ย ย ย ย ย if (!dateValue || !timeValue) {
ย ย ย ย ย ย ย alert('Data i godzina sฤ wymagane!');
ย ย ย ย ย ย ย return;
ย ย ย ย ย }

ย ย ย ย ย let timeFormatted = timeValue.length === 5 ? timeValue + ':00' : timeValue;
ย ย ย ย ย const topicTitle = ($('#sessionTopicInput').val() || '').trim();

ย ย ย ย ย const payload = {
ย ย ย ย ย ย ย group_id: gid,
ย ย ย ย ย ย ย topic_title: topicTitle,
ย ย ย ย ย ย ย session_date: `${dateValue}T${timeFormatted}`,
ย ย ย ย ย ย ย behavior_ids: ($('#sessionBehaviorsSelect').val() || []).map(v => parseInt(v, 10))
ย ย ย ย ย };

ย ย ย ย ย // --- NOWA SEKCJA: Zbieranie obecnoลci z formularza ---
ย ย ย ย ย const present_client_ids = [];
ย ย ย ย ย $form.find('.new-session-attendance:checked').each(function() {
ย ย ย ย ย ย ย present_client_ids.push(parseInt($(this).val(), 10));
ย ย ย ย ย });
ย ย ย ย ย payload.present_client_ids = present_client_ids;
ย ย ย ย ย // --- KONIEC NOWEJ SEKCJI ---

ย ย ย ย ย if (!payload.topic_title) {
ย ย ย ย ย ย ย return alert('Temat jest wymagany.');
ย ย ย ย ย }

ย ย ย ย ย // Zaktualizowany log, aby pokazaฤ nowe dane
ย ย ย ย ย console.log("Wysyลane dane sesji (z topic_title i obecnoลciฤ):", JSON.stringify(payload, null, 2));

ย ย ย ย ย try {
ย ย ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/sessions`, {
ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย await openGroupDetails(gid); // Odลwieลผ widok
ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย console.error("Bลฤd podczas tworzenia sesji:", err);
ย ย ย ย ย ย ย alert('Nie udaลo siฤ dodaฤ sesji: ' + err.message);
ย ย ย ย ย }
ย ย ย });
ย ย ย // KONIEC BLOKU DO ZASTฤPIENIA
ย ย ย $(document).on('click', '.delete-session-btn', async function() {
ย ย const sid = $(this).data('session-id');
ย ย const gid = $(this).data('group-id');

ย ย // --- POCZฤTEK NOWEJ LOGIKI PYTAล ---
ย ย // Pytanie 1: Potwierdzenie usuniฤcia sesji
ย ย if (!confirm('Czy na pewno chcesz usunฤฤ tฤ sesjฤ? Spowoduje to usuniฤcie punktรณw za zachowania i bonusรณw PRZYPISANYCH do tej konkretnej sesji.')) {
ย ย ย ย return; // Anuluj, jeลli uลผytkownik kliknie "Anuluj"
ย ย }

ย ย // Pytanie 2: Opcjonalne usuniฤcie wszystkich bonusรณw w grupie
ย ย const deleteAllBonuses = confirm(
ย ย ย ย 'PYTANIE DODATKOWE:\n\nCzy chcesz usunฤฤ rรณwnieลผ WSZYSTKIE bonusy (sesyjne i ogรณlne) dla caลej grupy?\n\n' +
ย ย ย ย '-> Kliknij "OK", aby wyczyลciฤ wszystkie bonusy w tej grupie.\n' +
ย ย ย ย '-> Kliknij "Anuluj", aby usunฤฤ tylko tฤ jednฤ sesjฤ i jej punkty.'
ย ย );
ย ย // --- KONIEC NOWEJ LOGIKI PYTAล ---

ย ย try {
ย ย ย ย // Dodajemy nowy parametr do zapytania, informujฤcy serwer o decyzji uลผytkownika
ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/sessions/${sid}?delete_all_bonuses=${deleteAllBonuses}`, {
ย ย ย ย ย ย method: 'DELETE'
ย ย ย ย });

ย ย ย ย alert('โ Sesja zostaลa usuniฤta.');
ย ย ย ย await openGroupDetails(gid);

ย ย } catch (e) {
ย ย ย ย alert('Nie udaลo siฤ usunฤฤ sesji: ' + e.message);
ย ย }
});

ย ย ย $(document).on('click', '.score-session-btn', function() {
ย ย ย ย openScoringModal($(this).data('session-id'), $(this).data('group-id'));
ย ย ย });

ย ย ย $(document).on('click', '.bonus-session-btn', function() {
ย ย ย ย openBonusModal($(this).data('session-id'));
ย ย ย });

ย ย ย $(document).on('submit', '#groupTargetForm', async function(e) {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย const $form = $(this);
ย ย ย ย ย ย const gid = $form.data('group-id');

ย ย ย ย ย ย // --- POPRAWIONE ODCZYTYWANIE WARTOลCI Z FORMULARZA ---
ย ย ย ย ย ย const payload = {
ย ย ย ย ย ย ย ย school_year_start: parseInt($form.find('select[name="school_year_start"]').val(), 10),
ย ย ย ย ย ย ย ย semester: parseInt($form.find('select[name="semester"]').val(), 10),
ย ย ย ย ย ย ย ย points: parseInt($form.find('input[name="points"]').val(), 10),
ย ย ย ย ย ย ย ย reward: ($form.find('input[name="reward"]').val() || '').trim()
ย ย ย ย ย ย };

ย ย ย ย ย ย // --- POPRAWIONA WALIDACJA ---
ย ย ย ย ย ย if (!payload.school_year_start || isNaN(payload.points)) {
ย ย ย ย ย ย ย ย alert('Rok szkolny i cel (punkty) sฤ wymagane.');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/target`, {
ย ย ย ย ย ย ย ย ย ย method: 'PUT',
ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย alert('โ Cel zostaล zapisany.');

ย ย ย ย ย ย ย ย // Automatycznie odลwieลผ widok podsumowania po zapisaniu celu
ย ย ย ย ย ย ย ย await refreshBonusesSummary(gid, payload.school_year_start);

ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error(err);
ย ย ย ย ย ย ย ย alert('Nie udaลo siฤ zapisaฤ celu: ' + err.message);
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย $(document).on('click', '#bonusScopeRefreshBtn', function() {
ย ย ย ย const gid = $(this).data('group-id');
ย ย ย ย // === POPRAWKA 1: Zmieniono ID z #bonusYearInput na #bonusYearSelect ===
ย ย ย ย const year = parseInt($('#bonusYearSelect').val(), 10) || new Date().getFullYear();
ย ย ย ย refreshBonusesSummary(gid, year);
ย ย ย });

ย ย ย $(document).on('click', '#hideBonusesBtn', function() {
ย ย ย ย $('#bonusesSummary').empty();
ย ย ย ย $(this).hide();
ย ย ย });

ย ย ย $(document).on('click', '#showTopicHistoryBtn', async function() {
ย ย ย ย const gid = $(this).data('group-id');
ย ย ย ย const $body = $('#topicHistoryBody').html('<p class="text-center text-muted">ลadowanie...</p>');
ย ย ย ย topicHistoryModal.show();

ย ย ย ย try {
ย ย ย ย ย const historyData = await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/topic-history`);
ย ย ย ย ย if (Object.keys(historyData).length === 0) {
ย ย ย ย ย ย $body.html('<p class="text-center">Brak danych do wyลwietlenia.</p>');
ย ย ย ย ย ย return;
ย ย ย ย ย }
ย ย ย ย ย let finalHtml = '';
ย ย ย ย ย for (const clientId in historyData) {
ย ย ย ย ย ย const clientData = historyData[clientId];
ย ย ย ย ย ย const itemsHtml = clientData.history.map(item => {
ย ย ย ย ย ย ย const date = new Date(item.date).toLocaleDateString('pl-PL');
ย ย ย ย ย ย ย return `<li><strong>${item.topic}</strong> <small class="text-muted">(${date} w: ${item.group_name})</small></li>`;
ย ย ย ย ย ย }).join('');
ย ย ย ย ย ย finalHtml += `<h6 class="mt-3 border-bottom pb-1">${clientData.client_name}</h6><ul class="list-unstyled">${itemsHtml}</ul>`;
ย ย ย ย ย }
ย ย ย ย ย $body.html(finalHtml);
ย ย ย ย } catch (err) {
ย ย ย ย ย $body.html(`<div class="alert alert-danger">${err.message}</div>`);
ย ย ย ย }
ย ย ย });

ย ย ย $(document).on('submit', '#awardGeneralBonusForm', async function(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย const $form = $(this);
ย ย ย ย const gid = $form.data('group-id');
ย ย ย ย const payload = {
ย ย ย ย ย client_id: parseInt($form.find('select[name="client_id"]').val(), 10),
ย ย ย ย ย points: parseInt($form.find('input[name="points"]').val(), 10),
ย ย ย ย ย reason: ($form.find('input[name="reason"]').val() || '').trim()
ย ย ย ย };

ย ย ย ย if (!payload.client_id || !payload.points || payload.points <= 0) {
ย ย ย ย ย return alert('Wybierz uczestnika i podaj poprawnฤ liczbฤ punktรณw (wiฤkszฤ od 0).');
ย ย ย ย }

ย ย ย ย try {
ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/groups/${gid}/award-general-bonus`, {
ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย });

ย ย ย ย ย alert('โ Bonus zostaล przyznany!');
ย ย ย ย ย await openGroupDetails(gid);

ย ย ย ย } catch (err) {
ย ย ย ย ย alert('Nie udaลo siฤ przyznaฤ bonusu: ' + err.message);
ย ย ย ย }
ย ย ย });

ย ย ย // === POPRAWKA 2: Usuniฤto zduplikowany listener dla #saveScheduleBtn ===
ย ย ย // (Prawidลowy listener znajduje siฤ wewnฤtrz funkcji openGroupDetails)


ย ย ย // --- Akcje w modalu oceniania (scoring) ---
ย ย ย $(document).on('input', '.score-input', function() {
ย ย ย ย const $row = $(this).closest('tr');
ย ย ย ย let sum = 0;
ย ย ย ย $row.find('.score-input').each(function() {
ย ย ย ย ย sum += parseInt($(this).val() || '0', 10);
ย ย ย ย });
ย ย ย ย $row.find('.sum-cell').text(sum);
ย ย ย });

ย ย ย $('#saveScoresBtn').on('click', async function() {
ย ย ย ย const sid = parseInt($('#scoringSessionId').val(), 10);
ย ย ย ย const gid = parseInt($('#scoringGroupId').val(), 10);
ย ย ย ยย
ย ย ย ย const payload = { scores: [], attendance: [] };

ย ย ย ย $('#scoringBody tbody tr').each(function() {
ย ย ย ย ย const client_id = parseInt($(this).data('cid'), 10);
ย ย ย ย ยย
ย ย ย ย ย // Zbieranie danych o obecnoลci (zawsze)
ย ย ย ย ย const is_present = $(this).find('.attendance-check').is(':checked');
ย ย ย ย ย payload.attendance.push({ client_id, is_present });

ย ย ย ย ย // Zbieranie punktรณw (tylko jeลli istniejฤ inputy ocen)
ย ย ย ย ย const items = [];
ย ย ย ย ย const $scoreInputs = $(this).find('.score-input');

ย ย ย ย ย if ($scoreInputs.length > 0) {
ย ย ย ย ย ย $scoreInputs.each(function() {
ย ย ย ย ย ย ย items.push({
ย ย ย ย ย ย ย ย behavior_id: parseInt($(this).data('bid'), 10),
ย ย ย ย ย ย ย ย points: parseInt($(this).val(), 10) || 0
ย ย ย ย ย ย ย });
ย ย ย ย ย ย });
ย ย ย ย ย ย payload.scores.push({ client_id, items });
ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย try {
ย ย ย ย ย // Logika zapisu jest taka sama, backend obsลuลผy pustฤ tablicฤ 'scores'
ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/sessions/${sid}/scores`, {
ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย });
ย ย ย ย ย scoringModal.hide();
ย ย ย ย ย alert('โ Punktacja i obecnoลฤ zostaลy zapisane.');
ย ย ย ย ย await openGroupDetails(gid);
ย ย ย ย } catch (e) {
ย ย ย ย ย alert('Nie udaลo siฤ zapisaฤ punktacji: ' + e.message);
ย ย ย ย }
ย ย ย });

ย ย ย // --- Akcje w modalu bonusรณw ---
ย ย ย $('#saveBonusesBtn').on('click', async function() {
ย ย ย ย const sessionId = $(this).data('session-id');
ย ย ย ย const bonuses = [];
ย ย ย ย $('.bonus-points-input').each(function() {
ย ย ย ย ย bonuses.push({
ย ย ย ย ย ย client_id: $(this).data('client-id'),
ย ย ย ย ย ย points: parseInt($(this).val(), 10) || 0
ย ย ย ย ย });
ย ย ย ย });

ย ย ย ย try {
ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/sessions/${sessionId}/bonuses`, {
ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย body: JSON.stringify({ bonuses })
ย ย ย ย ย });
ย ย ย ย ย bonusModal.hide();
ย ย ย ย ย alert('โ Bonusy zostaลy zapisane.');
ย ย ย ย ย // Automatyczne odลwieลผenie widoku grupy, jeลli jest otwarty
ย ย ย ย ย const activeModal = document.querySelector('#groupDetailsModal.show');
ย ย ย ย ย if(activeModal){
ย ย ย ย ย ย const groupId = $(activeModal).find('#deleteGroupFromDetailsBtn').data('group-id');
ย ย ย ย ย ย if(groupId){
ย ย ย ย ย ย ย await openGroupDetails(groupId);
ย ย ย ย ย ย }
ย ย ย ย ย }
ย ย ย ย } catch (err) {
ย ย ย ย ย alert(`Bลฤd zapisu bonusรณw: ${err.message}`);
ย ย ย ย }
ย ย ย });

ย ย ย // --- Akcje w modalu Tematรณw ---
ย ย ย $('#topicsModal').on('shown.bs.modal', loadTopicsModalList);
ย ย ย $('#addTopicForm').on('submit', async function(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย const title = ($('#newTopicTitle').val() || '').trim();
ย ย ย ย if (!title) return;
ย ย ย ย try {
ย ย ย ย ย // === GลรWNA POPRAWKA: Usuniฤto bลฤdnฤ liniฤ tekstu ===
ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/topics`, {
ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย body: JSON.stringify({ title })
ย ย ย ย ย });
ย ย ย ย ย $('#newTopicTitle').val('');
ย ย ย ย ย await loadTopicsModalList();
ย ย ย ย } catch (err) {
ย ย ย ย ย alert('Nie udaลo siฤ dodaฤ tematu: ' + err.message);
ย ย ย ย }
ย ย ย });

ย ย ย // --- Akcje w modalu Zachowaล ---
ย ย ย $('#behaviorsModal').on('shown.bs.modal', reloadBehaviorsModal);
ย ย ย $('#addBehaviorForm').on('submit', async function(e) {
ย ย ย ย e.preventDefault();
ย ย ย ย const payload = {
ย ย ย ย ย title: ($('#newBehaviorTitle').val() || '').trim(),
ย ย ย ย ย default_max_points: parseInt($('#newBehaviorMax').val() || '3', 10)
ย ย ย ย };
ย ย ย ย if (!payload.title) return;
ย ย ย ย try {
ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/behaviors`, {
ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย body: JSON.stringify(payload)
ย ย ย ย ย });
ย ย ย ย ย $('#newBehaviorTitle').val('');
ย ย ย ย ย $('#newBehaviorMax').val('3');
ย ย ย ย ย await reloadBehaviorsModal();
ย ย ย ย } catch (err) {
ย ย ย ย ย alert('Nie udaลo siฤ dodaฤ zachowania: ' + err.message);
ย ย ย ย }
ย ย ย });

ย ย ย $(document).on('click', '.del-beh', async function() {
ย ย ย ย const id = $(this).data('id');
ย ย ย ย if (!confirm('Usunฤฤ to zachowanie ze sลownika?')) return;
ย ย ย ย try {
ย ย ย ย ย await fetchJSON(`${API_BASE}/api/tus/behaviors/${id}`, { method: 'DELETE' });
ย ย ย ย ย await reloadBehaviorsModal();
ย ย ย ย } catch (err) {
ย ย ย ย ย alert('Nie udaลo siฤ usunฤฤ zachowania: ' + err.message);
ย ย ย ย }
ย ย ย });

ย ย ย // ==========================================================
ย ย ย // === FUNKCJE URUCHOMIENIOWE ===============================
ย ย ย // ==========================================================

ย ย ย /**
ย ย ย ย* Sprawdza, czy w URL znajduje siฤ parametr `openGroup` i jeลli tak,
ย ย ย ย* automatycznie otwiera modal szczegรณลรณw dla wskazanej grupy.
ย ย ย ย*/
ย ย ย function openGroupFromUrl() {
ย ย ย ย const urlParams = new URLSearchParams(window.location.search);
ย ย ย ย const groupIdToOpen = urlParams.get('openGroup');
ย ย ย ย if (groupIdToOpen) {
ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย console.log(`Prรณba automatycznego otwarcia grupy o ID: ${groupIdToOpen}`);
ย ย ย ย ย ย openGroupDetails(groupIdToOpen).catch(err => {
ย ย ย ย ย ย ย console.error(`Nie udaลo siฤ otworzyฤ grupy z URL: ${err.message}`);
ย ย ย ย ย ย ย alert(`Nie moลผna byลo otworzyฤ grupy o ID ${groupIdToOpen}. Byฤ moลผe zostaลa usuniฤta.`);
ย ย ย ย ย ย });
ย ย ย ย ย }, 500); // Opรณลบnienie, aby daฤ UI czas na zaลadowanie
ย ย ย ย }
ย ย ย }

ย ย ย // Inicjalne zaลadowanie grup i sprawdzenie URL
ย ย ย loadGroups();
ย ย ย openGroupFromUrl();

ย ย });


ย </script>
</body>

</html>
