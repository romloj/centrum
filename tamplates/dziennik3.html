<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Zestawienie Miesięcznej Obecności</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .main-container {
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    .header-section {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 2rem;
    }
    .controls-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-bottom: 2px solid #e9ecef;
    }
    .stats-card {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    .stat-box {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .stat-present { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; }
    .stat-absent { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; }
    .stat-late { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; }
    .stat-excused { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); color: #0c5460; }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .calendar-header {
      text-align: center;
      font-weight: bold;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .calendar-day {
      aspect-ratio: 1;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    .calendar-day:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .calendar-day.empty {
      border: none;
      cursor: default;
    }
    .calendar-day.empty:hover {
      transform: none;
      box-shadow: none;
    }
    .day-number {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }
    .day-status {
      font-size: 1.5rem;
    }
    .status-obecny {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      border-color: #28a745;
    }
    .status-nieobecny {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      border-color: #dc3545;
    }
    .status-spóźniony {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border-color: #ffc107;
    }
    .status-usprawiedliwiony {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      border-color: #17a2b8;
    }
    .status-no-data {
      background: #f8f9fa;
      border-color: #dee2e6;
    }
    .client-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }
    .client-photo-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
    }
    .chart-container {
      position: relative;
      height: 250px;
      margin: 1rem 0;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    /* FAB Menu */
    .fab-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 1050;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      gap: 1rem;
    }
    .fab-main {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 2;
    }
    .fab-main:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
    .fab-main i {
      transition: transform 0.3s ease;
    }
    .fab-container.open .fab-main i {
      transform: rotate(45deg);
    }
    .fab-menu {
      display: flex;
      flex-direction: column-reverse;
      gap: 0.75rem;
      opacity: 0;
      transform: translateY(20px) scale(0.8);
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .fab-container.open .fab-menu {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: all;
    }
    .fab-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }
    .fab-label {
      background: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      transform: translateX(10px);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    .fab-container.open .fab-label {
      opacity: 1;
      transform: translateX(0);
    }
    .fab-button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      text-decoration: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    .fab-button:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: scale(1.15);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .fab-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1049;
    }
    .fab-container.open ~ .fab-backdrop {
      opacity: 1;
      pointer-events: all;
    }

    /* Wyszukiwanie klienta */
    .search-container {
      position: relative;
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .search-result-item {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
    }
    .search-result-item:hover {
      background-color: #f8f9fa;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .client-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .client-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      background: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
    }

    /* Print Styles */
    @media print {
      body {
        background: white !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      .main-container {
        box-shadow: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
      }
      .header-section {
        background: #2c3e50 !important;
        padding: 1rem !important;
      }
      .controls-section,
      .fab-container,
      .fab-backdrop,
      .alert {
        display: none !important;
      }
      .stats-card {
        box-shadow: none !important;
        border: 1px solid #dee2e6 !important;
        margin-bottom: 1rem !important;
        page-break-inside: avoid;
      }
      .client-info {
        background: #667eea !important;
        margin-bottom: 1rem !important;
      }
      .chart-container {
        height: 200px !important;
      }
      .calendar-day:hover {
        transform: none !important;
        box-shadow: none !important;
      }
    }

    @media (max-width: 768px) {
      .calendar-grid {
        gap: 0.25rem;
      }
      .calendar-day {
        padding: 0.25rem;
      }
      .day-number {
        font-size: 0.9rem;
      }
      .day-status {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Nagłówek -->
    <div class="header-section text-center">
      <h1 class="display-6 mb-2">📊 Zestawienie Miesięcznej Obecności</h1>
      <p class="lead mb-0">Raport obecności dla wybranego klienta</p>
    </div>

    <!-- Kontrolki -->
    <div class="controls-section">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label"><strong>Wyszukaj klienta</strong></label>
          <div class="search-container">
            <input type="text" id="clientSearch" class="form-control" placeholder="Wpisz imię lub nazwisko klienta..." autocomplete="off">
            <div id="searchResults" class="search-results"></div>
          </div>
          <input type="hidden" id="selectedClientId">
        </div>
        <div class="col-md-3">
          <label class="form-label"><strong>Miesiąc</strong></label>
          <select id="monthSelect" class="form-select">
            <option value="0">Styczeń</option>
            <option value="1">Luty</option>
            <option value="2">Marzec</option>
            <option value="3">Kwiecień</option>
            <option value="4">Maj</option>
            <option value="5">Czerwiec</option>
            <option value="6">Lipiec</option>
            <option value="7">Sierpień</option>
            <option value="8">Wrzesień</option>
            <option value="9">Październik</option>
            <option value="10">Listopad</option>
            <option value="11">Grudzień</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><strong>Rok</strong></label>
          <select id="yearSelect" class="form-select">
          </select>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12">
          <button class="btn btn-primary" onclick="loadReport()">
            <i class="bi bi-bar-chart-fill"></i> Wygeneruj raport
          </button>
          <button class="btn btn-success" onclick="exportToPDF()">
            <i class="bi bi-download"></i> Eksportuj PDF
          </button>
          <button class="btn btn-outline-secondary" onclick="clearSearch()">
            <i class="bi bi-x-circle"></i> Wyczyść
          </button>
          <button class="btn btn-info" onclick="printReport()">
            <i class="bi bi-printer"></i> Drukuj
          </button>
        </div>
      </div>
    </div>

    <!-- Alert -->
    <div id="alertBox" class="m-3"></div>

    <!-- Wyniki -->
    <div id="reportContent" class="p-3" style="display: none;">

      <!-- Informacje o kliencie -->
      <div class="client-info">
        <div class="row align-items-center">
          <div class="col-auto">
            <img id="clientPhoto" src="" alt="Klient" class="client-photo-large">
          </div>
          <div class="col">
            <h3 id="clientName" class="mb-1"></h3>
            <p class="mb-0" id="clientDetails"></p>
          </div>
          <div class="col-auto">
            <small>Wygenerowano: <span id="reportDate"></span></small>
          </div>
        </div>
      </div>

      <!-- Statystyki -->
      <div class="stats-card">
        <h5 class="mb-3"><i class="bi bi-graph-up"></i> Podsumowanie obecności</h5>
        <div class="row">
          <div class="col-md-3">
            <div class="stat-box stat-present">
              <div class="display-6" id="statPresent">0</div>
              <small><strong>Obecny</strong></small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box stat-absent">
              <div class="display-6" id="statAbsent">0</div>
              <small><strong>Nieobecny</strong></small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box stat-late">
              <div class="display-6" id="statLate">0</div>
              <small><strong>Spóźniony</strong></small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box stat-excused">
              <div class="display-6" id="statExcused">0</div>
              <small><strong>Usprawiedliwiony</strong></small>
            </div>
          </div>
        </div>
        <div class="mt-3 text-center">
          <h4>Frekwencja: <span id="attendanceRate" class="text-primary">0%</span></h4>
          <small class="text-muted">Procent obecności względem zaplanowanych zajęć</small>
        </div>
      </div>

      <!-- Kalendarz -->
      <div class="stats-card">
        <h5 class="mb-3"><i class="bi bi-calendar3"></i> Kalendarz obecności</h5>
        <h6 class="text-center text-muted mb-3" id="calendarTitle"></h6>

        <div class="calendar-grid">
          <div class="calendar-header">Pn</div>
          <div class="calendar-header">Wt</div>
          <div class="calendar-header">Śr</div>
          <div class="calendar-header">Cz</div>
          <div class="calendar-header">Pt</div>
          <div class="calendar-header">So</div>
          <div class="calendar-header">Nd</div>
        </div>

        <div class="calendar-grid" id="calendarDays"></div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);"></div>
            <span>Obecny</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);"></div>
            <span>Nieobecny</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);"></div>
            <span>Spóźniony</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);"></div>
            <span>Usprawiedliwiony</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            <span>Brak danych</span>
          </div>
        </div>
      </div>

      <!-- Wykres -->
      <div class="stats-card">
        <h5 class="mb-3"><i class="bi bi-pie-chart-fill"></i> Wykres obecności</h5>
        <div class="chart-container">
          <canvas id="attendanceChart"></canvas>
        </div>
      </div>

      <!-- Tabela szczegółów -->
      <div class="stats-card d-none" id="detailedTableSection">
        <h5 class="mb-3"><i class="bi bi-table"></i> Szczegółowy wykaz obecności</h5>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="detailedTable">
            <thead class="table-dark">
              <tr>
                <th>Data</th>
                <th>Status</th>
                <th>Notatki</th>
                <th>Godzina</th>
              </tr>
            </thead>
            <tbody id="detailedTableBody">
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- FAB Menu -->
  <div class="fab-container" id="fabContainer">
    <div class="fab-menu">
      <div class="fab-item">
        <span class="fab-label">Strona główna</span>
        <a href="index.html" class="fab-button" title="Strona główna">
          <i class="bi bi-house-fill"></i>
        </a>
      </div>
      <div class="fab-item">
        <span class="fab-label">Lista obecności</span>
        <a href="attendance.html" class="fab-button" title="Lista obecności">
          <i class="bi bi-clipboard-check"></i>
        </a>
      </div>
      <div class="fab-item">
        <span class="fab-label">Klienci</span>
        <a href="klienci.html" class="fab-button" title="Lista klientów">
          <i class="bi bi-people-fill"></i>
        </a>
      </div>
      <div class="fab-item">
        <span class="fab-label">Plan SUO</span>
        <a href="panel.html" class="fab-button" title="Plan SUO">
          <i class="bi bi-calendar3"></i>
        </a>
      </div>
    </div>
    <button class="fab-main" id="fabMainBtn" aria-label="Menu nawigacji">
      <i class="bi bi-plus-lg"></i>
    </button>
  </div>

  <div class="fab-backdrop" id="fabBackdrop"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    const API_URL = ""; // ✅ POPRAWNIE
    let allClients = [];
    let attendanceData = {};
    let currentChart = null;
    let currentClient = null;
    let currentMonth = null;
    let currentYear = null;

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      initializeSelects();
      loadClients();
      setupSearch();
    });

    function setupEventListeners() {
      const fabContainer = document.getElementById('fabContainer');
      const fabMainBtn = document.getElementById('fabMainBtn');
      const fabBackdrop = document.getElementById('fabBackdrop');

      if (fabMainBtn) {
        fabMainBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          fabContainer.classList.toggle('open');
        });
      }

      if (fabBackdrop) {
        fabBackdrop.addEventListener('click', () => {
          fabContainer.classList.remove('open');
        });
      }

      document.querySelectorAll('.fab-button').forEach(btn => {
        btn.addEventListener('click', () => {
          fabContainer.classList.remove('open');
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && fabContainer.classList.contains('open')) {
          fabContainer.classList.remove('open');
        }
      });
    }

    function initializeSelects() {
      const today = new Date();
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');

      for (let year = today.getFullYear(); year >= today.getFullYear() - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }

      monthSelect.value = today.getMonth();
      yearSelect.value = today.getFullYear();
    }

    function setupSearch() {
      const searchInput = document.getElementById('clientSearch');
      const searchResults = document.getElementById('searchResults');

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        
        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }

        const filteredClients = allClients.filter(client => 
          (client.full_name && client.full_name.toLowerCase().includes(query)) ||
          (client.email && client.email.toLowerCase().includes(query)) ||
          (client.phone && client.phone.includes(query))
        );

        displaySearchResults(filteredClients);
      });

      // Ukryj wyniki wyszukiwania po kliknięciu gdziekolwiek indziej
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
    }

    function displaySearchResults(clients) {
      const searchResults = document.getElementById('searchResults');
      searchResults.innerHTML = '';

      if (clients.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item text-muted">Brak wyników</div>';
        searchResults.style.display = 'block';
        return;
      }

      clients.slice(0, 10).forEach(client => {
        const resultItem = document.createElement('div');
        resultItem.className = 'search-result-item';
        
        const initials = (client.full_name || 'K').charAt(0).toUpperCase();
        
        resultItem.innerHTML = `
          <div class="client-option">
            <div class="client-avatar">
              ${initials}
            </div>
            <div>
              <strong>${client.full_name || 'Brak nazwy'}</strong>
              <div class="text-muted small">
                ${client.phone || 'Brak telefonu'} | ${client.email || 'Brak email'}
              </div>
            </div>
          </div>
        `;

        resultItem.addEventListener('click', () => {
          selectClient(client);
        });

        searchResults.appendChild(resultItem);
      });

      searchResults.style.display = 'block';
    }

    function selectClient(client) {
      const searchInput = document.getElementById('clientSearch');
      const selectedClientId = document.getElementById('selectedClientId');
      const searchResults = document.getElementById('searchResults');

      searchInput.value = client.full_name || 'Brak nazwy';
      selectedClientId.value = client.client_id || client.id;
      searchResults.style.display = 'none';

      // Automatycznie wygeneruj raport dla wybranego klienta
      setTimeout(() => {
        loadReport();
      }, 500);
    }

    function clearSearch() {
      const searchInput = document.getElementById('clientSearch');
      const selectedClientId = document.getElementById('selectedClientId');
      const searchResults = document.getElementById('searchResults');
      const reportContent = document.getElementById('reportContent');

      searchInput.value = '';
      selectedClientId.value = '';
      searchResults.style.display = 'none';
      reportContent.style.display = 'none';

      showAlert('Wyszukiwanie wyczyszczone', 'info');
    }

    async function loadClients() {
      try {
        const response = await fetch(`${API_URL}/api/clients`);
        if (!response.ok) throw new Error('Błąd pobierania klientów');

        allClients = await response.json();

        showAlert(`Załadowano ${allClients.length} klientów`, 'success');

      } catch (error) {
        console.error('Błąd ładowania klientów:', error);
        showAlert('Nie udało się załadować listy klientów', 'danger');
      }
    }

    async function loadReport() {
      const clientId = document.getElementById('selectedClientId').value;
      const month = parseInt(document.getElementById('monthSelect').value);
      const year = parseInt(document.getElementById('yearSelect').value);

      if (!clientId) {
        showAlert('Wybierz klienta z listy wyszukiwania', 'warning');
        return;
      }

      const client = allClients.find(c => (c.client_id || c.id) == clientId);
      if (!client) {
        showAlert('Nie znaleziono klienta', 'danger');
        return;
      }

      currentClient = client;
      currentMonth = month;
      currentYear = year;

      showAlert('Generowanie raportu...', 'info');

      try {
        const startDate = new Date(year, month, 1);
        const endDate = new Date(year, month + 1, 0);

        attendanceData = {};

        console.log("🔍 Pobieram obecność dla:", {
            client: client.full_name,
            clientId: clientId,
            month: month + 1,
            year: year,
            startDate: startDate.toISOString().split('T')[0],
            endDate: endDate.toISOString().split('T')[0]
        });

        let foundCount = 0;

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          d.setHours(12, 0, 0, 0);
          const dateStr = d.toISOString().split('T')[0];

          try {
            const url = `${API_URL}/api/attendance?date=${dateStr}&client_id=${clientId}`;
            console.log(`   📡 Zapytanie: ${url}`);

            const response = await fetch(url);

            if (response.ok) {
              const data = await response.json();
              console.log(`   📥 Odpowiedź dla ${dateStr}:`, data);

              const clientRecord = data.find(a => a.client_id == clientId);
              if (clientRecord) {
                attendanceData[dateStr] = clientRecord;
                foundCount++;
                console.log(`   ✅ Znaleziono obecność: ${clientRecord.status}`);
              }
            } else {
              console.log(`   ⚠️ HTTP ${response.status} dla ${dateStr}`);
            }
          } catch (e) {
            console.log(`   ❌ Błąd dla ${dateStr}:`, e.message);
          }
        }

        console.log(`🎯 PODSUMOWANIE: Znaleziono ${foundCount} dni z obecnością`);
        console.log("📋 attendanceData:", attendanceData);

        displayReport(client, month, year);
        showAlert(`Raport wygenerowany dla ${client.full_name} (${foundCount} wpisów)`, 'success');

      } catch (error) {
        console.error('❌ Błąd generowania raportu:', error);
        showAlert('Błąd podczas generowania raportu', 'danger');
      }
    }

    function displayReport(client, month, year) {
      const reportContent = document.getElementById('reportContent');
      reportContent.style.display = 'block';

      // Ustaw datę wygenerowania raportu
      const now = new Date();
      document.getElementById('reportDate').textContent = now.toLocaleDateString('pl-PL', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const initials = (client.full_name || 'K').charAt(0).toUpperCase();
      const avatarSVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Ccircle cx='40' cy='40' r='40' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.35em' fill='white' font-size='36' font-family='Arial'%3E${initials}%3C/text%3E%3C/svg%3E`;

      document.getElementById('clientPhoto').src = client.photo_url || avatarSVG;
      document.getElementById('clientName').textContent = client.full_name;
      document.getElementById('clientDetails').textContent = `Tel: ${client.phone || 'Brak'} | Email: ${client.email || 'Brak'}`;

      const stats = calculateStats();
      document.getElementById('statPresent').textContent = stats.obecny;
      document.getElementById('statAbsent').textContent = stats.nieobecny;
      document.getElementById('statLate').textContent = stats.spóźniony;
      document.getElementById('statExcused').textContent = stats.usprawiedliwiony;

      const totalScheduled = stats.obecny + stats.nieobecny + stats.spóźniony + stats.usprawiedliwiony;
      const rate = totalScheduled > 0 ? Math.round((stats.obecny / totalScheduled) * 100) : 0;
      document.getElementById('attendanceRate').textContent = rate + '%';

      const monthNames = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
                          'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];
      document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

      displayCalendar(month, year);
      displayChart(stats);
      displayDetailedTable();
    }

    function calculateStats() {
      const stats = {
        obecny: 0,
        nieobecny: 0,
        spóźniony: 0,
        usprawiedliwiony: 0
      };

      Object.values(attendanceData).forEach(record => {
        if (record.status && stats.hasOwnProperty(record.status)) {
          stats[record.status]++;
        }
      });

      return stats;
    }

    function displayCalendar(month, year) {
      const calendarDays = document.getElementById('calendarDays');
      calendarDays.innerHTML = '';

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      let dayOfWeek = firstDay.getDay();
      dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

      for (let i = 0; i < dayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendarDays.appendChild(emptyDay);
      }

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day, 12, 0, 0);
        const dateStr = date.toISOString().split('T')[0];
        const record = attendanceData[dateStr];

        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';

        if (record && record.status) {
          dayDiv.classList.add(`status-${record.status}`);
          const statusEmoji = {
            'obecny': '✅',
            'nieobecny': '❌',
            'spóźniony': '⏰',
            'usprawiedliwiony': '📝'
          };
          dayDiv.innerHTML = `
            <div class="day-number">${day}</div>
            <div class="day-status">${statusEmoji[record.status] || ''}</div>
          `;
          dayDiv.title = `${day} - ${record.status}${record.notes ? '\n' + record.notes : ''}`;
        } else {
          dayDiv.classList.add('status-no-data');
          dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
          dayDiv.title = `${day} - Brak danych`;
        }

        calendarDays.appendChild(dayDiv);
      }
    }

    function displayChart(stats) {
      const ctx = document.getElementById('attendanceChart');

      if (currentChart) {
        currentChart.destroy();
      }

      currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Obecny', 'Nieobecny', 'Spóźniony', 'Usprawiedliwiony'],
          datasets: [{
            data: [stats.obecny, stats.nieobecny, stats.spóźniony, stats.usprawiedliwiony],
            backgroundColor: [
              'rgba(40, 167, 69, 0.8)',
              'rgba(220, 53, 69, 0.8)',
              'rgba(255, 193, 7, 0.8)',
              'rgba(23, 162, 184, 0.8)'
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(23, 162, 184, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    function displayDetailedTable() {
      const tableBody = document.getElementById('detailedTableBody');
      const tableSection = document.getElementById('detailedTableSection');
      
      tableBody.innerHTML = '';

      if (Object.keys(attendanceData).length === 0) {
        tableSection.classList.add('d-none');
        return;
      }

      tableSection.classList.remove('d-none');

      // Sortuj daty
      const sortedDates = Object.keys(attendanceData).sort();

      sortedDates.forEach(dateStr => {
        const record = attendanceData[dateStr];
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('pl-PL', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        const statusLabels = {
          'obecny': 'Obecny',
          'nieobecny': 'Nieobecny',
          'spóźniony': 'Spóźniony',
          'usprawiedliwiony': 'Usprawiedliwiony'
        };

        const statusColors = {
          'obecny': 'text-success',
          'nieobecny': 'text-danger',
          'spóźniony': 'text-warning',
          'usprawiedliwiony': 'text-info'
        };

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${formattedDate}</strong></td>
          <td><span class="${statusColors[record.status]}">${statusLabels[record.status] || record.status}</span></td>
          <td>${record.notes || '-'}</td>
          <td>${record.time || '-'}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function exportToPDF() {
      const reportContent = document.getElementById('reportContent');
      
      if (reportContent.style.display === 'none') {
        showAlert('Najpierw wygeneruj raport', 'warning');
        return;
      }

      showAlert('Generowanie PDF...', 'info');

      // Tymczasowo pokaż tabelę szczegółów dla PDF
      const tableSection = document.getElementById('detailedTableSection');
      tableSection.classList.remove('d-none');

      const options = {
        margin: [10, 10, 10, 10],
        filename: `raport_obecnosci_${currentClient.full_name}_${currentMonth + 1}_${currentYear}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          logging: false
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait' 
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      // Pobierz element do eksportu (bez kontrolek)
      const element = document.querySelector('.main-container');

      html2pdf()
        .set(options)
        .from(element)
        .save()
        .then(() => {
          showAlert('PDF został wygenerowany pomyślnie', 'success');
          // Ukryj tabelę szczegółów po wygenerowaniu PDF
          if (Object.keys(attendanceData).length === 0) {
            tableSection.classList.add('d-none');
          }
        })
        .catch(error => {
          console.error('Błąd generowania PDF:', error);
          showAlert('Błąd podczas generowania PDF', 'danger');
        });
    }

    function printReport() {
      const reportContent = document.getElementById('reportContent');
      
      if (reportContent.style.display === 'none') {
        showAlert('Najpierw wygeneruj raport', 'warning');
        return;
      }

      // Tymczasowo pokaż tabelę szczegółów dla druku
      const tableSection = document.getElementById('detailedTableSection');
      tableSection.classList.remove('d-none');

      window.print();

      // Ukryj tabelę szczegółów po drukowaniu
      if (Object.keys(attendanceData).length === 0) {
        tableSection.classList.add('d-none');
      }
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      if (type !== 'danger') {
        setTimeout(() => {
          const alert = alertBox.querySelector('.alert');
          if (alert) alert.remove();
        }, 5000);
      }
    }

    // Eksportuj funkcję dla kompatybilności wstecznej
    function exportReport() {
      exportToPDF();
    }
  </script>
</body>
</html>
