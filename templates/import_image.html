<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Import Planu z Obrazu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="menu_fab.css">
  <style>
    body { padding: 1rem; background-color: #f8f9fa; }
    .preview-container { max-height: 400px; overflow: auto; border: 1px solid var(--bs-border-color); border-radius: .5rem; }
    .preview-container img { max-width: 100%; }

    /* Edytowalne pola */
    .results-table input {
        width: 100%;
        border: 1px solid transparent;
        background-color: transparent;
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.2s;
    }

    .results-table input:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .results-table input:focus {
        border: 1px solid var(--bs-primary);
        background-color: #fff;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .results-table input[readonly] {
        background-color: var(--bs-light);
        cursor: not-allowed;
        color: #6c757d;
    }

    .results-table input[readonly]:hover {
        background-color: var(--bs-light);
    }

    .results-table select {
        width: 100%;
        border: 1px solid transparent;
        background-color: transparent;
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.2s;
    }

    .results-table select:focus {
        border: 1px solid var(--bs-primary);
        background-color: #fff;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .table-actions {
        white-space: nowrap;
        text-align: center;
    }

    .delete-row-btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
    }

    .delete-row-btn:hover {
        transform: scale(1.05);
    }

    .matched-name {
        border-left: 3px solid #198754;
        padding-left: 0.5rem;
        background-color: rgba(25, 135, 84, 0.05);
    }

    .unmatched-name {
        border-left: 3px solid #fd7e14;
        padding-left: 0.5rem;
        background-color: rgba(253, 126, 20, 0.05);
    }

    .edited-field {
        background-color: rgba(13, 110, 253, 0.1) !important;
        border-left: 3px solid #0d6efd !important;
    }

    /* NOWE: Style dla duplikat√≥w */
    .duplicate-row {
        background-color: rgba(220, 53, 69, 0.1) !important;
        border-left: 4px solid #dc3545 !important;
    }

    .duplicate-badge {
        animation: pulse-danger 2s infinite;
    }

    @keyframes pulse-danger {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    /* Animacja usuwania */
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; transform: translateX(-20px); }
    }

    .row-deleting {
        animation: fadeOut 0.3s ease-out forwards;
    }

    /* Tooltip dla oryginalnej nazwy */
    .original-name-tooltip {
        position: relative;
        cursor: help;
    }

    .original-name-tooltip::after {
        content: attr(data-original);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 1000;
        margin-bottom: 5px;
    }

    .original-name-tooltip:hover::after {
        opacity: 1;
    }

    /* Tooltip dla duplikat√≥w */
    .duplicate-tooltip {
        position: relative;
        cursor: help;
    }

    .duplicate-tooltip::after {
        content: attr(data-duplicates);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        white-space: pre-line;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 1000;
        margin-bottom: 5px;
        max-width: 300px;
    }

    .duplicate-tooltip:hover::after {
        opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="d-flex flex-wrap align-items-center gap-2 mb-4">
      <h1 class="h4 m-0">ü§ñ Import Planu z Rƒôcznych Notatek</h1>
      <a href="index.html" class="btn btn-outline-secondary ms-auto">
        <i class="bi bi-house-door-fill"></i> Powr√≥t do menu
      </a>
    </header>

    <div id="alertBox" class="mb-3"></div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Krok 1: Okre≈õl zakres planu</h5>
            <div class="mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="importScope" id="scopeDay" value="day" checked>
                    <label class="form-check-label" for="scopeDay">Jeden dzie≈Ñ</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="importScope" id="scopeMonth" value="month">
                    <label class="form-check-label" for="scopeMonth">Ca≈Çy miesiƒÖc</label>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-6" id="date-wrapper">
                    <label for="importDate" class="form-label">Data planu</label>
                    <input type="date" id="importDate" class="form-control">
                </div>
                <div class="col-md-6 d-none" id="month-wrapper">
                    <label for="importMonth" class="form-label">MiesiƒÖc planu</label>
                    <input type="month" id="importMonth" class="form-control">
                </div>
                <div class="col-md-6">
                    <label for="importTherapist" class="form-label">Terapeuta</label>
                    <select id="importTherapist" class="form-select">
                        <option value="">≈Åadowanie terapeut√≥w...</option>
                    </select>
                </div>
            </div>

            <hr class="my-4">

            <h5 class="card-title">Krok 2: Wgraj zdjƒôcie lub skan</h5>
            <div class="mb-3">
                <input class="form-control" type="file" id="imageUpload" accept="image/*" disabled>
                <div class="form-text">Wybierz zakres i terapeutƒô, aby odblokowaƒá mo≈ºliwo≈õƒá wgrania pliku.</div>
            </div>

            <div id="previewCard" class="card d-none">
                <div class="card-header">PodglƒÖd obrazu</div>
                <div class="card-body">
                    <div class="preview-container"><img id="imagePreview" src="#" alt="PodglƒÖd" /></div>
                    <div class="d-grid mt-3">
                        <button id="analyzeBtn" class="btn btn-primary btn-lg">
                            <span id="analyzeSpinner" class="spinner-border spinner-border-sm d-none"></span>
                            <i class="bi bi-magic"></i> Analizuj obraz
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resultsCard" class="card mt-4 d-none">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">Krok 3: Zweryfikuj i popraw dane</h5>
                    <small>Kliknij w kom√≥rkƒô, aby edytowaƒá. U≈ºyj przycisku <i class="bi bi-trash"></i> aby usunƒÖƒá wpis.</small>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <span class="badge bg-success me-2" id="matchedCount">
                        <i class="bi bi-check-circle"></i> 0 dopasowanych
                    </span>
                    <span class="badge bg-warning text-dark me-2" id="unmatchedCount">
                        <i class="bi bi-exclamation-triangle"></i> 0 niedopasowanych
                    </span>
                    <span class="badge bg-danger me-2" id="duplicateCount">
                        <i class="bi bi-exclamation-diamond"></i> 0 duplikat√≥w
                    </span>
                    <span class="badge bg-secondary" id="totalCount">
                        <i class="bi bi-list-ul"></i> 0 wpis√≥w
                    </span>
                </div>
                <div>
                    <button class="btn btn-outline-warning btn-sm me-2" id="removeDuplicatesBtn">
                        <i class="bi bi-filter"></i> Usu≈Ñ duplikaty
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="clearAllBtn">
                        <i class="bi bi-trash"></i> Wyczy≈õƒá wszystko
                    </button>
                </div>
            </div>

            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i>
                <strong>Wskaz√≥wki:</strong>
                <ul class="mb-0 mt-2">
                    <li>Pola z <span class="badge bg-success">zielonƒÖ ramkƒÖ</span> = poprawnie dopasowane nazwy</li>
                    <li>Pola z <span class="badge bg-warning text-dark">pomara≈ÑczowƒÖ ramkƒÖ</span> = wymaga korekty</li>
                    <li><span class="badge bg-danger">Czerwone t≈Ço</span> = wykryto duplikat (ta sama data, terapeuta, godzina i klient)</li>
                    <li>Szare pola sƒÖ zablokowane (data, terapeuta)</li>
                    <li>Najechanie na nazwƒô klienta poka≈ºe oryginalnƒÖ nazwƒô z notatki</li>
                </ul>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover results-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px;" class="text-center">Akcje</th>
                            <th style="width: 120px;">Data</th>
                            <th>Terapeuta</th>
                            <th style="width: 100px;">Start</th>
                            <th style="width: 100px;">Koniec</th>
                            <th>Klient / Grupa</th>
                            <th style="width: 150px;">Typ</th>
                            <th style="width: 120px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>

            <div class="d-grid gap-2 mt-3">
                <button id="saveBtn" class="btn btn-success btn-lg">
                    <span id="saveSpinner" class="spinner-border spinner-border-sm d-none"></span>
                    <i class="bi bi-calendar-check"></i> Zapisz w kalendarzu
                </button>
            </div>
        </div>
    </div>
  </div>

  <!-- Floating Action Menu -->
  <div class="fab-container" id="fabContainer">
    <ul class="fab-menu">
        <li class="fab-item">
            <span class="fab-label">Plan terapeuty</span>
            <a href="therapist1.html" class="fab-button" title="Plan terapeuty">
                <i class="bi bi-heart-pulse"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Modu≈Ç TUS</span>
            <a href="tus.html" class="fab-button" title="Modu≈Ç TUS">
                <i class="bi bi-star-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Lista klient√≥w</span>
            <a href="klienci.html" class="fab-button" title="Lista klient√≥w">
                <i class="bi bi-people-fill"></i>
            </a>
        </li>
        <li class="fab-item">
            <span class="fab-label">Strona g≈Ç√≥wna</span>
            <a href="index.html" class="fab-button" title="Strona g≈Ç√≥wna">
                <i class="bi bi-house-fill"></i>
            </a>
        </li>
    </ul>
    <button class="fab-main" id="fabMainBtn" aria-label="Rozwi≈Ñ menu">
        <i class="bi bi-plus-lg"></i>
    </button>
  </div>
  <div class="fab-backdrop" id="fabBackdrop"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="fab-menu.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL ="";
    const importDate = document.getElementById('importDate');
    const importMonth = document.getElementById('importMonth');
    const importTherapist = document.getElementById('importTherapist');
    const imageUpload = document.getElementById('imageUpload');
    const previewCard = document.getElementById('previewCard');
    const imagePreview = document.getElementById('imagePreview');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultsCard = document.getElementById('resultsCard');
    const resultsBody = document.getElementById('resultsBody');
    const saveBtn = document.getElementById('saveBtn');
    const scopeDayRadio = document.getElementById('scopeDay');
    const scopeMonthRadio = document.getElementById('scopeMonth');
    const dateWrapper = document.getElementById('date-wrapper');
    const monthWrapper = document.getElementById('month-wrapper');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const removeDuplicatesBtn = document.getElementById('removeDuplicatesBtn');
    const matchedCount = document.getElementById('matchedCount');
    const unmatchedCount = document.getElementById('unmatchedCount');
    const duplicateCount = document.getElementById('duplicateCount');
    const totalCount = document.getElementById('totalCount');

    let currentScheduleData = [];
    let originalScheduleData = [];

    const showAlert = (msg, type = "danger") => {
        const alertBox = document.getElementById("alertBox");
        alertBox.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'}"></i>
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        setTimeout(() => {
            const alert = alertBox.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    };

    async function initializeSelectors() {
        try {
            const response = await fetch(`${API_URL}/api/therapists`);
            const therapists = await response.json();
            importTherapist.innerHTML = '<option value="">-- Wybierz terapeutƒô --</option>';
            therapists.filter(t => t.active).forEach(therapist => {
                importTherapist.add(new Option(therapist.full_name, therapist.full_name));
            });
        } catch (error) {
            showAlert('B≈ÇƒÖd ≈Çadowania listy terapeut√≥w.', 'danger');
        }

        const today = new Date();
        importDate.value = today.toISOString().split('T')[0];
        importMonth.value = today.toISOString().slice(0, 7);
        checkIfReadyToUpload();
    }

    function checkIfReadyToUpload() {
        const scope = document.querySelector('input[name="importScope"]:checked').value;
        const dateOk = (scope === 'day' && importDate.value) || (scope === 'month' && importMonth.value);
        imageUpload.disabled = !(dateOk && importTherapist.value);
    }

    function handleScopeChange() {
        const scope = document.querySelector('input[name="importScope"]:checked').value;
        dateWrapper.classList.toggle('d-none', scope !== 'day');
        monthWrapper.classList.toggle('d-none', scope !== 'month');
        checkIfReadyToUpload();
    }

    imageUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            if (file.size > 10 * 1024 * 1024) {
                showAlert('Plik jest za du≈ºy (maksymalnie 10MB)', 'warning');
                imageUpload.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                previewCard.classList.remove('d-none');
                resultsCard.classList.add('d-none');
            };
            reader.readAsDataURL(file);
        }
    });

    analyzeBtn.addEventListener('click', async () => {
        const file = imageUpload.files[0];
        if (!file) return showAlert('Proszƒô wybraƒá plik z obrazem.');

        const spinner = document.getElementById('analyzeSpinner');
        spinner.classList.remove('d-none');
        analyzeBtn.disabled = true;

        const formData = new FormData();
        const scope = document.querySelector('input[name="importScope"]:checked').value;
        formData.append('schedule_image', file);
        formData.append('scope', scope);
        formData.append('therapist_name', importTherapist.value);

        if (scope === 'day') {
            formData.append('date', importDate.value);
        } else {
            formData.append('month', importMonth.value);
        }

        try {
            const response = await fetch(`${API_URL}/api/parse-schedule-image`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || `B≈ÇƒÖd serwera: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                currentScheduleData = result.data || [];
                originalScheduleData = JSON.parse(JSON.stringify(currentScheduleData));
                detectDuplicates(); // NOWE: wykryj duplikaty
                renderResults(currentScheduleData);
                resultsCard.classList.remove('d-none');
                updateCounters();

                const duplicates = currentScheduleData.filter(item => item.is_duplicate).length;
                const warningMsg = duplicates > 0 ? ` ‚ö†Ô∏è Wykryto ${duplicates} duplikat√≥w!` : '';

                showAlert(
                    `‚úÖ Pomy≈õlnie przetworzono ${result.total_count} wpis√≥w. Dopasowano ${result.matched_count} nazw.${warningMsg}`,
                    duplicates > 0 ? 'warning' : 'success'
                );
            } else {
                throw new Error(result.error || 'Nieznany b≈ÇƒÖd przetwarzania');
            }
        } catch (error) {
            console.error('B≈ÇƒÖd analizy:', error);
            showAlert(`Analiza nie powiod≈Ça siƒô: ${error.message}`);
        } finally {
            spinner.classList.add('d-none');
            analyzeBtn.disabled = false;
        }
    });

    // NOWA FUNKCJA: Wykrywanie duplikat√≥w
    function detectDuplicates() {
        const seen = new Map();

        currentScheduleData.forEach((item, index) => {
            // Klucz unikalno≈õci: data + terapeuta + start_time + klient
            const key = `${item.date}|${item.therapist_name}|${item.start_time}|${item.client_name}`.toLowerCase();

            if (seen.has(key)) {
                // Duplikat znaleziony
                item.is_duplicate = true;
                item.duplicate_indices = [seen.get(key), index];

                // Oznacz te≈º pierwszy wpis jako duplikat
                const firstIndex = seen.get(key);
                currentScheduleData[firstIndex].is_duplicate = true;
                currentScheduleData[firstIndex].duplicate_indices = [firstIndex, index];
            } else {
                seen.set(key, index);
                item.is_duplicate = false;
            }
        });
    }

    function renderResults(scheduleItems) {
        const scope = document.querySelector('input[name="importScope"]:checked').value;
        const isDateReadOnly = (scope === 'day');

        if (!scheduleItems || scheduleItems.length === 0) {
            resultsBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">Nie uda≈Ço siƒô odczytaƒá ≈ºadnych wpis√≥w.</p>
                    </td>
                </tr>
            `;
            return;
        }

        resultsBody.innerHTML = scheduleItems.map((item, index) => {
            const matchStatus = item.is_duplicate ?
                '<span class="badge bg-danger duplicate-badge"><i class="bi bi-exclamation-diamond"></i> Duplikat</span>' :
                item.matched ?
                '<span class="badge bg-success"><i class="bi bi-check-circle"></i> OK</span>' :
                '<span class="badge bg-warning text-dark"><i class="bi bi-pencil"></i> Popraw</span>';

            const nameClass = item.matched ? 'matched-name' : 'unmatched-name';

            const originalNameAttr = item.original_name && item.original_name !== item.client_name ?
                `data-original="Oryginalna nazwa: ${item.original_name}"` : '';

            const duplicateInfo = item.is_duplicate && item.duplicate_indices ?
                `data-duplicates="DUPLIKAT!\nWpisy: ${item.duplicate_indices.map(i => i + 1).join(', ')}\nData: ${item.date}\nGodzina: ${item.start_time}\nKlient: ${item.client_name}"` : '';

            const rowClass = item.is_duplicate ? 'duplicate-row' : '';

            return `
                <tr data-index="${index}" class="${rowClass}">
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-danger delete-row-btn"
                                title="Usu≈Ñ wpis"
                                data-index="${index}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td>
                        <input type="text"
                               value="${item.date || ''}"
                               data-field="date"
                               data-index="${index}"
                               ${isDateReadOnly ? 'readonly' : ''}>
                    </td>
                    <td>
                        <input type="text"
                               value="${item.therapist_name || ''}"
                               data-field="therapist_name"
                               data-index="${index}"
                               readonly>
                    </td>
                    <td>
                        <input type="text"
                               value="${item.start_time || ''}"
                               data-field="start_time"
                               data-index="${index}"
                               placeholder="HH:MM">
                    </td>
                    <td>
                        <input type="text"
                               value="${item.end_time || ''}"
                               data-field="end_time"
                               data-index="${index}"
                               placeholder="HH:MM">
                    </td>
                    <td>
                        <input type="text"
                               value="${item.client_name || ''}"
                               data-field="client_name"
                               data-index="${index}"
                               class="${nameClass} ${originalNameAttr ? 'original-name-tooltip' : ''}"
                               ${originalNameAttr}
                               placeholder="Nazwa klienta/grupy">
                    </td>
                    <td>
                        <select data-field="type"
                                data-index="${index}"
                                class="form-select form-select-sm">
                            <option value="indywidualne" ${item.type === 'indywidualne' ? 'selected' : ''}>Indywidualne</option>
                            <option value="tus" ${item.type === 'tus' ? 'selected' : ''}>TUS</option>
                        </select>
                    </td>
                    <td class="text-center ${item.is_duplicate ? 'duplicate-tooltip' : ''}" ${duplicateInfo}>${matchStatus}</td>
                </tr>
            `;
        }).join('');

        document.querySelectorAll('.delete-row-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                deleteRow(index);
            });
        });

        document.querySelectorAll('#resultsBody input, #resultsBody select').forEach(element => {
            element.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const field = this.dataset.field;
                updateFieldValue(index, field, this.value);
            });

            if (element.tagName === 'INPUT' && !element.readOnly) {
                element.addEventListener('focus', function() {
                    this.classList.add('edited-field');
                });

                element.addEventListener('blur', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const original = originalScheduleData[index];

                    if (original && this.value !== original[field]) {
                        this.classList.add('edited-field');
                    } else {
                        this.classList.remove('edited-field');
                    }

                    // NOWE: Sprawd≈∫ duplikaty po zmianie
                    detectDuplicates();
                    renderResults(currentScheduleData);
                    updateCounters();
                });
            }
        });
    }

    function deleteRow(index) {
        const item = currentScheduleData[index];
        const clientName = item.client_name || 'ten wpis';

        if (confirm(`Czy na pewno chcesz usunƒÖƒá wpis dla "${clientName}"?`)) {
            const row = document.querySelector(`tr[data-index="${index}"]`);
            row.classList.add('row-deleting');

            setTimeout(() => {
                currentScheduleData.splice(index, 1);
                originalScheduleData.splice(index, 1);
                detectDuplicates(); // Ponownie sprawd≈∫ duplikaty
                renderResults(currentScheduleData);
                updateCounters();
                showAlert(`Wpis zosta≈Ç usuniƒôty.`, 'info');
            }, 300);
        }
    }

    function updateFieldValue(index, field, value) {
        if (!currentScheduleData[index]) return;

        currentScheduleData[index][field] = value.trim();

        if (field === 'client_name' && value.trim()) {
            currentScheduleData[index].matched = true;

            const input = document.querySelector(`input[data-index="${index}"][data-field="client_name"]`);
            if (input) {
                input.classList.remove('unmatched-name');
                input.classList.add('matched-name');
            }

            const row = document.querySelector(`tr[data-index="${index}"]`);
            const statusCell = row.querySelector('td:last-child');
            statusCell.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> OK</span>';
        }

        updateCounters();
    }

    function updateCounters() {
        const matched = currentScheduleData.filter(item => item.matched && !item.is_duplicate).length;
        const unmatched = currentScheduleData.filter(item => !item.matched && !item.is_duplicate).length;
        const duplicates = currentScheduleData.filter(item => item.is_duplicate).length;
        const total = currentScheduleData.length;

        matchedCount.innerHTML = `<i class="bi bi-check-circle"></i> ${matched} dopasowanych`;
        unmatchedCount.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${unmatched} niedopasowanych`;
        duplicateCount.innerHTML = `<i class="bi bi-exclamation-diamond"></i> ${duplicates} duplikat√≥w`;
        totalCount.innerHTML = `<i class="bi bi-list-ul"></i> ${total} wpis√≥w`;
    }

    // NOWA FUNKCJA: Usu≈Ñ wszystkie duplikaty
    removeDuplicatesBtn.addEventListener('click', () => {
        const duplicates = currentScheduleData.filter(item => item.is_duplicate);

        if (duplicates.length === 0) {
            showAlert('Nie wykryto duplikat√≥w.', 'info');
            return;
        }

        if (confirm(`Czy na pewno chcesz usunƒÖƒá ${duplicates.length} duplikat√≥w? Zostanie zachowany tylko pierwszy wpis z ka≈ºdej grupy duplikat√≥w.`)) {
            // Usu≈Ñ duplikaty (zachowaj tylko pierwszy z grupy)
            const seen = new Set();
            currentScheduleData = currentScheduleData.filter((item, index) => {
                const key = `${item.date}|${item.therapist_name}|${item.start_time}|${item.client_name}`.toLowerCase();

                if (seen.has(key)) {
                    return false; // Usu≈Ñ duplikat
                }

                seen.add(key);
                return true; // Zachowaj pierwszy wpis
            });

            originalScheduleData = JSON.parse(JSON.stringify(currentScheduleData));
            detectDuplicates();
            renderResults(currentScheduleData);
            updateCounters();
            showAlert(`Usuniƒôto ${duplicates.length} duplikat√≥w.`, 'success');
        }
    });

    clearAllBtn.addEventListener('click', () => {
        if (currentScheduleData.length === 0) {
            showAlert('Brak wpis√≥w do usuniƒôcia.', 'warning');
            return;
        }

        if (confirm(`Czy na pewno chcesz usunƒÖƒá WSZYSTKIE ${currentScheduleData.length} wpis√≥w? Tej operacji nie mo≈ºna cofnƒÖƒá.`)) {
            currentScheduleData = [];
            originalScheduleData = [];
            renderResults(currentScheduleData);
            updateCounters();
            showAlert('Wszystkie wpisy zosta≈Çy usuniƒôte.', 'info');
        }
    });

    saveBtn.addEventListener('click', async () => {
        if (currentScheduleData.length === 0) {
            showAlert('Brak danych do zapisania.', 'warning');
            return;
        }

        const invalidItems = currentScheduleData.filter(item =>
            !item.client_name || !item.start_time || !item.end_time || !item.date
        );

        if (invalidItems.length > 0) {
            showAlert(`Uwaga: ${invalidItems.length} wpis√≥w ma niepe≈Çne dane. Uzupe≈Çnij wszystkie wymagane pola.`, 'warning');
            return;
        }

        // NOWE: Sprawd≈∫ duplikaty przed zapisem
        const duplicates = currentScheduleData.filter(item => item.is_duplicate);
        if (duplicates.length > 0) {
            const confirmSave = confirm(
                `‚ö†Ô∏è UWAGA: Wykryto ${duplicates.length} duplikat√≥w!\n\n` +
                `Duplikaty to wpisy z identycznƒÖ datƒÖ, terapeutƒÖ, godzinƒÖ i klientem.\n\n` +
                `Czy chcesz kontynuowaƒá zapis? (Zalecane jest usuniƒôcie duplikat√≥w przed zapisem)`
            );
            if (!confirmSave) return;
        }

        const unmatchedItems = currentScheduleData.filter(item => !item.matched);
        if (unmatchedItems.length > 0) {
            const confirmSave = confirm(
                `Uwaga: ${unmatchedItems.length} wpis√≥w ma niedopasowane nazwy klient√≥w.\n\n` +
                `Czy chcesz kontynuowaƒá zapis?`
            );
            if (!confirmSave) return;
        }

        const spinner = document.getElementById('saveSpinner');
        spinner.classList.remove('d-none');
        saveBtn.disabled = true;

        try {
            console.log('Wysy≈Çanie danych do zapisu:', currentScheduleData);

            const response = await fetch(`${API_URL}/api/save-parsed-schedule`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentScheduleData)
            });

            const result = await response.json();
            console.log('Odpowied≈∫ zapisu:', result);

            if (!response.ok) {
                throw new Error(result.error || `B≈ÇƒÖd serwera: ${response.status}`);
            }

            if (result.success) {
                const successMsg = `‚úÖ Pomy≈õlnie zapisano ${result.saved_count} z ${result.total_count} wpis√≥w!`;
                const errorsInfo = result.errors && result.errors.length > 0 ?
                    `\n\nPominiƒôto ${result.errors.length} wpis√≥w z powodu konflikt√≥w.` : '';

                showAlert(successMsg + errorsInfo, 'success');

                setTimeout(() => {
                    resultsCard.classList.add('d-none');
                    previewCard.classList.add('d-none');
                    imageUpload.value = '';
                    currentScheduleData = [];
                    originalScheduleData = [];
                    updateCounters();
                }, 2000);
            } else {
                throw new Error(result.error || 'Nieznany b≈ÇƒÖd zapisu');
            }
        } catch (error) {
            console.error('B≈ÇƒÖd zapisu:', error);
            showAlert(`‚ùå Zapis nie powi√≥d≈Ç siƒô: ${error.message}`);
        } finally {
            spinner.classList.add('d-none');
            saveBtn.disabled = false;
        }
    });

    [importDate, importTherapist, importMonth, scopeDayRadio, scopeMonthRadio].forEach(el => {
        el.addEventListener('change', checkIfReadyToUpload);
    });

    scopeDayRadio.addEventListener('change', handleScopeChange);
    scopeMonthRadio.addEventListener('change', handleScopeChange);

    initializeSelectors();
});

    analyzeBtn.addEventListener('click', async () => {
    const file = imageUpload.files[0];
    if (!file) return showAlert('Proszƒô wybraƒá plik z obrazem.');

    const spinner = document.getElementById('analyzeSpinner');
    spinner.classList.remove('d-none');
    analyzeBtn.disabled = true;

    const formData = new FormData();
    const scope = document.querySelector('input[name="importScope"]:checked').value;
    formData.append('schedule_image', file);
    formData.append('scope', scope);
    formData.append('therapist_name', importTherapist.value);

    if (scope === 'day') {
        formData.append('date', importDate.value);
    } else {
        formData.append('month', importMonth.value);
    }

    try {
        console.log('Wysy≈Çanie ≈ºƒÖdania do:', `${API_URL}/api/parse-schedule-image`);
        
        const response = await fetch(`${API_URL}/api/parse-schedule-image`, {
            method: 'POST',
            body: formData
        });

        // DEBUG: Sprawd≈∫ odpowied≈∫
        const responseText = await response.text();
        console.log('Odpowied≈∫ serwera:', responseText);
        console.log('Status:', response.status);
        console.log('Nag≈Ç√≥wki:', response.headers);

        // Spr√≥buj sparsowaƒá jako JSON
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (parseError) {
            console.error('B≈ÇƒÖd parsowania JSON:', parseError);
            throw new Error(`Serwer zwr√≥ci≈Ç HTML zamiast JSON. Status: ${response.status}`);
        }

        if (!response.ok) {
            throw new Error(result.error || `B≈ÇƒÖd serwera: ${response.status}`);
        }

        if (result.success) {
            currentScheduleData = result.data || [];
            originalScheduleData = JSON.parse(JSON.stringify(currentScheduleData));
            detectDuplicates();
            renderResults(currentScheduleData);
            resultsCard.classList.remove('d-none');
            updateCounters();

            const duplicates = currentScheduleData.filter(item => item.is_duplicate).length;
            const warningMsg = duplicates > 0 ? ` ‚ö†Ô∏è Wykryto ${duplicates} duplikat√≥w!` : '';

            showAlert(
                `‚úÖ Pomy≈õlnie przetworzono ${result.total_count} wpis√≥w. Dopasowano ${result.matched_count} nazw.${warningMsg}`,
                duplicates > 0 ? 'warning' : 'success'
            );
        } else {
            throw new Error(result.error || 'Nieznany b≈ÇƒÖd przetwarzania');
        }
    } catch (error) {
        console.error('B≈ÇƒÖd analizy:', error);
        showAlert(`Analiza nie powiod≈Ça siƒô: ${error.message}`);
    } finally {
        spinner.classList.add('d-none');
        analyzeBtn.disabled = false;
    }
});
</script>
</body>

</html>



