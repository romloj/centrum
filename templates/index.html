<!doctype html>
<html lang="pl">
<head>
Â  <meta charset="utf-8">
Â  <title>Planowanie SUO â€“ Panel GÅ‚Ã³wny</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
Â  <style>
Â  Â  body {
Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  padding: 20px;
Â  Â  }

Â  Â  .app-container {
Â  Â  Â  max-width: 1400px;
Â  Â  Â  margin: 0 auto;
Â  Â  }

Â  Â  .app-header {
Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 30px;
Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
Â  Â  }

Â  Â  .app-title {
Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  margin: 0;
Â  Â  }

Â  Â  .app-subtitle {
Â  Â  Â  color: #6c757d;
Â  Â  Â  margin-top: 8px;
Â  Â  }

Â  Â  .dashboard-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
Â  Â  Â  gap: 24px;
Â  Â  Â  margin-bottom: 30px;
Â  Â  }

Â  Â  .app-card {
Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 32px;
Â  Â  Â  text-align: center;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  Â  border: 2px solid transparent;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  .app-card::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
Â  Â  Â  opacity: 0;
Â  Â  Â  transition: opacity 0.3s;
Â  Â  }

Â  Â  .app-card:hover {
Â  Â  Â  transform: translateY(-8px) scale(1.02);
Â  Â  Â  box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
Â  Â  Â  border-color: rgba(102, 126, 234, 0.3);
Â  Â  }

Â  Â  .app-card:hover::before {
Â  Â  Â  opacity: 1;
Â  Â  }

Â  Â  .app-card:active {
Â  Â  Â  transform: translateY(-4px) scale(1.01);
Â  Â  }

Â  Â  .card-icon {
Â  Â  Â  font-size: 3.5rem;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  position: relative;
Â  Â  Â  z-index: 1;
Â  Â  }

Â  Â  .card-title {
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #2d3748;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  position: relative;
Â  Â  Â  z-index: 1;
Â  Â  }

Â  Â  .card-description {
Â  Â  Â  color: #718096;
Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  line-height: 1.5;
Â  Â  Â  position: relative;
Â  Â  Â  z-index: 1;
Â  Â  }

Â  Â  .stats-row {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  gap: 20px;
Â  Â  Â  margin-bottom: 30px;
Â  Â  }

Â  Â  .stat-card {
Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-radius: 16px;
Â  Â  Â  padding: 24px;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
Â  Â  }

Â  Â  .stat-value {
Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #667eea;
Â  Â  Â  margin-bottom: 8px;
Â  Â  }

Â  Â  .stat-label {
Â  Â  Â  color: #718096;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: 0.5px;
Â  Â  }

Â  Â  .quick-actions {
Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 24px;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
Â  Â  }

Â  Â  .quick-actions h3 {
Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #2d3748;
Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  .action-btn {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 16px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border: 2px solid #e2e8f0;
Â  Â  Â  background: white;
Â  Â  Â  color: #2d3748;
Â  Â  Â  font-weight: 500;
Â  Â  Â  transition: all 0.2s;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 12px;
Â  Â  }

Â  Â  .action-btn:hover {
Â  Â  Â  background: #667eea;
Â  Â  Â  color: white;
Â  Â  Â  border-color: #667eea;
Â  Â  Â  transform: translateX(4px);
Â  Â  }

Â  Â  .action-btn i {
Â  Â  Â  font-size: 1.3rem;
Â  Â  }

          /* Dodaj do sekcji style */
    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .offcanvas {
        box-shadow: -5px 0 30px rgba(0,0,0,0.1);
    }
    
    .btn-lg {
        padding: 12px 20px;
        font-size: 1.1rem;
    }
    Â  Â  @media (max-width: 768px) {
    Â  Â  Â  .app-title {
    Â  Â  Â  Â  font-size: 1.8rem;
    Â  Â  Â  }

Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  }

Â  Â  Â  .card-icon {
Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  }
Â  Â  }

Â  Â  .badge-status {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 16px;
Â  Â  Â  right: 16px;
Â  Â  Â  padding: 6px 12px;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  z-index: 2;
Â  Â  }

Â  Â  .loading-spinner {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 40px;
Â  Â  }

Â  Â  Â  /* Dodaj nowe style */
a.card-link {
Â  Â  display: block;
Â  Â  text-decoration: none;
Â  Â  color: inherit;
Â  Â  transition: transform 0.12s ease, box-shadow 0.12s ease;
}

a.card-link:hover {
Â  Â  color: inherit;
Â  Â  transform: translateY(-2px);
}

a.card-link:hover .start-card {
Â  Â  box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.08);
}

.start-card {
Â  Â  border-radius: 16px;
Â  Â  border: 1px solid rgba(0,0,0,0.125);
Â  Â  transition: box-shadow 0.12s ease;
}
            /* FORCE STYLES - tymczasowo */
.dashboard-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)) !important;
  gap: 20px !important;
  border: 3px solid lime !important;
  padding: 20px !important;
  background: rgba(0,255,0,0.1) !important;
}

.app-card {
  background: white !important;
  border: 2px solid blue !important;
  padding: 20px !important;
  border-radius: 10px !important;
  min-height: 150px !important;
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
}
Â  </style>
</head>
<body>
Â  {% include 'navbar.html' %}
Â  <div class="app-container">
Â  Â  Â  Â  <div class="app-header">
Â  Â  Â  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h1 class="app-title">
Â  Â  Â  Â  Â  Â  <i class="bi bi-calendar-check"></i> ModuÅ‚ Planowania SUO
Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  <p class="app-subtitle mb-0">System zarzÄ…dzania terapiami i transportem</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="d-flex gap-2">
Â  Â  Â  Â  Â  <input type="month" class="form-control" id="monthFilter" style="max-width: 160px;">
Â  Â  Â  Â  Â  <button class="btn btn-light" onclick="location.reload()">
Â  Â  Â  Â  Â  Â  <i class="bi bi-arrow-clockwise"></i>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="stats-row" id="statsRow">
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <div class="stat-value" id="clientsCount">-</div>
Â  Â  Â  Â  <div class="stat-label">Klienci aktywni</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <div class="stat-value" id="therapistsCount">-</div>
Â  Â  Â  Â  <div class="stat-label">Terapeuci</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <div class="stat-value" id="driversCount">-</div>
Â  Â  Â  Â  <div class="stat-label">Kierowcy</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  <div class="stat-value" id="packagesCount">-</div>
Â  Â  Â  Â  <div class="stat-label">Pakiety w miesiÄ…cu</div>
Â  Â  Â  </div>
Â  Â  </div>

            <!-- DIAGNOSTYKA - tymczasowo -->
<div style="background: red; color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px;">
  <h4>ğŸ”¥ DIAGNOSTYKA:</h4>
  <p>JeÅ›li ten czerwony blok jest widoczny, to strona Å‚aduje siÄ™</p>
  <p>is_admin: {{ is_admin }}, therapist_id: {{ therapist_id }}, driver_id: {{ driver_id }}</p>
</div>

<div style="background: yellow; padding: 15px; margin-bottom: 20px; border: 2px solid orange;">
  <p>ğŸ” SprawdÅº czy ten Å¼Ã³Å‚ty blok jest widoczny</p>
</div>
    Â  Â  <div class="dashboard-grid">
  <!-- Testowy kafel 1 -->
  <div class="app-card" onclick="navigateTo('{{ url_for('clients_page') }}')">
    <span class="badge bg-success badge-status">Aktywne</span>
    <i class="bi bi-people-fill card-icon"></i>
    <h2 class="card-title">Klienci</h2>
    <p class="card-description">
      ZarzÄ…dzaj bazÄ… klientÃ³w, przeglÄ…daj ich pakiety i dostÄ™pnoÅ›Ä‡
    </p>
  </div>

  <!-- Testowy kafel 2 -->
  <div class="app-card" onclick="navigateTo('{{ url_for('schedule_page') }}')">
    <i class="bi bi-heart-pulse-fill card-icon"></i>
    <h2 class="card-title">Grafik TerapeutÃ³w</h2>
    <p class="card-description">
      PrzeglÄ…daj grafiki, dodawaj terapeutÃ³w i planuj zajÄ™cia
    </p>
  </div>

  <!-- Testowy kafel 3 -->
  <div class="app-card" onclick="navigateTo('{{ url_for('driver_schedule_page') }}')">
    <i class="bi bi-truck card-icon"></i>
    <h2 class="card-title">Kierowcy</h2>
    <p class="card-description">
      ZarzÄ…dzaj kierowcami i przeglÄ…daj plany transportu
    </p>
  </div>

  <!-- Testowy kafel 4 -->
  <div class="app-card" onclick="navigateTo('{{ url_for('manager_page') }}')">
    <i class="bi bi-calendar3 card-icon"></i>
    <h2 class="card-title">Plan SUO</h2>
    <p class="card-description">
      PrzeglÄ…d salda godzin i pakietÃ³w wszystkich klientÃ³w
    </p>
  </div>
</div>
Â  Â  Â  {% if is_admin or therapist_id %}
Â  Â  Â  <div class="app-card" onclick="navigateTo('{{ url_for('tus_page') }}')">
Â  Â  Â  Â  <span class="badge bg-info badge-status">Grupy</span>
Â  Â  Â  Â  <i class="bi bi-star-fill card-icon"></i>
Â  Â  Â  Â  <h2 class="card-title">ModuÅ‚ TUS</h2>
Â  Â  Â  Â  <p class="card-description">
Â  Â  Â  Â  Â  ZarzÄ…dzanie zajÄ™ciami grupowymi i globalny plan TUS
Â  Â  Â  Â  </p>
Â  Â  Â  </div>
      {% endif %}
Â  Â  Â Â 
Â  Â  Â  {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('manager_page') }}')">
Â  Â  Â  <span class="badge bg-warning badge-status">MenadÅ¼er</span>
Â  Â  Â  <i class="bi bi-file-earmark-medical card-icon"></i>
Â  Â  Â  <h2 class="card-title">MenadÅ¼er</h2>
Â  Â  Â  <p class="card-description">
Â  Â  Â  Â  ZarzÄ…dzaj dokumentacjÄ… klientÃ³w, skanuj i przesyÅ‚aj pliki
Â  Â  Â  </p>
Â  Â  </div>
      {% endif %}

Â  Â   {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('waiting_list_page') }}')">
Â  Â  Â  Â  <i class="bi bi-alarm" style="font-size: 2rem; color: cornflowerblue;"></i>
Â  Â  Â  Â  <h2 class="card-title">OczekujÄ…cy</h2>
Â  Â  Â  Â  <p class="card-description">
Â  Â  Â  Â  Â  ZarzÄ…dzaj listÄ… klientÃ³w oczekujÄ…cych na przyjÄ™cie
Â  Â  Â  Â  </p>
Â  Â  Â  </div>
      {% endif %}
Â  Â  </div> Â  Â  Â  Â  <div class="quick-actions">
Â  Â  Â  <h3><i class="bi bi-lightning-fill"></i> Szybkie akcje</h3>
Â  Â  Â  <div class="row g-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  <button class="action-btn" onclick="openClientSelectForPackage()">
Â  Â  Â  Â  Â  Â  <i class="bi bi-plus-circle-fill"></i>
Â  Â  Â  Â  Â  Â  <span>Dodaj pakiet zajÄ™Ä‡</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  <button class="action-btn" onclick="quickAddClient()">
Â  Â  Â  Â  Â  Â  <i class="bi bi-person-plus-fill"></i>
Â  Â  Â  Â  Â  Â  <span>Dodaj nowego klienta</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  <button class="action-btn" onclick="quickAddTherapist()">
Â  Â  Â  Â  Â  Â  <i class="bi bi-person-fill-add"></i>
Â  Â  Â  Â  Â  Â  <span>Dodaj terapeutÄ™</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  <button class="action-btn" onclick="quickAddDriver()">
Â  Â  Â  Â  Â  Â  <i class="bi bi-person-plus-fill"></i>
Â  Â  Â  Â  Â  Â  <span>Dodaj kierowcÄ™</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  <button class="action-btn" onclick="quickCheckGaps()">
Â  Â  Â  Â  Â  Â  <i class="bi bi-exclamation-triangle-fill"></i>
Â  Â  Â  Â  Â  Â  <span>SprawdÅº braki w miesiÄ…cu</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="modal fade" id="addClientModal" tabindex="-1">
Â  Â  <div class="modal-dialog">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title">Dodaj nowego klienta</h5>
Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  <form id="addClientForm">
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ImiÄ™ i nazwisko <span class="text-danger">*</span></label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="clientName" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Telefon</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="clientPhone">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Adres</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="clientAddress">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
Â  Â  Â  Â  Â  <button type="button" class="btn btn-primary" onclick="submitAddClient()">
Â  Â  Â  Â  Â  Â  <span class="spinner-border spinner-border-sm d-none" id="clientSpinner"></span>
Â  Â  Â  Â  Â  Â  Dodaj klienta
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="modal fade" id="addTherapistModal" tabindex="-1">
Â  Â  <div class="modal-dialog">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title">Dodaj terapeutÄ™</h5>
Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  <form id="addTherapistForm">
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ImiÄ™ i nazwisko <span class="text-danger">*</span></label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="therapistName" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Specjalizacja</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="therapistSpec" placeholder="np. SI, psycholog">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Telefon</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="therapistPhone">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
Â  Â  Â  Â  Â  <button type="button" class="btn btn-primary" onclick="submitAddTherapist()">
Â  Â  Â  Â  Â  Â  <span class="spinner-border spinner-border-sm d-none" id="therapistSpinner"></span>
Â  Â  Â  Â  Â  Â  Dodaj terapeutÄ™
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="modal fade" id="addDriverModal" tabindex="-1">
Â  Â  <div class="modal-dialog">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title">Dodaj kierowcÄ™</h5>
Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  <form id="addDriverForm">
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ImiÄ™ i nazwisko <span class="text-danger">*</span></label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="driverName" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Telefon</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="driverPhone">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
Â  Â  Â  Â  Â  <button type="button" class="btn btn-primary" onclick="submitAddDriver()">
Â  Â  Â  Â  Â  Â  <span class="spinner-border spinner-border-sm d-none" id="driverSpinner"></span>
Â  Â  Â  Â  Â  Â  Dodaj kierowcÄ™
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div class="modal fade" id="gapsModal" tabindex="-1">
Â  Â  <div class="modal-dialog modal-xl">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title">Braki w miesiÄ…cu</h5>
Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-body" id="gapsContent">
Â  Â  Â  Â  Â  <div class="text-center py-4">
Â  Â  Â  Â  Â  Â  <div class="spinner-border" role="status"></div>
Â  Â  Â  Â  Â  Â  <p class="mt-2">Åadowanie...</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="offcanvas offcanvas-end" style="width: 520px;" tabindex="-1" id="packageCanvas">
Â  Â  <div class="offcanvas-header">
Â  Â  Â  Â  <h5>Dodaj pakiet zdarzeÅ„</h5>
Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
Â  Â  </div>
Â  Â  <div class="offcanvas-body">
Â  Â  Â  Â  <form id="packageForm">
Â  Â  Â  Â  Â  Â  <input type="hidden" id="pkgClientId">

Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Klient</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="pkgClientName" disabled>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Etykieta (np. â€Wtorek poranny")</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="pkgLabel">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <h6 class="mt-3">Terapia</h6>
Â  Â  Â  Â  Â  Â  <div class="row g-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Terapeuta</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" id="thSelect" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">â€” wybierz â€”</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Data</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" class="form-control" id="thDate" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Start</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="form-control" id="thStart" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Koniec</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="form-control" id="thEnd" required>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-12">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Miejsce</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="thPlace" value="Poradnia">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <hr class="my-3">

Â  Â  Â  Â  Â  Â  <div class="form-check form-switch mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  <input class="form-check-input" type="checkbox" id="withPickup">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-check-label" for="withPickup">Dodaj dowÃ³z (pickup)</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="pickupFields" class="row g-3 d-none">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Kierowca</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" id="pkDriverSelect">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">â€” wybierz â€”</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Start</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="form-control" id="pkStart">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Koniec</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="form-control" id="pkEnd">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <hr class="my-3">

Â  Â  Â  Â  Â  Â  <div class="form-check form-switch mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  <input class="form-check-input" type="checkbox" id="withDropoff">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-check-label" for="withDropoff">Dodaj odwÃ³z (dropoff)</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="dropoffFields" class="row g-3 d-none">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Kierowca</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" id="dpDriverSelect">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">â€” wybierz â€”</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Start</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="form-control" id="dpStart">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Koniec</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" class="form-control" id="dpEnd">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="d-grid gap-2 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">Zapisz pakiet</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Anuluj</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  </div>
</div>
<!-- wstawka z deep-->
    <!-- Modal wyboru klienta -->
<div class="modal fade" id="clientSelectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Wybierz klienta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <select class="form-select" id="modalClientSelect">
          <option value="">Åadowanie klientÃ³w...</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
        <button type="button" class="btn btn-primary" onclick="selectClient()">Wybierz</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal wyboru typu pakietu -->
<div class="modal fade" id="packageTypeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Wybierz typ pakietu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Dla klienta: <strong id="selectedClientName"></strong></p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary btn-lg" onclick="goToIndividualPackage()">
            <i class="bi bi-person-fill"></i> Terapia indywidualna
          </button>
          <button type="button" class="btn btn-info btn-lg" onclick="goToTusPackage()">
            <i class="bi bi-people-fill"></i> Grupa TUS
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
Â  
  Â  <script>
Â  Â  const API = "";

Â  Â  // Nawigacja
Â  Â  function navigateTo(url) {
Â  Â  Â  window.location.href = url;
Â  Â  }

Â  Â  // Inicjalizacja miesiÄ…ca
Â  Â  (function initMonth(){
Â  Â  Â  const today = new Date();
Â  Â  Â  const y = today.getFullYear();
Â  Â  Â  const m = String(today.getMonth()+1).padStart(2,'0');
Â  Â  Â  document.getElementById('monthFilter').value = `${y}-${m}`;
Â  Â  })();

Â  Â  // Åadowanie statystyk
Â  Â  async function loadStats() {
Â  Â  Â  const month = document.getElementById('monthFilter').value;
Â  Â  Â  try {
Â  Â  Â  Â  const clientsRes = await fetch(`${API}/api/clients?month=${month}`);
Â  Â  Â  Â  const clients = await clientsRes.json();
Â  Â  Â  Â  document.getElementById('clientsCount').textContent = clients.filter(c => c.active !== false).length;
Â  Â  Â  Â  const therapistsRes = await fetch(`${API}/api/therapists`);
Â  Â  Â  Â  const therapists = await therapistsRes.json();
Â  Â  Â  Â  document.getElementById('therapistsCount').textContent = therapists.filter(t => t.active !== false).length;
Â  Â  Â  Â  const driversRes = await fetch(`${API}/api/drivers`);
Â  Â  Â  Â  const drivers = await driversRes.json();
Â  Â  Â  Â  document.getElementById('driversCount').textContent = drivers.filter(d => d.active !== false).length;
Â  Â  Â  Â  const packagesCount = clients.reduce((sum, c) => sum + (c.minutes_used > 0 ? 1 : 0), 0);
Â  Â  Â  Â  document.getElementById('packagesCount').textContent = packagesCount;
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('BÅ‚Ä…d Å‚adowania statystyk:', err);
Â  Â  Â  }
Â  Â  }
Â  Â  document.getElementById('monthFilter').addEventListener('change', loadStats);
Â  Â  loadStats();

Â  Â  // OBSÅUGA SZYBKICH AKCJI
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  const action = urlParams.get('action');
Â  Â  Â  if (action === 'addClient') { quickAddClient(); }
      else if (action === 'addTherapist') { quickAddTherapist(); }
      else if (action === 'addDriver') { quickAddDriver(); }
      else if (action === 'checkGaps') { quickCheckGaps(); }
      else if (action === 'addPackage') { quickAddPackage(); }
Â  Â  });

Â  Â  // --- Funkcje Modali (z poprawionÄ… nawigacjÄ…) ---

Â  Â  // Dodaj klienta (bez zmian)
Â  Â  function quickAddClient() {
Â  Â  Â  document.getElementById('addClientForm').reset();
Â  Â  Â  new bootstrap.Modal(document.getElementById('addClientModal')).show();
Â  Â  }

    // âœ…âœ…âœ… POCZÄ„TEK BÅÄ˜DU SYNTAX âœ…âœ…âœ…
    // PoniÅ¼szy kod jest poza funkcjÄ…! Brakuje `async function submitAddClient() {`
Â  Â  async function submitAddClient() {
      const name = document.getElementById('clientName').value.trim();
Â  Â  Â  if (!name) { alert('Podaj imiÄ™ i nazwisko klienta'); return; }
Â  Â  Â  const phone = document.getElementById('clientPhone').value.trim();
Â  Â  Â  const address = document.getElementById('clientAddress').value.trim();
Â  Â  Â  const spinner = document.getElementById('clientSpinner');
Â  Â  Â  spinner.classList.remove('d-none');
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API}/api/clients`, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ full_name: name, phone: phone || null, address: address || null, active: true })
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  Â  Â  bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
Â  Â  Â  Â  alert('Klient zostaÅ‚ dodany pomyÅ›lnie!');
Â  Â  Â  Â  loadStats();
Â  Â  Â  Â  const viewClient = confirm('Czy chcesz przejÅ›Ä‡ do listy klientÃ³w?');
Â  Â  Â  Â  if (viewClient) {
Â  Â  Â  Â  Â  // âœ… POPRAWKA TUTAJ: UÅ¼yj url_for z Jinja2
Â  Â  Â  Â  Â  navigateTo('{{ url_for('clients_page') }}');
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  alert(`BÅ‚Ä…d dodawania klienta: ${err.message}`);
Â  Â  Â  } finally {
Â  Â  Â  Â  spinner.classList.add('d-none');
Â  Â  Â  }
    }
    // âœ…âœ…âœ… KONIEC BÅÄ˜DU SYNTAX âœ…âœ…âœ…


Â  Â  // Dodaj terapeutÄ™ - otwÃ³rz modal
Â  Â  function quickAddTherapist() {
Â  Â  Â  document.getElementById('addTherapistForm').reset();
Â  Â  Â  new bootstrap.Modal(document.getElementById('addTherapistModal')).show();
Â  Â  }

Â  Â  // Submit dodawania terapeuty
Â  Â  async function submitAddTherapist() {
Â  Â  Â  const name = document.getElementById('therapistName').value.trim();
Â  Â  Â  if (!name) {
Â  Â  Â  Â  alert('Podaj imiÄ™ i nazwisko terapeuty');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const spec = document.getElementById('therapistSpec').value.trim();
Â  Â  Â  const phone = document.getElementById('therapistPhone').value.trim();
Â  Â  Â  const spinner = document.getElementById('therapistSpinner');
Â  Â  Â  spinner.classList.remove('d-none');
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API}/api/therapists`, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  full_name: name,
Â  Â  Â  Â  Â  Â  specialization: spec || null,
Â  Â  Â  Â  Â  Â  phone: phone || null,
Â  Â  Â  Â  Â  Â  active: true
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  Â  Â  bootstrap.Modal.getInstance(document.getElementById('addTherapistModal')).hide();
Â  Â  Â  Â  alert('Terapeuta zostaÅ‚ dodany pomyÅ›lnie!');
Â  Â  Â  Â  loadStats();
Â  Â  Â  Â  const viewTherapist = confirm('Czy chcesz przejÅ›Ä‡ do planÃ³w terapeutÃ³w?');
Â  Â  Â  Â  if (viewTherapist) {
Â  Â  Â  Â  Â  // âœ… POPRAWKA TUTAJ: UÅ¼yj url_for z Jinja2
Â  Â  Â  Â  Â  navigateTo('{{ url_for('schedule_page') }}');
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  alert(`BÅ‚Ä…d dodawania terapeuty: ${err.message}`);
Â  Â  Â  } finally {
Â  Â  Â  Â  spinner.classList.add('d-none');
Â  Â  Â  }
Â  Â  }

Â  Â  // Dodaj kierowcÄ™ - otwÃ³rz modal
Â  Â  function quickAddDriver() {
Â  Â  Â  document.getElementById('addDriverForm').reset();
Â  Â  Â  new bootstrap.Modal(document.getElementById('addDriverModal')).show();
Â  Â  }

Â  Â  // Submit dodawania kierowcy
Â  Â  async function submitAddDriver() {
Â  Â  Â  const name = document.getElementById('driverName').value.trim();
Â  Â  Â  if (!name) {
Â  Â  Â  Â  alert('Podaj imiÄ™ i nazwisko kierowcy');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const phone = document.getElementById('driverPhone').value.trim();
Â  Â  Â  const spinner = document.getElementById('driverSpinner');
Â  Â  Â  spinner.classList.remove('d-none');
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API}/api/drivers`, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  full_name: name,
Â  Â  Â  Â  Â  Â  phone: phone || null,
Â  Â  Â  Â  Â  Â  active: true
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  Â  Â  bootstrap.Modal.getInstance(document.getElementById('addDriverModal')).hide();
Â  Â  Â  Â  alert('Kierowca zostaÅ‚ dodany pomyÅ›lnie!');
Â  Â  Â  Â  loadStats();
Â  Â  Â  Â  const viewDriver = confirm('Czy chcesz przejÅ›Ä‡ do planÃ³w kierowcÃ³w?');
Â  Â  Â  Â  if (viewDriver) {
Â  Â  Â  Â  Â  navigateTo('{{ url_for('driver_schedule_page') }}');
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  alert(`BÅ‚Ä…d dodawania kierowcy: ${err.message}`);
Â  Â  Â  } finally {
Â  Â  Â  Â  spinner.classList.add('d-none');
Â  Â  Â  }
Â  Â  }

    Â  Â  // SprawdÅº braki w miesiÄ…cu
Â  Â  async function quickCheckGaps() {
Â  Â  Â  const month = document.getElementById('monthFilter').value;
Â  Â  Â  if (!month) {
Â  Â  Â  Â  alert('Wybierz miesiÄ…c z filtra u gÃ³ry strony.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const modal = new bootstrap.Modal(document.getElementById('gapsModal'));
Â  Â  Â  modal.show();
Â  Â  Â  const content = document.getElementById('gapsContent');
Â  Â  Â  content.innerHTML = `<div class="text-center py-4"><div class="spinner-border" role="status"></div><p class="mt-2">Sprawdzam braki w miesiÄ…cu ${month}...</p></div>`;
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API}/api/gaps/month?month=${encodeURIComponent(month)}`);
Â  Â  Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  const c = data.counts || {clients:0, therapists:0, drivers:0};
Â  Â  Â  Â  const renderList = (arr, type) => {
Â  Â  Â  Â  Â  if (!arr || !arr.length) return '<div class="text-muted">Brak</div>';
Â  Â  Â  Â  Â  return `<ul class="list-group">
Â  Â  Â  Â  Â  Â  ${arr.map(item => {
Â  Â  Â  Â  Â  Â  Â  const personId = item.id || item.client_id || item.therapist_id || item.driver_id;
Â  Â  Â  Â  Â  Â  Â  const fullName = item.full_name || 'Brak nazwy';
Â  Â  Â  Â  Â  Â  Â  let actionButton = '';
Â  Â  Â  Â  Â  Â  Â  if (personId && type === 'client') {
Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-sm btn-primary" onclick="addPackageForClient(${personId}, '${fullName.replace(/'/g, "\\'")}')"><i class="bi bi-plus-circle"></i> Dodaj pakiet</button>`;
Â  Â  Â  Â  Â  Â  Â  } else if (personId && type === 'therapist') {
Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-sm btn-outline-secondary" onclick="viewTherapistSchedule(${personId})"><i class="bi bi-calendar3"></i> Grafik</button>`;
Â  Â  Â  Â  Â  Â  Â  } else if (personId && type === 'driver') {
Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button class="btn btn-sm btn-outline-secondary" onclick="viewDriverSchedule(${personId})"><i class="bi bi-truck"></i> Kursy</button>`;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  return `<li class="list-group-item d-flex justify-content-between align-items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${fullName}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.absence_status ? `<span class="badge bg-danger ms-2">${item.absence_status}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButton}
Â  Â  Â  Â  Â  Â  Â  Â  </li>`;
Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  </ul>`;
Â  Â  Â  Â  };
Â  Â  Â  Â  content.innerHTML = `
Â  Â  Â  Â  Â  <div class="row mb-3">
Â  Â  Â  Â  Â  Â  <div class="col-md-4"><div class="alert alert-secondary"><strong>Klienci bez zdarzeÅ„:</strong> ${c.clients}</div></div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4"><div class="alert alert-secondary"><strong>Terapeuci bez terapii:</strong> ${c.therapists}</div></div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4"><div class="alert alert-secondary"><strong>Kierowcy bez kursÃ³w:</strong> ${c.drivers}</div></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-md-4"><h6>Klienci</h6>${renderList(data.clients, 'client')}</div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4"><h6>Terapeuci</h6>${renderList(data.therapists, 'therapist')}</div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4"><h6>Kierowcy</h6>${renderList(data.drivers, 'driver')}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  content.innerHTML = `<div class="alert alert-danger">BÅ‚Ä…d: ${err.message}</div>`;
Â  Â  Â  }
Â  Â  }

Â  Â  // Dodaj pakiet - przekierowanie do wyboru klienta
Â  Â  function quickAddPackage() {
Â  Â  Â  // âœ… POPRAWKA TUTAJ: UÅ¼yj url_for z Jinja2
Â  Â  Â  window.location.href = '{{ url_for('main_index') }}?view=main&action=selectClient';
Â  Â  }

Â  Â  // PokaÅ¼ gÅ‚Ã³wny widok (bez zmian)
Â  Â  function showMainView() {
Â  Â  Â  alert('Funkcja "Plan SUO" zostanie wkrÃ³tce zintegrowana z tym ekranem startowym.');
Â  Â  }

Â  Â  // --- Poprawione funkcje z listy brakÃ³w ---

Â  Â  // Dodaj pakiet dla klienta z listy brakÃ³w
Â  Â  window.addPackageForClient = function(clientId, clientName) {
Â  Â  Â  const modalInstance = bootstrap.Modal.getInstance(document.getElementById('gapsModal'));
Â  Â  Â  if (modalInstance) modalInstance.hide();
Â  Â  Â  const confirmAdd = confirm(`Czy chcesz dodaÄ‡ pakiet dla klienta:\n${clientName}?`);
Â  Â  Â  if (confirmAdd) {
        // âœ… POPRAWKA TUTAJ: UÅ¼yj url_for z Jinja2
Â  Â  Â  Â  window.location.href = `{{ url_for('manager_page') }}?openPackageFor=${clientId}`;
Â  Â  Â  }
Â  Â  };

Â  Â  // Zobacz grafik terapeuty
Â  Â  window.viewTherapistSchedule = function(therapistId) {
Â  Â  Â  const modalInstance = bootstrap.Modal.getInstance(document.getElementById('gapsModal'));
Â  Â  Â  if (modalInstance) modalInstance.hide();
      // âœ… POPRAWKA TUTAJ: UÅ¼yj url_for z Jinja2
      window.location.href = `{{ url_for('schedule_page') }}?therapist_id=${therapistId}`;
Â  Â  };

Â  Â  // Zobacz kursy kierowcy
Â  Â  window.viewDriverSchedule = function(driverId) {
Â  Â  Â  const modalInstance = bootstrap.Modal.getInstance(document.getElementById('gapsModal'));
Â  Â  Â  if (modalInstance) modalInstance.hide();
      // âœ… POPRAWKA TUTAJ: UÅ¼yj url_for z Jinja2
Â  Â  Â  window.location.href = `{{ url_for('driver_schedule_page') }}?driver_id=${driverId}`;
Â  Â  };

Â  Â  Â  let selectedClientId = null;
    let selectedClientName = null;
// Toggle pickup/dropoff fields
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('withPickup')?.addEventListener('change', (e) => {
        document.getElementById('pickupFields').classList.toggle('d-none', !e.target.checked);
    });

    document.getElementById('withDropoff')?.addEventListener('change', (e) => {
        document.getElementById('dropoffFields').classList.toggle('d-none', !e.target.checked);
    });
});

async function openClientSelectForPackage() {
    const modal = new bootstrap.Modal(document.getElementById('clientSelectModal'));
    const select = document.getElementById('modalClientSelect');

    select.innerHTML = '<option value="">Åadowanie...</option>';
    select.disabled = true;
    modal.show();

    try {
        const res = await fetch(`${API}/api/clients`);
        const clients = await res.json();
        const activeClients = clients.filter(c => c.active !== false);

        if (activeClients.length > 0) {
            select.innerHTML = '<option value="">-- wybierz klienta --</option>' +
                activeClients.map(c => `<option value="${c.client_id}" data-name="${c.full_name}">${c.full_name}</option>`).join('');
        } else {
            select.innerHTML = '<option value="">Brak aktywnych klientÃ³w</option>';
        }
    } catch (err) {
        select.innerHTML = `<option value="">BÅ‚Ä…d: ${err.message}</option>`;
    } finally {
        select.disabled = false;
    }
}

function selectClient() {
    const select = document.getElementById('modalClientSelect');
    selectedClientId = select.value;
    selectedClientName = select.options[select.selectedIndex]?.getAttribute('data-name');

    if (!selectedClientId) {
        alert("ProszÄ™ wybraÄ‡ klienta z listy.");
        return;
    }

    bootstrap.Modal.getInstance(document.getElementById('clientSelectModal')).hide();

    setTimeout(() => {
        new bootstrap.Modal(document.getElementById('packageTypeModal')).show();
    }, 300);
}

async function goToIndividualPackage() {
    bootstrap.Modal.getInstance(document.getElementById('packageTypeModal')).hide();

    // ZaÅ‚aduj terapeutÃ³w i kierowcÃ³w
    await loadTherapistsAndDrivers();

    // WypeÅ‚nij dane klienta
    document.getElementById('pkgClientId').value = selectedClientId;
    document.getElementById('pkgClientName').value = selectedClientName;

    // Ustaw domyÅ›lnÄ… datÄ™ (jutro)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('thDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('thStart').value = '09:00';
    document.getElementById('thEnd').value = '10:00';

    // OtwÃ³rz formularz
    setTimeout(() => {
        new bootstrap.Offcanvas(document.getElementById('packageCanvas')).show();
    }, 300);
}

function goToTusPackage(){
      // âœ… POPRAWKA TUTAJ
Â  Â    window.location.href = `{{ url_for('tus_page') }}?action=addPackage&clientId=${selectedClientId}`;
    }

async function loadTherapistsAndDrivers() {
    try {
        const [tRes, dRes] = await Promise.all([
            fetch(`${API}/api/therapists`),
            fetch(`${API}/api/drivers`)
        ]);

        const therapists = await tRes.json();
        const drivers = await dRes.json();

        const activeTherapists = therapists.filter(t => t.active !== false);
        const activeDrivers = drivers.filter(d => d.active !== false);

        document.getElementById('thSelect').innerHTML = '<option value="">â€” wybierz â€”</option>' +
            activeTherapists.map(t => `<option value="${t.id}">${t.full_name}</option>`).join('');

        document.getElementById('pkDriverSelect').innerHTML = '<option value="">â€” wybierz â€”</option>' +
            activeDrivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');

        document.getElementById('dpDriverSelect').innerHTML = '<option value="">â€” wybierz â€”</option>' +
            activeDrivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');
    } catch (err) {
        alert(`BÅ‚Ä…d Å‚adowania danych: ${err.message}`);
    }
}

// ObsÅ‚uga zapisu pakietu
document.getElementById('packageForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
        client_id: parseInt(document.getElementById('pkgClientId').value),
        label: document.getElementById('pkgLabel').value || null,
        therapy: {
            therapist_id: parseInt(document.getElementById('thSelect').value),
            starts_at: `${document.getElementById('thDate').value}T${document.getElementById('thStart').value}:00`,
            ends_at: `${document.getElementById('thDate').value}T${document.getElementById('thEnd').value}:00`,
            place: document.getElementById('thPlace').value
        },
        status: 'planned'
    };

    if (document.getElementById('withPickup').checked) {
        payload.pickup = {
            driver_id: parseInt(document.getElementById('pkDriverSelect').value),
            starts_at: `${document.getElementById('thDate').value}T${document.getElementById('pkStart').value}:00`,
            ends_at: `${document.getElementById('thDate').value}T${document.getElementById('pkEnd').value}:00`,
            from: 'Dom',
            to: 'Poradnia'
        };
    }

    if (document.getElementById('withDropoff').checked) {
        payload.dropoff = {
            driver_id: parseInt(document.getElementById('dpDriverSelect').value),
            starts_at: `${document.getElementById('thDate').value}T${document.getElementById('dpStart').value}:00`,
            ends_at: `${document.getElementById('thDate').value}T${document.getElementById('dpEnd').value}:00`,
            from: 'Poradnia',
            to: 'Dom'
        };
    }

    try {
        const res = await fetch(`${API}/api/schedule/group`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        alert('Pakiet dodany pomyÅ›lnie!');
        bootstrap.Offcanvas.getInstance(document.getElementById('packageCanvas')).hide();
        document.getElementById('packageForm').reset();
    } catch (err) {
        alert(`BÅ‚Ä…d zapisu: ${err.message}`);
    }
});
  </script>
    
</body>

</html>
