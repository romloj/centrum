<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Planowanie SUO ‚Äì Panel G≈Ç√≥wny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="braki.css">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --glass-bg: rgba(0, 128,0, 1.0);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-dark: #2d3748;
      --text-light: #718096;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--primary-gradient);
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
    }

    /* Nowy Header z Glassmorphism */
    .app-header {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 30px 40px;
      margin-bottom: 30px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    }

    .app-title {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .app-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
      margin-top: 8px;
      font-weight: 400;
    }

    /* Ulepszone Statystyki */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 28px 24px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.6s;
    }

    .stat-card:hover::before {
      left: 100%;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .stat-value {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    /* Nowoczesny Grid Dashboard */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .app-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .app-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .app-card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      transition: all 0.6s;
    }

    .app-card:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    }

    .app-card:hover::after {
      left: 100%;
    }

    .app-card:hover::before {
      opacity: 1;
    }

    .card-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      z-index: 2;
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
      position: relative;
      z-index: 2;
    }

    .card-description {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95rem;
      line-height: 1.6;
      position: relative;
      z-index: 2;
    }

    .badge-status {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      z-index: 3;
      background: var(--success-gradient);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Szybkie Akcje - Nowy Styl */
    .quick-actions {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .quick-actions h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .quick-actions h3 i {
      background: var(--warning-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .action-btn {
      width: 100%;
      padding: 18px 24px;
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateX(8px);
      color: white;
    }

    .action-btn i {
      font-size: 1.3rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Responsywno≈õƒá */
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .app-title {
        font-size: 2.2rem;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .app-header {
        padding: 24px;
      }
      
      .card-icon {
        font-size: 2.8rem;
      }
    }

    /* Animacje */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .app-card, .stat-card, .quick-actions {
      animation: fadeInUp 0.6s ease-out;
    }

    .app-card:nth-child(2) { animation-delay: 0.1s; }
    .app-card:nth-child(3) { animation-delay: 0.2s; }
    .app-card:nth-child(4) { animation-delay: 0.3s; }
    .app-card:nth-child(5) { animation-delay: 0.4s; }
    .app-card:nth-child(6) { animation-delay: 0.5s; }
  </style>
</head>
<body>
 
  <div class="app-container">

	  {# === LINKI TYLKO DLA ADMINA === #}
		{% if session.get('is_admin') %}
		<div class="nav-item dropdown">
		    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
		        Admin üõ†Ô∏è
		    </a>
		    <div class="dropdown-menu" aria-labelledby="adminDropdown">
		        <a class="dropdown-item" href="{{ url_for('admin.admin_register_page') }}">Dodaj u≈ºytkownika</a>
		        
		        <a class="dropdown-item {% if request.endpoint == 'admin.manage_users_page' %}active{% endif %}" href="{{ url_for('admin.manage_users_page') }}">ZarzƒÖdzaj Rolami</a>
		        
		        <div class="dropdown-divider"></div>
		        <a class="dropdown-item" href="{{ url_for('admin.admin_change_password_page') }}">Zmie≈Ñ has≈Ço</a>
		    </div>
		</div>
		{% endif %}
    
    <!-- Nowy Header -->
    <div class="app-header">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
          <h1 class="app-title">
            <i class="bi bi-calendar-check"></i> Planowanie SUO
          </h1>
          <p class="app-subtitle">Zaawansowany system zarzƒÖdzania terapiami i transportem</p>
        </div>
        <div class="d-flex gap-2">
          <input type="month" class="form-control" id="monthFilter" style="
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            max-width: 160px;
          ">
          <button class="btn" onclick="location.reload()" style="
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
          ">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Nowe Statystyki -->
    <div class="stats-container" id="statsRow">
      <div class="stat-card">
        <div class="stat-value" id="clientsCount">-</div>
        <div class="stat-label">Aktywni Klienci</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="therapistsCount">-</div>
        <div class="stat-label">Terapeuci</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="driversCount">-</div>
        <div class="stat-label">Kierowcy</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="packagesCount">-</div>
        <div class="stat-label">Pakiety</div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('clients_page') }}')">
        <span class="badge-status">Aktywne</span>
        <i class="bi bi-people-fill card-icon"></i>
        <h2 class="card-title">Klienci</h2>
        <p class="card-description">
          ZarzƒÖdzaj bazƒÖ klient√≥w, przeglƒÖdaj ich pakiety i dostƒôpno≈õƒá
        </p>
      </div>
      {% endif %}

     

      {% if is_admin or driver_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('driver_schedule_page') }}')">
        <i class="bi bi-truck card-icon"></i>
        <h2 class="card-title">Kierowcy</h2>
        <p class="card-description">
          ZarzƒÖdzaj kierowcami i przeglƒÖdaj plany transportu
        </p>
      </div>
      {% endif %}

      {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('panel') }}')">
        <i class="bi bi-calendar3 card-icon"></i>
        <h2 class="card-title">Plan SUO</h2>
        <p class="card-description">
          PrzeglƒÖd salda godzin i pakiet√≥w wszystkich klient√≥w
        </p>
      </div>
      {% endif %}

      {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('tus_page') }}')">
        <span class="badge-status" style="background: var(--secondary-gradient);">Grupy</span>
        <i class="bi bi-star-fill card-icon"></i>
        <h2 class="card-title">Modu≈Ç TUS</h2>
        <p class="card-description">
          ZarzƒÖdzanie zajƒôciami grupowymi i globalny plan TUS
        </p>
      </div>
      {% endif %}
      
      {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('manager_page') }}')">
        <span class="badge-status" style="background: var(--warning-gradient);">Menad≈ºer</span>
        <i class="bi bi-file-earmark-medical card-icon"></i>
        <h2 class="card-title">Menad≈ºer</h2>
        <p class="card-description">
          ZarzƒÖdzaj dokumentacjƒÖ klient√≥w, skanuj i przesy≈Çaj pliki
        </p>
      </div>
      {% endif %}

      {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('waiting_list_page') }}')">
        <i class="bi bi-alarm card-icon"></i>
        <h2 class="card-title">OczekujƒÖcy</h2>
        <p class="card-description">
          ZarzƒÖdzaj listƒÖ klient√≥w oczekujƒÖcych na przyjƒôcie
        </p>
      </div>
      {% endif %}

		 {% if is_admin or therapist_id %}
      <div class="app-card" onclick="navigateTo('{{ url_for('terapeuta') }}')">
        <i class="bi bi-alarm card-icon"></i>
        <h2 class="card-title">Terapeuta</h2>
        <p class="card-description">
          ZarzƒÖdzaj listƒÖ klient√≥w oczekujƒÖcych na przyjƒôcie
        </p>
      </div>
      {% endif %}

		{% if is_admin or therapist_id %}
	      <div class="app-card" onclick="navigateTo('{{ url_for('sprawozdania') }}')">
	        <i class="bi bi-alarm card-icon"></i>
	        <h2 class="card-title">Sprawozdania</h2>
	        <p class="card-description">
	          ZarzƒÖdzaj listƒÖ klient√≥w oczekujƒÖcych na przyjƒôcie
	        </p>
	      </div>
      {% endif %}

		
    </div>

    <!-- Szybkie Akcje -->
    <div class="quick-actions">
      <h3><i class="bi bi-lightning-fill"></i> Szybkie akcje</h3>
      <div class="row g-3">
        <div class="col-md-6">
          <button class="action-btn" onclick="openClientSelectForPackage()">
            <i class="bi bi-plus-circle-fill"></i>
            <span>Dodaj pakiet zajƒôƒá</span>
          </button>
        </div>

        <div class="col-md-6">
          <button class="action-btn" onclick="quickAddClient()">
            <i class="bi bi-person-plus-fill"></i>
            <span>Dodaj nowego klienta</span>
          </button>
        </div>
        <div class="col-md-6">
          <button class="action-btn" onclick="quickAddTherapist()">
            <i class="bi bi-person-fill-add"></i>
            <span>Dodaj terapeutƒô</span>
          </button>
        </div>
        <div class="col-md-6">
          <button class="action-btn" onclick="quickAddDriver()">
            <i class="bi bi-person-plus-fill"></i>
            <span>Dodaj kierowcƒô</span>
          </button>
        </div>
        <div class="col-md-6">
          <button class="action-btn" onclick="quickCheckGaps()">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span>Sprawd≈∫ braki w miesiƒÖcu</span>
          </button>
        </div>
      </div>
    </div>
  </div>

¬† ¬† <div class="modal fade" id="addClientModal" tabindex="-1">
¬† ¬† <div class="modal-dialog">
¬† ¬† ¬† <div class="modal-content">
¬† ¬† ¬† ¬† <div class="modal-header">
¬† ¬† ¬† ¬† ¬† <h5 class="modal-title">Dodaj nowego klienta</h5>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <div class="modal-body">
¬† ¬† ¬† ¬† ¬† <form id="addClientForm">
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Imiƒô i nazwisko <span class="text-danger">*</span></label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="clientName" required>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Telefon</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="clientPhone">
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Adres</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="clientAddress">
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† </form>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <div class="modal-footer">
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-primary" onclick="submitAddClient()">
¬† ¬† ¬† ¬† ¬† ¬† <span class="spinner-border spinner-border-sm d-none" id="clientSpinner"></span>
¬† ¬† ¬† ¬† ¬† ¬† Dodaj klienta
¬† ¬† ¬† ¬† ¬† </button>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† </div>
¬† ¬† </div>
¬† </div>

¬† ¬† <div class="modal fade" id="addTherapistModal" tabindex="-1">
¬† ¬† <div class="modal-dialog">
¬† ¬† ¬† <div class="modal-content">
¬† ¬† ¬† ¬† <div class="modal-header">
¬† ¬† ¬† ¬† ¬† <h5 class="modal-title">Dodaj terapeutƒô</h5>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <div class="modal-body">
¬† ¬† ¬† ¬† ¬† <form id="addTherapistForm">
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Imiƒô i nazwisko <span class="text-danger">*</span></label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="therapistName" required>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Specjalizacja</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="therapistSpec" placeholder="np. SI, psycholog">
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Telefon</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="therapistPhone">
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† </form>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <div class="modal-footer">
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-primary" onclick="submitAddTherapist()">
¬† ¬† ¬† ¬† ¬† ¬† <span class="spinner-border spinner-border-sm d-none" id="therapistSpinner"></span>
¬† ¬† ¬† ¬† ¬† ¬† Dodaj terapeutƒô
¬† ¬† ¬† ¬† ¬† </button>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† </div>
¬† ¬† </div>
¬† </div>

¬† ¬† <div class="modal fade" id="addDriverModal" tabindex="-1">
¬† ¬† <div class="modal-dialog">
¬† ¬† ¬† <div class="modal-content">
¬† ¬† ¬† ¬† <div class="modal-header">
¬† ¬† ¬† ¬† ¬† <h5 class="modal-title">Dodaj kierowcƒô</h5>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <div class="modal-body">
¬† ¬† ¬† ¬† ¬† <form id="addDriverForm">
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Imiƒô i nazwisko <span class="text-danger">*</span></label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="driverName" required>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Telefon</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="driverPhone">
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† </form>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† <div class="modal-footer">
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-primary" onclick="submitAddDriver()">
¬† ¬† ¬† ¬† ¬† ¬† <span class="spinner-border spinner-border-sm d-none" id="driverSpinner"></span>
¬† ¬† ¬† ¬† ¬† ¬† Dodaj kierowcƒô
¬† ¬† ¬† ¬† ¬† </button>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† </div>
¬† ¬† </div>
¬† </div>

¬† ¬† <div class="modal fade" id="gapsModal" tabindex="-1">
¬† ¬† <div class="modal-dialog modal-xl">
¬† ¬† ¬† <div class="modal-content">
¬† ¬† ¬† ¬† <div class="modal-header">
¬† ¬† ¬† ¬† ¬† <h5 class="modal-title">Braki w miesiƒÖcu</h5>
¬† ¬† ¬† ¬† ¬† <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
¬† ¬† ¬† ¬† </div>

		  
¬† ¬† ¬† ¬† <div class="modal-body" id="gapsContent">
¬† ¬† ¬† ¬† ¬† <div class="text-center py-4">
¬† ¬† ¬† ¬† ¬† ¬† <div class="spinner-border" role="status"></div>
¬† ¬† ¬† ¬† ¬† ¬† <p class="mt-2">≈Åadowanie...</p>
¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† </div>
¬† ¬† </div>
¬† </div>

¬† <div class="offcanvas offcanvas-end" style="width: 520px;" tabindex="-1" id="packageCanvas">
¬† ¬† <div class="offcanvas-header">
¬† ¬† ¬† ¬† <h5>Dodaj pakiet zdarze≈Ñ</h5>
¬† ¬† ¬† ¬† <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
¬† ¬† </div>
¬† ¬† <div class="offcanvas-body">
¬† ¬† ¬† ¬† <form id="packageForm">
¬† ¬† ¬† ¬† ¬† ¬† <input type="hidden" id="pkgClientId">

¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Klient</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="pkgClientName" disabled>
¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† <div class="mb-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Etykieta (np. ‚ÄûWtorek poranny")</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="pkgLabel">
¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† <h6 class="mt-3">Terapia</h6>
¬† ¬† ¬† ¬† ¬† ¬† <div class="row g-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Terapeuta</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <select class="form-select" id="thSelect" required>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <option value="">‚Äî wybierz ‚Äî</option>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </select>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Data</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="date" class="form-control" id="thDate" required>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Start</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="time" class="form-control" id="thStart" required>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Koniec</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="time" class="form-control" id="thEnd" required>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-12">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Miejsce</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="text" class="form-control" id="thPlace" value="Poradnia">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† <hr class="my-3">

¬† ¬† ¬† ¬† ¬† ¬† <div class="form-check form-switch mb-2">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input class="form-check-input" type="checkbox" id="withPickup">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-check-label" for="withPickup">Dodaj dow√≥z (pickup)</label>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div id="pickupFields" class="row g-3 d-none">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Kierowca</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <select class="form-select" id="pkDriverSelect">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <option value="">‚Äî wybierz ‚Äî</option>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </select>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Start</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="time" class="form-control" id="pkStart">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Koniec</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="time" class="form-control" id="pkEnd">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† <hr class="my-3">

¬† ¬† ¬† ¬† ¬† ¬† <div class="form-check form-switch mb-2">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input class="form-check-input" type="checkbox" id="withDropoff">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-check-label" for="withDropoff">Dodaj odw√≥z (dropoff)</label>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div id="dropoffFields" class="row g-3 d-none">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Kierowca</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <select class="form-select" id="dpDriverSelect">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <option value="">‚Äî wybierz ‚Äî</option>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </select>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Start</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="time" class="form-control" id="dpStart">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="col-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <label class="form-label">Koniec</label>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <input type="time" class="form-control" id="dpEnd">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† <div class="d-grid gap-2 mt-4">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button type="submit" class="btn btn-primary">Zapisz pakiet</button>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Anuluj</button>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† </form>
¬† ¬† </div>
</div>

    <!-- Modal wyboru klienta -->
<div class="modal fade" id="clientSelectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Wybierz klienta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <select class="form-select" id="modalClientSelect">
          <option value="">≈Åadowanie klient√≥w...</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
        <button type="button" class="btn btn-primary" onclick="selectClient()">Wybierz</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal wyboru typu pakietu -->
<div class="modal fade" id="packageTypeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Wybierz typ pakietu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Dla klienta: <strong id="selectedClientName"></strong></p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary btn-lg" onclick="goToIndividualPackage()">
            <i class="bi bi-person-fill"></i> Terapia indywidualna
          </button>
          <button type="button" class="btn btn-info btn-lg" onclick="goToTusPackage()">
            <i class="bi bi-people-fill"></i> Grupa TUS
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

¬† <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
¬† 
  ¬† <script>
¬† ¬† const API = "";

¬† ¬† // Nawigacja
¬† ¬† function navigateTo(url) {
¬† ¬† ¬† window.location.href = url;
¬† ¬† }

¬† ¬† // Inicjalizacja miesiƒÖca
¬† ¬† (function initMonth(){
¬† ¬† ¬† const today = new Date();
¬† ¬† ¬† const y = today.getFullYear();
¬† ¬† ¬† const m = String(today.getMonth()+1).padStart(2,'0');
¬† ¬† ¬† document.getElementById('monthFilter').value = `${y}-${m}`;
¬† ¬† })();

¬† ¬† // ≈Åadowanie statystyk
¬† ¬† async function loadStats() {
¬† ¬† ¬† const month = document.getElementById('monthFilter').value;
¬† ¬† ¬† try {
¬† ¬† ¬† ¬† const clientsRes = await fetch(`${API}/api/clients?month=${month}`);
¬† ¬† ¬† ¬† const clients = await clientsRes.json();
¬† ¬† ¬† ¬† document.getElementById('clientsCount').textContent = clients.filter(c => c.active !== false).length;
¬† ¬† ¬† ¬† const therapistsRes = await fetch(`${API}/api/therapists`);
¬† ¬† ¬† ¬† const therapists = await therapistsRes.json();
¬† ¬† ¬† ¬† document.getElementById('therapistsCount').textContent = therapists.filter(t => t.active !== false).length;
¬† ¬† ¬† ¬† const driversRes = await fetch(`${API}/api/drivers`);
¬† ¬† ¬† ¬† const drivers = await driversRes.json();
¬† ¬† ¬† ¬† document.getElementById('driversCount').textContent = drivers.filter(d => d.active !== false).length;
¬† ¬† ¬† ¬† const packagesCount = clients.reduce((sum, c) => sum + (c.minutes_used > 0 ? 1 : 0), 0);
¬† ¬† ¬† ¬† document.getElementById('packagesCount').textContent = packagesCount;
¬† ¬† ¬† } catch (err) {
¬† ¬† ¬† ¬† console.error('B≈ÇƒÖd ≈Çadowania statystyk:', err);
¬† ¬† ¬† }
¬† ¬† }
¬† ¬† document.getElementById('monthFilter').addEventListener('change', loadStats);
¬† ¬† loadStats();

¬† ¬† // OBS≈ÅUGA SZYBKICH AKCJI
¬† ¬† document.addEventListener('DOMContentLoaded', () => {
¬† ¬† ¬† const urlParams = new URLSearchParams(window.location.search);
¬† ¬† ¬† const action = urlParams.get('action');
¬† ¬† ¬† if (action === 'addClient') { quickAddClient(); }
      else if (action === 'addTherapist') { quickAddTherapist(); }
      else if (action === 'addDriver') { quickAddDriver(); }
      else if (action === 'checkGaps') { quickCheckGaps(); }
      else if (action === 'addPackage') { quickAddPackage(); }
¬† ¬† });

¬† ¬† // --- Funkcje Modali (z poprawionƒÖ nawigacjƒÖ) ---

¬† ¬† // Dodaj klienta (bez zmian)
¬† ¬† function quickAddClient() {
¬† ¬† ¬† document.getElementById('addClientForm').reset();
¬† ¬† ¬† new bootstrap.Modal(document.getElementById('addClientModal')).show();
¬† ¬† }

    // ‚úÖ‚úÖ‚úÖ POCZƒÑTEK B≈ÅƒòDU SYNTAX ‚úÖ‚úÖ‚úÖ
    // Poni≈ºszy kod jest poza funkcjƒÖ! Brakuje `async function submitAddClient() {`
¬† ¬† async function submitAddClient() {
      const name = document.getElementById('clientName').value.trim();
¬† ¬† ¬† if (!name) { alert('Podaj imiƒô i nazwisko klienta'); return; }
¬† ¬† ¬† const phone = document.getElementById('clientPhone').value.trim();
¬† ¬† ¬† const address = document.getElementById('clientAddress').value.trim();
¬† ¬† ¬† const spinner = document.getElementById('clientSpinner');
¬† ¬† ¬† spinner.classList.remove('d-none');
¬† ¬† ¬† try {
¬† ¬† ¬† ¬† const res = await fetch(`${API}/api/clients`, {
¬† ¬† ¬† ¬† ¬† method: 'POST',
¬† ¬† ¬† ¬† ¬† headers: { 'Content-Type': 'application/json' },
¬† ¬† ¬† ¬† ¬† body: JSON.stringify({ full_name: name, phone: phone || null, address: address || null, active: true })
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† if (!res.ok) throw new Error(`HTTP ${res.status}`);
¬† ¬† ¬† ¬† bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
¬† ¬† ¬† ¬† alert('Klient zosta≈Ç dodany pomy≈õlnie!');
¬† ¬† ¬† ¬† loadStats();
¬† ¬† ¬† ¬† const viewClient = confirm('Czy chcesz przej≈õƒá do listy klient√≥w?');
¬† ¬† ¬† ¬† if (viewClient) {
¬† ¬† ¬† ¬† ¬† // ‚úÖ POPRAWKA TUTAJ: U≈ºyj url_for z Jinja2
¬† ¬† ¬† ¬† ¬† navigateTo('{{ url_for('clients_page') }}');
¬† ¬† ¬† ¬† }
¬† ¬† ¬† } catch (err) {
¬† ¬† ¬† ¬† alert(`B≈ÇƒÖd dodawania klienta: ${err.message}`);
¬† ¬† ¬† } finally {
¬† ¬† ¬† ¬† spinner.classList.add('d-none');
¬† ¬† ¬† }
    }
    // ‚úÖ‚úÖ‚úÖ KONIEC B≈ÅƒòDU SYNTAX ‚úÖ‚úÖ‚úÖ


¬† ¬† // Dodaj terapeutƒô - otw√≥rz modal
¬† ¬† function quickAddTherapist() {
¬† ¬† ¬† document.getElementById('addTherapistForm').reset();
¬† ¬† ¬† new bootstrap.Modal(document.getElementById('addTherapistModal')).show();
¬† ¬† }

¬† ¬† // Submit dodawania terapeuty
¬† ¬† async function submitAddTherapist() {
¬† ¬† ¬† const name = document.getElementById('therapistName').value.trim();
¬† ¬† ¬† if (!name) {
¬† ¬† ¬† ¬† alert('Podaj imiƒô i nazwisko terapeuty');
¬† ¬† ¬† ¬† return;
¬† ¬† ¬† }
¬† ¬† ¬† const spec = document.getElementById('therapistSpec').value.trim();
¬† ¬† ¬† const phone = document.getElementById('therapistPhone').value.trim();
¬† ¬† ¬† const spinner = document.getElementById('therapistSpinner');
¬† ¬† ¬† spinner.classList.remove('d-none');
¬† ¬† ¬† try {
¬† ¬† ¬† ¬† const res = await fetch(`${API}/api/therapists`, {
¬† ¬† ¬† ¬† ¬† method: 'POST',
¬† ¬† ¬† ¬† ¬† headers: { 'Content-Type': 'application/json' },
¬† ¬† ¬† ¬† ¬† body: JSON.stringify({
¬† ¬† ¬† ¬† ¬† ¬† full_name: name,
¬† ¬† ¬† ¬† ¬† ¬† specialization: spec || null,
¬† ¬† ¬† ¬† ¬† ¬† phone: phone || null,
¬† ¬† ¬† ¬† ¬† ¬† active: true
¬† ¬† ¬† ¬† ¬† })
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† if (!res.ok) throw new Error(`HTTP ${res.status}`);
¬† ¬† ¬† ¬† bootstrap.Modal.getInstance(document.getElementById('addTherapistModal')).hide();
¬† ¬† ¬† ¬† alert('Terapeuta zosta≈Ç dodany pomy≈õlnie!');
¬† ¬† ¬† ¬† loadStats();
¬† ¬† ¬† ¬† const viewTherapist = confirm('Czy chcesz przej≈õƒá do plan√≥w terapeut√≥w?');
¬† ¬† ¬† ¬† if (viewTherapist) {
¬† ¬† ¬† ¬† ¬† // ‚úÖ POPRAWKA TUTAJ: U≈ºyj url_for z Jinja2
¬† ¬† ¬† ¬† ¬† navigateTo('{{ url_for('schedule_page') }}');
¬† ¬† ¬† ¬† }
¬† ¬† ¬† } catch (err) {
¬† ¬† ¬† ¬† alert(`B≈ÇƒÖd dodawania terapeuty: ${err.message}`);
¬† ¬† ¬† } finally {
¬† ¬† ¬† ¬† spinner.classList.add('d-none');
¬† ¬† ¬† }
¬† ¬† }

¬† ¬† // Dodaj kierowcƒô - otw√≥rz modal
¬† ¬† function quickAddDriver() {
¬† ¬† ¬† document.getElementById('addDriverForm').reset();
¬† ¬† ¬† new bootstrap.Modal(document.getElementById('addDriverModal')).show();
¬† ¬† }

¬† ¬† // Submit dodawania kierowcy
¬† ¬† async function submitAddDriver() {
¬† ¬† ¬† const name = document.getElementById('driverName').value.trim();
¬† ¬† ¬† if (!name) {
¬† ¬† ¬† ¬† alert('Podaj imiƒô i nazwisko kierowcy');
¬† ¬† ¬† ¬† return;
¬† ¬† ¬† }
¬† ¬† ¬† const phone = document.getElementById('driverPhone').value.trim();
¬† ¬† ¬† const spinner = document.getElementById('driverSpinner');
¬† ¬† ¬† spinner.classList.remove('d-none');
¬† ¬† ¬† try {
¬† ¬† ¬† ¬† const res = await fetch(`${API}/api/drivers`, {
¬† ¬† ¬† ¬† ¬† method: 'POST',
¬† ¬† ¬† ¬† ¬† headers: { 'Content-Type': 'application/json' },
¬† ¬† ¬† ¬† ¬† body: JSON.stringify({
¬† ¬† ¬† ¬† ¬† ¬† full_name: name,
¬† ¬† ¬† ¬† ¬† ¬† phone: phone || null,
¬† ¬† ¬† ¬† ¬† ¬† active: true
¬† ¬† ¬† ¬† ¬† })
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† if (!res.ok) throw new Error(`HTTP ${res.status}`);
¬† ¬† ¬† ¬† bootstrap.Modal.getInstance(document.getElementById('addDriverModal')).hide();
¬† ¬† ¬† ¬† alert('Kierowca zosta≈Ç dodany pomy≈õlnie!');
¬† ¬† ¬† ¬† loadStats();
¬† ¬† ¬† ¬† const viewDriver = confirm('Czy chcesz przej≈õƒá do plan√≥w kierowc√≥w?');
¬† ¬† ¬† ¬† if (viewDriver) {
¬† ¬† ¬† ¬† ¬† navigateTo('{{ url_for('driver_schedule_page') }}');
¬† ¬† ¬† ¬† }
¬† ¬† ¬† } catch (err) {
¬† ¬† ¬† ¬† alert(`B≈ÇƒÖd dodawania kierowcy: ${err.message}`);
¬† ¬† ¬† } finally {
¬† ¬† ¬† ¬† spinner.classList.add('d-none');
¬† ¬† ¬† }
¬† ¬† }

    ¬† ¬† // Sprawd≈∫ braki w miesiƒÖcu
¬† ¬†// Sprawd≈∫ braki w miesiƒÖcu - uk≈Çad kolumnowy
async function quickCheckGaps() {
    const month = document.getElementById('monthFilter').value;
    if (!month) {
        alert('Wybierz miesiƒÖc z filtra u g√≥ry strony.');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('gapsModal'));
    modal.show();
    
    const content = document.getElementById('gapsContent');
    content.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-3 text-white">Sprawdzam braki w miesiƒÖcu ${month}...</p>
        </div>
    `;
    
    try {
        const res = await fetch(`${API}/api/gaps/month?month=${encodeURIComponent(month)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const c = data.counts || {clients: 0, therapists: 0, drivers: 0};
        
        const renderPersonList = (persons, type) => {
            if (!persons || !persons.length) {
                return '<div class="empty-list">Brak brakujƒÖcych</div>';
            }
            
            return persons.map(person => {
                const personId = person.id || person.client_id || person.therapist_id || person.driver_id;
                const fullName = person.full_name || 'Brak nazwy';
                
                let actionButton = '';
                if (personId && type === 'client') {
                    actionButton = `
                        <button class="action-btn btn-primary" onclick="addPackageForClient(${personId}, '${fullName.replace(/'/g, "\\'")}')">
                            <i class="bi bi-plus-circle"></i> Dodaj pakiet
                        </button>
                    `;
                } else if (personId && type === 'therapist') {
                    actionButton = `
                        <button class="action-btn btn-outline" onclick="viewTherapistSchedule(${personId})">
                            <i class="bi bi-calendar3"></i> Grafik
                        </button>
                    `;
                } else if (personId && type === 'driver') {
                    actionButton = `
                        <button class="action-btn btn-outline" onclick="viewDriverSchedule(${personId})">
                            <i class="bi bi-truck"></i> Kursy
                        </button>
                    `;
                }
                
                return `
                    <div class="person-item">
                        <div class="person-info">
                            <span class="person-name">${fullName}</span>
                            ${person.absence_status ? `<span class="person-badge">${person.absence_status}</span>` : ''}
                        </div>
                        <div class="person-actions">
                            ${actionButton}
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        content.innerHTML = `
            <div class="gaps-container">
                <!-- Klienci -->
                <div class="gaps-column">
                    <div class="column-header">
                        <h2>Klienci bez zdarze≈Ñ</h2>
                        <span class="column-count">${c.clients}</span>
                    </div>
                    <div class="column-list">
                        <div class="column-section">
                            <h3>Klienci</h3>
                            ${renderPersonList(data.clients, 'client')}
                        </div>
                    </div>
                </div>
                
                <!-- Terapeuci -->
                <div class="gaps-column">
                    <div class="column-header">
                        <h2>Terapeuci bez terapii</h2>
                        <span class="column-count">${c.therapists}</span>
                    </div>
                    <div class="column-list">
                        <div class="column-section">
                            <h3>Terapeuci</h3>
                            ${renderPersonList(data.therapists, 'therapist')}
                        </div>
                    </div>
                </div>
                
                <!-- Kierowcy -->
                <div class="gaps-column">
                    <div class="column-header">
                        <h2>Kierowcy bez kurs√≥w</h2>
                        <span class="column-count">${c.drivers}</span>
                    </div>
                    <div class="column-list">
                        <div class="column-section">
                            <h3>Kierowcy</h3>
                            ${renderPersonList(data.drivers, 'driver')}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } catch (err) {
        content.innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>B≈ÇƒÖd podczas ≈Çadowania danych:</strong><br>
                ${err.message}
            </div>
        `;
    }
}

¬† ¬† // Dodaj pakiet - przekierowanie do wyboru klienta
¬† ¬† function quickAddPackage() {
¬† ¬† ¬† // ‚úÖ POPRAWKA TUTAJ: U≈ºyj url_for z Jinja2
¬† ¬† ¬† window.location.href = '{{ url_for('main_index') }}?view=main&action=selectClient';
¬† ¬† }

¬† ¬† // Poka≈º g≈Ç√≥wny widok (bez zmian)
¬† ¬† function showMainView() {
¬† ¬† ¬† alert('Funkcja "Plan SUO" zostanie wkr√≥tce zintegrowana z tym ekranem startowym.');
¬† ¬† }

¬† ¬† // --- Poprawione funkcje z listy brak√≥w ---

¬† ¬† // Dodaj pakiet dla klienta z listy brak√≥w
¬† ¬† window.addPackageForClient = function(clientId, clientName) {
¬† ¬† ¬† const modalInstance = bootstrap.Modal.getInstance(document.getElementById('gapsModal'));
¬† ¬† ¬† if (modalInstance) modalInstance.hide();
¬† ¬† ¬† const confirmAdd = confirm(`Czy chcesz dodaƒá pakiet dla klienta:\n${clientName}?`);
¬† ¬† ¬† if (confirmAdd) {
        // ‚úÖ POPRAWKA TUTAJ: U≈ºyj url_for z Jinja2
¬† ¬† ¬† ¬† window.location.href = `{{ url_for('manager_page') }}?openPackageFor=${clientId}`;
¬† ¬† ¬† }
¬† ¬† };

¬† ¬† // Zobacz grafik terapeuty
¬† ¬† window.viewTherapistSchedule = function(therapistId) {
¬† ¬† ¬† const modalInstance = bootstrap.Modal.getInstance(document.getElementById('gapsModal'));
¬† ¬† ¬† if (modalInstance) modalInstance.hide();
      // ‚úÖ POPRAWKA TUTAJ: U≈ºyj url_for z Jinja2
      window.location.href = `{{ url_for('schedule_page') }}?therapist_id=${therapistId}`;
¬† ¬† };

¬† ¬† // Zobacz kursy kierowcy
¬† ¬† window.viewDriverSchedule = function(driverId) {
¬† ¬† ¬† const modalInstance = bootstrap.Modal.getInstance(document.getElementById('gapsModal'));
¬† ¬† ¬† if (modalInstance) modalInstance.hide();
      // ‚úÖ POPRAWKA TUTAJ: U≈ºyj url_for z Jinja2
¬† ¬† ¬† window.location.href = `{{ url_for('driver_schedule_page') }}?driver_id=${driverId}`;
¬† ¬† };

¬† ¬† ¬† let selectedClientId = null;
    let selectedClientName = null;
// Toggle pickup/dropoff fields
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('withPickup')?.addEventListener('change', (e) => {
        document.getElementById('pickupFields').classList.toggle('d-none', !e.target.checked);
    });

    document.getElementById('withDropoff')?.addEventListener('change', (e) => {
        document.getElementById('dropoffFields').classList.toggle('d-none', !e.target.checked);
    });
});

async function openClientSelectForPackage() {
    const modal = new bootstrap.Modal(document.getElementById('clientSelectModal'));
    const select = document.getElementById('modalClientSelect');

    select.innerHTML = '<option value="">≈Åadowanie...</option>';
    select.disabled = true;
    modal.show();

    try {
        const res = await fetch(`${API}/api/clients`);
        const clients = await res.json();
        const activeClients = clients.filter(c => c.active !== false);

        if (activeClients.length > 0) {
            select.innerHTML = '<option value="">-- wybierz klienta --</option>' +
                activeClients.map(c => `<option value="${c.client_id}" data-name="${c.full_name}">${c.full_name}</option>`).join('');
        } else {
            select.innerHTML = '<option value="">Brak aktywnych klient√≥w</option>';
        }
    } catch (err) {
        select.innerHTML = `<option value="">B≈ÇƒÖd: ${err.message}</option>`;
    } finally {
        select.disabled = false;
    }
}

function selectClient() {
    const select = document.getElementById('modalClientSelect');
    selectedClientId = select.value;
    selectedClientName = select.options[select.selectedIndex]?.getAttribute('data-name');

    if (!selectedClientId) {
        alert("Proszƒô wybraƒá klienta z listy.");
        return;
    }

    bootstrap.Modal.getInstance(document.getElementById('clientSelectModal')).hide();

    setTimeout(() => {
        new bootstrap.Modal(document.getElementById('packageTypeModal')).show();
    }, 300);
}

async function goToIndividualPackage() {
    bootstrap.Modal.getInstance(document.getElementById('packageTypeModal')).hide();

    // Za≈Çaduj terapeut√≥w i kierowc√≥w
    await loadTherapistsAndDrivers();

    // Wype≈Çnij dane klienta
    document.getElementById('pkgClientId').value = selectedClientId;
    document.getElementById('pkgClientName').value = selectedClientName;

    // Ustaw domy≈õlnƒÖ datƒô (jutro)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('thDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('thStart').value = '09:00';
    document.getElementById('thEnd').value = '10:00';

    // Otw√≥rz formularz
    setTimeout(() => {
        new bootstrap.Offcanvas(document.getElementById('packageCanvas')).show();
    }, 300);
}

function goToTusPackage(){
      // ‚úÖ POPRAWKA TUTAJ
¬† ¬†   window.location.href = `{{ url_for('tus_page') }}?action=addPackage&clientId=${selectedClientId}`;
    }

async function loadTherapistsAndDrivers() {
    try {
        const [tRes, dRes] = await Promise.all([
            fetch(`${API}/api/therapists`),
            fetch(`${API}/api/drivers`)
        ]);

        const therapists = await tRes.json();
        const drivers = await dRes.json();

        const activeTherapists = therapists.filter(t => t.active !== false);
        const activeDrivers = drivers.filter(d => d.active !== false);

        document.getElementById('thSelect').innerHTML = '<option value="">‚Äî wybierz ‚Äî</option>' +
            activeTherapists.map(t => `<option value="${t.id}">${t.full_name}</option>`).join('');

        document.getElementById('pkDriverSelect').innerHTML = '<option value="">‚Äî wybierz ‚Äî</option>' +
            activeDrivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');

        document.getElementById('dpDriverSelect').innerHTML = '<option value="">‚Äî wybierz ‚Äî</option>' +
            activeDrivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');
    } catch (err) {
        alert(`B≈ÇƒÖd ≈Çadowania danych: ${err.message}`);
    }
}

// Obs≈Çuga zapisu pakietu
document.getElementById('packageForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
        client_id: parseInt(document.getElementById('pkgClientId').value),
        label: document.getElementById('pkgLabel').value || null,
        therapy: {
            therapist_id: parseInt(document.getElementById('thSelect').value),
            starts_at: `${document.getElementById('thDate').value}T${document.getElementById('thStart').value}:00`,
            ends_at: `${document.getElementById('thDate').value}T${document.getElementById('thEnd').value}:00`,
            place: document.getElementById('thPlace').value
        },
        status: 'planned'
    };

    if (document.getElementById('withPickup').checked) {
        payload.pickup = {
            driver_id: parseInt(document.getElementById('pkDriverSelect').value),
            starts_at: `${document.getElementById('thDate').value}T${document.getElementById('pkStart').value}:00`,
            ends_at: `${document.getElementById('thDate').value}T${document.getElementById('pkEnd').value}:00`,
            from: 'Dom',
            to: 'Poradnia'
        };
    }

    if (document.getElementById('withDropoff').checked) {
        payload.dropoff = {
            driver_id: parseInt(document.getElementById('dpDriverSelect').value),
            starts_at: `${document.getElementById('thDate').value}T${document.getElementById('dpStart').value}:00`,
            ends_at: `${document.getElementById('thDate').value}T${document.getElementById('dpEnd').value}:00`,
            from: 'Poradnia',
            to: 'Dom'
        };
    }

    try {
        const res = await fetch(`${API}/api/schedule/group`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        alert('Pakiet dodany pomy≈õlnie!');
        bootstrap.Offcanvas.getInstance(document.getElementById('packageCanvas')).hide();
        document.getElementById('packageForm').reset();
    } catch (err) {
        alert(`B≈ÇƒÖd zapisu: ${err.message}`);
    }
});
  </script>
    
</body>

</html>
